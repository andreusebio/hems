[
    {
        "id": "ef23770c.5edc1",
        "type": "tab",
        "label": "plug0",
        "disabled": false,
        "info": ""
    },
    {
        "id": "be52c199.c86f58",
        "type": "tab",
        "label": "plug0A",
        "disabled": false,
        "info": ""
    },
    {
        "id": "c1eaebbb.b6c98",
        "type": "tab",
        "label": "plug0B",
        "disabled": false,
        "info": ""
    },
    {
        "id": "a4b5eb1e.5dd4d8",
        "type": "tab",
        "label": "plug1",
        "disabled": false,
        "info": ""
    },
    {
        "id": "bbaf6eb0.1f878",
        "type": "tab",
        "label": "plug2",
        "disabled": false,
        "info": ""
    },
    {
        "id": "2a4ee4a1.258c6c",
        "type": "tab",
        "label": "plug3",
        "disabled": false,
        "info": ""
    },
    {
        "id": "bb2dc5a6.c18128",
        "type": "tab",
        "label": "sonoff pow",
        "disabled": false,
        "info": ""
    },
    {
        "id": "2cf1d395.65be64",
        "type": "tab",
        "label": "Solar",
        "disabled": false,
        "info": ""
    },
    {
        "id": "9e52ccb8.2c00a8",
        "type": "tab",
        "label": "Advanced energy management",
        "disabled": false,
        "info": ""
    },
    {
        "id": "5f22000e.0f3588",
        "type": "tab",
        "label": "Logging",
        "disabled": false
    },
    {
        "id": "68347deb.b93a34",
        "type": "tab",
        "label": "GlobalStorage",
        "disabled": false,
        "info": ""
    },
    {
        "id": "b24c4c5e.ac4c1",
        "type": "tab",
        "label": "Cost",
        "disabled": false,
        "info": ""
    },
    {
        "id": "f512852c.8ffbe8",
        "type": "tab",
        "label": "Report",
        "disabled": false,
        "info": ""
    },
    {
        "id": "584b08c1.d6cff8",
        "type": "tab",
        "label": "User configuration",
        "disabled": false,
        "info": ""
    },
    {
        "id": "a288547e.abd6f",
        "type": "ui_base",
        "theme": {
            "name": "theme-light",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
            },
            "themeState": {
                "base-color": {
                    "default": "#0094CE",
                    "value": "#0094CE",
                    "edited": false
                },
                "page-titlebar-backgroundColor": {
                    "value": "#0094CE",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#fafafa",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#1bbfff",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#111111",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#0094ce",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "base-font": {
                    "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
                }
            }
        },
        "site": {
            "name": "House energy meter",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "dateFormat": "DD/MM/YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "4f35fce7.f4f55c",
        "type": "mqtt-broker",
        "z": "",
        "broker": "192.168.1.100",
        "port": "1883",
        "clientid": "",
        "usetls": false,
        "compatmode": true,
        "keepalive": "60",
        "cleansession": true,
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": ""
    },
    {
        "id": "94c641c2.2e173",
        "type": "ui_tab",
        "z": "",
        "name": "Home",
        "icon": "fa-area-chart ",
        "order": 1
    },
    {
        "id": "d92701a0.92dba",
        "type": "ui_group",
        "z": "",
        "name": "Plug1",
        "tab": "cb2f38ba.b1bd38",
        "disp": true,
        "width": "10"
    },
    {
        "id": "8dc84beb.c40e98",
        "type": "ui_group",
        "z": "",
        "name": "Plug3",
        "tab": "deb68155.23d708",
        "disp": true,
        "width": "10"
    },
    {
        "id": "deb68155.23d708",
        "type": "ui_tab",
        "z": "",
        "name": "plug3",
        "icon": "fa-plug",
        "order": 5
    },
    {
        "id": "cb2f38ba.b1bd38",
        "type": "ui_tab",
        "z": "",
        "name": "plug1",
        "icon": "fa-plug",
        "order": 3
    },
    {
        "id": "d8070267.de17e8",
        "type": "ui_group",
        "z": "",
        "name": "Plug3",
        "tab": "94c641c2.2e173",
        "order": 4,
        "disp": true,
        "width": "6"
    },
    {
        "id": "d6107674.e42698",
        "type": "ui_group",
        "z": "",
        "name": "Plug1",
        "tab": "94c641c2.2e173",
        "order": 2,
        "disp": true,
        "width": "6"
    },
    {
        "id": "8bf48dbe.d2725",
        "type": "ui_group",
        "z": "",
        "name": "Report",
        "tab": "5a3874fe.f5a1cc",
        "order": 2,
        "disp": false,
        "width": "24"
    },
    {
        "id": "7372a57c.b3cfbc",
        "type": "ui_group",
        "z": "",
        "name": "Filters",
        "tab": "5a3874fe.f5a1cc",
        "disp": true,
        "width": "24"
    },
    {
        "id": "b629c67.a0f9e38",
        "type": "sqlitedb",
        "z": "",
        "db": "/var/www/html/database/meter.db"
    },
    {
        "id": "213b5215.c08486",
        "type": "ui_group",
        "z": "",
        "name": "Plug2",
        "tab": "94c641c2.2e173",
        "order": 3,
        "disp": true,
        "width": "6"
    },
    {
        "id": "5efafd1d.cede14",
        "type": "ui_tab",
        "z": "",
        "name": "plug2",
        "icon": "fa-plug",
        "order": 4
    },
    {
        "id": "dee9af7d.49a6c8",
        "type": "ui_group",
        "z": "",
        "name": "Plug2",
        "tab": "5efafd1d.cede14",
        "disp": true,
        "width": "10"
    },
    {
        "id": "5a3874fe.f5a1cc",
        "type": "ui_tab",
        "z": "",
        "name": "Report",
        "icon": "event_note",
        "order": 8
    },
    {
        "id": "23b45b8f.2d22b4",
        "type": "ui_group",
        "z": "",
        "name": "Solar",
        "tab": "94c641c2.2e173",
        "order": 8,
        "disp": true,
        "width": "6"
    },
    {
        "id": "b71eb9c5.de272",
        "type": "ui_tab",
        "z": "",
        "name": "Solar",
        "icon": "fa-sun-o ",
        "order": 7
    },
    {
        "id": "9c0aaa2a.f18a08",
        "type": "ui_group",
        "z": "",
        "name": "Solar",
        "tab": "b71eb9c5.de272",
        "order": 1,
        "disp": false,
        "width": "10"
    },
    {
        "id": "29d0f416.9256cc",
        "type": "ui_group",
        "z": "",
        "name": "Main",
        "tab": "94c641c2.2e173",
        "order": 1,
        "disp": true,
        "width": "6"
    },
    {
        "id": "c7942fdd.46ab4",
        "type": "ui_tab",
        "z": "",
        "name": "Main",
        "icon": "dashboard",
        "order": 2
    },
    {
        "id": "3fa48937.d25e3e",
        "type": "ui_group",
        "z": "",
        "name": "Main",
        "tab": "c7942fdd.46ab4",
        "order": 1,
        "disp": true,
        "width": "6"
    },
    {
        "id": "63ae4fc1.3ca57",
        "type": "ui_group",
        "z": "",
        "name": "Main-A",
        "tab": "94c641c2.2e173",
        "order": 6,
        "disp": true,
        "width": "6"
    },
    {
        "id": "3bbbbd5f.04b81a",
        "type": "ui_group",
        "z": "",
        "name": "Main-A",
        "tab": "c7942fdd.46ab4",
        "order": 2,
        "disp": true,
        "width": "6"
    },
    {
        "id": "79110c42.df685c",
        "type": "ui_group",
        "z": "",
        "name": "Main-B",
        "tab": "94c641c2.2e173",
        "order": 7,
        "disp": true,
        "width": "6"
    },
    {
        "id": "27fc78e8.8a487",
        "type": "ui_group",
        "z": "",
        "name": "Main-B",
        "tab": "c7942fdd.46ab4",
        "order": 3,
        "disp": true,
        "width": "6"
    },
    {
        "id": "966ec1b.e6135c",
        "type": "ui_tab",
        "z": "",
        "name": "Configuration",
        "icon": "fa-cog",
        "order": 12
    },
    {
        "id": "6e68fe26.a57b88",
        "type": "ui_group",
        "z": "",
        "name": "Cost",
        "tab": "966ec1b.e6135c",
        "disp": true,
        "width": "6"
    },
    {
        "id": "d7d88c31.fa982",
        "type": "ui_tab",
        "z": "",
        "name": "Cost",
        "icon": "fa-eur",
        "order": 9
    },
    {
        "id": "d2a69f5d.cc4d48",
        "type": "ui_group",
        "z": "",
        "name": "Filters",
        "tab": "d7d88c31.fa982",
        "order": 2,
        "disp": true,
        "width": "24"
    },
    {
        "id": "8f5c5d5f.ac21d",
        "type": "ui_group",
        "z": "",
        "name": "Report",
        "tab": "d7d88c31.fa982",
        "order": 1,
        "disp": true,
        "width": "24"
    },
    {
        "id": "3ed23385.374b5c",
        "type": "ui_group",
        "z": "",
        "name": "Time",
        "tab": "966ec1b.e6135c",
        "disp": true,
        "width": "6"
    },
    {
        "id": "11870185.d80c26",
        "type": "ui_group",
        "z": "",
        "name": "Bi",
        "tab": "d7d88c31.fa982",
        "order": 4,
        "disp": true,
        "width": "12"
    },
    {
        "id": "fd2f3e1.36366c",
        "type": "ui_group",
        "z": "",
        "name": "Fixed",
        "tab": "d7d88c31.fa982",
        "order": 3,
        "disp": true,
        "width": "12"
    },
    {
        "id": "4cc559bd.58d388",
        "type": "sqlitedb",
        "z": "",
        "db": "/home/pi/sqlite/nodered"
    },
    {
        "id": "c55b4875.d02d68",
        "type": "ui_group",
        "z": "",
        "name": "Report",
        "tab": "",
        "order": 2,
        "disp": false,
        "width": "24"
    },
    {
        "id": "9b58e9b3.14cae8",
        "type": "ui_group",
        "z": "",
        "name": "Filters",
        "tab": "",
        "disp": true,
        "width": "24"
    },
    {
        "id": "9ba7e893.4a7ff8",
        "type": "ui_group",
        "z": "",
        "name": "Solar 30 days",
        "tab": "",
        "order": 1,
        "disp": false,
        "width": "4"
    },
    {
        "id": "5b19599b.7b6d1",
        "type": "ui_group",
        "z": "",
        "name": "Solar 7 days",
        "tab": "",
        "order": 2,
        "disp": false,
        "width": "4"
    },
    {
        "id": "b2be6af.a599198",
        "type": "ui_group",
        "z": "",
        "name": "Solar target",
        "tab": "",
        "order": 3,
        "disp": false,
        "width": "4"
    },
    {
        "id": "e0f33dce.f6675",
        "type": "ui_group",
        "z": "",
        "name": "30day",
        "tab": "b71eb9c5.de272",
        "order": 2,
        "disp": false,
        "width": "4"
    },
    {
        "id": "bc98572c.f737b8",
        "type": "ui_group",
        "z": "",
        "name": "7day",
        "tab": "b71eb9c5.de272",
        "order": 3,
        "disp": false,
        "width": "4"
    },
    {
        "id": "a7d74e40.4d39f",
        "type": "ui_group",
        "z": "",
        "name": "max",
        "tab": "b71eb9c5.de272",
        "order": 4,
        "disp": false,
        "width": "4"
    },
    {
        "id": "9efd6936.d139d",
        "type": "ui_group",
        "z": "",
        "name": "Company meter",
        "tab": "c7942fdd.46ab4",
        "order": 4,
        "disp": true,
        "width": "6"
    },
    {
        "id": "3511ff8f.e69b58",
        "type": "sqlitedb",
        "z": "",
        "db": "/home/pi/sqlite/diagnostic"
    },
    {
        "id": "a69229a4.0e735",
        "type": "ui_group",
        "z": "",
        "name": "State Administration",
        "tab": "5359fc1e.999494",
        "disp": true,
        "width": "6"
    },
    {
        "id": "e7471808.f28cc8",
        "type": "ui_group",
        "z": "",
        "name": "System Administration",
        "tab": "5359fc1e.999494",
        "order": 3,
        "disp": true,
        "width": "6"
    },
    {
        "id": "1edf709d.f1ac27",
        "type": "ui_group",
        "z": "",
        "name": "System Status",
        "tab": "5359fc1e.999494",
        "disp": true,
        "width": "6"
    },
    {
        "id": "32fd5db3.b26d8a",
        "type": "ui_group",
        "z": "",
        "name": "System Messages",
        "tab": "5359fc1e.999494",
        "disp": true,
        "width": "18"
    },
    {
        "id": "5f61ccca.187814",
        "type": "sqlitedb",
        "z": "",
        "db": "/home/pi/sqlite/nodered"
    },
    {
        "id": "5359fc1e.999494",
        "type": "ui_tab",
        "z": "",
        "name": "Logs",
        "icon": "message",
        "order": 11
    },
    {
        "id": "1289dac0.1e682d",
        "type": "ui_tab",
        "z": "",
        "name": "Advanced",
        "icon": "fa-superpowers ",
        "order": 10
    },
    {
        "id": "a0bae005.bf1858",
        "type": "ui_group",
        "z": "",
        "name": "Category Administration",
        "tab": "1289dac0.1e682d",
        "disp": true,
        "width": "6"
    },
    {
        "id": "dc50d37c.093608",
        "type": "ui_group",
        "z": "",
        "name": "System Administration",
        "tab": "1289dac0.1e682d",
        "disp": true,
        "width": "6"
    },
    {
        "id": "5fb27f4a.0e8b48",
        "type": "ui_group",
        "z": "",
        "name": "System Status",
        "tab": "1289dac0.1e682d",
        "disp": true,
        "width": "14"
    },
    {
        "id": "e542aa93.916948",
        "type": "ui_group",
        "z": "",
        "name": "Atcive status",
        "tab": "966ec1b.e6135c",
        "disp": true,
        "width": "6"
    },
    {
        "id": "722ee8c5.f8de58",
        "type": "ui_group",
        "z": "",
        "name": "Max load control",
        "tab": "1289dac0.1e682d",
        "disp": true,
        "width": "6"
    },
    {
        "id": "d56da8c0.0455f",
        "type": "ui_group",
        "z": "",
        "name": "Solar saving mode",
        "tab": "1289dac0.1e682d",
        "disp": true,
        "width": "6"
    },
    {
        "id": "b0658e7d.f070a",
        "type": "ui_group",
        "z": "",
        "name": "Plug4",
        "tab": "94c641c2.2e173",
        "order": 5,
        "disp": true,
        "width": "6"
    },
    {
        "id": "f51750bd.169ce8",
        "type": "ui_tab",
        "z": "",
        "name": "Plug4",
        "icon": "fa-plug",
        "order": 6
    },
    {
        "id": "5d54337e.fe413c",
        "type": "ui_group",
        "z": "",
        "name": "Plug4",
        "tab": "f51750bd.169ce8",
        "disp": true,
        "width": "10"
    },
    {
        "id": "fe8be95c.8917c8",
        "type": "ui_group",
        "z": "",
        "name": "sssss",
        "tab": "",
        "disp": true,
        "width": "6"
    },
    {
        "id": "5ca00d55.879cf4",
        "type": "ui_group",
        "z": "",
        "name": "Report",
        "tab": "966ec1b.e6135c",
        "disp": true,
        "width": "6"
    },
    {
        "id": "99a4dc27.7780b",
        "type": "ui_group",
        "z": "",
        "name": "provider_meter",
        "tab": "966ec1b.e6135c",
        "disp": true,
        "width": "6"
    },
    {
        "id": "145e2cec.4e9fa3",
        "type": "ui_group",
        "z": "",
        "name": "Source",
        "tab": "b71eb9c5.de272",
        "disp": true,
        "width": "8"
    },
    {
        "id": "a7907b5e.278518",
        "type": "ui_group",
        "z": "",
        "name": "Default",
        "tab": "966ec1b.e6135c",
        "disp": true,
        "width": "12"
    },
    {
        "id": "21f580fc.a25438",
        "type": "inject",
        "z": "68347deb.b93a34",
        "name": "1 Minute Backup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "60",
        "crontab": "",
        "once": false,
        "x": 198.81817626953125,
        "y": 123.09089660644531,
        "wires": [
            [
                "35da0df4.88b92a"
            ]
        ]
    },
    {
        "id": "35da0df4.88b92a",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "Prep data",
        "func": "// global variables separated by semicolon to be saved\nvar globallist = \"report_email;provider_meter;fixed_energy_cost;bi_day_energy_cost;bi_night_energy_cost;energy_tax;day_cost_hour;night_cost_hour;solar_max;energy_threshold\";\nvar plug1_list = \";plug1_name;relay1_state;plug1_t_c;plug1_t_d\";\nvar plug2_list = \";plug2_name;relay2_state;plug2_t_c;plug2_t_d\";\nvar plug3_list = \";plug3_name;relay3_state;plug3_t_c;plug3_t_d\";\nvar plug4_list = \";plug4_state;plug4_t_c;plug4_t_d\";\nvar solar_list = \";plugS_t_c;plugS_t_d\";\nvar plug0_list = \";plug0_t_c;plug0_t_d\";\nvar plug0A_list = \";plug0A_name;plugA_t_c;plugA_t_d\";\nvar plug0B_list = \";plug0B_name;plugB_t_c;plugB_t_d\";\nvar advanced_energy_list = \";max_load_control;max_load;solar_threshold_control;solar_threshold\";\n\n\nvar res = globallist.concat(plug1_list);\nvar res = res.concat(plug2_list);\nvar res = res.concat(plug3_list);\nvar res = res.concat(plug4_list);\nvar res = res.concat(solar_list);\nvar res = res.concat(plug0_list);\nvar res = res.concat(plug0A_list);\nvar res = res.concat(plug0B_list);\nvar res = res.concat(advanced_energy_list);\n\nvar mylist = res.split(\";\");\n\nvar outputs = [];\n\nfor (i=0; i<mylist.length; i++) {\n    outputs.push({ key : mylist[i], type: typeof global.get(mylist[i]), value: global.get(mylist[i])});\n}\n      \nmsg.payload = outputs;\nreturn msg;\n\n//msg.payload=typeof global.get(\"torrent_keywords\");\n",
        "outputs": 1,
        "noerr": 0,
        "x": 409.0908508300781,
        "y": 124.272705078125,
        "wires": [
            [
                "ca1fce2f.0a4e28"
            ]
        ]
    },
    {
        "id": "94ef90a4.670a4",
        "type": "comment",
        "z": "68347deb.b93a34",
        "name": "Save global variables",
        "info": "",
        "x": 190.81817626953125,
        "y": 78.09089660644531,
        "wires": []
    },
    {
        "id": "5d08b330.f99154",
        "type": "comment",
        "z": "68347deb.b93a34",
        "name": "Restore global variables",
        "info": "",
        "x": 197,
        "y": 210,
        "wires": []
    },
    {
        "id": "2c88c14e.aa0176",
        "type": "inject",
        "z": "68347deb.b93a34",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 168,
        "y": 257,
        "wires": [
            [
                "66a62339.6b1cc4"
            ]
        ]
    },
    {
        "id": "77337646.a78f5",
        "type": "file",
        "z": "68347deb.b93a34",
        "name": "",
        "filename": "/home/pi/NRdata/global.json",
        "appendNewline": true,
        "createDir": false,
        "overwriteFile": "true",
        "x": 764.7012939453125,
        "y": 125.05189514160156,
        "wires": []
    },
    {
        "id": "66a62339.6b1cc4",
        "type": "file in",
        "z": "68347deb.b93a34",
        "name": "",
        "filename": "/home/pi/NRdata/global.json",
        "format": "utf8",
        "sendError": true,
        "x": 397,
        "y": 257,
        "wires": [
            [
                "e8d259d9.5ac728"
            ]
        ]
    },
    {
        "id": "8e1d0e60.1f30a",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "Restore",
        "func": "var output = [];\n\nfor (var i=0; i<msg.payload.length; i++) {\n    switch (msg.payload[i].type) {\n        case 'undefined': \n            // the global variable probably had no value, nothing needs to be restored\n            output.push(msg.payload[i].key + \" is undefined.\");\n            break;\n        case 'number':\n            if ( (msg.payload[i].value===\"NaN\") || (msg.payload[i].value===null) ) {\n                // there is no valid value to be restored, skip this variable\n                output.push(msg.payload[i].key + \" is NaN.\");\n            } else {\n                if (msg.payload[i].value.toString().indexOf(\".\")>-1) {\n                    // the value appears to be a float\n                    global.set(msg.payload[i].key,parseFloat(msg.payload[i].value));\n                    output.push(msg.payload[i].key + \" is restored to \" + msg.payload[i].value);\n                } else {\n                    global.set(msg.payload[i].key,parseInt(msg.payload[i].value));\n                    output.push(msg.payload[i].key + \" is restored to \" + msg.payload[i].value);\n                }\n            }\n            break;\n        case 'string':\n            global.set(msg.payload[i].key,msg.payload[i].value);\n            output.push(msg.payload[i].key + \" is restored to \" + msg.payload[i].value);\n            break;\n        case 'boolean':\n            global.set(msg.payload[i].key,msg.payload[i].value===\"true\");\n            output.push(msg.payload[i].key + \" is restored to \" + msg.payload[i].value);\n            break;\n    }\n}\n\nmsg.payload = output;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 256,
        "y": 379,
        "wires": [
            [
                "2ba29697.bfae62",
                "8f21b06b.adad78",
                "ec6b5db4.8eb368",
                "d24031da.22794",
                "6499d11a.301f08",
                "3ba89f95.c18e5",
                "36896a53.d9e826",
                "a68cc198.4c102",
                "e0bf91fe.611e38",
                "daed444c.ae337",
                "80188192.4391b",
                "89bac48c.03a6d",
                "4c9e928a.5cff04",
                "dcbdf519.188a98",
                "d5d2ce37.d784f8",
                "f4672c67.f75378"
            ]
        ]
    },
    {
        "id": "ca1fce2f.0a4e28",
        "type": "json",
        "z": "68347deb.b93a34",
        "name": "",
        "pretty": false,
        "x": 552.0908508300781,
        "y": 124.272705078125,
        "wires": [
            [
                "77337646.a78f5"
            ]
        ]
    },
    {
        "id": "e8d259d9.5ac728",
        "type": "json",
        "z": "68347deb.b93a34",
        "name": "",
        "x": 601.2857055664062,
        "y": 257,
        "wires": [
            [
                "8e1d0e60.1f30a"
            ]
        ]
    },
    {
        "id": "f52dc37a.11cb9",
        "type": "mqtt in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "topic": "/pwrMeter/plug1/readings",
        "qos": "1",
        "broker": "4f35fce7.f4f55c",
        "x": 290,
        "y": 100,
        "wires": [
            [
                "edb40463.b8bf78",
                "d94fe7c5.2ff8a8"
            ]
        ]
    },
    {
        "id": "edb40463.b8bf78",
        "type": "json",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "pretty": false,
        "x": 490,
        "y": 160,
        "wires": [
            [
                "4a27c2fa.685884"
            ]
        ]
    },
    {
        "id": "4a27c2fa.685884",
        "type": "link out",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Plug1dat",
        "links": [
            "38c3551d.b533ba",
            "88b0a70f.a4621",
            "b815ca16.06fa1",
            "b750d383.28f5f",
            "381b6ef2.125f7a",
            "1dfcacd9.c5d923",
            "8caccec6.dabe5",
            "887b8006.85373",
            "602f025c.df5c2c",
            "cc02aa28.4257b8",
            "a4fb53f5.ac794",
            "f6ce171.6686b68"
        ],
        "x": 598,
        "y": 161.00003051757812,
        "wires": []
    },
    {
        "id": "2ba29697.bfae62",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore relay1 state",
        "func": "msg.topic = \"relay1_state\";\nmsg.payload = global.get(\"relay1_state\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 496.0000305175781,
        "y": 426,
        "wires": [
            [
                "6d590e3c.67856"
            ]
        ]
    },
    {
        "id": "6d590e3c.67856",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_relay1",
        "links": [
            "f07ee546.ea82c",
            "dba591f4.723198",
            "4046a134.2524f8"
        ],
        "x": 639.0000305175781,
        "y": 428,
        "wires": []
    },
    {
        "id": "d6e01e0e.a3f7e",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Current",
        "func": "msg.payload = msg.payload.current;\nmsg.topic = \"Current\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 456.21087646484375,
        "y": 1201.422119140625,
        "wires": [
            [
                "5aa7e105.c369b8"
            ]
        ]
    },
    {
        "id": "88b0a70f.a4621",
        "type": "link in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "4a27c2fa.685884",
            "7f5a6a46.c4819c"
        ],
        "x": 319.2109069824219,
        "y": 1201.4220581054688,
        "wires": [
            [
                "d6e01e0e.a3f7e",
                "4cb2769c.1020b8"
            ]
        ]
    },
    {
        "id": "b7da0a63.5b2968",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Power",
        "func": "msg.payload = msg.payload.power;\nmsg.topic = \"Power\";\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Power:\" +msg.payload+ \"w\" });\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 357.59844970703125,
        "y": 912.3561401367188,
        "wires": [
            [
                "9b6453b4.b490a8",
                "d2d4dacc.659198",
                "5d79d3c7.eba19c"
            ]
        ]
    },
    {
        "id": "b750d383.28f5f",
        "type": "link in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "4a27c2fa.685884"
        ],
        "x": 258.59844970703125,
        "y": 912.3561401367188,
        "wires": [
            [
                "b7da0a63.5b2968"
            ]
        ]
    },
    {
        "id": "3cdf7cca.a2000c",
        "type": "file in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power1chart",
        "format": "utf8",
        "sendError": true,
        "x": 546.1439208984375,
        "y": 1054.7197265625,
        "wires": [
            [
                "3437fe8c.e6b5fa"
            ]
        ]
    },
    {
        "id": "49f4f1e5.b24de8",
        "type": "inject",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 380.1439208984375,
        "y": 1055.7197265625,
        "wires": [
            [
                "3cdf7cca.a2000c"
            ]
        ]
    },
    {
        "id": "3437fe8c.e6b5fa",
        "type": "json",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "x": 680.1439208984375,
        "y": 1054.7197265625,
        "wires": [
            [
                "d0dbeab5.7a0eb"
            ]
        ]
    },
    {
        "id": "9d4c135b.175018",
        "type": "file",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power1chart",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1110.0010070800781,
        "y": 1053.4697875976562,
        "wires": []
    },
    {
        "id": "a31fce48.3cd228",
        "type": "inject",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "topic": "",
        "payload": "0",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 360.04554748535156,
        "y": 434.29547119140625,
        "wires": [
            [
                "391e98c2.64ad4"
            ]
        ]
    },
    {
        "id": "9581622d.aa8f8",
        "type": "inject",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "topic": "",
        "payload": "1",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 362.04554748535156,
        "y": 489.2954406738281,
        "wires": [
            [
                "391e98c2.64ad4"
            ]
        ]
    },
    {
        "id": "1470c6ec.85a1c9",
        "type": "mqtt out",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "topic": "/pwrMeter/plug1/relay",
        "qos": "1",
        "retain": "",
        "broker": "4f35fce7.f4f55c",
        "x": 1219.0455322265625,
        "y": 447.7954406738281,
        "wires": []
    },
    {
        "id": "91b5673b.5eeab",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "State status",
        "func": "var state = msg.payload;\n\nif (state === undefined) {\n    state = '1';\n}\n\nglobal.set(msg.topic,state);\n\nmsg.payload = state;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1016.0455322265625,
        "y": 446.29547119140625,
        "wires": [
            [
                "1470c6ec.85a1c9"
            ]
        ]
    },
    {
        "id": "f07ee546.ea82c",
        "type": "link in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "6d590e3c.67856"
        ],
        "x": 443.0455322265625,
        "y": 389.29547119140625,
        "wires": [
            [
                "391e98c2.64ad4"
            ]
        ]
    },
    {
        "id": "c8bcf61a.be197",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "state changed?",
        "func": "var temp = context.get(\"last_state\");\n\nif (msg.payload === temp)\n    return;\n\ncontext.set(\"last_state\", msg.payload);\n\nif (msg.payload == \"1\")\n    msg.payload = \"1\";\nelse\n    msg.payload = \"0\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 501.0455322265625,
        "y": 538.29541015625,
        "wires": [
            [
                "391e98c2.64ad4",
                "8320718.73c221"
            ]
        ]
    },
    {
        "id": "381b6ef2.125f7a",
        "type": "link in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "4a27c2fa.685884",
            "7f5a6a46.c4819c"
        ],
        "x": 208.04554748535156,
        "y": 540.29541015625,
        "wires": [
            [
                "6a0b22a7.1035f4"
            ]
        ]
    },
    {
        "id": "8245bdb4.1bfb08",
        "type": "ui_text",
        "z": "a4b5eb1e.5dd4d8",
        "group": "d92701a0.92dba",
        "order": 2,
        "width": 0,
        "height": 0,
        "name": "Power",
        "label": "Power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 969.5009460449219,
        "y": 971.7197265625,
        "wires": []
    },
    {
        "id": "d0dbeab5.7a0eb",
        "type": "ui_chart",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Power",
        "group": "d92701a0.92dba",
        "order": 3,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 970.7510681152344,
        "y": 1021.7197875976562,
        "wires": [
            [
                "9d4c135b.175018"
            ],
            []
        ]
    },
    {
        "id": "3705cdb3.dbd7c2",
        "type": "ui_text",
        "z": "a4b5eb1e.5dd4d8",
        "group": "d92701a0.92dba",
        "order": 4,
        "width": 0,
        "height": 0,
        "name": "Current",
        "label": "Current",
        "format": "{{msg.payload}} A",
        "layout": "row-spread",
        "x": 935.1753540039062,
        "y": 1199.636474609375,
        "wires": []
    },
    {
        "id": "911bf8f.a869208",
        "type": "mqtt in",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "topic": "/pwrMeter/plug3/readings",
        "qos": "1",
        "broker": "4f35fce7.f4f55c",
        "x": 305.354248046875,
        "y": 98.5,
        "wires": [
            [
                "eca1742e.0a7f4",
                "bb72e7b7.d50a8"
            ]
        ]
    },
    {
        "id": "eca1742e.0a7f4",
        "type": "debug",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "payload",
        "x": 563.354248046875,
        "y": 100,
        "wires": []
    },
    {
        "id": "bb72e7b7.d50a8",
        "type": "json",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "pretty": false,
        "x": 254.18756103515625,
        "y": 193.33334350585938,
        "wires": [
            [
                "349c8e0a.86e3b2"
            ]
        ]
    },
    {
        "id": "349c8e0a.86e3b2",
        "type": "link out",
        "z": "2a4ee4a1.258c6c",
        "name": "Plug3dat",
        "links": [
            "62aa3b63.9205bc",
            "8a334007.d1b068",
            "9b938622.6934a8",
            "fc13024c.54e97",
            "168d945b.243c8c",
            "66cdfe67.e478a"
        ],
        "x": 367.18756103515625,
        "y": 195.3333740234375,
        "wires": []
    },
    {
        "id": "91e75561.1c57a8",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "Current",
        "func": "msg.payload = msg.payload.current;\nmsg.topic = \"Current\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 405.60430908203125,
        "y": 1162.7499389648438,
        "wires": [
            [
                "1dff20d9.5e7f87"
            ]
        ]
    },
    {
        "id": "62aa3b63.9205bc",
        "type": "link in",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "349c8e0a.86e3b2"
        ],
        "x": 274.60430908203125,
        "y": 1161.7499389648438,
        "wires": [
            [
                "91e75561.1c57a8"
            ]
        ]
    },
    {
        "id": "5fd0e5b8.e3dd44",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "Power",
        "func": "msg.payload = msg.payload.power;\nmsg.topic = \"Power\";\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Power:\" +msg.payload+ \"w\" });\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 323.354248046875,
        "y": 883.7499389648438,
        "wires": [
            [
                "e514a928.791",
                "bc7aa29f.b91948",
                "494c0474.96f3cc"
            ]
        ]
    },
    {
        "id": "8a334007.d1b068",
        "type": "link in",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "349c8e0a.86e3b2"
        ],
        "x": 224.354248046875,
        "y": 883.7499389648438,
        "wires": [
            [
                "5fd0e5b8.e3dd44"
            ]
        ]
    },
    {
        "id": "87906a3f.d4e39",
        "type": "file in",
        "z": "2a4ee4a1.258c6c",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power3chart",
        "format": "utf8",
        "sendError": true,
        "x": 486.1042175292969,
        "y": 1025.999855041504,
        "wires": [
            [
                "9fe4f6df.cae57"
            ]
        ]
    },
    {
        "id": "7d44d41.f85a82c",
        "type": "inject",
        "z": "2a4ee4a1.258c6c",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 320.1042175292969,
        "y": 1026.999855041504,
        "wires": [
            [
                "87906a3f.d4e39"
            ]
        ]
    },
    {
        "id": "9fe4f6df.cae57",
        "type": "json",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "x": 620.1042175292969,
        "y": 1025.999855041504,
        "wires": [
            [
                "c42319d.abba568"
            ]
        ]
    },
    {
        "id": "37802ac9.2eee96",
        "type": "file",
        "z": "2a4ee4a1.258c6c",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power3chart",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1048.3542785644531,
        "y": 1035.999870300293,
        "wires": []
    },
    {
        "id": "8043b6d.2760748",
        "type": "inject",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "topic": "",
        "payload": "0",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 316.104248046875,
        "y": 408.50000762939453,
        "wires": [
            [
                "f808b4e4.b3bc1"
            ]
        ]
    },
    {
        "id": "78817d12.0e4d5c",
        "type": "inject",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "topic": "",
        "payload": "1",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 318.104248046875,
        "y": 463.4999771118164,
        "wires": [
            [
                "f808b4e4.b3bc1"
            ]
        ]
    },
    {
        "id": "e76bb0a7.990af8",
        "type": "mqtt out",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "topic": "/pwrMeter/plug3/relay",
        "qos": "1",
        "retain": "",
        "broker": "4f35fce7.f4f55c",
        "x": 1220,
        "y": 420,
        "wires": []
    },
    {
        "id": "f808b4e4.b3bc1",
        "type": "ui_switch",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "label": "Relay",
        "group": "8dc84beb.c40e98",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "relay3_state",
        "style": "",
        "onvalue": "1",
        "onvalueType": "str",
        "onicon": "",
        "oncolor": "",
        "offvalue": "0",
        "offvalueType": "str",
        "officon": "",
        "offcolor": "",
        "x": 642,
        "y": 420,
        "wires": [
            [
                "e7f8383c.d12df"
            ]
        ]
    },
    {
        "id": "69cd15fd.97c654",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "State status",
        "func": "var state = msg.payload;\n\nif (state === undefined) {\n    state = '1';\n}\n\nglobal.set(msg.topic,state);\n\nmsg.payload = state;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 970,
        "y": 420,
        "wires": [
            [
                "e76bb0a7.990af8"
            ]
        ]
    },
    {
        "id": "5a9584a.720a2fc",
        "type": "link in",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "606c3c46.7ef714",
            "83e95aed.2a211"
        ],
        "x": 392.104248046875,
        "y": 369.5,
        "wires": [
            [
                "f808b4e4.b3bc1"
            ]
        ]
    },
    {
        "id": "9b938622.6934a8",
        "type": "link in",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "349c8e0a.86e3b2"
        ],
        "x": 120.35426330566406,
        "y": 512.5,
        "wires": [
            [
                "ecb6a153.8466a8"
            ]
        ]
    },
    {
        "id": "b9addeec.b57fd8",
        "type": "ui_text",
        "z": "2a4ee4a1.258c6c",
        "group": "8dc84beb.c40e98",
        "order": 2,
        "width": 0,
        "height": 0,
        "name": "Power",
        "label": "Power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 887.854248046875,
        "y": 959.4998779296875,
        "wires": []
    },
    {
        "id": "c42319d.abba568",
        "type": "ui_chart",
        "z": "2a4ee4a1.258c6c",
        "name": "Power",
        "group": "8dc84beb.c40e98",
        "order": 3,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 887.854248046875,
        "y": 1005.4998779296875,
        "wires": [
            [
                "37802ac9.2eee96"
            ],
            []
        ]
    },
    {
        "id": "c8fa56c8.535178",
        "type": "ui_text",
        "z": "2a4ee4a1.258c6c",
        "group": "8dc84beb.c40e98",
        "order": 4,
        "width": 0,
        "height": 0,
        "name": "Current",
        "label": "Current",
        "format": "{{msg.payload}} A",
        "layout": "row-spread",
        "x": 902.8542633056641,
        "y": 1166.2499084472656,
        "wires": []
    },
    {
        "id": "8f21b06b.adad78",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore relay3 state",
        "func": "msg.topic = \"relay3_state\";\nmsg.payload = global.get(\"relay3_state\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 500.35418701171875,
        "y": 655.1041870117188,
        "wires": [
            [
                "606c3c46.7ef714"
            ]
        ]
    },
    {
        "id": "606c3c46.7ef714",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_relay3",
        "links": [
            "5a9584a.720a2fc"
        ],
        "x": 657.3541870117188,
        "y": 655.1041870117188,
        "wires": []
    },
    {
        "id": "9b6453b4.b490a8",
        "type": "aggregator",
        "z": "a4b5eb1e.5dd4d8",
        "name": "10s mean",
        "topic": "Power",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 584.2481079101562,
        "y": 991.8239135742188,
        "wires": [
            [
                "967528a6.8f0848"
            ]
        ]
    },
    {
        "id": "5aa7e105.c369b8",
        "type": "aggregator",
        "z": "a4b5eb1e.5dd4d8",
        "name": "10s mean",
        "topic": "Current",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 628.2794189453125,
        "y": 1200.490478515625,
        "wires": [
            [
                "e64f1c3f.b85e58"
            ]
        ]
    },
    {
        "id": "967528a6.8f0848",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 732.9981079101562,
        "y": 994.3239135742188,
        "wires": [
            [
                "8245bdb4.1bfb08",
                "fc3f8e9a.d3c3c8",
                "d0dbeab5.7a0eb"
            ]
        ]
    },
    {
        "id": "e64f1c3f.b85e58",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 784.0294189453125,
        "y": 1199.740478515625,
        "wires": [
            [
                "3705cdb3.dbd7c2"
            ]
        ]
    },
    {
        "id": "ab899a1c.99ee6",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Plug2 webpage",
        "info": "",
        "x": 966.7093505859375,
        "y": 923.0737915039062,
        "wires": []
    },
    {
        "id": "e514a928.791",
        "type": "aggregator",
        "z": "2a4ee4a1.258c6c",
        "name": "10s mean",
        "topic": "Power",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 501.1042175292969,
        "y": 958.6040725708008,
        "wires": [
            [
                "e6aec6c9.d8024"
            ]
        ]
    },
    {
        "id": "e6aec6c9.d8024",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 649.8542175292969,
        "y": 961.1040725708008,
        "wires": [
            [
                "b9addeec.b57fd8",
                "c42319d.abba568",
                "693310c.3d6e1f"
            ]
        ]
    },
    {
        "id": "1dff20d9.5e7f87",
        "type": "aggregator",
        "z": "2a4ee4a1.258c6c",
        "name": "10s mean",
        "topic": "Current",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 576.1042633056641,
        "y": 1163.6040344238281,
        "wires": [
            [
                "9454b7c2.71f8e"
            ]
        ]
    },
    {
        "id": "9454b7c2.71f8e",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 724.8542633056641,
        "y": 1166.1040344238281,
        "wires": [
            [
                "c8fa56c8.535178"
            ]
        ]
    },
    {
        "id": "df949994.0bacb8",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Plug1 webpage",
        "info": "",
        "x": 940.3834838867188,
        "y": 1154.2293090820312,
        "wires": []
    },
    {
        "id": "2cc2f7e8.f76fd8",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "Plug3 webpage",
        "info": "",
        "x": 904.1597900390625,
        "y": 847.2152709960938,
        "wires": []
    },
    {
        "id": "26c6530d.61fbcc",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "Plug3 webpage",
        "info": "",
        "x": 906.1041412353516,
        "y": 1123.2916564941406,
        "wires": []
    },
    {
        "id": "ebaa5788.5617f",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "Plugs webpage",
        "info": "",
        "x": 898.6041870117188,
        "y": 701.7290649414062,
        "wires": []
    },
    {
        "id": "5de544ae.8e8dcc",
        "type": "file in",
        "z": "2a4ee4a1.258c6c",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power3chart1min",
        "format": "utf8",
        "sendError": true,
        "x": 484.8542022705078,
        "y": 732.9789733886719,
        "wires": [
            [
                "964be8b7.e4e558"
            ]
        ]
    },
    {
        "id": "2df0604a.35bd08",
        "type": "inject",
        "z": "2a4ee4a1.258c6c",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 318.8542022705078,
        "y": 733.9789733886719,
        "wires": [
            [
                "5de544ae.8e8dcc"
            ]
        ]
    },
    {
        "id": "964be8b7.e4e558",
        "type": "json",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "x": 618.8542022705078,
        "y": 732.9789733886719,
        "wires": [
            [
                "347ad60f.d794ca"
            ]
        ]
    },
    {
        "id": "8f00f9e2.3c02d8",
        "type": "file",
        "z": "2a4ee4a1.258c6c",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power3chart1min",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1058.3542022705078,
        "y": 734.2289123535156,
        "wires": []
    },
    {
        "id": "bc7aa29f.b91948",
        "type": "aggregator",
        "z": "2a4ee4a1.258c6c",
        "name": "1min mean",
        "topic": "Power",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 509.8542022705078,
        "y": 786.8331604003906,
        "wires": [
            [
                "3cc1a872.8c326"
            ]
        ]
    },
    {
        "id": "3cc1a872.8c326",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 648.6042022705078,
        "y": 789.3331604003906,
        "wires": [
            [
                "d1d053f2.993058",
                "347ad60f.d794ca"
            ]
        ]
    },
    {
        "id": "b0443d9f.c388d",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Plugs webpage",
        "info": "",
        "x": 962.9317932128906,
        "y": 728.1061096191406,
        "wires": []
    },
    {
        "id": "5d8c85fc.c9556c",
        "type": "file in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power1chart1min",
        "format": "utf8",
        "sendError": true,
        "x": 551.6817932128906,
        "y": 769.3560180664062,
        "wires": [
            [
                "7f72e0c7.a3e55"
            ]
        ]
    },
    {
        "id": "dba6136a.4e9cf8",
        "type": "inject",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 385.6817932128906,
        "y": 770.3560180664062,
        "wires": [
            [
                "5d8c85fc.c9556c"
            ]
        ]
    },
    {
        "id": "7f72e0c7.a3e55",
        "type": "json",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "x": 685.6817932128906,
        "y": 769.3560180664062,
        "wires": [
            [
                "4885ae51.533f58"
            ]
        ]
    },
    {
        "id": "ee786e66.c553c8",
        "type": "file",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power1chart1min",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1125.1817932128906,
        "y": 770.60595703125,
        "wires": []
    },
    {
        "id": "d2d4dacc.659198",
        "type": "aggregator",
        "z": "a4b5eb1e.5dd4d8",
        "name": "1min mean",
        "topic": "Power",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 553.8246154785156,
        "y": 826.0673522949219,
        "wires": [
            [
                "55a4c41d.8a1c1c"
            ]
        ]
    },
    {
        "id": "55a4c41d.8a1c1c",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 715.4317932128906,
        "y": 825.710205078125,
        "wires": [
            [
                "1861e982.8bfe36",
                "4885ae51.533f58"
            ]
        ]
    },
    {
        "id": "1861e982.8bfe36",
        "type": "link out",
        "z": "a4b5eb1e.5dd4d8",
        "name": "plug1_1m_avg",
        "links": [
            "93e0ba4f.cadb6",
            "e6f833bd.b545d",
            "6d57a6e7.e973",
            "83d91b4c.742a",
            "6ea0be8a.3aeb5",
            "a8b2095c.4db45"
        ],
        "x": 810.6818542480469,
        "y": 866.7369689941406,
        "wires": []
    },
    {
        "id": "74dc8e6c.8de5f",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plug1','power',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 865.1616821289062,
        "y": 1927.3380737304688,
        "wires": [
            [
                "a245d04d.b0735",
                "f5123852.7587b"
            ]
        ]
    },
    {
        "id": "a245d04d.b0735",
        "type": "sqlite",
        "z": "a4b5eb1e.5dd4d8",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 1073.9949951171875,
        "y": 1928.3380737304688,
        "wires": [
            []
        ]
    },
    {
        "id": "3688ca16.0cb8be",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Plug1 DB",
        "info": "",
        "x": 574.8131713867188,
        "y": 1765.1561889648438,
        "wires": []
    },
    {
        "id": "6d57a6e7.e973",
        "type": "link in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "1861e982.8bfe36"
        ],
        "x": 537.9950561523438,
        "y": 1977.1715698242188,
        "wires": [
            [
                "b0c98ec9.0d3038",
                "74dc8e6c.8de5f"
            ]
        ]
    },
    {
        "id": "43667753.24a628",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plug1','consumption',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 872.9950561523438,
        "y": 2049.1715698242188,
        "wires": [
            [
                "6bde7efc.81f88",
                "f5123852.7587b"
            ]
        ]
    },
    {
        "id": "6bde7efc.81f88",
        "type": "sqlite",
        "z": "a4b5eb1e.5dd4d8",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 1074.828369140625,
        "y": 2050.1715698242188,
        "wires": [
            []
        ]
    },
    {
        "id": "b0c98ec9.0d3038",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "det Wh minute",
        "func": "var last_minute = msg.payload;\n\nmsg.payload = Number((last_minute/60).toFixed(2));\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 681.9950561523438,
        "y": 2049.1715698242188,
        "wires": [
            [
                "43667753.24a628"
            ]
        ]
    },
    {
        "id": "c6d84ad6.61a9b8",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "every minute",
        "info": "",
        "x": 392.81317138671875,
        "y": 1832.9896850585938,
        "wires": []
    },
    {
        "id": "33057f2.d5daf8",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 723.7677001953125,
        "y": 1671.421630859375,
        "wires": []
    },
    {
        "id": "c6ec4655.d1166",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 696.3863525390625,
        "y": 1343.6590576171875,
        "wires": []
    },
    {
        "id": "b940d6fd.63c398",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 712.9317932128906,
        "y": 624.772705078125,
        "wires": []
    },
    {
        "id": "4a45de7f.4b0c78",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 689.5455322265625,
        "y": 258.5455017089844,
        "wires": []
    },
    {
        "id": "cf24dde.492cda",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "<==========Messages reception==========>",
        "info": "",
        "x": 696.7500305175781,
        "y": 26.49999237060547,
        "wires": []
    },
    {
        "id": "7ff7a248.49aa0c",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "<==========Relay management==========>",
        "info": "",
        "x": 682.0455322265625,
        "y": 299.5455017089844,
        "wires": []
    },
    {
        "id": "837326dd.d54288",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "<==========Power chart and current ==========>",
        "info": "",
        "x": 728.1817932128906,
        "y": 668.522705078125,
        "wires": []
    },
    {
        "id": "da797907.4a168",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "<==========Consumption and cost==========>",
        "info": "",
        "x": 690,
        "y": 1380,
        "wires": []
    },
    {
        "id": "a4c352e6.cdd94",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "<==========Database==========>",
        "info": "",
        "x": 690.5177001953125,
        "y": 1709.671630859375,
        "wires": []
    },
    {
        "id": "4dc5b263.51963c",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "<==========Messages reception==========>",
        "info": "",
        "x": 632.5,
        "y": 32.5,
        "wires": []
    },
    {
        "id": "184fd7ba.d08068",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 636.25,
        "y": 250,
        "wires": []
    },
    {
        "id": "f4526167.bae41",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "<==========Relay management==========>",
        "info": "",
        "x": 628.75,
        "y": 291,
        "wires": []
    },
    {
        "id": "f9c1c2ee.e11068",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 638.75,
        "y": 578.75,
        "wires": []
    },
    {
        "id": "4a17f09c.52c18",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "<==========Power chart and current ==========>",
        "info": "",
        "x": 628.75,
        "y": 622.5,
        "wires": []
    },
    {
        "id": "d1d053f2.993058",
        "type": "link out",
        "z": "2a4ee4a1.258c6c",
        "name": "plug3_1m_avg",
        "links": [
            "e917f7ad.64745",
            "1321e3f.343989c"
        ],
        "x": 735,
        "y": 838.75,
        "wires": []
    },
    {
        "id": "d108511a.4c8a1",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 651.25,
        "y": 1232.5,
        "wires": []
    },
    {
        "id": "36e1991e.b7b886",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "Plug3 energy consumption today",
        "info": "",
        "x": 551.25,
        "y": 1356.25,
        "wires": []
    },
    {
        "id": "e917f7ad.64745",
        "type": "link in",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "d1d053f2.993058"
        ],
        "x": 193.6072998046875,
        "y": 1402.9638671875,
        "wires": [
            [
                "cb90e383.babaa8"
            ]
        ]
    },
    {
        "id": "5eaee7e7.552c48",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "det Wh Day",
        "func": "var consumption = global.get(\"plug3_t_c\");\nvar last_m_date = global.get(\"plug3_t_d\");\n\nvar last_minute = msg.payload;\nvar atual_m_date = 0;\n\nif ( (consumption===\"NaN\") || (!consumption) ) \n    consumption = 0;\n\n//det date timestamp\nvar now     = new Date(); \nvar year    = now.getFullYear();\nvar month   = now.getMonth()+1; \nvar day     = now.getDate();\n\nif(month.toString().length == 1) {\nvar month = '0'+month;\n}\nif(day.toString().length == 1) {\nvar day = '0'+day;\n} \n\nmsg.timestamp = year+'-'+month+'-'+day;\nvar atual_m_date = msg.timestamp;\n\n//check if day has passed\nif (last_m_date === undefined) {\n    last_m_date = atual_m_date;\n    global.set(\"plug3_t_d\",last_m_date);\n}else{\n    //check if day is over to restart counting\n    if (last_m_date !== atual_m_date) {\n        consumption = 0;\n        global.set(\"plug3_t_d\",atual_m_date);\n    }\n}\n\n//calculate power consumption\nif (consumption === undefined) {\n    consumption = last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plug3_t_c\",consumption);\n}else{\n    consumption += last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plug3_t_c\",consumption);\n}\n\nmsg.payload = consumption;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 484.4644775390625,
        "y": 1399.9639282226562,
        "wires": [
            [
                "195f72c1.ee47f5",
                "e4c47808.5ad568"
            ]
        ]
    },
    {
        "id": "5ee97ccd.204ebc",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 630.5713500976562,
        "y": 1597.8928833007812,
        "wires": []
    },
    {
        "id": "cb27b092.5b50f8",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "<==========Consumption and cost==========>",
        "info": "",
        "x": 574.8213500976562,
        "y": 1271.1428833007812,
        "wires": []
    },
    {
        "id": "c367ad00.453cb8",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "<==========Database==========>",
        "info": "",
        "x": 597.3213500976562,
        "y": 1636.1428833007812,
        "wires": []
    },
    {
        "id": "45dc5d52.fef0f4",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "Plug3 DB",
        "info": "",
        "x": 437,
        "y": 1690.2501220703125,
        "wires": []
    },
    {
        "id": "1321e3f.343989c",
        "type": "link in",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "d1d053f2.993058"
        ],
        "x": 400,
        "y": 1963.08349609375,
        "wires": [
            [
                "9831c0d0.3bd298",
                "cc047e2d.021308"
            ]
        ]
    },
    {
        "id": "15498755.445a61",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plug3','consumption',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 733,
        "y": 1962.08349609375,
        "wires": [
            [
                "f34bfbdb.b80118"
            ]
        ]
    },
    {
        "id": "f34bfbdb.b80118",
        "type": "sqlite",
        "z": "2a4ee4a1.258c6c",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 942.3333740234375,
        "y": 1959.3334350585938,
        "wires": [
            []
        ]
    },
    {
        "id": "9831c0d0.3bd298",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "det Wh minute",
        "func": "var last_minute = msg.payload;\n\nmsg.payload = Number((last_minute/60).toFixed(2));\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 542,
        "y": 1962.08349609375,
        "wires": [
            [
                "15498755.445a61"
            ]
        ]
    },
    {
        "id": "d42e61f4.57f1e",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "every second",
        "info": "",
        "x": 261,
        "y": 1754.0836181640625,
        "wires": []
    },
    {
        "id": "e2cbc93c.a64958",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "every minute",
        "info": "",
        "x": 260,
        "y": 1830.0836181640625,
        "wires": []
    },
    {
        "id": "24431ce8.66b66c",
        "type": "mqtt in",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "topic": "/pwrMeter/plug2/readings",
        "qos": "1",
        "broker": "4f35fce7.f4f55c",
        "x": 262.75,
        "y": 94.25,
        "wires": [
            [
                "3b25a8ea.8e1e9",
                "721451a8.03eee"
            ]
        ]
    },
    {
        "id": "3b25a8ea.8e1e9",
        "type": "json",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "pretty": false,
        "x": 211.58331298828125,
        "y": 189.08334350585938,
        "wires": [
            [
                "2d878a6f.e60d26"
            ]
        ]
    },
    {
        "id": "2d878a6f.e60d26",
        "type": "link out",
        "z": "bbaf6eb0.1f878",
        "name": "Plug2dat",
        "links": [
            "a6d5b242.274048",
            "5bbb5b5f.38d094",
            "7124349c.e71364",
            "79c840cc.b15b6",
            "fa64fa2a.5cc63",
            "b5d551d3.f06d8",
            "ac42d531.ae197",
            "9c01f7a9.c3b4e"
        ],
        "x": 324.58331298828125,
        "y": 191.0833740234375,
        "wires": []
    },
    {
        "id": "55953e68.5a104",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "<==========Messages reception==========>",
        "info": "",
        "x": 557.75,
        "y": 32.25,
        "wires": []
    },
    {
        "id": "20d4dd0.f35e124",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 592.2499847412109,
        "y": 249,
        "wires": []
    },
    {
        "id": "7ae8eb2e.f2df54",
        "type": "mqtt out",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "topic": "/pwrMeter/plug2/relay",
        "qos": "1",
        "retain": "",
        "broker": "4f35fce7.f4f55c",
        "x": 1099,
        "y": 382,
        "wires": []
    },
    {
        "id": "61ece7d2.e0755",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "State status",
        "func": "var state = msg.payload;\n\nif (state === undefined) {\n    state = '1';\n}\n\nglobal.set(msg.topic,state);\n\nmsg.payload = state;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 896,
        "y": 380.5000305175781,
        "wires": [
            [
                "7ae8eb2e.f2df54"
            ]
        ]
    },
    {
        "id": "9090c3aa.bfaf2",
        "type": "link in",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "d525871b.3dde5"
        ],
        "x": 352.166748046875,
        "y": 369.1666564941406,
        "wires": [
            [
                "3a703e97.f6496a"
            ]
        ]
    },
    {
        "id": "a6d5b242.274048",
        "type": "link in",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "2d878a6f.e60d26"
        ],
        "x": 78.16670227050781,
        "y": 520.1666259765625,
        "wires": [
            [
                "f285f394.36e7a8"
            ]
        ]
    },
    {
        "id": "725446be.932f98",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "<==========Relay management==========>",
        "info": "",
        "x": 570.1666870117188,
        "y": 287.4166564941406,
        "wires": []
    },
    {
        "id": "ec6b5db4.8eb368",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore relay2 state",
        "func": "msg.topic = \"relay2_state\";\nmsg.payload = global.get(\"relay2_state\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 508.16668701171875,
        "y": 543.1666870117188,
        "wires": [
            [
                "d525871b.3dde5"
            ]
        ]
    },
    {
        "id": "d525871b.3dde5",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_relay2",
        "links": [
            "9090c3aa.bfaf2"
        ],
        "x": 654.1666870117188,
        "y": 542.1666870117188,
        "wires": []
    },
    {
        "id": "afe66635.95ee1",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "Current",
        "func": "msg.payload = msg.payload.current;\nmsg.topic = \"Current\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 363.0952453613281,
        "y": 1230.2380981445312,
        "wires": [
            [
                "6a6c8b6f.f467c4"
            ]
        ]
    },
    {
        "id": "7124349c.e71364",
        "type": "link in",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "2d878a6f.e60d26"
        ],
        "x": 232.09524536132812,
        "y": 1229.2380981445312,
        "wires": [
            [
                "afe66635.95ee1"
            ]
        ]
    },
    {
        "id": "67a1e79d.b07a7",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "Power",
        "func": "msg.payload = msg.payload.power;\nmsg.topic = \"Power\";\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Power:\" +msg.payload+ \"w\" });\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 274.1191711425781,
        "y": 896.5358276367188,
        "wires": [
            [
                "b68b3a79.143828",
                "7e54a347.1ab7d4",
                "c67758d0.144f78"
            ]
        ]
    },
    {
        "id": "5bbb5b5f.38d094",
        "type": "link in",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "2d878a6f.e60d26"
        ],
        "x": 135,
        "y": 897,
        "wires": [
            [
                "67a1e79d.b07a7"
            ]
        ]
    },
    {
        "id": "efcf0a27.9294e",
        "type": "file in",
        "z": "bbaf6eb0.1f878",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power2chart",
        "format": "utf8",
        "sendError": true,
        "x": 458.1191711425781,
        "y": 1082.5357666015625,
        "wires": [
            [
                "c6019a73.6b9008"
            ]
        ]
    },
    {
        "id": "c656bebe.0a1748",
        "type": "inject",
        "z": "bbaf6eb0.1f878",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 292.1191711425781,
        "y": 1083.5357666015625,
        "wires": [
            [
                "efcf0a27.9294e"
            ]
        ]
    },
    {
        "id": "c6019a73.6b9008",
        "type": "json",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "x": 592.1191711425781,
        "y": 1082.5357666015625,
        "wires": [
            [
                "6e51b8c5.3ae2b8"
            ]
        ]
    },
    {
        "id": "1d590da8.caccf2",
        "type": "file",
        "z": "bbaf6eb0.1f878",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power2chart",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1021.9762573242188,
        "y": 1081.2858276367188,
        "wires": []
    },
    {
        "id": "9d930c92.0ef36",
        "type": "ui_text",
        "z": "bbaf6eb0.1f878",
        "group": "dee9af7d.49a6c8",
        "order": 2,
        "width": 0,
        "height": 0,
        "name": "Power",
        "label": "Power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 886.4762573242188,
        "y": 998.5357666015625,
        "wires": []
    },
    {
        "id": "6e51b8c5.3ae2b8",
        "type": "ui_chart",
        "z": "bbaf6eb0.1f878",
        "name": "Power",
        "group": "dee9af7d.49a6c8",
        "order": 3,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 882.726318359375,
        "y": 1049.5358276367188,
        "wires": [
            [
                "1d590da8.caccf2"
            ],
            []
        ]
    },
    {
        "id": "87763289.277fc",
        "type": "ui_text",
        "z": "bbaf6eb0.1f878",
        "group": "dee9af7d.49a6c8",
        "order": 4,
        "width": 0,
        "height": 0,
        "name": "Current",
        "label": "Current",
        "format": "{{msg.payload}} A",
        "layout": "row-spread",
        "x": 855.0596923828125,
        "y": 1232.4524536132812,
        "wires": []
    },
    {
        "id": "b68b3a79.143828",
        "type": "aggregator",
        "z": "bbaf6eb0.1f878",
        "name": "10s mean",
        "topic": "Power",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 496.2233581542969,
        "y": 1019.6399536132812,
        "wires": [
            [
                "9d7b1ee1.a15c8"
            ]
        ]
    },
    {
        "id": "6a6c8b6f.f467c4",
        "type": "aggregator",
        "z": "bbaf6eb0.1f878",
        "name": "10s mean",
        "topic": "Current",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 540,
        "y": 1240,
        "wires": [
            [
                "3a2158e9.c8066"
            ]
        ]
    },
    {
        "id": "9d7b1ee1.a15c8",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 644.9733581542969,
        "y": 1022.1399536132812,
        "wires": [
            [
                "9d930c92.0ef36",
                "6e51b8c5.3ae2b8",
                "5d2088d0.4dc85"
            ]
        ]
    },
    {
        "id": "3a2158e9.c8066",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 689.913818359375,
        "y": 1230.556640625,
        "wires": [
            [
                "87763289.277fc"
            ]
        ]
    },
    {
        "id": "2b4d16db.e562fa",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "Plug1 webpage",
        "info": "",
        "x": 884.9345703125,
        "y": 955.8898315429688,
        "wires": []
    },
    {
        "id": "a22a9209.d9496",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "Plug1 webpage",
        "info": "",
        "x": 853.267822265625,
        "y": 1175.6817016601562,
        "wires": []
    },
    {
        "id": "c69a5c24.ae4b8",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "Plugs webpage",
        "info": "",
        "x": 879.4525146484375,
        "y": 712.2857971191406,
        "wires": []
    },
    {
        "id": "cce7ef8.efc059",
        "type": "file in",
        "z": "bbaf6eb0.1f878",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power2chart1min",
        "format": "utf8",
        "sendError": true,
        "x": 468.2025146484375,
        "y": 753.5357055664062,
        "wires": [
            [
                "a16fea15.432d28"
            ]
        ]
    },
    {
        "id": "5a04d1e7.2df58",
        "type": "inject",
        "z": "bbaf6eb0.1f878",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 302.2025146484375,
        "y": 754.5357055664062,
        "wires": [
            [
                "cce7ef8.efc059"
            ]
        ]
    },
    {
        "id": "a16fea15.432d28",
        "type": "json",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "pretty": false,
        "x": 602.2025146484375,
        "y": 753.5357055664062,
        "wires": [
            [
                "2e80c328.9ead4c"
            ]
        ]
    },
    {
        "id": "1383fff8.577d28",
        "type": "file",
        "z": "bbaf6eb0.1f878",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power2chart1min",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1041.7025146484375,
        "y": 754.78564453125,
        "wires": []
    },
    {
        "id": "7e54a347.1ab7d4",
        "type": "aggregator",
        "z": "bbaf6eb0.1f878",
        "name": "1min mean",
        "topic": "Power",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 470.3453369140625,
        "y": 810.2470397949219,
        "wires": [
            [
                "700b8751.09578"
            ]
        ]
    },
    {
        "id": "700b8751.09578",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 623.9525146484375,
        "y": 810.889892578125,
        "wires": [
            [
                "8d5ccb4b.2be008",
                "2e80c328.9ead4c"
            ]
        ]
    },
    {
        "id": "8d5ccb4b.2be008",
        "type": "link out",
        "z": "bbaf6eb0.1f878",
        "name": "plug2_1m_avg",
        "links": [
            "298509fe.be6586",
            "9fcf14d1.5c7a3"
        ],
        "x": 727.2025756835938,
        "y": 850.9166564941406,
        "wires": []
    },
    {
        "id": "7583375d.7d6f5",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 629.4525146484375,
        "y": 608.952392578125,
        "wires": []
    },
    {
        "id": "4ea77d2c.88b194",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "<==========Power chart and current ==========>",
        "info": "",
        "x": 644.7025146484375,
        "y": 652.702392578125,
        "wires": []
    },
    {
        "id": "8ab021c2.8c2a5",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 632.7083740234375,
        "y": 1283.9583740234375,
        "wires": []
    },
    {
        "id": "9333d305.e2db08",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "Plug energy consumption today",
        "info": "",
        "x": 566.4583740234375,
        "y": 1408.9583740234375,
        "wires": []
    },
    {
        "id": "298509fe.be6586",
        "type": "link in",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "8d5ccb4b.2be008"
        ],
        "x": 193.815673828125,
        "y": 1453.67236328125,
        "wires": [
            [
                "a37c26eb.62a798"
            ]
        ]
    },
    {
        "id": "180e5a93.63d955",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "det Wh Day",
        "func": "var consumption = global.get(\"plug2_t_c\");\nvar last_m_date = global.get(\"plug2_t_d\");\n\nvar last_minute = msg.payload;\nvar atual_m_date = 0;\n\nif ( (consumption===\"NaN\") || (!consumption) ) \n    consumption = 0;\n\n//det date timestamp\nvar now     = new Date(); \nvar year    = now.getFullYear();\nvar month   = now.getMonth()+1; \nvar day     = now.getDate();\n\nif(month.toString().length == 1) {\nvar month = '0'+month;\n}\nif(day.toString().length == 1) {\nvar day = '0'+day;\n} \n\nmsg.timestamp = year+'-'+month+'-'+day;\nvar atual_m_date = msg.timestamp;\n\n//check if day has passed\nif (last_m_date === undefined) {\n    last_m_date = atual_m_date;\n    global.set(\"plug2_t_d\",last_m_date);\n}else{\n    //check if day is over to restart counting\n    if (last_m_date !== atual_m_date) {\n        consumption = 0;\n        global.set(\"plug2_t_d\",atual_m_date);\n    }\n}\n\n//calculate power consumption\nif (consumption === undefined) {\n    consumption = last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plug2_t_c\",consumption);\n}else{\n    consumption += last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plug2_t_c\",consumption);\n}\n\nmsg.payload = consumption;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 499.6728515625,
        "y": 1452.6723022460938,
        "wires": [
            [
                "89c7ed08.984a4",
                "3572c416.655cac"
            ]
        ]
    },
    {
        "id": "f058e5aa.4ea1c8",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "<==========Consumption and cost==========>",
        "info": "",
        "x": 590.0297241210938,
        "y": 1323.8512573242188,
        "wires": []
    },
    {
        "id": "8f303e87.ea52b",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 651.4583740234375,
        "y": 2028.958251953125,
        "wires": []
    },
    {
        "id": "6a623a74.c8fbc4",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "Plug2 DB",
        "info": "",
        "x": 473.54168701171875,
        "y": 2170.4583740234375,
        "wires": []
    },
    {
        "id": "9fcf14d1.5c7a3",
        "type": "link in",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "8d5ccb4b.2be008"
        ],
        "x": 428.54168701171875,
        "y": 2395.2919921875,
        "wires": [
            [
                "8a88c2fe.23e748",
                "da402cdd.cd2e28"
            ]
        ]
    },
    {
        "id": "b767e4fd.11c818",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plug2','consumption',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 761.5416870117188,
        "y": 2394.2919921875,
        "wires": [
            [
                "bcf788a4.5e0bf"
            ]
        ]
    },
    {
        "id": "bcf788a4.5e0bf",
        "type": "sqlite",
        "z": "bbaf6eb0.1f878",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 963.375,
        "y": 2395.2919921875,
        "wires": [
            []
        ]
    },
    {
        "id": "8a88c2fe.23e748",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "det Wh minute",
        "func": "var last_minute = msg.payload;\n\nmsg.payload = Number((last_minute/60).toFixed(2));\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 570.5416870117188,
        "y": 2394.2919921875,
        "wires": [
            [
                "b767e4fd.11c818"
            ]
        ]
    },
    {
        "id": "7b094203.ff226c",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "every minute",
        "info": "",
        "x": 296.54168701171875,
        "y": 2310.2918701171875,
        "wires": []
    },
    {
        "id": "6fa179f3.42e66",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "<==========Database==========>",
        "info": "",
        "x": 583.7916259765625,
        "y": 2066.7918701171875,
        "wires": []
    },
    {
        "id": "d24031da.22794",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore relay1 name",
        "func": "msg.topic = \"plug1_name\";\nmsg.payload = global.get(\"plug1_name\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 503.9583740234375,
        "y": 378.45831298828125,
        "wires": [
            [
                "6778d345.69b6c4"
            ]
        ]
    },
    {
        "id": "6778d345.69b6c4",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_name1",
        "links": [
            "3313b79e.7e3e38"
        ],
        "x": 639.9583740234375,
        "y": 377.45831298828125,
        "wires": []
    },
    {
        "id": "6499d11a.301f08",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore  plug2 name",
        "func": "msg.topic = \"plug2_name\";\nmsg.payload = global.get(\"plug2_name\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 519,
        "y": 501,
        "wires": [
            [
                "2272dd6a.11814a"
            ]
        ]
    },
    {
        "id": "2272dd6a.11814a",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_name2",
        "links": [
            "f16e6d73.d202c8",
            "3877d400.d35534"
        ],
        "x": 655,
        "y": 500,
        "wires": []
    },
    {
        "id": "3ba89f95.c18e5",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore plug3 name",
        "func": "msg.topic = \"plug3_name\";\nmsg.payload = global.get(\"plug3_name\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 510,
        "y": 613,
        "wires": [
            [
                "6c165bac.c4f39c"
            ]
        ]
    },
    {
        "id": "6c165bac.c4f39c",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_name3",
        "links": [
            "6dd6c4dc.6db334",
            "a15ce72f.994578"
        ],
        "x": 657,
        "y": 615,
        "wires": []
    },
    {
        "id": "7d2968b6.ec1bc8",
        "type": "function",
        "z": "f512852c.8ffbe8",
        "name": "SQL",
        "func": "// This will handle any device and any attribute as long as it is in the DB\nvar p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\nvar sql = [];\nvar sourcelist = [];\nvar aggrlist = [];\nvar title = \"\";\n\n\n// Get the period and the list of data sources \n// also set some default values if one or the other does not exist yet\nsourcelist = context.get(\"sourcelist\");\nif (sourcelist===undefined) { // if running for the first time\n    sourcelist = [];\n}\nfromdate = context.get(\"fromdate\");\nif (fromdate===undefined) {\n    // set the period to a default if it is not selected yet\n    fromdate = current-p_1d;\n}\nenddate = context.get(\"enddate\");\nif (enddate===undefined) {\n    // set the period to a default if it is not selected yet\n    enddate = current;\n}\n\nswitch(msg.topic) {\n    case \"period\":\n        switch(msg.payload) {\n            case \"today\":\n                fromdate = today0h;\n                enddate = today0h+p_1d;\n                break;\n            case \"yesterday\":\n                fromdate = today0h-p_1d;\n                enddate = today0h;\n                break;\n            case \"thisweek\":\n                fromdate = monday0h;\n                enddate = monday0h+p_7d;\n                break;\n            case \"lastweek\":\n                fromdate = monday0h-p_7d;\n                enddate = monday0h;\n                break;\n            case \"last24h\":\n                fromdate = current-p_1d;\n                enddate = current;\n                break;\n            case \"last7d\":\n                fromdate = current-p_7d;\n                enddate = current;\n                break;\n            case \"last30d\":\n                fromdate = current-p_30d;\n                enddate = current;\n                break;\n            case \"last365d\":\n                fromdate = current-p_365d;\n                enddate = current;\n                break;\n        }\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"datasource\":\n        if (msg.payload===\"delete\") {\n            // remove all previous data sources\n            sourcelist = [];\n        } else {\n            sourcelist = context.get(\"sourcelist\");\n            if (sourcelist===undefined) { // if running for the first time\n                sourcelist = [];\n            }\n            sourcelist.push(msg.payload);\n        }\n        context.set(\"sourcelist\",sourcelist);\n        break;\n    case \"minus1w\":\n        fromdate = fromdate-p_7d;\n        enddate = enddate-p_7d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"plus1w\":\n        fromdate = fromdate+p_7d;\n        enddate = enddate+p_7d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"minus1d\":\n        fromdate = fromdate-p_1d;\n        enddate = enddate-p_1d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"plus1d\":\n        fromdate = fromdate+p_1d;\n        enddate = enddate+p_1d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"minus1m\":\n        fromdate = fromdate-30*p_1d;\n        enddate = enddate-30*p_1d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"plus1m\":\n        fromdate = fromdate+30*p_1d;\n        enddate = enddate+30*p_1d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n}\n\n\n// Regenerate the SQL statements\n// Run through the data source list an generate the SQL statements\nsql = [];\nif (sourcelist.length>0) {\n    for (var i = 0; i < sourcelist.length; i++) {\n        var parts = sourcelist[i].split(\"/\");\n        sql.push({ topic: \"SELECT * FROM sensor_data WHERE device='\"+parts[0]+\"' AND sensor='\"+parts[1]+\"' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n    }\n} \nif (sql.length===0) {    \n    // Dummy select that returns nothing to clear the chart\n    sql.push({ topic: \"SELECT * FROM sensor_data WHERE device='xxxx'\" });\n}\n\n// set the completed flag for the join node later\nsql[sql.length-1].complete=true;\n// pass along the email flag to redirect the flow later\nif (msg.topic===\"email\") {\n    sql[sql.length-1].email=true;\n}\n\n// Generate report title\nif (sourcelist.length===0 && aggrlist.length===0) {\n    title = \"No data source\";\n} else {\n    if (sourcelist.length!==0) {\n        title = title + sourcelist.toString()+ \", \";\n    }\n    if (aggrlist.length!==0) {\n        title = title + aggrlist.toString()+ \", \";\n    }\n    title = title.substring(0,title.length-2);\n    title = title + \" | \";\n\n    var d = new Date();\n    d.setTime(fromdate);\n    var yyyy = d.getFullYear();\n    var mm = d.getMonth() < 9 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1); // getMonth() is zero-based\n    var dd  = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate();\n    var hh = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\n    var mmm  = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n    var ss  = d.getSeconds() < 10 ? \"0\" + d.getSeconds() : d.getSeconds();\n    title = title + dd + \".\" + mm + \".\" + yyyy;\n    d.setTime(enddate);\n    yyyy = d.getFullYear();\n    mm = d.getMonth() < 9 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1); // getMonth() is zero-based\n    dd  = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate();\n    hh = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\n    mmm  = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n    ss  = d.getSeconds() < 10 ? \"0\" + d.getSeconds() : d.getSeconds();\n    title = title + \" - \" + dd + \".\" + mm + \".\" + yyyy;\n}\nsql[sql.length-1].title=title;\n\nreturn [ sql ];\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 362,
        "y": 392.25,
        "wires": [
            [
                "29126346.6d251c"
            ]
        ]
    },
    {
        "id": "29126346.6d251c",
        "type": "sqlite",
        "z": "f512852c.8ffbe8",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 502,
        "y": 392.25,
        "wires": [
            [
                "d3f18f4b.72e2c"
            ]
        ]
    },
    {
        "id": "1072f2fb.821145",
        "type": "ui_chart",
        "z": "f512852c.8ffbe8",
        "name": "Chart",
        "group": "8bf48dbe.d2725",
        "order": 2,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "dd HH:mm",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": "1",
        "removeOlderPoints": "",
        "removeOlderUnit": "604800",
        "cutout": "",
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 1370,
        "y": 440,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "4594e54e.4749dc",
        "type": "function",
        "z": "f512852c.8ffbe8",
        "name": "Chart Prep",
        "func": "var msg2 = [];\n\nif (msg.payload[0].length>0) {\n    // this is the logic when there are multiple data sets are received\n    for (var i=0; i<msg.payload.length; i++) {\n        var output = [];\n        for (var j=0; j<msg.payload[i].length; j++) {\n            output.push([msg.payload[i][j].epoch, msg.payload[i][j].value]);\n        }\n        msg2.push({ key: msg.payload[i][0].device+\"/\"+msg.payload[i][0].sensor, values : output});\n        //msg2.push({ key: \"test\", values : output});\n    }\n} \n\nmsg.payload=msg2;\n//msg.payload = [ { key: \"Power\", values : output} ];\n//msg.topic = \"Power\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1197.1667175292969,
        "y": 440.3333740234375,
        "wires": [
            [
                "1072f2fb.821145"
            ]
        ]
    },
    {
        "id": "b60d9d43.c6a9f8",
        "type": "inject",
        "z": "f512852c.8ffbe8",
        "name": "Reset chart",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 930,
        "y": 560,
        "wires": [
            [
                "e7ee27b4.bccc88"
            ]
        ]
    },
    {
        "id": "e7ee27b4.bccc88",
        "type": "function",
        "z": "f512852c.8ffbe8",
        "name": "Empty payload",
        "func": "msg.payload = [];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1160,
        "y": 560,
        "wires": [
            [
                "1072f2fb.821145"
            ]
        ]
    },
    {
        "id": "d3f18f4b.72e2c",
        "type": "join",
        "z": "f512852c.8ffbe8",
        "name": "",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "",
        "count": "",
        "x": 910,
        "y": 380,
        "wires": [
            [
                "a46c27c5.f513b",
                "4594e54e.4749dc",
                "7662e7a4.bf6338"
            ]
        ]
    },
    {
        "id": "855d7f76.3659d8",
        "type": "ui_dropdown",
        "z": "f512852c.8ffbe8",
        "name": "Data source",
        "label": "",
        "place": "",
        "group": "7372a57c.b3cfbc",
        "order": 1,
        "width": "5",
        "height": "1",
        "passthru": false,
        "options": [
            {
                "label": "[Remove all]",
                "value": "delete",
                "type": "str"
            },
            {
                "label": "Supply voltage",
                "value": "plug0/supplyVoltage",
                "type": "str"
            },
            {
                "label": "Main current",
                "value": "plug0/current",
                "type": "str"
            },
            {
                "label": "Plug0 real power",
                "value": "plug0/realPower",
                "type": "str"
            },
            {
                "label": "Plug0 apparent power",
                "value": "plug0/apparentPower",
                "type": "str"
            },
            {
                "label": "Plug0 power factor",
                "value": "plug0/powerFactor",
                "type": "str"
            },
            {
                "label": "Solar power",
                "value": "solar/power",
                "type": "str"
            },
            {
                "label": "Solar production",
                "value": "solar/production",
                "type": "str"
            },
            {
                "label": "Plug1 power",
                "value": "plug1/power",
                "type": "str"
            },
            {
                "label": "Plug1 relay",
                "value": "plug1/relay",
                "type": "str"
            },
            {
                "label": "Plug0 consumption",
                "value": "plug0/consumption",
                "type": "str"
            },
            {
                "label": "Plug1 consumption",
                "value": "plug1/consumption",
                "type": "str"
            },
            {
                "label": "Plug2 power",
                "value": "plug2/power",
                "type": "str"
            },
            {
                "label": "Plug2 relay",
                "value": "plug2/relay",
                "type": "str"
            },
            {
                "label": "Plug2 consumption",
                "value": "plug2/consumption",
                "type": "str"
            },
            {
                "label": "Plug3 power",
                "value": "plug3/power",
                "type": "str"
            },
            {
                "label": "Plug3 relay",
                "value": "plug3/relay",
                "type": "str"
            },
            {
                "label": "Plug3 consumption",
                "value": "plug3/consumption",
                "type": "str"
            },
            {
                "label": "PlugA real power",
                "value": "plugA/realPower",
                "type": "str"
            },
            {
                "label": "PlugA consumption",
                "value": "plugA/consumption",
                "type": "str"
            },
            {
                "label": "PlugA apparent power",
                "value": "plugA/apparentPower",
                "type": "str"
            },
            {
                "label": "PlugA power factor",
                "value": "plugA/powerFactor",
                "type": "str"
            },
            {
                "label": "PlugB real power",
                "value": "plugB/realPower",
                "type": "str"
            },
            {
                "label": "PlugB consumption",
                "value": "plugB/consumption",
                "type": "str"
            },
            {
                "label": "PlugB apparent power",
                "value": "plugB/apparentPower",
                "type": "str"
            },
            {
                "label": "PlugB power factor",
                "value": "plugB/powerFactor",
                "type": "str"
            },
            {
                "label": "Plug4 real power",
                "value": "plug4/power",
                "type": "str"
            },
            {
                "label": "Plug4 relay",
                "value": "plug4/relay",
                "type": "str"
            },
            {
                "label": "Plug4 consumption",
                "value": "plug4/consumption",
                "type": "str"
            },
            {
                "label": "Plug4 voltage",
                "value": "plug4/voltage",
                "type": "str"
            },
            {
                "label": "Plug4 power factor",
                "value": "plug4/factor",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "datasource",
        "x": 544.25,
        "y": 187,
        "wires": [
            [
                "7d2968b6.ec1bc8"
            ]
        ]
    },
    {
        "id": "1396c935.483837",
        "type": "ui_dropdown",
        "z": "f512852c.8ffbe8",
        "name": "Period",
        "label": "",
        "place": "",
        "group": "7372a57c.b3cfbc",
        "order": 4,
        "width": "4",
        "height": "1",
        "passthru": false,
        "options": [
            {
                "label": "Today",
                "value": "today",
                "type": "str"
            },
            {
                "label": "Yesterday",
                "value": "yesterday",
                "type": "str"
            },
            {
                "label": "This week",
                "value": "thisweek",
                "type": "str"
            },
            {
                "label": "Last week",
                "value": "lastweek",
                "type": "str"
            },
            {
                "label": "Last 24 hours",
                "value": "last24h",
                "type": "str"
            },
            {
                "label": "Last 7 days",
                "value": "last7d",
                "type": "str"
            },
            {
                "label": "Last 30 days",
                "value": "last30d",
                "type": "str"
            },
            {
                "label": "Last 365 days",
                "value": "last365d",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "period",
        "x": 534.25,
        "y": 248,
        "wires": [
            [
                "7d2968b6.ec1bc8"
            ]
        ]
    },
    {
        "id": "4a000050.326af8",
        "type": "inject",
        "z": "f512852c.8ffbe8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 323.25,
        "y": 188,
        "wires": [
            [
                "855d7f76.3659d8",
                "1396c935.483837"
            ]
        ]
    },
    {
        "id": "53125608.a6ed7",
        "type": "ui_button",
        "z": "f512852c.8ffbe8",
        "name": "",
        "group": "7372a57c.b3cfbc",
        "order": 6,
        "width": "2",
        "height": "1",
        "label": "-1D",
        "color": "",
        "bgcolor": "",
        "icon": "chevron_left",
        "payload": "",
        "payloadType": "str",
        "topic": "minus1d",
        "x": 91.25,
        "y": 218,
        "wires": [
            [
                "927003af.57c46",
                "7d2968b6.ec1bc8"
            ]
        ]
    },
    {
        "id": "b045f06c.eabdd",
        "type": "ui_button",
        "z": "f512852c.8ffbe8",
        "name": "",
        "group": "7372a57c.b3cfbc",
        "order": 8,
        "width": "2",
        "height": "1",
        "passthru": false,
        "label": "+1W",
        "color": "",
        "bgcolor": "",
        "icon": "chevron_right",
        "payload": "",
        "payloadType": "str",
        "topic": "plus1w",
        "x": 89.25,
        "y": 293,
        "wires": [
            [
                "927003af.57c46",
                "7d2968b6.ec1bc8"
            ]
        ]
    },
    {
        "id": "57e5fd58.4d7bd4",
        "type": "ui_button",
        "z": "f512852c.8ffbe8",
        "name": "",
        "group": "7372a57c.b3cfbc",
        "order": 7,
        "width": "2",
        "height": "1",
        "label": "+1D",
        "color": "",
        "bgcolor": "",
        "icon": "chevron_right",
        "payload": "",
        "payloadType": "str",
        "topic": "plus1d",
        "x": 87.25,
        "y": 330,
        "wires": [
            [
                "927003af.57c46",
                "7d2968b6.ec1bc8"
            ]
        ]
    },
    {
        "id": "927003af.57c46",
        "type": "change",
        "z": "f512852c.8ffbe8",
        "name": "Reset",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 321.25,
        "y": 248,
        "wires": [
            [
                "1396c935.483837"
            ]
        ]
    },
    {
        "id": "a46c27c5.f513b",
        "type": "change",
        "z": "f512852c.8ffbe8",
        "name": "Title",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "title",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1213.8333206176758,
        "y": 352.75006103515625,
        "wires": [
            [
                "699c108.39a3e7"
            ]
        ]
    },
    {
        "id": "699c108.39a3e7",
        "type": "ui_text",
        "z": "f512852c.8ffbe8",
        "group": "8bf48dbe.d2725",
        "order": 1,
        "width": "0",
        "height": "0",
        "name": "Chart title",
        "label": "",
        "format": "{{msg.payload}}",
        "layout": "row-center",
        "x": 1382.8333053588867,
        "y": 353.7500514984131,
        "wires": []
    },
    {
        "id": "8268f654.49fb2",
        "type": "ui_button",
        "z": "f512852c.8ffbe8",
        "name": "",
        "group": "7372a57c.b3cfbc",
        "order": 5,
        "width": "2",
        "height": "1",
        "passthru": false,
        "label": "-1M",
        "color": "",
        "bgcolor": "",
        "icon": "chevron_left",
        "payload": "",
        "payloadType": "str",
        "topic": "minus1m",
        "x": 93,
        "y": 143,
        "wires": [
            [
                "927003af.57c46",
                "7d2968b6.ec1bc8"
            ]
        ]
    },
    {
        "id": "faadb6c4.e99fc8",
        "type": "ui_button",
        "z": "f512852c.8ffbe8",
        "name": "",
        "group": "7372a57c.b3cfbc",
        "order": 8,
        "width": "2",
        "height": "1",
        "passthru": false,
        "label": "+1M",
        "color": "",
        "bgcolor": "",
        "icon": "chevron_right",
        "payload": "",
        "payloadType": "str",
        "topic": "plus1m",
        "x": 88,
        "y": 255,
        "wires": [
            [
                "927003af.57c46",
                "7d2968b6.ec1bc8"
            ]
        ]
    },
    {
        "id": "5ecdc5aa.e9826c",
        "type": "ui_button",
        "z": "f512852c.8ffbe8",
        "name": "",
        "group": "7372a57c.b3cfbc",
        "order": 5,
        "width": "2",
        "height": "1",
        "label": "-1W",
        "color": "",
        "bgcolor": "",
        "icon": "chevron_left",
        "payload": "",
        "payloadType": "str",
        "topic": "minus1w",
        "x": 91,
        "y": 181,
        "wires": [
            [
                "927003af.57c46",
                "7d2968b6.ec1bc8"
            ]
        ]
    },
    {
        "id": "ca12d38d.6827c",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data(device,sensor,value,epoch) \" +\n        \"VALUES ('plug1','relay',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 867.4949951171875,
        "y": 1835.1715698242188,
        "wires": [
            [
                "86499363.1f6618"
            ]
        ]
    },
    {
        "id": "86499363.1f6618",
        "type": "sqlite",
        "z": "a4b5eb1e.5dd4d8",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 1070.3283081054688,
        "y": 1831.1715698242188,
        "wires": [
            []
        ]
    },
    {
        "id": "f4b19daf.d21468",
        "type": "delay",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 684.4949951171875,
        "y": 1837.1715698242188,
        "wires": [
            [
                "ca12d38d.6827c"
            ]
        ]
    },
    {
        "id": "de237351.a9b5a8",
        "type": "link out",
        "z": "a4b5eb1e.5dd4d8",
        "name": "relay1_state",
        "links": [
            "11e61038.20c5a",
            "852005f.8ce4078",
            "f1f0fe91.2bbcb"
        ],
        "x": 425.5455322265625,
        "y": 583.5455322265625,
        "wires": []
    },
    {
        "id": "11e61038.20c5a",
        "type": "link in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "de237351.a9b5a8",
            "1f5475dd.9e1382"
        ],
        "x": 538.4949951171875,
        "y": 1836.171630859375,
        "wires": [
            [
                "f4b19daf.d21468"
            ]
        ]
    },
    {
        "id": "da402cdd.cd2e28",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plug2','power',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 767,
        "y": 2308,
        "wires": [
            [
                "6eeb5eeb.f0de08"
            ]
        ]
    },
    {
        "id": "6eeb5eeb.f0de08",
        "type": "sqlite",
        "z": "bbaf6eb0.1f878",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 975.8333129882812,
        "y": 2309,
        "wires": [
            []
        ]
    },
    {
        "id": "e73c83bb.d5648",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data(device,sensor,value,epoch) \" +\n        \"VALUES ('plug2','relay',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 767.3333129882812,
        "y": 2243.83349609375,
        "wires": [
            [
                "e42d4925.74dd7"
            ]
        ]
    },
    {
        "id": "e42d4925.74dd7",
        "type": "sqlite",
        "z": "bbaf6eb0.1f878",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 970.1666259765625,
        "y": 2239.83349609375,
        "wires": [
            []
        ]
    },
    {
        "id": "da193861.312d58",
        "type": "delay",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 584.3333129882812,
        "y": 2245.83349609375,
        "wires": [
            [
                "e73c83bb.d5648"
            ]
        ]
    },
    {
        "id": "250b0fe5.203d8",
        "type": "link in",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "9bb47bb5.ee73f8"
        ],
        "x": 446.33331298828125,
        "y": 2253.83349609375,
        "wires": [
            [
                "da193861.312d58"
            ]
        ]
    },
    {
        "id": "9bb47bb5.ee73f8",
        "type": "link out",
        "z": "bbaf6eb0.1f878",
        "name": "relay2_state",
        "links": [
            "250b0fe5.203d8"
        ],
        "x": 333,
        "y": 569,
        "wires": []
    },
    {
        "id": "6cb1fb0a.80f8c4",
        "type": "link out",
        "z": "2a4ee4a1.258c6c",
        "name": "relay3_state",
        "links": [
            "11d1ca54.9b812e"
        ],
        "x": 329,
        "y": 542,
        "wires": []
    },
    {
        "id": "cc047e2d.021308",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plug3','power',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 737.5,
        "y": 1861.75,
        "wires": [
            [
                "e47cfd18.2541a8"
            ]
        ]
    },
    {
        "id": "e47cfd18.2541a8",
        "type": "sqlite",
        "z": "2a4ee4a1.258c6c",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 946.3333129882812,
        "y": 1862.75,
        "wires": [
            []
        ]
    },
    {
        "id": "ae2828e.8db2158",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data(device,sensor,value,epoch) \" +\n        \"VALUES ('plug3','relay',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 739.8333129882812,
        "y": 1769.58349609375,
        "wires": [
            [
                "b06ba233.9570a"
            ]
        ]
    },
    {
        "id": "b06ba233.9570a",
        "type": "sqlite",
        "z": "2a4ee4a1.258c6c",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 942.6666259765625,
        "y": 1765.58349609375,
        "wires": [
            []
        ]
    },
    {
        "id": "dd3bc80a.eef78",
        "type": "delay",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 556.8333129882812,
        "y": 1771.58349609375,
        "wires": [
            [
                "ae2828e.8db2158"
            ]
        ]
    },
    {
        "id": "11d1ca54.9b812e",
        "type": "link in",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "6cb1fb0a.80f8c4"
        ],
        "x": 418.83331298828125,
        "y": 1779.58349609375,
        "wires": [
            [
                "dd3bc80a.eef78"
            ]
        ]
    },
    {
        "id": "36da9d7c.24fbba",
        "type": "mqtt in",
        "z": "2cf1d395.65be64",
        "name": "",
        "topic": "/pwrMeter/plug_s/readings",
        "qos": "1",
        "broker": "4f35fce7.f4f55c",
        "x": 300.1666717529297,
        "y": 90.16666412353516,
        "wires": [
            [
                "66d9726d.b0441c",
                "70954617.eeef"
            ]
        ]
    },
    {
        "id": "66d9726d.b0441c",
        "type": "debug",
        "z": "2cf1d395.65be64",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "payload",
        "x": 943.1666870117188,
        "y": 87.66665649414062,
        "wires": []
    },
    {
        "id": "70954617.eeef",
        "type": "json",
        "z": "2cf1d395.65be64",
        "name": "",
        "pretty": false,
        "x": 522,
        "y": 179,
        "wires": [
            [
                "71854246.48025c"
            ]
        ]
    },
    {
        "id": "afe923ae.3ecf3",
        "type": "link out",
        "z": "2cf1d395.65be64",
        "name": "PlugSdat",
        "links": [
            "8ceb7831.75033",
            "4745a48e.030a94"
        ],
        "x": 827,
        "y": 178.00003051757812,
        "wires": []
    },
    {
        "id": "327bd0e2.1ad08",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "<==========Messages reception==========>",
        "info": "",
        "x": 588.1666870117188,
        "y": 27.166664123535156,
        "wires": []
    },
    {
        "id": "3d4ad1b2.c2ebae",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "Solar",
        "func": "msg.payload = msg.payload.solar;\nmsg.topic = \"Solar\";\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Power:\" +msg.payload+ \"w\" });\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 295.2083435058594,
        "y": 533.9583129882812,
        "wires": [
            [
                "f6b5194e.397ff",
                "951d2a17.2a9ef8",
                "35f44c43.6243c4"
            ]
        ]
    },
    {
        "id": "8ceb7831.75033",
        "type": "link in",
        "z": "2cf1d395.65be64",
        "name": "",
        "links": [
            "afe923ae.3ecf3"
        ],
        "x": 196.20834350585938,
        "y": 533.9583129882812,
        "wires": [
            [
                "3d4ad1b2.c2ebae"
            ]
        ]
    },
    {
        "id": "6d4e0470.021024",
        "type": "file in",
        "z": "2cf1d395.65be64",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/solarchart",
        "format": "utf8",
        "sendError": true,
        "x": 457.0006103515625,
        "y": 800.9971923828125,
        "wires": [
            [
                "6a0b7d0d.783cac"
            ]
        ]
    },
    {
        "id": "b07e8da.2c421f",
        "type": "inject",
        "z": "2cf1d395.65be64",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 291.0006103515625,
        "y": 801.9971923828125,
        "wires": [
            [
                "6d4e0470.021024"
            ]
        ]
    },
    {
        "id": "6a0b7d0d.783cac",
        "type": "json",
        "z": "2cf1d395.65be64",
        "name": "",
        "x": 591.0006103515625,
        "y": 800.9971923828125,
        "wires": [
            [
                "bcf975cd.f6b88"
            ]
        ]
    },
    {
        "id": "42e7cf39.3c5fc8",
        "type": "file",
        "z": "2cf1d395.65be64",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/solarchart",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1030,
        "y": 800,
        "wires": []
    },
    {
        "id": "64068ec4.c599e",
        "type": "ui_text",
        "z": "2cf1d395.65be64",
        "group": "9c0aaa2a.f18a08",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "Solar",
        "label": "Solar",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 885.3576965332031,
        "y": 716.9971923828125,
        "wires": []
    },
    {
        "id": "bcf975cd.f6b88",
        "type": "ui_chart",
        "z": "2cf1d395.65be64",
        "name": "Solar",
        "group": "9c0aaa2a.f18a08",
        "order": 2,
        "width": "0",
        "height": "0",
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 881.6077575683594,
        "y": 767.9972534179688,
        "wires": [
            [
                "42e7cf39.3c5fc8"
            ],
            []
        ]
    },
    {
        "id": "f6b5194e.397ff",
        "type": "aggregator",
        "z": "2cf1d395.65be64",
        "name": "10s mean",
        "topic": "Solar",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 495.10479736328125,
        "y": 738.1013793945312,
        "wires": [
            [
                "57239bf8.4ebf0c"
            ]
        ]
    },
    {
        "id": "57239bf8.4ebf0c",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 643.8547973632812,
        "y": 740.6013793945312,
        "wires": [
            [
                "64068ec4.c599e",
                "bcf975cd.f6b88",
                "ab9afd5b.68908"
            ]
        ]
    },
    {
        "id": "fe008c79.bd608",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "Solar webpage",
        "info": "",
        "x": 896.6730346679688,
        "y": 655.7798461914062,
        "wires": []
    },
    {
        "id": "ae223fce.2f7b58",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "Plugs webpage",
        "info": "",
        "x": 900.5416870117188,
        "y": 349.7082824707031,
        "wires": []
    },
    {
        "id": "ea662df3.a1cd5",
        "type": "file in",
        "z": "2cf1d395.65be64",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/solarchart1min",
        "format": "utf8",
        "sendError": true,
        "x": 489.29168701171875,
        "y": 390.95819091796875,
        "wires": [
            [
                "4754e1b1.6fa698"
            ]
        ]
    },
    {
        "id": "3795fcad.053c4c",
        "type": "inject",
        "z": "2cf1d395.65be64",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 323.29168701171875,
        "y": 391.95819091796875,
        "wires": [
            [
                "ea662df3.a1cd5"
            ]
        ]
    },
    {
        "id": "4754e1b1.6fa698",
        "type": "json",
        "z": "2cf1d395.65be64",
        "name": "",
        "x": 623.2916870117188,
        "y": 390.95819091796875,
        "wires": [
            [
                "5be3aacd.c0bbdc"
            ]
        ]
    },
    {
        "id": "33c7e2d4.3d3f66",
        "type": "file",
        "z": "2cf1d395.65be64",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/solarchart1min",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1062.7916870117188,
        "y": 392.2081298828125,
        "wires": []
    },
    {
        "id": "951d2a17.2a9ef8",
        "type": "aggregator",
        "z": "2cf1d395.65be64",
        "name": "1min mean",
        "topic": "Solar",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 491.43450927734375,
        "y": 447.6695251464844,
        "wires": [
            [
                "ca8928d4.276e2"
            ]
        ]
    },
    {
        "id": "ca8928d4.276e2",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 653.0416870117188,
        "y": 447.3123779296875,
        "wires": [
            [
                "cd54eda1.576ea",
                "5be3aacd.c0bbdc"
            ]
        ]
    },
    {
        "id": "cd54eda1.576ea",
        "type": "link out",
        "z": "2cf1d395.65be64",
        "name": "solar_1m_avg",
        "links": [
            "5faafea6.4c8658",
            "dac85505.3bfa38"
        ],
        "x": 748.291748046875,
        "y": 488.3391418457031,
        "wires": []
    },
    {
        "id": "78ffa550.0857d4",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 650.5416870117188,
        "y": 246.3748779296875,
        "wires": []
    },
    {
        "id": "bc852ec6.5a31d8",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "<==========Power chart ==========>",
        "info": "",
        "x": 625.7916870117188,
        "y": 290.1248779296875,
        "wires": []
    },
    {
        "id": "ab9afd5b.68908",
        "type": "ui_text",
        "z": "2cf1d395.65be64",
        "group": "23b45b8f.2d22b4",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Solar",
        "label": "Solar",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 882.7916870117188,
        "y": 447.8748779296875,
        "wires": []
    },
    {
        "id": "5be3aacd.c0bbdc",
        "type": "ui_chart",
        "z": "2cf1d395.65be64",
        "name": "Solar",
        "group": "23b45b8f.2d22b4",
        "order": 0,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 882.0416870117188,
        "y": 399.8749694824219,
        "wires": [
            [
                "33c7e2d4.3d3f66"
            ],
            []
        ]
    },
    {
        "id": "63c1f0c7.089238",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 634.7213745117188,
        "y": 944.1963806152344,
        "wires": []
    },
    {
        "id": "a13d1293.8b1ec8",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "<==========Poduction==========>",
        "info": "",
        "x": 590.7213745117188,
        "y": 987.6963806152344,
        "wires": []
    },
    {
        "id": "dac85505.3bfa38",
        "type": "link in",
        "z": "2cf1d395.65be64",
        "name": "",
        "links": [
            "cd54eda1.576ea"
        ],
        "x": 203.82867431640625,
        "y": 1088.5769958496094,
        "wires": [
            [
                "a258ebfb.1c7e1"
            ]
        ]
    },
    {
        "id": "c84794c6.a069a8",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "det Wh Day",
        "func": "var consumption = global.get(\"plugS_t_c\");\nvar last_m_date = global.get(\"plugS_t_d\");\n\nvar last_minute = msg.payload;\nvar atual_m_date = 0;\n\n//det date timestamp\nvar now     = new Date(); \nvar year    = now.getFullYear();\nvar month   = now.getMonth()+1; \nvar day     = now.getDate();\n\nif(month.toString().length == 1) {\nvar month = '0'+month;\n}\nif(day.toString().length == 1) {\nvar day = '0'+day;\n} \n\nmsg.timestamp = year+'-'+month+'-'+day;\nvar atual_m_date = msg.timestamp;\n\n//check if day has passed\nif (last_m_date === undefined) {\n    last_m_date = atual_m_date;\n    global.set(\"plugS_t_d\",last_m_date);\n}else{\n    //check if day is over to restart counting\n    if (last_m_date !== atual_m_date) {\n        consumption = 0;\n        global.set(\"plugS_t_d\",atual_m_date);\n    }\n}\n\n//calculate power consumption\nif (consumption === undefined) {\n    consumption = last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plugS_t_c\",consumption);\n}else{\n    consumption += last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plugS_t_c\",consumption);\n}\n\nmsg.payload = consumption;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 533.6858520507812,
        "y": 1090.5769958496094,
        "wires": [
            [
                "4d7aa21.cc283dc"
            ]
        ]
    },
    {
        "id": "7969b711.cf7f4",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "today",
        "info": "",
        "x": 487.47137451171875,
        "y": 1041.8630981445312,
        "wires": []
    },
    {
        "id": "5d6438e3.4800e",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('solar','power',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 824.0396118164062,
        "y": 1347.1697998046875,
        "wires": [
            [
                "6db968ab.36ebf"
            ]
        ]
    },
    {
        "id": "6db968ab.36ebf",
        "type": "sqlite",
        "z": "2cf1d395.65be64",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 1032.8729248046875,
        "y": 1348.1697998046875,
        "wires": [
            []
        ]
    },
    {
        "id": "5f5417c0.c11768",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "Solar DB",
        "info": "",
        "x": 530.50927734375,
        "y": 1282.8290100097656,
        "wires": []
    },
    {
        "id": "5faafea6.4c8658",
        "type": "link in",
        "z": "2cf1d395.65be64",
        "name": "",
        "links": [
            "cd54eda1.576ea"
        ],
        "x": 488.691162109375,
        "y": 1347.9123840332031,
        "wires": [
            [
                "eed62cc2.540b8",
                "5d6438e3.4800e"
            ]
        ]
    },
    {
        "id": "e0b29dbe.0750f",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('solar','production',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 829.1456909179688,
        "y": 1414.4578247070312,
        "wires": [
            [
                "2ce4d084.d7cf9"
            ]
        ]
    },
    {
        "id": "2ce4d084.d7cf9",
        "type": "sqlite",
        "z": "2cf1d395.65be64",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 1030.97900390625,
        "y": 1415.4578247070312,
        "wires": [
            []
        ]
    },
    {
        "id": "eed62cc2.540b8",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "det Wh minute",
        "func": "var last_minute = msg.payload;\n\nmsg.payload = Number((last_minute/60).toFixed(2));\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 638.1456909179688,
        "y": 1414.4578247070312,
        "wires": [
            [
                "e0b29dbe.0750f"
            ]
        ]
    },
    {
        "id": "76485644.6f72d8",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "every minute",
        "info": "",
        "x": 348.50927734375,
        "y": 1350.6625061035156,
        "wires": []
    },
    {
        "id": "2cb5784b.509668",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 658.5547485351562,
        "y": 1169.0942687988281,
        "wires": []
    },
    {
        "id": "4b2bfa44.9ccd04",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "<==========Database==========>",
        "info": "",
        "x": 625.3047485351562,
        "y": 1207.3442687988281,
        "wires": []
    },
    {
        "id": "7334985a.19dfc8",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Plug energy consumption today",
        "info": "",
        "x": 690,
        "y": 1440,
        "wires": []
    },
    {
        "id": "90bb6f0.d018a9",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "det Wh Day",
        "func": "var consumption = global.get(\"plug1_t_c\");\nvar last_m_date = global.get(\"plug1_t_d\");\n\nvar last_minute = msg.payload;\nvar atual_m_date = 0;\n\nif ( (consumption===\"NaN\") || (!consumption) ) \n    consumption = 0;\n\n//det date timestamp\nvar now     = new Date(); \nvar year    = now.getFullYear();\nvar month   = now.getMonth()+1; \nvar day     = now.getDate();\n\nif(month.toString().length == 1) {\nvar month = '0'+month;\n}\nif(day.toString().length == 1) {\nvar day = '0'+day;\n} \n\nmsg.timestamp = year+'-'+month+'-'+day;\nvar atual_m_date = msg.timestamp;\n\n//check if day has passed\nif (last_m_date === undefined) {\n    last_m_date = atual_m_date;\n    global.set(\"plug1_t_d\",last_m_date);\n}else{\n    //check if day is over to restart counting\n    if (last_m_date !== atual_m_date) {\n        consumption = 0;\n        global.set(\"plug1_t_d\",atual_m_date);\n    }\n}\n\n//calculate power consumption\nif (consumption === undefined) {\n    consumption = last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plug1_t_c\",consumption);\n}else{\n    consumption += last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plug1_t_c\",consumption);\n}\n\nmsg.payload = consumption;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 1500,
        "wires": [
            [
                "377d34f0.994c14",
                "af291191.93fa5"
            ]
        ]
    },
    {
        "id": "38865256.5af806",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "func": "var consumption = msg.payload/60;\nmsg.payload = Number((consumption).toFixed(2));\n\nif ( (msg.payload===\"NaN\") || !(msg.payload) ) \n    return;\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 390,
        "y": 1500,
        "wires": [
            [
                "90bb6f0.d018a9"
            ]
        ]
    },
    {
        "id": "a8b2095c.4db45",
        "type": "link in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "1861e982.8bfe36"
        ],
        "x": 255,
        "y": 1500,
        "wires": [
            [
                "38865256.5af806"
            ]
        ]
    },
    {
        "id": "a37c26eb.62a798",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "func": "var consumption = msg.payload/60;\nmsg.payload = Number((consumption).toFixed(2));\n\nif ( (msg.payload===\"NaN\") || !(msg.payload) ) \n    return;\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 304.75,
        "y": 1451.75,
        "wires": [
            [
                "180e5a93.63d955"
            ]
        ]
    },
    {
        "id": "cb90e383.babaa8",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "func": "var consumption = msg.payload/60;\nmsg.payload = Number((consumption).toFixed(2));\n\nif ( (msg.payload===\"NaN\") || !(msg.payload) ) \n    return;\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 287.75,
        "y": 1402.25,
        "wires": [
            [
                "5eaee7e7.552c48"
            ]
        ]
    },
    {
        "id": "a258ebfb.1c7e1",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "",
        "func": "var consumption = msg.payload/60;\nmsg.payload = Number((consumption).toFixed(2));\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 323.76300048828125,
        "y": 1088.3214111328125,
        "wires": [
            [
                "c84794c6.a069a8"
            ]
        ]
    },
    {
        "id": "11ecfc17.056ddc",
        "type": "ui_text",
        "z": "2cf1d395.65be64",
        "group": "9c0aaa2a.f18a08",
        "order": 3,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Production today",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 970,
        "y": 1080,
        "wires": []
    },
    {
        "id": "71854246.48025c",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "",
        "func": "var voltage = msg.payload.solar;\nvar power = 0;\n//var load_value = 1700;\nvar load_value =800;\n\n\npower = (voltage*voltage)/load_value;\n\npower = Number((power).toFixed(2));\n\nmsg.payload.solar = power;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 678.36669921875,
        "y": 178,
        "wires": [
            [
                "afe923ae.3ecf3"
            ]
        ]
    },
    {
        "id": "53572ca3.cae0a4",
        "type": "ui_text",
        "z": "a4b5eb1e.5dd4d8",
        "group": "d6107674.e42698",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "Name",
        "label": "",
        "format": "{{msg.payload}}",
        "layout": "row-left",
        "x": 1200.5,
        "y": 187.5833740234375,
        "wires": []
    },
    {
        "id": "3efe6bb6.c7490c",
        "type": "mqtt in",
        "z": "ef23770c.5edc1",
        "name": "",
        "topic": "/pwrMeter/plug0/readings",
        "qos": "1",
        "broker": "4f35fce7.f4f55c",
        "x": 335.1666259765625,
        "y": 112.16665649414062,
        "wires": [
            [
                "c7690723.8673a",
                "1b6a1e9f.996e89"
            ]
        ]
    },
    {
        "id": "c7690723.8673a",
        "type": "json",
        "z": "ef23770c.5edc1",
        "name": "",
        "pretty": false,
        "x": 547.9999389648438,
        "y": 171,
        "wires": [
            [
                "f36ca3a5.292f98"
            ]
        ]
    },
    {
        "id": "bb02f6f3.4e4a4",
        "type": "file in",
        "z": "ef23770c.5edc1",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/realpower0chart",
        "format": "utf8",
        "sendError": true,
        "x": 464.1861877441406,
        "y": 894.0087890625,
        "wires": [
            [
                "135f82c5.2e6175"
            ]
        ]
    },
    {
        "id": "49b1dcb2.a4baac",
        "type": "inject",
        "z": "ef23770c.5edc1",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 298.1861877441406,
        "y": 895.0087890625,
        "wires": [
            [
                "bb02f6f3.4e4a4"
            ]
        ]
    },
    {
        "id": "135f82c5.2e6175",
        "type": "json",
        "z": "ef23770c.5edc1",
        "name": "",
        "x": 598.1861877441406,
        "y": 894.0087890625,
        "wires": [
            [
                "1e038617.c9ceb2"
            ]
        ]
    },
    {
        "id": "2c169baf.fc4824",
        "type": "file",
        "z": "ef23770c.5edc1",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/realpower0chart",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1084.0432434082031,
        "y": 886.7588500976562,
        "wires": []
    },
    {
        "id": "5f92a587.60c564",
        "type": "ui_text",
        "z": "ef23770c.5edc1",
        "group": "3fa48937.d25e3e",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Real power",
        "label": "Real power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 907.543212890625,
        "y": 811.0087890625,
        "wires": []
    },
    {
        "id": "1e038617.c9ceb2",
        "type": "ui_chart",
        "z": "ef23770c.5edc1",
        "name": "Real power",
        "group": "3fa48937.d25e3e",
        "order": 0,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 908.7933349609375,
        "y": 861.0088500976562,
        "wires": [
            [
                "2c169baf.fc4824"
            ],
            []
        ]
    },
    {
        "id": "8025bdb9.f9f33",
        "type": "ui_text",
        "z": "ef23770c.5edc1",
        "group": "3fa48937.d25e3e",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Current",
        "label": "Current",
        "format": "{{msg.payload}} A",
        "layout": "row-spread",
        "x": 880,
        "y": 1040,
        "wires": []
    },
    {
        "id": "595ec6e7.8dfb6",
        "type": "aggregator",
        "z": "ef23770c.5edc1",
        "name": "10s mean",
        "topic": "Power",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 502.2903747558594,
        "y": 831.1129760742188,
        "wires": [
            [
                "e7091b10.7722b",
                "b44bffa.c670b"
            ]
        ]
    },
    {
        "id": "cd3b1394.511cb",
        "type": "aggregator",
        "z": "ef23770c.5edc1",
        "name": "10s mean",
        "topic": "Current",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 540,
        "y": 1040,
        "wires": [
            [
                "818115a5.986f78"
            ]
        ]
    },
    {
        "id": "e7091b10.7722b",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 651.0403747558594,
        "y": 833.6129760742188,
        "wires": [
            [
                "5f92a587.60c564",
                "1e038617.c9ceb2",
                "d3b9545c.99a708"
            ]
        ]
    },
    {
        "id": "818115a5.986f78",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 1040,
        "wires": [
            [
                "8025bdb9.f9f33",
                "c59bd702.99693"
            ]
        ]
    },
    {
        "id": "107fa97d.25964f",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "Main webpage",
        "info": "",
        "x": 893.223876953125,
        "y": 770.6962280273438,
        "wires": []
    },
    {
        "id": "badd2fea.356448",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "Plugs webpage",
        "info": "",
        "x": 889.761962890625,
        "y": 381.9405822753906,
        "wires": []
    },
    {
        "id": "6c71c35c.bc25c4",
        "type": "file in",
        "z": "ef23770c.5edc1",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/realpower0chart1min",
        "format": "utf8",
        "sendError": true,
        "x": 478.511962890625,
        "y": 423.19049072265625,
        "wires": [
            [
                "35bc6c99.329edc"
            ]
        ]
    },
    {
        "id": "c4d88f74.fe45a8",
        "type": "inject",
        "z": "ef23770c.5edc1",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 312.511962890625,
        "y": 424.19049072265625,
        "wires": [
            [
                "6c71c35c.bc25c4"
            ]
        ]
    },
    {
        "id": "35bc6c99.329edc",
        "type": "json",
        "z": "ef23770c.5edc1",
        "name": "",
        "x": 612.511962890625,
        "y": 423.19049072265625,
        "wires": [
            [
                "afc33ade.de184"
            ]
        ]
    },
    {
        "id": "ba8cce71.7a3128",
        "type": "file",
        "z": "ef23770c.5edc1",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/realpower0chart1min",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1075.0119934082031,
        "y": 430.44049072265625,
        "wires": []
    },
    {
        "id": "5a8a7bab.04bdfc",
        "type": "aggregator",
        "z": "ef23770c.5edc1",
        "name": "1min mean",
        "topic": "Power",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 480.65478515625,
        "y": 479.9018249511719,
        "wires": [
            [
                "1989c53c.781efb"
            ]
        ]
    },
    {
        "id": "1989c53c.781efb",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 642.261962890625,
        "y": 479.544677734375,
        "wires": [
            [
                "c615b96.54c52c8",
                "afc33ade.de184"
            ]
        ]
    },
    {
        "id": "c615b96.54c52c8",
        "type": "link out",
        "z": "ef23770c.5edc1",
        "name": "plug0_1m_avg",
        "links": [
            "a57f992d.0cca78",
            "a5e6ff33.f44828",
            "3f434545.4268ca"
        ],
        "x": 737.5120239257812,
        "y": 520.5714416503906,
        "wires": []
    },
    {
        "id": "548642e9.83d034",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 639.761962890625,
        "y": 278.607177734375,
        "wires": []
    },
    {
        "id": "b415295d.a819c8",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "<==========Power chart and current main==========>",
        "info": "",
        "x": 665.011962890625,
        "y": 322.357177734375,
        "wires": []
    },
    {
        "id": "d3b9545c.99a708",
        "type": "ui_text",
        "z": "ef23770c.5edc1",
        "group": "29d0f416.9256cc",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Real power",
        "label": "Real power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 892.011962890625,
        "y": 480.107177734375,
        "wires": []
    },
    {
        "id": "afc33ade.de184",
        "type": "ui_chart",
        "z": "ef23770c.5edc1",
        "name": "Real power",
        "group": "29d0f416.9256cc",
        "order": 0,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": "6",
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 891.261962890625,
        "y": 432.1072692871094,
        "wires": [
            [
                "ba8cce71.7a3128"
            ],
            []
        ]
    },
    {
        "id": "4a2027bc.95a9e",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "<==========Messages reception==========>",
        "info": "",
        "x": 520.75,
        "y": 23.75,
        "wires": []
    },
    {
        "id": "2b1a06d5.bb4be2",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "realPower",
        "func": "msg.payload = msg.payload.realPower;\nmsg.topic = \"realPower\";\n\nif (msg.payload === undefined)\n    return;\n\nnode.status({fill:\"blue\",shape:\"ring\",text:msg.topic + \":\" + msg.payload});\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 309.72406005859375,
        "y": 554.4383544921875,
        "wires": [
            [
                "5a8a7bab.04bdfc",
                "595ec6e7.8dfb6",
                "cf83a567.c60898"
            ]
        ]
    },
    {
        "id": "bfbeee07.efbf88",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "b9093c05.eb581",
            "f36ca3a5.292f98"
        ],
        "x": 196.72406005859375,
        "y": 556.4383544921875,
        "wires": [
            [
                "2b1a06d5.bb4be2"
            ]
        ]
    },
    {
        "id": "5d945cd1.8d6ff4",
        "type": "file in",
        "z": "be52c199.c86f58",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/realpowerAchart",
        "format": "utf8",
        "sendError": true,
        "x": 510.2468566894531,
        "y": 616.67431640625,
        "wires": [
            [
                "954e8af.bbe1078"
            ]
        ]
    },
    {
        "id": "c93edb5.4717aa8",
        "type": "inject",
        "z": "be52c199.c86f58",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 344.2468566894531,
        "y": 617.67431640625,
        "wires": [
            [
                "5d945cd1.8d6ff4"
            ]
        ]
    },
    {
        "id": "954e8af.bbe1078",
        "type": "json",
        "z": "be52c199.c86f58",
        "name": "",
        "x": 644.2468566894531,
        "y": 616.67431640625,
        "wires": [
            [
                "777e6d99.0b6974"
            ]
        ]
    },
    {
        "id": "d4c51690.a3dd",
        "type": "file",
        "z": "be52c199.c86f58",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/realpowerAchart",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1130.1039123535156,
        "y": 609.4243774414062,
        "wires": []
    },
    {
        "id": "13a653b5.af1724",
        "type": "ui_text",
        "z": "be52c199.c86f58",
        "group": "3bbbbd5f.04b81a",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Real power",
        "label": "Real power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 953.6038818359375,
        "y": 533.67431640625,
        "wires": []
    },
    {
        "id": "777e6d99.0b6974",
        "type": "ui_chart",
        "z": "be52c199.c86f58",
        "name": "Real power",
        "group": "3bbbbd5f.04b81a",
        "order": 0,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 954.85400390625,
        "y": 583.6743774414062,
        "wires": [
            [
                "d4c51690.a3dd"
            ],
            []
        ]
    },
    {
        "id": "9db34bae.2e0e4",
        "type": "ui_text",
        "z": "be52c199.c86f58",
        "group": "3bbbbd5f.04b81a",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Current",
        "label": "Current",
        "format": "{{msg.payload}} A",
        "layout": "row-spread",
        "x": 932.7330017089844,
        "y": 738.5001220703125,
        "wires": []
    },
    {
        "id": "631e8fb5.87949",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 697.1010437011719,
        "y": 556.2785034179688,
        "wires": [
            [
                "13a653b5.af1724",
                "777e6d99.0b6974",
                "a8288ac3.09d09"
            ]
        ]
    },
    {
        "id": "adf02863.13bf9",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 758.5870361328125,
        "y": 740.604248046875,
        "wires": [
            [
                "9db34bae.2e0e4"
            ]
        ]
    },
    {
        "id": "a9818f69.9e1118",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "Main webpage",
        "info": "",
        "x": 927.062255859375,
        "y": 490.02838134765625,
        "wires": []
    },
    {
        "id": "b9e6c720.ec2f08",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "Plug1 webpage",
        "info": "",
        "x": 916.0320434570312,
        "y": 686.1838989257812,
        "wires": []
    },
    {
        "id": "c932e6ee.75f46",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "Plugs webpage",
        "info": "",
        "x": 945.2166137695312,
        "y": 277.3334045410156,
        "wires": []
    },
    {
        "id": "a2202b10.c83",
        "type": "file in",
        "z": "be52c199.c86f58",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/realpowerAchart1min",
        "format": "utf8",
        "sendError": true,
        "x": 533.9666137695312,
        "y": 318.58331298828125,
        "wires": [
            [
                "fc87c3d7.4c0c88"
            ]
        ]
    },
    {
        "id": "25a73ea7.b8b322",
        "type": "inject",
        "z": "be52c199.c86f58",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 367.96661376953125,
        "y": 319.58331298828125,
        "wires": [
            [
                "a2202b10.c83"
            ]
        ]
    },
    {
        "id": "fc87c3d7.4c0c88",
        "type": "json",
        "z": "be52c199.c86f58",
        "name": "",
        "x": 667.9666137695312,
        "y": 318.58331298828125,
        "wires": [
            [
                "37c7c81b.f975e8"
            ]
        ]
    },
    {
        "id": "8b3ccc2b.e531b",
        "type": "file",
        "z": "be52c199.c86f58",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/realpowerAchart1min",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1130.4666442871094,
        "y": 325.83331298828125,
        "wires": []
    },
    {
        "id": "7b189691.be95f",
        "type": "aggregator",
        "z": "be52c199.c86f58",
        "name": "1min mean",
        "topic": "Power",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 536.1094360351562,
        "y": 375.2946472167969,
        "wires": [
            [
                "c95ce443.d1894"
            ]
        ]
    },
    {
        "id": "c95ce443.d1894",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 697.7166137695312,
        "y": 374.9375,
        "wires": [
            [
                "95e90acf.5e7258",
                "37c7c81b.f975e8"
            ]
        ]
    },
    {
        "id": "95e90acf.5e7258",
        "type": "link out",
        "z": "be52c199.c86f58",
        "name": "plugA_1m_avg",
        "links": [
            "b3991d95.d3fc98",
            "122450a6.3b2a67"
        ],
        "x": 792.9666748046875,
        "y": 415.9642639160156,
        "wires": []
    },
    {
        "id": "eb5a50f5.ac6c28",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 695.2166137695312,
        "y": 174,
        "wires": []
    },
    {
        "id": "aefbb77b.a0531",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "<==========Power chart and current side A==========>",
        "info": "",
        "x": 730.4666137695312,
        "y": 217.75,
        "wires": []
    },
    {
        "id": "a8288ac3.09d09",
        "type": "ui_text",
        "z": "be52c199.c86f58",
        "group": "63ae4fc1.3ca57",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Real power",
        "label": "Real power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 947.4666137695312,
        "y": 375.5,
        "wires": []
    },
    {
        "id": "37c7c81b.f975e8",
        "type": "ui_chart",
        "z": "be52c199.c86f58",
        "name": "Real power",
        "group": "63ae4fc1.3ca57",
        "order": 0,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": "6",
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 946.7166137695312,
        "y": 327.5000915527344,
        "wires": [
            [
                "8b3ccc2b.e531b"
            ],
            []
        ]
    },
    {
        "id": "1bb2dc23.2b852c",
        "type": "link in",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "f36ca3a5.292f98"
        ],
        "x": 227.63327026367188,
        "y": 465.467529296875,
        "wires": [
            [
                "c9f20064.85cd48"
            ]
        ]
    },
    {
        "id": "12eae82e.a0c83",
        "type": "link in",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "f36ca3a5.292f98"
        ],
        "x": 280.5424499511719,
        "y": 739.2857666015625,
        "wires": [
            [
                "8fd36fd1.7858b8"
            ]
        ]
    },
    {
        "id": "c9f20064.85cd48",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "realPowerA",
        "func": "msg.payload = msg.payload.realPowerA;\nmsg.topic = \"realPowerA\";\n\nif (msg.payload === undefined)\n    return;\n    \nnode.status({fill:\"blue\",shape:\"ring\",text:\"Power:\" +msg.payload+ \"w\" });\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 337.3832702636719,
        "y": 465.76519775390625,
        "wires": [
            [
                "7b189691.be95f",
                "382e9114.5f32be"
            ]
        ]
    },
    {
        "id": "8fd36fd1.7858b8",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "IrmsA",
        "func": "msg.payload = msg.payload.IrmsA;\nmsg.topic = \"IrmsA\";\n\nif (msg.payload === undefined)\n    return;\n    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 386.2924499511719,
        "y": 739.5834350585938,
        "wires": [
            [
                "75d94f6d.b93f68",
                "f2aa8d25.89f92"
            ]
        ]
    },
    {
        "id": "f6ea7627.c47df",
        "type": "file in",
        "z": "c1eaebbb.b6c98",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/realpowerBchart",
        "format": "utf8",
        "sendError": true,
        "x": 518.8833312988281,
        "y": 622.3610229492188,
        "wires": [
            [
                "5a672ab0.f278bc"
            ]
        ]
    },
    {
        "id": "8bdf3633.112c2",
        "type": "inject",
        "z": "c1eaebbb.b6c98",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 352.8833312988281,
        "y": 623.3610229492188,
        "wires": [
            [
                "f6ea7627.c47df"
            ]
        ]
    },
    {
        "id": "5a672ab0.f278bc",
        "type": "json",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "x": 652.8833312988281,
        "y": 622.3610229492188,
        "wires": [
            [
                "b72b964a.673df"
            ]
        ]
    },
    {
        "id": "f7955b39.9adb6",
        "type": "file",
        "z": "c1eaebbb.b6c98",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/realpowerBchart",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1138.7403869628906,
        "y": 615.111083984375,
        "wires": []
    },
    {
        "id": "5234209a.7c5b28",
        "type": "ui_text",
        "z": "c1eaebbb.b6c98",
        "group": "27fc78e8.8a487",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Real power",
        "label": "Real power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 962.2403564453125,
        "y": 539.3610229492188,
        "wires": []
    },
    {
        "id": "b72b964a.673df",
        "type": "ui_chart",
        "z": "c1eaebbb.b6c98",
        "name": "Real power",
        "group": "27fc78e8.8a487",
        "order": 0,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 963.490478515625,
        "y": 589.361083984375,
        "wires": [
            [
                "f7955b39.9adb6"
            ],
            []
        ]
    },
    {
        "id": "b7891bdc.a9745",
        "type": "ui_text",
        "z": "c1eaebbb.b6c98",
        "group": "27fc78e8.8a487",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Current",
        "label": "Current",
        "format": "{{msg.payload}} A",
        "layout": "row-spread",
        "x": 924.6015319824219,
        "y": 751.0556945800781,
        "wires": []
    },
    {
        "id": "2b094747.187c7",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 705.7375183105469,
        "y": 561.9652099609375,
        "wires": [
            [
                "5234209a.7c5b28",
                "b72b964a.673df",
                "e1c8d623.3d3d98"
            ]
        ]
    },
    {
        "id": "815482cf.ce86d8",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 750.45556640625,
        "y": 753.1598205566406,
        "wires": [
            [
                "b7891bdc.a9745"
            ]
        ]
    },
    {
        "id": "b46f4327.af7778",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "Main webpage",
        "info": "",
        "x": 935.69873046875,
        "y": 495.715087890625,
        "wires": []
    },
    {
        "id": "582701b9.13f15",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "Plug1 webpage",
        "info": "",
        "x": 918.8096313476562,
        "y": 693.2849426269531,
        "wires": []
    },
    {
        "id": "547b4208.c1b444",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "Plugs webpage",
        "info": "",
        "x": 940.2166137695312,
        "y": 284.3333740234375,
        "wires": []
    },
    {
        "id": "96b77dcf.eb9478",
        "type": "file in",
        "z": "c1eaebbb.b6c98",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/realpowerBchart1min",
        "format": "utf8",
        "sendError": true,
        "x": 528.9666137695312,
        "y": 325.5832824707031,
        "wires": [
            [
                "f5cca453.fd48e8"
            ]
        ]
    },
    {
        "id": "4f4e23a1.7bc854",
        "type": "inject",
        "z": "c1eaebbb.b6c98",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 362.96661376953125,
        "y": 326.5832824707031,
        "wires": [
            [
                "96b77dcf.eb9478"
            ]
        ]
    },
    {
        "id": "f5cca453.fd48e8",
        "type": "json",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "x": 662.9666137695312,
        "y": 325.5832824707031,
        "wires": [
            [
                "63fed91c.36388"
            ]
        ]
    },
    {
        "id": "766eb2d3.6148dc",
        "type": "file",
        "z": "c1eaebbb.b6c98",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/realpowerBchart1min",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1125.4666442871094,
        "y": 332.8332824707031,
        "wires": []
    },
    {
        "id": "9cd2ecb7.316c58",
        "type": "aggregator",
        "z": "c1eaebbb.b6c98",
        "name": "1min mean",
        "topic": "Power",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 531.1094360351562,
        "y": 382.29461669921875,
        "wires": [
            [
                "10582ea0.43fe39"
            ]
        ]
    },
    {
        "id": "10582ea0.43fe39",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "round",
        "func": "msg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 692.7166137695312,
        "y": 381.9374694824219,
        "wires": [
            [
                "3c3d8db9.4d587a",
                "63fed91c.36388"
            ]
        ]
    },
    {
        "id": "3c3d8db9.4d587a",
        "type": "link out",
        "z": "c1eaebbb.b6c98",
        "name": "plugB_1m_avg",
        "links": [
            "141a28af.5050f7",
            "e7d16954.e40e2"
        ],
        "x": 787.9666748046875,
        "y": 422.9642333984375,
        "wires": []
    },
    {
        "id": "5b38e47d.1c1004",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 690.2166137695312,
        "y": 180.99996948242188,
        "wires": []
    },
    {
        "id": "7eaa7e03.0e6138",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "<==========Power chart and current side B==========>",
        "info": "",
        "x": 725.4666137695312,
        "y": 224.74996948242188,
        "wires": []
    },
    {
        "id": "e1c8d623.3d3d98",
        "type": "ui_text",
        "z": "c1eaebbb.b6c98",
        "group": "79110c42.df685c",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Real power",
        "label": "Real power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 942.4666137695312,
        "y": 382.4999694824219,
        "wires": []
    },
    {
        "id": "63fed91c.36388",
        "type": "ui_chart",
        "z": "c1eaebbb.b6c98",
        "name": "Real power",
        "group": "79110c42.df685c",
        "order": 0,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": "6",
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 941.7166137695312,
        "y": 334.50006103515625,
        "wires": [
            [
                "766eb2d3.6148dc"
            ],
            []
        ]
    },
    {
        "id": "b38df6db.bf79d8",
        "type": "link in",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "f36ca3a5.292f98"
        ],
        "x": 242.63327026367188,
        "y": 484.2856750488281,
        "wires": [
            [
                "c6cebd97.da1288"
            ]
        ]
    },
    {
        "id": "e2d35626.8bb458",
        "type": "link in",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "f36ca3a5.292f98"
        ],
        "x": 272.4109802246094,
        "y": 751.8413391113281,
        "wires": [
            [
                "4b899912.b649c"
            ]
        ]
    },
    {
        "id": "c6cebd97.da1288",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "realPowerB",
        "func": "msg.payload = msg.payload.realPowerB;\nmsg.topic = \"realPowerB\";\n\nif (msg.payload === undefined)\n    return;\n    \nnode.status({fill:\"blue\",shape:\"ring\",text:\"Power:\" +msg.payload+ \"w\" });    \n    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 358.8832702636719,
        "y": 485.5833435058594,
        "wires": [
            [
                "9cd2ecb7.316c58",
                "c8ab6d3d.c2ab2"
            ]
        ]
    },
    {
        "id": "4b899912.b649c",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "IrmsB",
        "func": "msg.payload = msg.payload.IrmsB;\nmsg.topic = \"IrmsB\";\n\nif (msg.payload === undefined)\n    return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 371.6609802246094,
        "y": 754.1390075683594,
        "wires": [
            [
                "ac5a418d.4eec1",
                "458732d7.276ab4"
            ]
        ]
    },
    {
        "id": "382e9114.5f32be",
        "type": "aggregator",
        "z": "be52c199.c86f58",
        "name": "10s mean",
        "topic": "Real power",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 555.3635864257812,
        "y": 556.0909423828125,
        "wires": [
            [
                "631e8fb5.87949",
                "a7bc17f9.7ce678"
            ]
        ]
    },
    {
        "id": "75d94f6d.b93f68",
        "type": "aggregator",
        "z": "be52c199.c86f58",
        "name": "10s mean",
        "topic": "Current",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 586.9091796875,
        "y": 739.0000610351562,
        "wires": [
            [
                "adf02863.13bf9"
            ]
        ]
    },
    {
        "id": "c8ab6d3d.c2ab2",
        "type": "aggregator",
        "z": "c1eaebbb.b6c98",
        "name": "10s mean",
        "topic": "Real power",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 554.0000610351562,
        "y": 559.7776794433594,
        "wires": [
            [
                "2b094747.187c7",
                "c95ba018.0786a"
            ]
        ]
    },
    {
        "id": "ac5a418d.4eec1",
        "type": "aggregator",
        "z": "c1eaebbb.b6c98",
        "name": "10s mean",
        "topic": "Current",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 553.7777099609375,
        "y": 754.5556640625,
        "wires": [
            [
                "815482cf.ce86d8"
            ]
        ]
    },
    {
        "id": "7e916390.7a285c",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "Irms",
        "func": "msg.payload = msg.payload.Irms;\nmsg.topic = \"Irms\";\n\nif (msg.payload === undefined)\n    return;\n    \nif (msg.payload > 15 )\n    return;\n\nnode.status({fill:\"blue\",shape:\"ring\",text:msg.topic + \":\" + msg.payload});\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 322.08758544921875,
        "y": 1046.4382629394531,
        "wires": [
            [
                "cd3b1394.511cb",
                "2b2a1ab9.198fee",
                "484ebdd.5d0e544"
            ]
        ]
    },
    {
        "id": "fbdaa90.38d7bd8",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "b9093c05.eb581",
            "f36ca3a5.292f98"
        ],
        "x": 219.08758544921875,
        "y": 1048.4382629394531,
        "wires": [
            [
                "7e916390.7a285c"
            ]
        ]
    },
    {
        "id": "a83d100d.bdbc98",
        "type": "ui_text",
        "z": "ef23770c.5edc1",
        "group": "3fa48937.d25e3e",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Voltage",
        "label": "Voltage",
        "format": "{{msg.payload}} V",
        "layout": "row-spread",
        "x": 868.8008422851562,
        "y": 1161.779296875,
        "wires": []
    },
    {
        "id": "ff9bffd1.386738",
        "type": "aggregator",
        "z": "ef23770c.5edc1",
        "name": "10s mean",
        "topic": "Voltage",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 550.9048767089844,
        "y": 1162.6333618164062,
        "wires": [
            [
                "4e75e86d.7617c"
            ]
        ]
    },
    {
        "id": "4e75e86d.7617c",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 694.6548767089844,
        "y": 1163.8834228515625,
        "wires": [
            [
                "a83d100d.bdbc98",
                "488ddfca.319ff8"
            ]
        ]
    },
    {
        "id": "41db5353.87ff34",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "supplyVoltage",
        "func": "msg.payload = msg.payload.supplyVoltage;\nmsg.topic = \"supplyVoltage\";\n\nif (msg.payload === undefined)\n    return;\n   \nif (msg.payload <= 215 )\n    return;\n    \nif (msg.payload >= 250 )\n    return;\n\nnode.status({fill:\"blue\",shape:\"ring\",text:msg.topic + \":\" + msg.payload});\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 353.61029052734375,
        "y": 1163.779296875,
        "wires": [
            [
                "ff9bffd1.386738",
                "eef245ea.8dc0b8"
            ]
        ]
    },
    {
        "id": "2a441638.501802",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "b9093c05.eb581",
            "f36ca3a5.292f98"
        ],
        "x": 222.61029052734375,
        "y": 1163.779296875,
        "wires": [
            [
                "41db5353.87ff34"
            ]
        ]
    },
    {
        "id": "5e39ec3a.fd3f2c",
        "type": "ui_text",
        "z": "ef23770c.5edc1",
        "group": "3fa48937.d25e3e",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Apparent Power",
        "label": "Apparent Power",
        "format": "{{msg.payload}} VA",
        "layout": "row-spread",
        "x": 892.437255859375,
        "y": 1282.0518798828125,
        "wires": []
    },
    {
        "id": "57f2fb28.6c9264",
        "type": "aggregator",
        "z": "ef23770c.5edc1",
        "name": "10s mean",
        "topic": "apparentPower",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 554.5412902832031,
        "y": 1282.9059448242188,
        "wires": [
            [
                "d9192a4f.9d4838"
            ]
        ]
    },
    {
        "id": "d9192a4f.9d4838",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 698.2912902832031,
        "y": 1284.156005859375,
        "wires": [
            [
                "5e39ec3a.fd3f2c"
            ]
        ]
    },
    {
        "id": "1a549d7a.de25ab",
        "type": "ui_text",
        "z": "ef23770c.5edc1",
        "group": "3fa48937.d25e3e",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Power factor",
        "label": "Power factor",
        "format": "{{msg.payload}} ",
        "layout": "row-spread",
        "x": 882.6191101074219,
        "y": 1401.1428833007812,
        "wires": []
    },
    {
        "id": "2aff5b99.b0bf3c",
        "type": "aggregator",
        "z": "ef23770c.5edc1",
        "name": "10s mean",
        "topic": "powerFactor",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 554.72314453125,
        "y": 1401.9969482421875,
        "wires": [
            [
                "4f4e7027.0115e8"
            ]
        ]
    },
    {
        "id": "4f4e7027.0115e8",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 698.47314453125,
        "y": 1403.2470092773438,
        "wires": [
            [
                "1a549d7a.de25ab",
                "5833f8a3.f53658"
            ]
        ]
    },
    {
        "id": "f4d46734.5f22b",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "apparentPower",
        "func": "msg.payload = msg.payload.apparentPower;\nmsg.topic = \"apparentPower\";\n\nif (msg.payload === undefined)\n    return;\n\nnode.status({fill:\"blue\",shape:\"ring\",text:msg.topic + \":\" + msg.payload});\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 359.2467041015625,
        "y": 1284.0518798828125,
        "wires": [
            [
                "57f2fb28.6c9264",
                "656083e0.e08d8c"
            ]
        ]
    },
    {
        "id": "96a1616f.66f4d8",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "b9093c05.eb581",
            "f36ca3a5.292f98"
        ],
        "x": 234.2467041015625,
        "y": 1284.0518798828125,
        "wires": [
            [
                "f4d46734.5f22b"
            ]
        ]
    },
    {
        "id": "36623690.25f812",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "powerFactor",
        "func": "msg.payload = msg.payload.powerFactor;\nmsg.topic = \"powerFactor\";\n\nif (msg.payload === undefined)\n    return;\n    \nif (msg.payload > 1)\n    return;\n\nif (msg.payload <= 0.3)\n    return;\n\nnode.status({fill:\"blue\",shape:\"ring\",text:msg.topic + \":\" + msg.payload});\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 351.4285583496094,
        "y": 1401.1428833007812,
        "wires": [
            [
                "2aff5b99.b0bf3c",
                "c3af2920.ace248"
            ]
        ]
    },
    {
        "id": "5776e8d1.919cd",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "b9093c05.eb581",
            "f36ca3a5.292f98"
        ],
        "x": 228.42855834960938,
        "y": 1403.1428833007812,
        "wires": [
            [
                "36623690.25f812"
            ]
        ]
    },
    {
        "id": "488ddfca.319ff8",
        "type": "ui_text",
        "z": "ef23770c.5edc1",
        "group": "29d0f416.9256cc",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Voltage",
        "label": "Voltage",
        "format": "{{msg.payload}} V",
        "layout": "row-spread",
        "x": 1016.6102905273438,
        "y": 1207.779296875,
        "wires": []
    },
    {
        "id": "5833f8a3.f53658",
        "type": "ui_text",
        "z": "ef23770c.5edc1",
        "group": "29d0f416.9256cc",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Power factor",
        "label": "Power factor",
        "format": "{{msg.payload}} ",
        "layout": "row-spread",
        "x": 1043.4285583496094,
        "y": 1437.1428833007812,
        "wires": []
    },
    {
        "id": "ee3b1800.d0ef5",
        "type": "ui_text",
        "z": "be52c199.c86f58",
        "group": "3bbbbd5f.04b81a",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Apparent Power",
        "label": "Apparent Power",
        "format": "{{msg.payload}} VA",
        "layout": "row-spread",
        "x": 938.0997619628906,
        "y": 829.71435546875,
        "wires": []
    },
    {
        "id": "e470f00b.d38c",
        "type": "aggregator",
        "z": "be52c199.c86f58",
        "name": "10s mean",
        "topic": "apparentPower",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 600.2037963867188,
        "y": 830.5684204101562,
        "wires": [
            [
                "f9075985.a361"
            ]
        ]
    },
    {
        "id": "f9075985.a361",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 743.9537963867188,
        "y": 831.8184814453125,
        "wires": [
            [
                "ee3b1800.d0ef5"
            ]
        ]
    },
    {
        "id": "ff95f4b.2c0a408",
        "type": "ui_text",
        "z": "be52c199.c86f58",
        "group": "3bbbbd5f.04b81a",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Power factor",
        "label": "Power factor",
        "format": "{{msg.payload}} ",
        "layout": "row-spread",
        "x": 937.2425537109375,
        "y": 926.8572387695312,
        "wires": []
    },
    {
        "id": "d7b7b2a9.8414b8",
        "type": "aggregator",
        "z": "be52c199.c86f58",
        "name": "10s mean",
        "topic": "powerFactor",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 609.3465881347656,
        "y": 927.7113037109375,
        "wires": [
            [
                "f6597cd4.c6e88"
            ]
        ]
    },
    {
        "id": "f6597cd4.c6e88",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 753.0965881347656,
        "y": 928.9613647460938,
        "wires": [
            [
                "ff95f4b.2c0a408"
            ]
        ]
    },
    {
        "id": "6120e9a0.0daec",
        "type": "ui_text",
        "z": "c1eaebbb.b6c98",
        "group": "27fc78e8.8a487",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Apparent Power",
        "label": "Apparent Power",
        "format": "{{msg.payload}} VA",
        "layout": "row-spread",
        "x": 940.9681396484375,
        "y": 848.8414764404297,
        "wires": []
    },
    {
        "id": "c4216d05.875178",
        "type": "aggregator",
        "z": "c1eaebbb.b6c98",
        "name": "10s mean",
        "topic": "apparentPower",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 603.0721740722656,
        "y": 849.6955413818359,
        "wires": [
            [
                "aebfc67a.1d027"
            ]
        ]
    },
    {
        "id": "aebfc67a.1d027",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 746.8221740722656,
        "y": 850.9456024169922,
        "wires": [
            [
                "6120e9a0.0daec"
            ]
        ]
    },
    {
        "id": "6cbc5ddb.fac93c",
        "type": "ui_text",
        "z": "c1eaebbb.b6c98",
        "group": "27fc78e8.8a487",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "Power factor",
        "label": "Power factor",
        "format": "{{msg.payload}} ",
        "layout": "row-spread",
        "x": 935.8253173828125,
        "y": 947.4127807617188,
        "wires": []
    },
    {
        "id": "fbad1d2f.947c2",
        "type": "aggregator",
        "z": "c1eaebbb.b6c98",
        "name": "10s mean",
        "topic": "powerFactor",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 607.9293518066406,
        "y": 948.266845703125,
        "wires": [
            [
                "83393d2e.6900d"
            ]
        ]
    },
    {
        "id": "83393d2e.6900d",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 751.6793518066406,
        "y": 949.5169067382812,
        "wires": [
            [
                "6cbc5ddb.fac93c"
            ]
        ]
    },
    {
        "id": "f0966e4c.da8f18",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "apparentPowerA",
        "func": "msg.payload = msg.payload.apparentPowerA;\nmsg.topic = \"apparentPowerA\";\n\nif (msg.payload === undefined)\n    return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 421.9092102050781,
        "y": 835.71435546875,
        "wires": [
            [
                "e470f00b.d38c",
                "89a8f480.c02768"
            ]
        ]
    },
    {
        "id": "d6163892.554af",
        "type": "link in",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "f36ca3a5.292f98"
        ],
        "x": 278.9092102050781,
        "y": 837.71435546875,
        "wires": [
            [
                "f0966e4c.da8f18"
            ]
        ]
    },
    {
        "id": "1356edf3.e6fd82",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "powerFactorA",
        "func": "msg.payload = msg.payload.powerFactorA;\nmsg.topic = \"powerFactorA\";\n\nif (msg.payload === undefined)\n    return;\n    \nif (msg.payload > 1)\n    return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 408.0520935058594,
        "y": 926.1429443359375,
        "wires": [
            [
                "d7b7b2a9.8414b8",
                "de251c6c.be3e48"
            ]
        ]
    },
    {
        "id": "153a657b.33e83b",
        "type": "link in",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "f36ca3a5.292f98"
        ],
        "x": 275.0520935058594,
        "y": 928.1429443359375,
        "wires": [
            [
                "1356edf3.e6fd82"
            ]
        ]
    },
    {
        "id": "adcd33f.d41f9d",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "apparentPowerB",
        "func": "msg.payload = msg.payload.apparentPowerB;\nmsg.topic = \"apparentPowerB\";\n\nif (msg.payload === undefined)\n    return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 421.4919128417969,
        "y": 849.5557250976562,
        "wires": [
            [
                "c4216d05.875178",
                "e630f16c.5dafb"
            ]
        ]
    },
    {
        "id": "35d5dba2.f06364",
        "type": "link in",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "f36ca3a5.292f98"
        ],
        "x": 278.4919128417969,
        "y": 851.5557250976562,
        "wires": [
            [
                "adcd33f.d41f9d"
            ]
        ]
    },
    {
        "id": "cc593143.72d96",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "powerFactorB",
        "func": "msg.payload = msg.payload.powerFactorB;\nmsg.topic = \"powerFactorB\";\n\nif (msg.payload === undefined)\n    return;\n    \nif (msg.payload > 1)\n    return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 414.3490295410156,
        "y": 946.984375,
        "wires": [
            [
                "fbad1d2f.947c2",
                "19b5df34.3d63c1"
            ]
        ]
    },
    {
        "id": "663e558f.848adc",
        "type": "link in",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "f36ca3a5.292f98"
        ],
        "x": 281.3490295410156,
        "y": 948.984375,
        "wires": [
            [
                "cc593143.72d96"
            ]
        ]
    },
    {
        "id": "391e98c2.64ad4",
        "type": "ui_switch",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "label": "Relay",
        "group": "d6107674.e42698",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "relay1_state",
        "style": "",
        "onvalue": "1",
        "onvalueType": "str",
        "onicon": "",
        "oncolor": "",
        "offvalue": "0",
        "offvalueType": "str",
        "officon": "",
        "offcolor": "",
        "x": 686.5455322265625,
        "y": 457.5455017089844,
        "wires": [
            [
                "925dd150.9ca6b"
            ]
        ]
    },
    {
        "id": "fc3f8e9a.d3c3c8",
        "type": "ui_text",
        "z": "a4b5eb1e.5dd4d8",
        "group": "d6107674.e42698",
        "order": 3,
        "width": 0,
        "height": 0,
        "name": "Power",
        "label": "Power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 961.1817932128906,
        "y": 819.272705078125,
        "wires": []
    },
    {
        "id": "4885ae51.533f58",
        "type": "ui_chart",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Power",
        "group": "d6107674.e42698",
        "order": 4,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": "6",
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 960.4317932128906,
        "y": 771.2727966308594,
        "wires": [
            [
                "ee786e66.c553c8"
            ],
            []
        ]
    },
    {
        "id": "5d2088d0.4dc85",
        "type": "ui_text",
        "z": "bbaf6eb0.1f878",
        "group": "213b5215.c08486",
        "order": 3,
        "width": 0,
        "height": 0,
        "name": "Power",
        "label": "Power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 872,
        "y": 816,
        "wires": []
    },
    {
        "id": "2e80c328.9ead4c",
        "type": "ui_chart",
        "z": "bbaf6eb0.1f878",
        "name": "Power",
        "group": "213b5215.c08486",
        "order": 4,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": "6",
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 871.25,
        "y": 768.0000915527344,
        "wires": [
            [
                "1383fff8.577d28"
            ],
            []
        ]
    },
    {
        "id": "af986007.6321",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 663.9999389648438,
        "y": 1524.2857666015625,
        "wires": []
    },
    {
        "id": "72f2795e.8bcce",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "<==========Consumption and cost==========>",
        "info": "",
        "x": 659.9999389648438,
        "y": 1567.7857666015625,
        "wires": []
    },
    {
        "id": "b6efd2c2.4555a8",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "Plug energy consumption today",
        "info": "",
        "x": 630.9642944335938,
        "y": 1629.5357666015625,
        "wires": []
    },
    {
        "id": "14f91809.07c948",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "det Wh Day",
        "func": "var consumption = global.get(\"plug0_t_c\");\nvar last_m_date = global.get(\"plug0_t_d\");\n\nvar last_minute = msg.payload;\nvar atual_m_date = 0;\n\nif ( (consumption===\"NaN\") || (!consumption) ) \n    consumption = 0;\n\n//det date timestamp\nvar now     = new Date(); \nvar year    = now.getFullYear();\nvar month   = now.getMonth()+1; \nvar day     = now.getDate();\n\nif(month.toString().length == 1) {\nvar month = '0'+month;\n}\nif(day.toString().length == 1) {\nvar day = '0'+day;\n} \n\nmsg.timestamp = year+'-'+month+'-'+day;\nvar atual_m_date = msg.timestamp;\n\n//check if day has passed\nif (last_m_date === undefined) {\n    last_m_date = atual_m_date;\n    global.set(\"plug0_t_d\",last_m_date);\n}else{\n    //check if day is over to restart counting\n    if (last_m_date !== atual_m_date) {\n        consumption = 0;\n        global.set(\"plug0_t_d\",atual_m_date);\n    }\n}\n\n//calculate power consumption\nif (consumption === undefined) {\n    consumption = last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plug0_t_c\",consumption);\n}else{\n    consumption += last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plug0_t_c\",consumption);\n}\n\nmsg.payload = consumption;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 572.1787719726562,
        "y": 1674.249755859375,
        "wires": [
            [
                "af34835c.aa33e8",
                "5b19f928.a1d4a"
            ]
        ]
    },
    {
        "id": "c1ab9af7.d15c5",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "",
        "func": "var consumption = msg.payload/60;\nmsg.payload = Number((consumption).toFixed(2));\n\nif ( (msg.payload===\"NaN\") || !(msg.payload) ) \n    return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 371.33099365234375,
        "y": 1669.5357666015625,
        "wires": [
            [
                "14f91809.07c948"
            ]
        ]
    },
    {
        "id": "a5e6ff33.f44828",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "c615b96.54c52c8"
        ],
        "x": 243.33096313476562,
        "y": 1670.0357666015625,
        "wires": [
            [
                "c1ab9af7.d15c5"
            ]
        ]
    },
    {
        "id": "5b19f928.a1d4a",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "save choice",
        "func": "msg.payload = global.get(\"plug0_t_c\");\n\n\nif (msg.payload > 1000){\n    msg.payload = msg.payload/1000;\n    msg.payload = Number((msg.payload).toFixed(2));\n    msg.payload = msg.payload + \" kWh\";\n}else{\n    msg.payload = msg.payload + \" Wh\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 790.7142944335938,
        "y": 1671.7857666015625,
        "wires": [
            [
                "5f92f7c6.c64388"
            ]
        ]
    },
    {
        "id": "5f92f7c6.c64388",
        "type": "ui_text",
        "z": "ef23770c.5edc1",
        "group": "3fa48937.d25e3e",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Today consumption",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1045.3309936523438,
        "y": 1670.7857666015625,
        "wires": []
    },
    {
        "id": "af34835c.aa33e8",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "save choice",
        "func": "var cost = global.get(\"fixed_energy_cost\");\nvar today_cost = 0;\n\nmsg.payload = global.get(\"plug0_t_c\");\n        \ntoday_cost = (msg.payload/1000)*cost\n\nmsg.payload = Number((today_cost).toFixed(4));\n\n msg.payload = msg.payload + \" \";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 796.7142944335938,
        "y": 1718.7857666015625,
        "wires": [
            [
                "addc0e12.269908"
            ]
        ]
    },
    {
        "id": "addc0e12.269908",
        "type": "ui_text",
        "z": "ef23770c.5edc1",
        "group": "3fa48937.d25e3e",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Today cost",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1027.3309936523438,
        "y": 1716.7857666015625,
        "wires": []
    },
    {
        "id": "af4c67e2.6194b8",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 632.9869384765625,
        "y": 1042.2079467773438,
        "wires": []
    },
    {
        "id": "fb4a16ed.abc7c",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "<==========Consumption and cost==========>",
        "info": "",
        "x": 628.9869384765625,
        "y": 1085.7079467773438,
        "wires": []
    },
    {
        "id": "5c20a808.94b858",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "Plug energy consumption today",
        "info": "",
        "x": 645.4058837890625,
        "y": 1147.4578552246094,
        "wires": []
    },
    {
        "id": "db4beff6.4f42d",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "det Wh Day",
        "func": "var consumption = global.get(\"plugA_t_c\");\nvar last_m_date = global.get(\"plugA_t_d\");\n\nvar last_minute = msg.payload;\nvar atual_m_date = 0;\n\nif ( (consumption===\"NaN\") || (!consumption) ) \n    consumption = 0;\n\n//det date timestamp\nvar now     = new Date(); \nvar year    = now.getFullYear();\nvar month   = now.getMonth()+1; \nvar day     = now.getDate();\n\nif(month.toString().length == 1) {\nvar month = '0'+month;\n}\nif(day.toString().length == 1) {\nvar day = '0'+day;\n} \n\nmsg.timestamp = year+'-'+month+'-'+day;\nvar atual_m_date = msg.timestamp;\n\n//check if day has passed\nif (last_m_date === undefined) {\n    last_m_date = atual_m_date;\n    global.set(\"plugA_t_d\",last_m_date);\n}else{\n    //check if day is over to restart counting\n    if (last_m_date !== atual_m_date) {\n        consumption = 0;\n        global.set(\"plugA_t_d\",atual_m_date);\n    }\n}\n\n//calculate power consumption\nif (consumption === undefined) {\n    consumption = last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plugA_t_c\",consumption);\n}else{\n    consumption += last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plugA_t_c\",consumption);\n}\n\nmsg.payload = consumption;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 578.620361328125,
        "y": 1191.1717834472656,
        "wires": [
            [
                "1398c56b.78217b",
                "7b81bba2.3d94dc"
            ]
        ]
    },
    {
        "id": "85440563.03a878",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "",
        "func": "var consumption = msg.payload/60;\nmsg.payload = Number((consumption).toFixed(2));\n\nif ( (msg.payload===\"NaN\") || !(msg.payload) ) \n    return;\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 335.7725830078125,
        "y": 1187.4578552246094,
        "wires": [
            [
                "db4beff6.4f42d"
            ]
        ]
    },
    {
        "id": "b3991d95.d3fc98",
        "type": "link in",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "95e90acf.5e7258"
        ],
        "x": 207.77255249023438,
        "y": 1187.9578552246094,
        "wires": [
            [
                "85440563.03a878"
            ]
        ]
    },
    {
        "id": "61ef451a.aece2c",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 648.571533203125,
        "y": 1081.428466796875,
        "wires": []
    },
    {
        "id": "ac861195.c825c",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "<==========Consumption and cost==========>",
        "info": "",
        "x": 644.571533203125,
        "y": 1124.928466796875,
        "wires": []
    },
    {
        "id": "f3a04cbb.a3d55",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "Plug energy consumption today",
        "info": "",
        "x": 665.535888671875,
        "y": 1186.678466796875,
        "wires": []
    },
    {
        "id": "1c7ffe3a.57e682",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "det Wh Day",
        "func": "var consumption = global.get(\"plugB_t_c\");\nvar last_m_date = global.get(\"plugB_t_d\");\n\nvar last_minute = msg.payload;\nvar atual_m_date = 0;\n\nif ( (consumption===\"NaN\") || (!consumption) ) \n    consumption = 0;\n    \n//det date timestamp\nvar now     = new Date(); \nvar year    = now.getFullYear();\nvar month   = now.getMonth()+1; \nvar day     = now.getDate();\n\nif(month.toString().length == 1) {\nvar month = '0'+month;\n}\nif(day.toString().length == 1) {\nvar day = '0'+day;\n} \n\nmsg.timestamp = year+'-'+month+'-'+day;\nvar atual_m_date = msg.timestamp;\n\n//check if day has passed\nif (last_m_date === undefined) {\n    last_m_date = atual_m_date;\n    global.set(\"plugB_t_d\",last_m_date);\n}else{\n    //check if day is over to restart counting\n    if (last_m_date !== atual_m_date) {\n        consumption = 0;\n        global.set(\"plugB_t_d\",atual_m_date);\n    }\n}\n\n//calculate power consumption\nif (consumption === undefined) {\n    consumption = last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plugB_t_c\",consumption);\n}else{\n    consumption += last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(\"plugB_t_c\",consumption);\n}\n\nmsg.payload = consumption;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 598.7503662109375,
        "y": 1230.3923950195312,
        "wires": [
            [
                "b49fc88c.9a31f",
                "a31707e2.6f79e8"
            ]
        ]
    },
    {
        "id": "ce61f61.66f3408",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "func": "var consumption = msg.payload/60;\nmsg.payload = Number((consumption).toFixed(2));\n\nif ( (msg.payload===\"NaN\") || !(msg.payload) ) \n    return;\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 355.902587890625,
        "y": 1226.678466796875,
        "wires": [
            [
                "1c7ffe3a.57e682"
            ]
        ]
    },
    {
        "id": "141a28af.5050f7",
        "type": "link in",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "3c3d8db9.4d587a"
        ],
        "x": 227.90255737304688,
        "y": 1227.178466796875,
        "wires": [
            [
                "ce61f61.66f3408"
            ]
        ]
    },
    {
        "id": "36896a53.d9e826",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore plugA name",
        "func": "msg.topic = \"plug0A_name\";\nmsg.payload = global.get(\"plug0A_name\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 502.2857360839844,
        "y": 716.2857055664062,
        "wires": [
            [
                "a74e316e.a76f78"
            ]
        ]
    },
    {
        "id": "a74e316e.a76f78",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_nameA",
        "links": [
            "da1774c0.cb1b68"
        ],
        "x": 649.2857360839844,
        "y": 718.2857055664062,
        "wires": []
    },
    {
        "id": "a68cc198.4c102",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore plugB name",
        "func": "msg.topic = \"plug0B_name\";\nmsg.payload = global.get(\"plug0B_name\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 503.7143249511719,
        "y": 759.1428833007812,
        "wires": [
            [
                "b67404a0.b816f"
            ]
        ]
    },
    {
        "id": "b67404a0.b816f",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_nameB",
        "links": [
            "7fc60c7.57cb274"
        ],
        "x": 650.7143249511719,
        "y": 761.1428833007812,
        "wires": []
    },
    {
        "id": "b27ff392.367828",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plug0','realPower',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 730.36376953125,
        "y": 1933.2464599609375,
        "wires": [
            [
                "2cafdd78.8cc23a"
            ]
        ]
    },
    {
        "id": "2cafdd78.8cc23a",
        "type": "sqlite",
        "z": "ef23770c.5edc1",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 939.1970825195312,
        "y": 1934.2464599609375,
        "wires": [
            []
        ]
    },
    {
        "id": "2e748177.2a5d36",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "Plug0 DB",
        "info": "",
        "x": 881.8334350585938,
        "y": 1839.1170043945312,
        "wires": []
    },
    {
        "id": "a57f992d.0cca78",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "c615b96.54c52c8"
        ],
        "x": 381.76849365234375,
        "y": 1951.6514282226562,
        "wires": [
            [
                "4ff7c50b.00d2f4",
                "b27ff392.367828"
            ]
        ]
    },
    {
        "id": "2c09245f.9d15d4",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plug0','consumption',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 749.6256103515625,
        "y": 1986.5084838867188,
        "wires": [
            [
                "cd4d6b00.82f23"
            ]
        ]
    },
    {
        "id": "cd4d6b00.82f23",
        "type": "sqlite",
        "z": "ef23770c.5edc1",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 951.4589233398438,
        "y": 1987.5084838867188,
        "wires": [
            []
        ]
    },
    {
        "id": "4ff7c50b.00d2f4",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "det Wh minute",
        "func": "var last_minute = msg.payload;\n\nmsg.payload = Number((last_minute/60).toFixed(2));\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 558.6256103515625,
        "y": 1986.5084838867188,
        "wires": [
            [
                "2c09245f.9d15d4"
            ]
        ]
    },
    {
        "id": "3860ab0.a48b2d6",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "every minute",
        "info": "",
        "x": 374.7684326171875,
        "y": 1882.7944946289062,
        "wires": []
    },
    {
        "id": "277b2c50.fb0f04",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 698.7099609375,
        "y": 1803.4342041015625,
        "wires": []
    },
    {
        "id": "7abc8681.cb8f48",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "<==========Database==========>",
        "info": "",
        "x": 665.4599609375,
        "y": 1841.6842041015625,
        "wires": []
    },
    {
        "id": "2b2a1ab9.198fee",
        "type": "aggregator",
        "z": "ef23770c.5edc1",
        "name": "1min mean",
        "topic": "current",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 566.3375549316406,
        "y": 1093.1168518066406,
        "wires": [
            [
                "ef01e876.e5ce4"
            ]
        ]
    },
    {
        "id": "eef245ea.8dc0b8",
        "type": "aggregator",
        "z": "ef23770c.5edc1",
        "name": "1min mean",
        "topic": "supplyVoltage",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 563.6102600097656,
        "y": 1215.0650024414062,
        "wires": [
            [
                "b87dab38.35038"
            ]
        ]
    },
    {
        "id": "656083e0.e08d8c",
        "type": "aggregator",
        "z": "ef23770c.5edc1",
        "name": "1min mean",
        "topic": "apparentPower",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 565.8180847167969,
        "y": 1329.4804077148438,
        "wires": [
            [
                "20c6906a.38872"
            ]
        ]
    },
    {
        "id": "c3af2920.ace248",
        "type": "aggregator",
        "z": "ef23770c.5edc1",
        "name": "1min mean",
        "topic": "powerFactor",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 562.5713500976562,
        "y": 1452.857177734375,
        "wires": [
            [
                "cf4409ab.c304a"
            ]
        ]
    },
    {
        "id": "ef01e876.e5ce4",
        "type": "link out",
        "z": "ef23770c.5edc1",
        "name": "plug0_1m_current_avg",
        "links": [
            "72d1fac2.30f23c"
        ],
        "x": 703.4803771972656,
        "y": 1094.5453796386719,
        "wires": []
    },
    {
        "id": "b87dab38.35038",
        "type": "link out",
        "z": "ef23770c.5edc1",
        "name": "plug0_1m_supplyVoltage_avg",
        "links": [
            "7310e120.7627e8",
            "a0e9be67.abc168"
        ],
        "x": 692.1816711425781,
        "y": 1213.6364135742188,
        "wires": []
    },
    {
        "id": "20c6906a.38872",
        "type": "link out",
        "z": "ef23770c.5edc1",
        "name": "plug0_1m_apparentPower_avg",
        "links": [
            "e04e2c9d.490f18"
        ],
        "x": 702.9610290527344,
        "y": 1330.9089965820312,
        "wires": []
    },
    {
        "id": "cf4409ab.c304a",
        "type": "link out",
        "z": "ef23770c.5edc1",
        "name": "plug0_1m_powerFactor_avg",
        "links": [
            "139cf93e.e0696f"
        ],
        "x": 692.5713500976562,
        "y": 1455.7142333984375,
        "wires": []
    },
    {
        "id": "e068c2af.44f1f8",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plug0','current',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 667.5064086914062,
        "y": 2078.9610595703125,
        "wires": [
            [
                "fba66dec.dd8698"
            ]
        ]
    },
    {
        "id": "fba66dec.dd8698",
        "type": "sqlite",
        "z": "ef23770c.5edc1",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 942.05419921875,
        "y": 2078.5322265625,
        "wires": [
            []
        ]
    },
    {
        "id": "72d1fac2.30f23c",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "ef01e876.e5ce4"
        ],
        "x": 416.0540466308594,
        "y": 2080.223388671875,
        "wires": [
            [
                "ae5a39f5.d3ce6"
            ]
        ]
    },
    {
        "id": "6894d6f5.feee8",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plug0','supplyVoltage',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 666.077880859375,
        "y": 2158.961181640625,
        "wires": [
            [
                "58838be4.1c1eb4"
            ]
        ]
    },
    {
        "id": "58838be4.1c1eb4",
        "type": "sqlite",
        "z": "ef23770c.5edc1",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 940.6256713867188,
        "y": 2158.5323486328125,
        "wires": [
            []
        ]
    },
    {
        "id": "7310e120.7627e8",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "b87dab38.35038"
        ],
        "x": 414.6255187988281,
        "y": 2160.2235107421875,
        "wires": [
            [
                "40fdb70.aff6e48"
            ]
        ]
    },
    {
        "id": "4325d041.5d152",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plug0','apparentPower',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 663.220703125,
        "y": 2238.961181640625,
        "wires": [
            [
                "4315c268.771dfc"
            ]
        ]
    },
    {
        "id": "4315c268.771dfc",
        "type": "sqlite",
        "z": "ef23770c.5edc1",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 937.7684936523438,
        "y": 2238.5323486328125,
        "wires": [
            []
        ]
    },
    {
        "id": "e04e2c9d.490f18",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "20c6906a.38872"
        ],
        "x": 411.7683410644531,
        "y": 2240.2235107421875,
        "wires": [
            [
                "8e75890f.e12788"
            ]
        ]
    },
    {
        "id": "66321043.e3363",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plug0','powerFactor',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 661.7921142578125,
        "y": 2318.961181640625,
        "wires": [
            [
                "dc196999.9d4868"
            ]
        ]
    },
    {
        "id": "dc196999.9d4868",
        "type": "sqlite",
        "z": "ef23770c.5edc1",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 936.3399047851562,
        "y": 2318.5323486328125,
        "wires": [
            []
        ]
    },
    {
        "id": "139cf93e.e0696f",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "cf4409ab.c304a"
        ],
        "x": 410.3397521972656,
        "y": 2320.2235107421875,
        "wires": [
            [
                "fb747644.21fdd8"
            ]
        ]
    },
    {
        "id": "f2aa8d25.89f92",
        "type": "aggregator",
        "z": "be52c199.c86f58",
        "name": "1min mean",
        "topic": "currentA",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 605.4329833984375,
        "y": 783.5714721679688,
        "wires": [
            [
                "2e283f92.7d9ad8"
            ]
        ]
    },
    {
        "id": "2e283f92.7d9ad8",
        "type": "link out",
        "z": "be52c199.c86f58",
        "name": "plugA_1m_current_avg",
        "links": [
            "7c75db6a.7c765c"
        ],
        "x": 742.5758056640625,
        "y": 785,
        "wires": []
    },
    {
        "id": "89a8f480.c02768",
        "type": "aggregator",
        "z": "be52c199.c86f58",
        "name": "1min mean",
        "topic": "apparentPowerA",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 614.00439453125,
        "y": 882.1428833007812,
        "wires": [
            [
                "246d985b.dfb818"
            ]
        ]
    },
    {
        "id": "246d985b.dfb818",
        "type": "link out",
        "z": "be52c199.c86f58",
        "name": "plugA_1m_apparentPower_avg",
        "links": [
            "5159ca37.28c2b4"
        ],
        "x": 751.1473388671875,
        "y": 883.5714721679688,
        "wires": []
    },
    {
        "id": "de251c6c.be3e48",
        "type": "aggregator",
        "z": "be52c199.c86f58",
        "name": "1min mean",
        "topic": "powerFactorA",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 615.4329833984375,
        "y": 975.0000610351562,
        "wires": [
            [
                "c4ad34f0.9c009"
            ]
        ]
    },
    {
        "id": "c4ad34f0.9c009",
        "type": "link out",
        "z": "be52c199.c86f58",
        "name": "plugA_1m_powerFactor_avg",
        "links": [
            "70f7357d.5759d4"
        ],
        "x": 745.4329833984375,
        "y": 977.8571166992188,
        "wires": []
    },
    {
        "id": "19b5df34.3d63c1",
        "type": "aggregator",
        "z": "c1eaebbb.b6c98",
        "name": "1min mean",
        "topic": "powerFactorB",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 628.015869140625,
        "y": 991.27001953125,
        "wires": [
            [
                "dce253af.0f45c8"
            ]
        ]
    },
    {
        "id": "dce253af.0f45c8",
        "type": "link out",
        "z": "c1eaebbb.b6c98",
        "name": "plugB_1m_powerFactor_avg",
        "links": [
            "5a24ac0a.d8209c"
        ],
        "x": 758.015869140625,
        "y": 994.1270751953125,
        "wires": []
    },
    {
        "id": "e630f16c.5dafb",
        "type": "aggregator",
        "z": "c1eaebbb.b6c98",
        "name": "1min mean",
        "topic": "apparentPowerB",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 632.3015747070312,
        "y": 892.6985778808594,
        "wires": [
            [
                "e0d98ef3.e2fc38"
            ]
        ]
    },
    {
        "id": "e0d98ef3.e2fc38",
        "type": "link out",
        "z": "c1eaebbb.b6c98",
        "name": "plugB_1m_apparentPower_avg",
        "links": [
            "faabef1f.ab9468"
        ],
        "x": 762.3016357421875,
        "y": 899.8414306640625,
        "wires": []
    },
    {
        "id": "458732d7.276ab4",
        "type": "aggregator",
        "z": "c1eaebbb.b6c98",
        "name": "1min mean",
        "topic": "currentB",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 605.15869140625,
        "y": 802.6986083984375,
        "wires": [
            [
                "eaa6bd62.254758"
            ]
        ]
    },
    {
        "id": "eaa6bd62.254758",
        "type": "link out",
        "z": "c1eaebbb.b6c98",
        "name": "plugB_1m_current_avg",
        "links": [
            "b0e1bcec.05d8e"
        ],
        "x": 742.301513671875,
        "y": 804.1271362304688,
        "wires": []
    },
    {
        "id": "f36ca3a5.292f98",
        "type": "link out",
        "z": "ef23770c.5edc1",
        "name": "Plug0dat",
        "links": [
            "51babec8.f64dd",
            "a6666087.111e78",
            "a202604f.dd093",
            "7162f143.514728",
            "32e676dd.a2517a",
            "e3cfee6b.c4afa",
            "3ec8be9b.5ddbd2",
            "957ed705.c5ff08",
            "7357f954.454df8",
            "6688bed.488dd4",
            "ce05f680.b57c4",
            "dffbed39.2565f",
            "7150a3cb.76da34",
            "35f4bfdd.a6a778",
            "e6909fbd.a16a28",
            "d54dc0f.56ed74",
            "33fef96f.a0932e",
            "3fe86b33.34615c",
            "bfbeee07.efbf88",
            "fbdaa90.38d7bd8",
            "df4aafb2.c0cdc8",
            "45c6ca82.a307dc",
            "c852e2c3.7d4dc8",
            "b1f138bf.a7e1d8",
            "1bb2dc23.2b852c",
            "12eae82e.a0c83",
            "b38df6db.bf79d8",
            "e2d35626.8bb458",
            "a656bb9e.db8c9",
            "54224389.5dac14",
            "df93444d.f42888",
            "857fc383.4e3e5",
            "1d1a6c39.41eeb4",
            "2a441638.501802",
            "96a1616f.66f4d8",
            "5776e8d1.919cd",
            "6699b95a.4941c8",
            "154516f9.a80059",
            "62e1fa63.61ecbc",
            "3032746d.45174c",
            "d6163892.554af",
            "153a657b.33e83b",
            "35d5dba2.f06364",
            "663e558f.848adc",
            "a5b517c9.76809",
            "599fe2fe.eb93c4",
            "6d2381d.dcf4a8"
        ],
        "x": 639.050048828125,
        "y": 171.04998779296875,
        "wires": []
    },
    {
        "id": "7b41bbcc.01e5f4",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plugA','realPower',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 702.6610717773438,
        "y": 1599.9111328125,
        "wires": [
            [
                "bad392b9.ff85f8"
            ]
        ]
    },
    {
        "id": "bad392b9.ff85f8",
        "type": "sqlite",
        "z": "be52c199.c86f58",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 911.494384765625,
        "y": 1600.9111328125,
        "wires": [
            []
        ]
    },
    {
        "id": "e4928e59.46308",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "Plug0A DB",
        "info": "",
        "x": 540.4942932128906,
        "y": 1493.0542602539062,
        "wires": []
    },
    {
        "id": "122450a6.3b2a67",
        "type": "link in",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "95e90acf.5e7258"
        ],
        "x": 354.0657958984375,
        "y": 1618.3161010742188,
        "wires": [
            [
                "c603b63a.3e27e",
                "7b41bbcc.01e5f4"
            ]
        ]
    },
    {
        "id": "b2b8a0d.b61e7e",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plugA','consumption',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 721.9229125976562,
        "y": 1653.1731567382812,
        "wires": [
            [
                "c88d4b83.702ef8"
            ]
        ]
    },
    {
        "id": "c88d4b83.702ef8",
        "type": "sqlite",
        "z": "be52c199.c86f58",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 923.7562255859375,
        "y": 1654.1731567382812,
        "wires": [
            []
        ]
    },
    {
        "id": "c603b63a.3e27e",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "det Wh minute",
        "func": "var last_minute = msg.payload;\n\nmsg.payload = Number((last_minute/60).toFixed(2));\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 530.9229125976562,
        "y": 1653.1731567382812,
        "wires": [
            [
                "b2b8a0d.b61e7e"
            ]
        ]
    },
    {
        "id": "bcf913ba.069ae",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "every minute",
        "info": "",
        "x": 347.06573486328125,
        "y": 1549.4591674804688,
        "wires": []
    },
    {
        "id": "5aa35b43.f6165c",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 678.2799072265625,
        "y": 1378.2806396484375,
        "wires": []
    },
    {
        "id": "87f375f7.f888a8",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "<==========Database==========>",
        "info": "",
        "x": 645.0299072265625,
        "y": 1416.5306396484375,
        "wires": []
    },
    {
        "id": "8a7f67ef.eed828",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plugA','current',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 639.8037109375,
        "y": 1745.625732421875,
        "wires": [
            [
                "fe0e699b.f29e3"
            ]
        ]
    },
    {
        "id": "fe0e699b.f29e3",
        "type": "sqlite",
        "z": "be52c199.c86f58",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 914.3515014648438,
        "y": 1745.1968994140625,
        "wires": [
            []
        ]
    },
    {
        "id": "7c75db6a.7c765c",
        "type": "link in",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "2e283f92.7d9ad8"
        ],
        "x": 388.3513488769531,
        "y": 1746.8880615234375,
        "wires": [
            [
                "2c0545b5.00256a"
            ]
        ]
    },
    {
        "id": "b8286516.82dc48",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plugA','apparentPower',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 640.5179443359375,
        "y": 1845.6258544921875,
        "wires": [
            [
                "855c35b1.4e3cd"
            ]
        ]
    },
    {
        "id": "855c35b1.4e3cd",
        "type": "sqlite",
        "z": "be52c199.c86f58",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 915.0657348632812,
        "y": 1845.197021484375,
        "wires": [
            []
        ]
    },
    {
        "id": "5159ca37.28c2b4",
        "type": "link in",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "246d985b.dfb818"
        ],
        "x": 389.0655822753906,
        "y": 1846.88818359375,
        "wires": [
            [
                "e0a88055.fda15"
            ]
        ]
    },
    {
        "id": "a48cd467.ce24f8",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plugA','powerFactor',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 639.08935546875,
        "y": 1925.6258544921875,
        "wires": [
            [
                "684208ca.b5838"
            ]
        ]
    },
    {
        "id": "684208ca.b5838",
        "type": "sqlite",
        "z": "be52c199.c86f58",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 913.6371459960938,
        "y": 1925.197021484375,
        "wires": [
            []
        ]
    },
    {
        "id": "70f7357d.5759d4",
        "type": "link in",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "c4ad34f0.9c009"
        ],
        "x": 387.6369934082031,
        "y": 1926.88818359375,
        "wires": [
            [
                "f376e185.1e3bf"
            ]
        ]
    },
    {
        "id": "61aa3ca1.dfb834",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plugB','realPower',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 674.4389038085938,
        "y": 1605.8278198242188,
        "wires": [
            [
                "2e1e9c13.e2dc74"
            ]
        ]
    },
    {
        "id": "2e1e9c13.e2dc74",
        "type": "sqlite",
        "z": "c1eaebbb.b6c98",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 883.272216796875,
        "y": 1606.8278198242188,
        "wires": [
            []
        ]
    },
    {
        "id": "1fe1949d.c1b28b",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "Plug0A DB",
        "info": "",
        "x": 513.2720947265625,
        "y": 1492.970947265625,
        "wires": []
    },
    {
        "id": "e7d16954.e40e2",
        "type": "link in",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "3c3d8db9.4d587a"
        ],
        "x": 325.8436279296875,
        "y": 1624.2327880859375,
        "wires": [
            [
                "db9e6463.4c85a",
                "61aa3ca1.dfb834"
            ]
        ]
    },
    {
        "id": "8615d30.770eeb",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plugB','consumption',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 693.7007446289062,
        "y": 1659.08984375,
        "wires": [
            [
                "7ba1d84c.e0d6b8"
            ]
        ]
    },
    {
        "id": "7ba1d84c.e0d6b8",
        "type": "sqlite",
        "z": "c1eaebbb.b6c98",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 895.5340576171875,
        "y": 1660.08984375,
        "wires": [
            []
        ]
    },
    {
        "id": "db9e6463.4c85a",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "det Wh minute",
        "func": "var last_minute = msg.payload;\n\nmsg.payload = Number((last_minute/60).toFixed(2));\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 502.70074462890625,
        "y": 1659.08984375,
        "wires": [
            [
                "8615d30.770eeb"
            ]
        ]
    },
    {
        "id": "844bff33.64e5a",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "every minute",
        "info": "",
        "x": 318.84356689453125,
        "y": 1555.3758544921875,
        "wires": []
    },
    {
        "id": "6def2d36.f53c94",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 650.0577392578125,
        "y": 1384.1973266601562,
        "wires": []
    },
    {
        "id": "516b5f70.54bf08",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "<==========Database==========>",
        "info": "",
        "x": 616.8077392578125,
        "y": 1422.4473266601562,
        "wires": []
    },
    {
        "id": "83f672ad.7cbae8",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plugB','current',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 611.58154296875,
        "y": 1751.5424194335938,
        "wires": [
            [
                "7963f718.9efcb8"
            ]
        ]
    },
    {
        "id": "7963f718.9efcb8",
        "type": "sqlite",
        "z": "c1eaebbb.b6c98",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 886.1293334960938,
        "y": 1751.1135864257812,
        "wires": [
            []
        ]
    },
    {
        "id": "b0e1bcec.05d8e",
        "type": "link in",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "eaa6bd62.254758"
        ],
        "x": 360.1291809082031,
        "y": 1752.8047485351562,
        "wires": [
            [
                "95cdd141.2690e"
            ]
        ]
    },
    {
        "id": "c83b3757.e9e53",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plugB','apparentPower',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 612.2957763671875,
        "y": 1851.5425415039062,
        "wires": [
            [
                "934e0a73.8d3db"
            ]
        ]
    },
    {
        "id": "934e0a73.8d3db",
        "type": "sqlite",
        "z": "c1eaebbb.b6c98",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 886.8435668945312,
        "y": 1851.1137084960938,
        "wires": [
            []
        ]
    },
    {
        "id": "faabef1f.ab9468",
        "type": "link in",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "e0d98ef3.e2fc38"
        ],
        "x": 360.8434143066406,
        "y": 1852.8048706054688,
        "wires": [
            [
                "3f9f0782.d06b28"
            ]
        ]
    },
    {
        "id": "29c92b83.07396c",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "Save to DB",
        "func": "var sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('plugB','powerFactor',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 610.8671875,
        "y": 1931.5425415039062,
        "wires": [
            [
                "c0c98c4b.6653d"
            ]
        ]
    },
    {
        "id": "c0c98c4b.6653d",
        "type": "sqlite",
        "z": "c1eaebbb.b6c98",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 885.4149780273438,
        "y": 1931.1137084960938,
        "wires": [
            []
        ]
    },
    {
        "id": "5a24ac0a.d8209c",
        "type": "link in",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "dce253af.0f45c8"
        ],
        "x": 359.4148254394531,
        "y": 1932.8048706054688,
        "wires": [
            [
                "b2ae6df0.433f7"
            ]
        ]
    },
    {
        "id": "c59bd702.99693",
        "type": "ui_gauge",
        "z": "ef23770c.5edc1",
        "name": "",
        "group": "29d0f416.9256cc",
        "order": 0,
        "width": 0,
        "height": 0,
        "gtype": "gage",
        "title": "Current",
        "label": "A",
        "format": "{{value}}",
        "min": 0,
        "max": "15",
        "colors": [
            "#00b500",
            "#e6e600",
            "#ca3838"
        ],
        "seg1": "5",
        "seg2": "10",
        "x": 1019.6755981445312,
        "y": 1094.112060546875,
        "wires": []
    },
    {
        "id": "df4af0a4.e79a38",
        "type": "comment",
        "z": "584b08c1.d6cff8",
        "name": "cost variables",
        "info": "",
        "x": 263.8515930175781,
        "y": 63.28021240234375,
        "wires": []
    },
    {
        "id": "99f19c75.415e58",
        "type": "comment",
        "z": "584b08c1.d6cff8",
        "name": "fixed cost",
        "info": "",
        "x": 319.8515930175781,
        "y": 113.28009033203125,
        "wires": []
    },
    {
        "id": "6b8ea746.7046b",
        "type": "comment",
        "z": "584b08c1.d6cff8",
        "name": "bi-cost",
        "info": "",
        "x": 307.8515930175781,
        "y": 223.28009033203125,
        "wires": []
    },
    {
        "id": "995e6d38.7589f",
        "type": "function",
        "z": "584b08c1.d6cff8",
        "name": "Set fixed energy cost",
        "func": "//0.1652\ntax = global.get(\"energy_tax\");\nvar cost = msg.payload*(1+tax);\ncost = Number((cost).toFixed(4));\nglobal.set(\"fixed_energy_cost\",cost);\n\nmsg.payload = cost;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 667.9152526855469,
        "y": 190.16893005371094,
        "wires": [
            []
        ]
    },
    {
        "id": "ce665d53.0b5a98",
        "type": "function",
        "z": "b24c4c5e.ac4c1",
        "name": "SQL",
        "func": "// This will handle any device and any attribute as long as it is in the DB\nvar p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\nvar sql = [];\nvar sourcelist = [];\nvar aggrlist = [];\nvar title = \"\";\n\n\n// Get the period and the list of data sources \n// also set some default values if one or the other does not exist yet\nsourcelist = context.get(\"sourcelist\");\nif (sourcelist===undefined) { // if running for the first time\n    sourcelist = [];\n}\nfromdate = context.get(\"fromdate\");\nif (fromdate===undefined) {\n    // set the period to a default if it is not selected yet\n    fromdate = current-p_1d;\n}\nenddate = context.get(\"enddate\");\nif (enddate===undefined) {\n    // set the period to a default if it is not selected yet\n    enddate = current;\n}\n\nswitch(msg.topic) {\n    case \"period\":\n        switch(msg.payload) {\n            case \"today\":\n                fromdate = today0h;\n                enddate = today0h+p_1d;\n                break;\n            case \"yesterday\":\n                fromdate = today0h-p_1d;\n                enddate = today0h;\n                break;\n            case \"thisweek\":\n                fromdate = monday0h;\n                enddate = monday0h+p_7d;\n                break;\n            case \"lastweek\":\n                fromdate = monday0h-p_7d;\n                enddate = monday0h;\n                break;\n            case \"last24h\":\n                fromdate = current-p_1d;\n                enddate = current;\n                break;\n            case \"last7d\":\n                fromdate = current-p_7d;\n                enddate = current;\n                break;\n            case \"last30d\":\n                fromdate = current-p_30d;\n                enddate = current;\n                break;\n            case \"last365d\":\n                fromdate = current-p_365d;\n                enddate = current;\n                break;\n        }\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"datasource\":\n        if (msg.payload===\"delete\") {\n            // remove all previous data sources\n            sourcelist = [];\n        } else {\n            sourcelist = context.get(\"sourcelist\");\n            if (sourcelist===undefined) { // if running for the first time\n                sourcelist = [];\n            }\n            sourcelist[0] = msg.payload;\n        }\n        context.set(\"sourcelist\",sourcelist);\n        break;\n    case \"minus1w\":\n        fromdate = fromdate-p_7d;\n        enddate = enddate-p_7d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"plus1w\":\n        fromdate = fromdate+p_7d;\n        enddate = enddate+p_7d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"minus1d\":\n        fromdate = fromdate-p_1d;\n        enddate = enddate-p_1d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"plus1d\":\n        fromdate = fromdate+p_1d;\n        enddate = enddate+p_1d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n}\n\n\n// Regenerate the SQL statements\n// Run through the data source list an generate the SQL statements\nsql = [];\nif (sourcelist.length>0) {\n    for (var i = 0; i < sourcelist.length; i++) {\n        var parts = sourcelist[i].split(\"/\");\n        sql.push({ topic: \"SELECT SUM(value) FROM sensor_data WHERE device='\"+parts[0]+\"' AND sensor='\"+parts[1]+\"' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n    }               \n\n} \nif (sql.length===0) {    \n    // Dummy select that returns nothing to clear the chart\n    sql.push({ topic: \"SELECT * FROM sensor_data WHERE device='xxxx'\" });\n}\n\n// set the completed flag for the join node later\nsql[sql.length-1].complete=true;\n// pass along the email flag to redirect the flow later\nif (msg.topic===\"email\") {\n    sql[sql.length-1].email=true;\n}\n\n// Generate report title\nif (sourcelist.length===0 && aggrlist.length===0) {\n    title = \"No data source\";\n} else {\n    if (sourcelist.length!==0) {\n        title = title + sourcelist.toString()+ \", \";\n    }\n    if (aggrlist.length!==0) {\n        title = title + aggrlist.toString()+ \", \";\n    }\n    title = title.substring(0,title.length-2);\n    title = title + \" | \";\n\n    var d = new Date();\n    d.setTime(fromdate);\n    var yyyy = d.getFullYear();\n    var mm = d.getMonth() < 9 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1); // getMonth() is zero-based\n    var dd  = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate();\n    var hh = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\n    var mmm  = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n    var ss  = d.getSeconds() < 10 ? \"0\" + d.getSeconds() : d.getSeconds();\n    title = title + dd + \".\" + mm + \".\" + yyyy;\n    d.setTime(enddate);\n    yyyy = d.getFullYear();\n    mm = d.getMonth() < 9 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1); // getMonth() is zero-based\n    dd  = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate();\n    hh = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\n    mmm  = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n    ss  = d.getSeconds() < 10 ? \"0\" + d.getSeconds() : d.getSeconds();\n    title = title + \" - \" + dd + \".\" + mm + \".\" + yyyy;\n}\nsql[sql.length-1].title=title;\n\nreturn [ sql ];\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 383.1055603027344,
        "y": 329.1388854980469,
        "wires": [
            [
                "90069b6f.a0292"
            ]
        ]
    },
    {
        "id": "90069b6f.a0292",
        "type": "sqlite",
        "z": "b24c4c5e.ac4c1",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 523.1055603027344,
        "y": 329.1388854980469,
        "wires": [
            [
                "d3dc6a7e.5a2068"
            ]
        ]
    },
    {
        "id": "f8776689.3caa3",
        "type": "inject",
        "z": "b24c4c5e.ac4c1",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 382.1333312988281,
        "y": 136,
        "wires": [
            [
                "36449bd4.1c9574",
                "778c505b.a689f8"
            ]
        ]
    },
    {
        "id": "c047396b.e0b75",
        "type": "ui_button",
        "z": "b24c4c5e.ac4c1",
        "name": "",
        "group": "d2a69f5d.cc4d48",
        "order": 6,
        "width": "2",
        "height": "1",
        "passthru": false,
        "label": "-1D",
        "color": "",
        "bgcolor": "",
        "icon": "chevron_left",
        "payload": "",
        "payloadType": "str",
        "topic": "minus1d",
        "x": 192.13333129882812,
        "y": 174,
        "wires": [
            [
                "169bc5a5.45705a",
                "ce665d53.0b5a98",
                "f0817793.2e5638"
            ]
        ]
    },
    {
        "id": "43c40b5.d8c5b74",
        "type": "ui_button",
        "z": "b24c4c5e.ac4c1",
        "name": "",
        "group": "d2a69f5d.cc4d48",
        "order": 8,
        "width": "2",
        "height": "1",
        "passthru": false,
        "label": "+1W",
        "color": "",
        "bgcolor": "",
        "icon": "chevron_right",
        "payload": "",
        "payloadType": "str",
        "topic": "plus1w",
        "x": 190.13333129882812,
        "y": 249,
        "wires": [
            [
                "169bc5a5.45705a",
                "ce665d53.0b5a98",
                "f0817793.2e5638"
            ]
        ]
    },
    {
        "id": "7f2525a4.10fe9c",
        "type": "ui_button",
        "z": "b24c4c5e.ac4c1",
        "name": "",
        "group": "d2a69f5d.cc4d48",
        "order": 7,
        "width": "2",
        "height": "1",
        "passthru": false,
        "label": "+1D",
        "color": "",
        "bgcolor": "",
        "icon": "chevron_right",
        "payload": "",
        "payloadType": "str",
        "topic": "plus1d",
        "x": 188.13333129882812,
        "y": 286,
        "wires": [
            [
                "169bc5a5.45705a",
                "ce665d53.0b5a98",
                "f0817793.2e5638"
            ]
        ]
    },
    {
        "id": "169bc5a5.45705a",
        "type": "change",
        "z": "b24c4c5e.ac4c1",
        "name": "Reset",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 380.1333312988281,
        "y": 196,
        "wires": [
            [
                "778c505b.a689f8"
            ]
        ]
    },
    {
        "id": "47b9336c.cf7f2c",
        "type": "ui_button",
        "z": "b24c4c5e.ac4c1",
        "name": "",
        "group": "d2a69f5d.cc4d48",
        "order": 5,
        "width": "2",
        "height": "1",
        "passthru": false,
        "label": "-1M",
        "color": "",
        "bgcolor": "",
        "icon": "chevron_left",
        "payload": "",
        "payloadType": "str",
        "topic": "minus1m",
        "x": 193.88333129882812,
        "y": 99,
        "wires": [
            [
                "169bc5a5.45705a",
                "ce665d53.0b5a98",
                "f0817793.2e5638"
            ]
        ]
    },
    {
        "id": "83ab4a57.2b4348",
        "type": "ui_button",
        "z": "b24c4c5e.ac4c1",
        "name": "",
        "group": "d2a69f5d.cc4d48",
        "order": 8,
        "width": "2",
        "height": "1",
        "passthru": false,
        "label": "+1M",
        "color": "",
        "bgcolor": "",
        "icon": "chevron_right",
        "payload": "",
        "payloadType": "str",
        "topic": "plus1m",
        "x": 188.88333129882812,
        "y": 211,
        "wires": [
            [
                "169bc5a5.45705a",
                "ce665d53.0b5a98",
                "f0817793.2e5638"
            ]
        ]
    },
    {
        "id": "8073da8b.2022e",
        "type": "ui_button",
        "z": "b24c4c5e.ac4c1",
        "name": "",
        "group": "d2a69f5d.cc4d48",
        "order": 5,
        "width": "2",
        "height": "1",
        "passthru": false,
        "label": "-1W",
        "color": "",
        "bgcolor": "",
        "icon": "chevron_left",
        "payload": "",
        "payloadType": "str",
        "topic": "minus1w",
        "x": 191.88333129882812,
        "y": 137,
        "wires": [
            [
                "169bc5a5.45705a",
                "ce665d53.0b5a98",
                "f0817793.2e5638"
            ]
        ]
    },
    {
        "id": "d3dc6a7e.5a2068",
        "type": "function",
        "z": "b24c4c5e.ac4c1",
        "name": "get value",
        "func": "//msg.payload = Math.round(6.688689);\n\nvar aux = msg.payload[0];\naux = aux[\"SUM(value)\"];\n\nmsg.payload = Number(aux.toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 672.9942626953125,
        "y": 329.54998779296875,
        "wires": [
            [
                "36161a23.cde18e",
                "84a57baa.6935a",
                "16d356c.972e7a9"
            ]
        ]
    },
    {
        "id": "1919aae9.9260cd",
        "type": "ui_text",
        "z": "b24c4c5e.ac4c1",
        "group": "fd2f3e1.36366c",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Consumption",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1134.210693359375,
        "y": 329.28887939453125,
        "wires": []
    },
    {
        "id": "84a57baa.6935a",
        "type": "function",
        "z": "b24c4c5e.ac4c1",
        "name": "get price",
        "func": "var cost = global.get(\"fixed_energy_cost\");\nvar today_cost = 0;\n\ntoday_cost = (msg.payload/1000)*cost\n\nmsg.payload = Number((today_cost).toFixed(4));\n\nmsg.payload = msg.payload + \" \";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 890.27783203125,
        "y": 389.72222900390625,
        "wires": [
            [
                "eec56ad5.c7b938"
            ]
        ]
    },
    {
        "id": "eec56ad5.c7b938",
        "type": "ui_text",
        "z": "b24c4c5e.ac4c1",
        "group": "fd2f3e1.36366c",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Cost",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1115.3387451171875,
        "y": 393.2778015136719,
        "wires": []
    },
    {
        "id": "36161a23.cde18e",
        "type": "function",
        "z": "b24c4c5e.ac4c1",
        "name": "define magnitude",
        "func": "if (msg.payload > 1000){\n    msg.payload = msg.payload/1000;\n    msg.payload = Number((msg.payload).toFixed(2));\n    msg.payload = msg.payload + \" kWh\";\n}else{\n    msg.payload = msg.payload + \" Wh\";\n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 913.6109619140625,
        "y": 328.6111145019531,
        "wires": [
            [
                "1919aae9.9260cd"
            ]
        ]
    },
    {
        "id": "dc0df16e.ffd748",
        "type": "change",
        "z": "b24c4c5e.ac4c1",
        "name": "Title",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "title",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1012.333251953125,
        "y": 266.1666564941406,
        "wires": [
            [
                "b7fd259f.05b2a"
            ]
        ]
    },
    {
        "id": "b7fd259f.05b2a",
        "type": "ui_text",
        "z": "b24c4c5e.ac4c1",
        "group": "8f5c5d5f.ac21d",
        "order": 1,
        "width": "0",
        "height": "0",
        "name": "Chart title",
        "label": "",
        "format": "{{msg.payload}}",
        "layout": "row-center",
        "x": 1164.333251953125,
        "y": 266.1666564941406,
        "wires": []
    },
    {
        "id": "93fa16d4.4a838",
        "type": "comment",
        "z": "584b08c1.d6cff8",
        "name": "Time",
        "info": "",
        "x": 324.8333740234375,
        "y": 716.6111450195312,
        "wires": []
    },
    {
        "id": "cac5c1d1.8375b8",
        "type": "function",
        "z": "584b08c1.d6cff8",
        "name": "Set day cost hour",
        "func": "global.set(\"day_cost_hour\",msg.payload);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 655.95263671875,
        "y": 838.27783203125,
        "wires": [
            []
        ]
    },
    {
        "id": "a350f701.cf068",
        "type": "function",
        "z": "584b08c1.d6cff8",
        "name": "Set night cost hour",
        "func": "global.set(\"night_cost_hour\",msg.payload);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 657.0556030273438,
        "y": 934.9445190429688,
        "wires": [
            []
        ]
    },
    {
        "id": "e0bf91fe.611e38",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore fixed_energy_cost",
        "func": "msg.topic = \"fixed_energy_cost\";\nmsg.payload = global.get(\"fixed_energy_cost\");\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 516.611083984375,
        "y": 836.1666870117188,
        "wires": [
            [
                "b9ec789e.311ed"
            ]
        ]
    },
    {
        "id": "b9ec789e.311ed",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_fixed_cost",
        "links": [
            "90dfb8fe.a131a"
        ],
        "x": 683.9629516601562,
        "y": 835.6111450195312,
        "wires": []
    },
    {
        "id": "daed444c.ae337",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore bi_day_energy_cost",
        "func": "msg.topic = \"bi_day_energy_cost\";\nmsg.payload = global.get(\"bi_day_energy_cost\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 525.5,
        "y": 890.6111450195312,
        "wires": [
            [
                "9074d5cf.c60e9"
            ]
        ]
    },
    {
        "id": "9074d5cf.c60e9",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_day_cost",
        "links": [
            "47cf9ba2.be3574",
            "db99943e.2a4a6",
            "9efc1657.883628"
        ],
        "x": 687.29638671875,
        "y": 891.1666870117188,
        "wires": []
    },
    {
        "id": "89bac48c.03a6d",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore energy_tax",
        "func": "msg.topic = \"energy_tax\";\nmsg.payload = global.get(\"energy_tax\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 496.61114501953125,
        "y": 988.388916015625,
        "wires": [
            [
                "10c1709c.23cedf"
            ]
        ]
    },
    {
        "id": "10c1709c.23cedf",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_tax",
        "links": [
            "faee50.4d8c39b",
            "bd0e91fd.0d2698",
            "da11d813.9b5e98"
        ],
        "x": 677.29638671875,
        "y": 988.9443969726562,
        "wires": []
    },
    {
        "id": "4c9e928a.5cff04",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore day_cost_hour",
        "func": "msg.topic = \"day_cost_hour\";\nmsg.payload = global.get(\"day_cost_hour\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 508.83331298828125,
        "y": 1035.0556640625,
        "wires": [
            [
                "858278ff.eb167"
            ]
        ]
    },
    {
        "id": "858278ff.eb167",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_day_hour",
        "links": [
            "49661278.78d894"
        ],
        "x": 683.9630126953125,
        "y": 1033.3889770507812,
        "wires": []
    },
    {
        "id": "dcbdf519.188a98",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore night_cost_hour",
        "func": "msg.topic = \"night_cost_hour\";\nmsg.payload = global.get(\"night_cost_hour\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 517.7222290039062,
        "y": 1083.944580078125,
        "wires": [
            [
                "d7cd5103.4a1d2"
            ]
        ]
    },
    {
        "id": "d7cd5103.4a1d2",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_night_hour",
        "links": [
            "399f5635.9ad072"
        ],
        "x": 682.8519287109375,
        "y": 1082.2778930664062,
        "wires": []
    },
    {
        "id": "80188192.4391b",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore bi_night_energy_cost",
        "func": "msg.topic = \"bi_night_energy_cost\";\nmsg.payload = global.get(\"bi_night_energy_cost\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 523.2777709960938,
        "y": 936.1668701171875,
        "wires": [
            [
                "29ea263e.c39342"
            ]
        ]
    },
    {
        "id": "29ea263e.c39342",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_night_cost",
        "links": [
            "1bae9331.040365",
            "40d05032.3f93a",
            "92396afb.d4938"
        ],
        "x": 689.5185546875,
        "y": 934.5001831054688,
        "wires": []
    },
    {
        "id": "90dfb8fe.a131a",
        "type": "link in",
        "z": "584b08c1.d6cff8",
        "name": "",
        "links": [
            "b9ec789e.311ed"
        ],
        "x": 485.9630126953125,
        "y": 130.55555725097656,
        "wires": [
            [
                "cf938085.209bf8"
            ]
        ]
    },
    {
        "id": "49661278.78d894",
        "type": "link in",
        "z": "584b08c1.d6cff8",
        "name": "",
        "links": [
            "858278ff.eb167"
        ],
        "x": 470.3889465332031,
        "y": 770.5000457763672,
        "wires": [
            [
                "7f82a180.e5b27"
            ]
        ]
    },
    {
        "id": "399f5635.9ad072",
        "type": "link in",
        "z": "584b08c1.d6cff8",
        "name": "",
        "links": [
            "d7cd5103.4a1d2",
            "92e74f8e.536b",
            "5b454428.1c4fe4"
        ],
        "x": 471.5000305175781,
        "y": 878.2780609130859,
        "wires": [
            [
                "7ae22809.d63a5"
            ]
        ]
    },
    {
        "id": "269b0b06.198fb4",
        "type": "function",
        "z": "584b08c1.d6cff8",
        "name": "Save day energy cost",
        "func": "//0.1652\ntax = global.get(\"energy_tax\");\nvar cost = msg.payload*(1+tax);\ncost = Number((cost).toFixed(4));\nglobal.set(\"bi_day_energy_cost\",cost);\n\nmsg.payload = cost;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 656.388916015625,
        "y": 298.6111145019531,
        "wires": [
            []
        ]
    },
    {
        "id": "49d44b84.cd61c4",
        "type": "function",
        "z": "584b08c1.d6cff8",
        "name": "Save night energy cost",
        "func": "//0.1652\ntax = global.get(\"energy_tax\");\nvar cost = msg.payload*(1+tax);\ncost = Number((cost).toFixed(4));\nglobal.set(\"bi_night_energy_cost\",cost);\n\nmsg.payload = cost;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 679.4501037597656,
        "y": 398.7833557128906,
        "wires": [
            []
        ]
    },
    {
        "id": "9efc1657.883628",
        "type": "link in",
        "z": "584b08c1.d6cff8",
        "name": "",
        "links": [
            "9074d5cf.c60e9"
        ],
        "x": 477.9130554199219,
        "y": 232.94998168945312,
        "wires": [
            [
                "22751095.cf764"
            ]
        ]
    },
    {
        "id": "92396afb.d4938",
        "type": "link in",
        "z": "584b08c1.d6cff8",
        "name": "",
        "links": [
            "29ea263e.c39342"
        ],
        "x": 478.339111328125,
        "y": 332.11669921875,
        "wires": [
            [
                "f1cf9475.f1824"
            ]
        ]
    },
    {
        "id": "9e26d1e7.a6508",
        "type": "comment",
        "z": "584b08c1.d6cff8",
        "name": "TAX",
        "info": "",
        "x": 317.9444580078125,
        "y": 540.6111450195312,
        "wires": []
    },
    {
        "id": "8d869708.ddad3",
        "type": "function",
        "z": "584b08c1.d6cff8",
        "name": "set tax value",
        "func": "//0.1652\nglobal.set(\"energy_tax\",msg.payload/100);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 667.063720703125,
        "y": 631.2778472900391,
        "wires": [
            []
        ]
    },
    {
        "id": "da11d813.9b5e98",
        "type": "link in",
        "z": "584b08c1.d6cff8",
        "name": "",
        "links": [
            "10c1709c.23cedf"
        ],
        "x": 508.16668701171875,
        "y": 570.1666870117188,
        "wires": [
            [
                "89664a02.b71be"
            ]
        ]
    },
    {
        "id": "cf938085.209bf8",
        "type": "ui_text",
        "z": "584b08c1.d6cff8",
        "group": "6e68fe26.a57b88",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Energy fixed cost",
        "format": "{{msg.payload}} ",
        "layout": "row-spread",
        "x": 666.388916015625,
        "y": 140.83334350585938,
        "wires": []
    },
    {
        "id": "cd83709b.6aaf18",
        "type": "ui_text_input",
        "z": "584b08c1.d6cff8",
        "name": "",
        "label": "change cost",
        "group": "6e68fe26.a57b88",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 430.8333740234375,
        "y": 168.61111450195312,
        "wires": [
            [
                "995e6d38.7589f",
                "cf938085.209bf8"
            ]
        ]
    },
    {
        "id": "22751095.cf764",
        "type": "ui_text",
        "z": "584b08c1.d6cff8",
        "group": "6e68fe26.a57b88",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Energy day cost",
        "format": "{{msg.payload}} ",
        "layout": "row-spread",
        "x": 660.8333740234375,
        "y": 251.9444580078125,
        "wires": []
    },
    {
        "id": "c68e851d.95352",
        "type": "ui_text_input",
        "z": "584b08c1.d6cff8",
        "name": "",
        "label": "change cost",
        "group": "6e68fe26.a57b88",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 436.388916015625,
        "y": 274.16668701171875,
        "wires": [
            [
                "22751095.cf764",
                "269b0b06.198fb4"
            ]
        ]
    },
    {
        "id": "f1cf9475.f1824",
        "type": "ui_text",
        "z": "584b08c1.d6cff8",
        "group": "6e68fe26.a57b88",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Energy night cost",
        "format": "{{msg.payload}} ",
        "layout": "row-spread",
        "x": 669.7222900390625,
        "y": 353.0555725097656,
        "wires": []
    },
    {
        "id": "bca5dba5.b65f8",
        "type": "ui_text_input",
        "z": "584b08c1.d6cff8",
        "name": "",
        "label": "change cost",
        "group": "6e68fe26.a57b88",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 443.05560302734375,
        "y": 374.16668701171875,
        "wires": [
            [
                "49d44b84.cd61c4",
                "f1cf9475.f1824"
            ]
        ]
    },
    {
        "id": "89664a02.b71be",
        "type": "ui_text",
        "z": "584b08c1.d6cff8",
        "group": "6e68fe26.a57b88",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "TAX percentage",
        "format": "{{msg.payload}} %",
        "layout": "row-spread",
        "x": 674.8333740234375,
        "y": 569.0555419921875,
        "wires": []
    },
    {
        "id": "7ee9082.9ef7878",
        "type": "ui_text_input",
        "z": "584b08c1.d6cff8",
        "name": "",
        "label": "change percentage",
        "group": "6e68fe26.a57b88",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 430.388916015625,
        "y": 627.9444580078125,
        "wires": [
            [
                "8d869708.ddad3",
                "89664a02.b71be"
            ]
        ]
    },
    {
        "id": "7f82a180.e5b27",
        "type": "ui_text",
        "z": "584b08c1.d6cff8",
        "group": "3ed23385.374b5c",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Day cost starting time",
        "format": "{{msg.payload}} ",
        "layout": "row-spread",
        "x": 657.0556030273438,
        "y": 784.9445037841797,
        "wires": []
    },
    {
        "id": "3a3aa19b.01076e",
        "type": "ui_text_input",
        "z": "584b08c1.d6cff8",
        "name": "",
        "label": "change hour HH:MM",
        "group": "3ed23385.374b5c",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 392.61114501953125,
        "y": 837.1666717529297,
        "wires": [
            [
                "cac5c1d1.8375b8",
                "7f82a180.e5b27"
            ]
        ]
    },
    {
        "id": "7ae22809.d63a5",
        "type": "ui_text",
        "z": "584b08c1.d6cff8",
        "group": "3ed23385.374b5c",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Night cost starting time",
        "format": "{{msg.payload}} ",
        "layout": "row-spread",
        "x": 655.9445190429688,
        "y": 884.9445648193359,
        "wires": []
    },
    {
        "id": "645a4d10.efc3e4",
        "type": "ui_text_input",
        "z": "584b08c1.d6cff8",
        "name": "",
        "label": "change hour HH:MM",
        "group": "3ed23385.374b5c",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 397.05560302734375,
        "y": 928.6111907958984,
        "wires": [
            [
                "7ae22809.d63a5",
                "a350f701.cf068"
            ]
        ]
    },
    {
        "id": "f0817793.2e5638",
        "type": "function",
        "z": "b24c4c5e.ac4c1",
        "name": "SQL",
        "func": "// This will handle any device and any attribute as long as it is in the DB\nvar p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\nvar sql = [];\nvar sourcelist = [];\nvar aggrlist = [];\nvar title = \"\";\n\n\n// Get the period and the list of data sources \n// also set some default values if one or the other does not exist yet\nsourcelist = context.get(\"sourcelist\");\nif (sourcelist===undefined) { // if running for the first time\n    sourcelist = [];\n}\nfromdate = context.get(\"fromdate\");\nif (fromdate===undefined) {\n    // set the period to a default if it is not selected yet\n    fromdate = current-p_1d;\n}\nenddate = context.get(\"enddate\");\nif (enddate===undefined) {\n    // set the period to a default if it is not selected yet\n    enddate = current;\n}\n\nswitch(msg.topic) {\n    case \"period\":\n        switch(msg.payload) {\n            case \"today\":\n                fromdate = today0h;\n                enddate = today0h+p_1d;\n                break;\n            case \"yesterday\":\n                fromdate = today0h-p_1d;\n                enddate = today0h;\n                break;\n            case \"thisweek\":\n                fromdate = monday0h;\n                enddate = monday0h+p_7d;\n                break;\n            case \"lastweek\":\n                fromdate = monday0h-p_7d;\n                enddate = monday0h;\n                break;\n            case \"last24h\":\n                fromdate = current-p_1d;\n                enddate = current;\n                break;\n            case \"last7d\":\n                fromdate = current-p_7d;\n                enddate = current;\n                break;\n            case \"last30d\":\n                fromdate = current-p_30d;\n                enddate = current;\n                break;\n            case \"last365d\":\n                fromdate = current-p_365d;\n                enddate = current;\n                break;\n        }\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"datasource\":\n        if (msg.payload===\"delete\") {\n            // remove all previous data sources\n            sourcelist = [];\n        } else {\n            sourcelist = context.get(\"sourcelist\");\n            if (sourcelist===undefined) { // if running for the first time\n                sourcelist = [];\n            }\n            sourcelist[0] = msg.payload;\n        }\n        context.set(\"sourcelist\",sourcelist);\n        break;\n    case \"minus1w\":\n        fromdate = fromdate-p_7d;\n        enddate = enddate-p_7d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"plus1w\":\n        fromdate = fromdate+p_7d;\n        enddate = enddate+p_7d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"minus1d\":\n        fromdate = fromdate-p_1d;\n        enddate = enddate-p_1d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n    case \"plus1d\":\n        fromdate = fromdate+p_1d;\n        enddate = enddate+p_1d;\n        context.set(\"fromdate\",fromdate);\n        context.set(\"enddate\",enddate);\n        break;\n}\n\n\n// Regenerate the SQL statements\n// Run through the data source list an generate the SQL statements\nsql = [];\nif (sourcelist.length>0) {\n    for (var i = 0; i < sourcelist.length; i++) {\n        var parts = sourcelist[i].split(\"/\");\n        sql.push({ topic: \"SELECT * FROM sensor_data WHERE device='\"+parts[0]+\"' AND sensor='\"+parts[1]+\"' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n    }               \n\n} \nif (sql.length===0) {    \n    // Dummy select that returns nothing to clear the chart\n    sql.push({ topic: \"SELECT * FROM sensor_data WHERE device='xxxx'\" });\n}\n\n// set the completed flag for the join node later\nsql[sql.length-1].complete=true;\n// pass along the email flag to redirect the flow later\nif (msg.topic===\"email\") {\n    sql[sql.length-1].email=true;\n}\n\n// Generate report title\nif (sourcelist.length===0 && aggrlist.length===0) {\n    title = \"No data source\";\n} else {\n    if (sourcelist.length!==0) {\n        title = title + sourcelist.toString()+ \", \";\n    }\n    if (aggrlist.length!==0) {\n        title = title + aggrlist.toString()+ \", \";\n    }\n    title = title.substring(0,title.length-2);\n    title = title + \" | \";\n\n    var d = new Date();\n    d.setTime(fromdate);\n    var yyyy = d.getFullYear();\n    var mm = d.getMonth() < 9 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1); // getMonth() is zero-based\n    var dd  = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate();\n    var hh = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\n    var mmm  = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n    var ss  = d.getSeconds() < 10 ? \"0\" + d.getSeconds() : d.getSeconds();\n    title = title + dd + \".\" + mm + \".\" + yyyy;\n    d.setTime(enddate);\n    yyyy = d.getFullYear();\n    mm = d.getMonth() < 9 ? \"0\" + (d.getMonth() + 1) : (d.getMonth() + 1); // getMonth() is zero-based\n    dd  = d.getDate() < 10 ? \"0\" + d.getDate() : d.getDate();\n    hh = d.getHours() < 10 ? \"0\" + d.getHours() : d.getHours();\n    mmm  = d.getMinutes() < 10 ? \"0\" + d.getMinutes() : d.getMinutes();\n    ss  = d.getSeconds() < 10 ? \"0\" + d.getSeconds() : d.getSeconds();\n    title = title + \" - \" + dd + \".\" + mm + \".\" + yyyy;\n}\nsql[sql.length-1].title=title;\n\nreturn [ sql ];\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 383.75,
        "y": 484.75,
        "wires": [
            [
                "402168d.4256c98"
            ]
        ]
    },
    {
        "id": "402168d.4256c98",
        "type": "sqlite",
        "z": "b24c4c5e.ac4c1",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 513.892822265625,
        "y": 484.3214111328125,
        "wires": [
            [
                "8f366d99.a66c08"
            ]
        ]
    },
    {
        "id": "3ea38cd4.01c89c",
        "type": "function",
        "z": "b24c4c5e.ac4c1",
        "name": "bi cost calc",
        "func": "day_time = global.get(\"day_cost_hour\");\nnight_time = global.get(\"night_cost_hour\");\n\nvar d_time = day_time.split(\":\");\nvar n_time = night_time.split(\":\");\n\nvar day_total = 0;\nvar night_total = 0;\n\n/*\nvar now     = new Date(); \nvar year    = now.getFullYear();\nvar month   = now.getMonth()+1; \nvar day     = now.getDate();\nvar hour    = now.getHours();\nvar minute  = now.getMinutes();\nvar second  = now.getSeconds(); \n*/\n\nif (msg.payload[0].length>0) {\n    // this is the logic when there are multiple data sets are received\n    for (var i=0; i<msg.payload.length; i++) {\n\n        for (var j=0; j<msg.payload[i].length; j++) {\n            var aux = msg.payload[i][j].epoch;\n            var date = new Date(aux);\n            aux = date;\n            \n            console.log(d_time[0]);\n            console.log(d_time[1]);\n            console.log(n_time[0]);\n            console.log(n_time[1]);\n            \n            //check if value fits hour interval\n            if ( (aux.getHours() > d_time[0]) && (aux.getHours() < n_time[0]) ){\n                day_total += msg.payload[i][j].value;\n            }else{\n                //check if value fits left minute interval\n                if ( (aux.getHours() == d_time[0]) && (aux.getMinutes() >= d_time[1]) ){\n                    day_total += msg.payload[i][j].value;\n                }else{\n                    if ( (aux.getHours() == n_time[0]) && (aux.getMinutes() <= n_time[1]) ){\n                        day_total += msg.payload[i][j].value;\n                    }else{\n                        night_total += msg.payload[i][j].value;\n                    }   \n                }\n            }\n                \n        }\n        \n    }\n} \n\nday_total = Number((day_total).toFixed(2));\nnight_total = Number((night_total).toFixed(2));\n\nvar total = {day: day_total, night: night_total};\n\nmsg.payload = total;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 807.75,
        "y": 484.75,
        "wires": [
            [
                "d41a8ccc.50cf68",
                "36ba29a3.ed8456",
                "eaa79bb8.650978",
                "3ca97395.e2d604",
                "2a56637f.a5a4b4"
            ]
        ]
    },
    {
        "id": "7283311a.a43d58",
        "type": "ui_text",
        "z": "b24c4c5e.ac4c1",
        "group": "11870185.d80c26",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Day consumption",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1215.75,
        "y": 482.75,
        "wires": []
    },
    {
        "id": "d9cb4676.a1dcc",
        "type": "ui_text",
        "z": "b24c4c5e.ac4c1",
        "group": "11870185.d80c26",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Night consumption",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1219.75,
        "y": 583.75,
        "wires": []
    },
    {
        "id": "d41a8ccc.50cf68",
        "type": "function",
        "z": "b24c4c5e.ac4c1",
        "name": "define magnitude",
        "func": "msg.payload = msg.payload.night;\n\nif (msg.payload > 1000){\n    msg.payload = msg.payload/1000;\n    msg.payload = Number((msg.payload).toFixed(2));\n    msg.payload = msg.payload + \" kWh\";\n}else{\n    msg.payload = msg.payload + \" Wh\";\n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1014.75,
        "y": 583.75,
        "wires": [
            [
                "d9cb4676.a1dcc"
            ]
        ]
    },
    {
        "id": "36ba29a3.ed8456",
        "type": "function",
        "z": "b24c4c5e.ac4c1",
        "name": "define magnitude",
        "func": "msg.payload = msg.payload.day;\n\nif (msg.payload > 1000){\n    msg.payload = msg.payload/1000;\n    msg.payload = Number((msg.payload).toFixed(2));\n    msg.payload = msg.payload + \" kWh\";\n}else{\n    msg.payload = msg.payload + \" Wh\";\n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1007.75,
        "y": 483.75,
        "wires": [
            [
                "7283311a.a43d58"
            ]
        ]
    },
    {
        "id": "eaa79bb8.650978",
        "type": "function",
        "z": "b24c4c5e.ac4c1",
        "name": "get price day ",
        "func": "var cost = global.get(\"bi_day_energy_cost\");\nvar today_cost = 0;\n\ntoday_cost = (msg.payload.day/1000)*cost\n\nmsg.payload = Number((today_cost).toFixed(4));\n\nmsg.payload = msg.payload + \" \";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1011.75,
        "y": 535.75,
        "wires": [
            [
                "13dc93e.58e92ec"
            ]
        ]
    },
    {
        "id": "13dc93e.58e92ec",
        "type": "ui_text",
        "z": "b24c4c5e.ac4c1",
        "group": "11870185.d80c26",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Day cost",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1238.8109130859375,
        "y": 537.3055419921875,
        "wires": []
    },
    {
        "id": "3ca97395.e2d604",
        "type": "function",
        "z": "b24c4c5e.ac4c1",
        "name": "get price night",
        "func": "var cost = global.get(\"bi_night_energy_cost\");\nvar today_cost = 0;\n\ntoday_cost = (msg.payload.night/1000)*cost\n\nmsg.payload = Number((today_cost).toFixed(4));\n\nmsg.payload = msg.payload + \" \";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1015.75,
        "y": 629.75,
        "wires": [
            [
                "a9e527db.155758"
            ]
        ]
    },
    {
        "id": "a9e527db.155758",
        "type": "ui_text",
        "z": "b24c4c5e.ac4c1",
        "group": "11870185.d80c26",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Night cost",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1232.8109130859375,
        "y": 631.3055419921875,
        "wires": []
    },
    {
        "id": "36449bd4.1c9574",
        "type": "ui_dropdown",
        "z": "b24c4c5e.ac4c1",
        "name": "Data source",
        "label": "",
        "place": "",
        "group": "d2a69f5d.cc4d48",
        "order": 1,
        "width": "5",
        "height": "1",
        "passthru": false,
        "options": [
            {
                "label": "[Remove all]",
                "value": "delete",
                "type": "str"
            },
            {
                "label": "Plug 0",
                "value": "plug0/consumption",
                "type": "str"
            },
            {
                "label": "Plug A",
                "value": "plugA/consumption",
                "type": "str"
            },
            {
                "label": "Plug B",
                "value": "plugB/consumption",
                "type": "str"
            },
            {
                "label": "Plug 1",
                "value": "plug1/consumption",
                "type": "str"
            },
            {
                "label": "Plug 2",
                "value": "plug2/consumption",
                "type": "str"
            },
            {
                "label": "Plug 3",
                "value": "plug3/consumption",
                "type": "str"
            },
            {
                "label": "Plug 4",
                "value": "plug4/consumption",
                "type": "str"
            },
            {
                "label": "Solar production",
                "value": "solar/production",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "datasource",
        "x": 573.75,
        "y": 136.75,
        "wires": [
            [
                "ce665d53.0b5a98",
                "f0817793.2e5638",
                "da8e74ba.04bc18"
            ]
        ]
    },
    {
        "id": "778c505b.a689f8",
        "type": "ui_dropdown",
        "z": "b24c4c5e.ac4c1",
        "name": "Period",
        "label": "",
        "place": "",
        "group": "d2a69f5d.cc4d48",
        "order": 4,
        "width": "4",
        "height": "1",
        "passthru": false,
        "options": [
            {
                "label": "Today",
                "value": "today",
                "type": "str"
            },
            {
                "label": "Yesterday",
                "value": "yesterday",
                "type": "str"
            },
            {
                "label": "This week",
                "value": "thisweek",
                "type": "str"
            },
            {
                "label": "Last week",
                "value": "lastweek",
                "type": "str"
            },
            {
                "label": "Last 24 hours",
                "value": "last24h",
                "type": "str"
            },
            {
                "label": "Last 7 days",
                "value": "last7d",
                "type": "str"
            },
            {
                "label": "Last 30 days",
                "value": "last30d",
                "type": "str"
            },
            {
                "label": "Last 365 days",
                "value": "last365d",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "period",
        "x": 563.75,
        "y": 197.75,
        "wires": [
            [
                "ce665d53.0b5a98",
                "f0817793.2e5638",
                "1fceff76.efeb39"
            ]
        ]
    },
    {
        "id": "2a56637f.a5a4b4",
        "type": "function",
        "z": "b24c4c5e.ac4c1",
        "name": "get Bi price ",
        "func": "var cost = global.get(\"bi_day_energy_cost\");\nvar today_cost = 0;\n\ntoday_cost = (msg.payload.day/1000)*cost\n\nvar day_total = Number((today_cost).toFixed(4));\n\ncost = global.get(\"bi_night_energy_cost\");\ntoday_cost = 0;\n\ntoday_cost = (msg.payload.night/1000)*cost\n\nvar night_total = Number((today_cost).toFixed(4));\n\nvar total = day_total + night_total;\n\ntotal = Number((total).toFixed(4));\n\nmsg.payload = total + \" \";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010.75,
        "y": 683.75,
        "wires": [
            [
                "ee4034f7.e354f8"
            ]
        ]
    },
    {
        "id": "ee4034f7.e354f8",
        "type": "ui_text",
        "z": "b24c4c5e.ac4c1",
        "group": "11870185.d80c26",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Total Bi cost",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1247.8109130859375,
        "y": 685.3055419921875,
        "wires": []
    },
    {
        "id": "16d356c.972e7a9",
        "type": "join",
        "z": "b24c4c5e.ac4c1",
        "name": "",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "timeout": "",
        "count": "",
        "x": 874.7222900390625,
        "y": 269.72222900390625,
        "wires": [
            [
                "dc0df16e.ffd748"
            ]
        ]
    },
    {
        "id": "8f366d99.a66c08",
        "type": "join",
        "z": "b24c4c5e.ac4c1",
        "name": "",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "timeout": "",
        "count": "",
        "x": 641.75,
        "y": 484.75,
        "wires": [
            [
                "3ea38cd4.01c89c"
            ]
        ]
    },
    {
        "id": "da8e74ba.04bc18",
        "type": "debug",
        "z": "b24c4c5e.ac4c1",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 817.8571166992188,
        "y": 137.14283752441406,
        "wires": []
    },
    {
        "id": "1fceff76.efeb39",
        "type": "debug",
        "z": "b24c4c5e.ac4c1",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 821.8095703125,
        "y": 188.95240783691406,
        "wires": []
    },
    {
        "id": "20c5593b.c7241e",
        "type": "ui_template",
        "z": "2cf1d395.65be64",
        "group": "e0f33dce.f6675",
        "name": "Trend",
        "order": 3,
        "width": "4",
        "height": "3",
        "format": "<div layout=\"row\" layout-align=\"space-between\">\n    <table width=\"100%\" height=\"100%\">\n        <tr>\n            <td colspan=\"2\">{{msg.title}}</td>\n        </tr>\n        <tr>\n            <td rowspan=\"2\" style=\"text-align: center;\"><span style=\"font-size: 300%; font-weight: bold;\">{{msg.current}}</span><br/>{{msg.unit}}</td>\n            <td style=\"text-align: center; font-size: 300%; font-weight: bold;\" ng-style=\"{color: msg.trend === 'up' ? 'green' : 'red'}\">{{(msg.trend === 'up') ? '&#8679;' : '&#8681;'}}</td>\n        </tr>\n        <tr>\n            <td style=\"text-align: center; font-style: italic;\">{{msg.reference}}</td>\n        </tr>\n    </table>\n</div>",
        "storeOutMessages": false,
        "fwdInMessages": false,
        "templateScope": "local",
        "x": 1043.7401733398438,
        "y": 1622.5107421875,
        "wires": [
            []
        ]
    },
    {
        "id": "4cbb2e1d.32bf88",
        "type": "inject",
        "z": "2cf1d395.65be64",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "01 00 * * *",
        "once": false,
        "x": 217.07351684570312,
        "y": 1623.5107727050781,
        "wires": [
            [
                "1a531d7b.3b4e83",
                "c47b33de.447678",
                "d142439.492df4"
            ]
        ]
    },
    {
        "id": "1a531d7b.3b4e83",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "SQL",
        "func": "var p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\nvar sql = [];\n\nfromdate = today0h - p_30d;\nenddate = today0h;\nsql.push({ topic: \"SELECT sum(value) AS value FROM sensor_data WHERE device='solar' AND sensor='production' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n\nfromdate = fromdate - p_30d;\nenddate = enddate - p_30d;\nsql.push({ topic: \"SELECT sum(value) AS value FROM sensor_data WHERE device='solar' AND sensor='production' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n\n// set the completed flag for the join node later\nsql[sql.length-1].complete=true;\n\nreturn [ sql ];",
        "outputs": 1,
        "noerr": 0,
        "x": 442.74017333984375,
        "y": 1623.5107421875,
        "wires": [
            [
                "dae92716.08532"
            ]
        ]
    },
    {
        "id": "dae92716.08532",
        "type": "sqlite",
        "z": "2cf1d395.65be64",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 587.7401733398438,
        "y": 1622.5107421875,
        "wires": [
            [
                "83c3c86e.68e8d"
            ]
        ]
    },
    {
        "id": "83c3c86e.68e8d",
        "type": "join",
        "z": "2cf1d395.65be64",
        "name": "",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "timeout": "",
        "count": "",
        "x": 720.7401733398438,
        "y": 1622.5107421875,
        "wires": [
            [
                "2363c8fe.51fee8"
            ]
        ]
    },
    {
        "id": "2363c8fe.51fee8",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "Prep Data",
        "func": "// Output format for the ui_template node\n// msg.current: current values displayed in large numbers\n// msg.unit: unit value shown under the current value\n// msg.trend = up|down: displays the up/down trend arrow\n// msg.reference: reference/past value displayed in smaller numbers\n// msg.title: KPI title shown on the top\n\nmsg.title = \"Solar generation in last 30 days\";\nmsg.current = Math.floor(msg.payload[0][0].value/1000);\nmsg.unit = \"kWh\";\nmsg.reference = Math.floor(msg.payload[1][0].value/1000);\nif (msg.payload[0][0].value>msg.payload[1][0].value) {\n    msg.trend = \"up\";\n} else {\n    msg.trend = \"down\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 882.7401733398438,
        "y": 1622.5107421875,
        "wires": [
            [
                "20c5593b.c7241e"
            ]
        ]
    },
    {
        "id": "65bfb866.0f6498",
        "type": "ui_template",
        "z": "2cf1d395.65be64",
        "group": "bc98572c.f737b8",
        "name": "Trend",
        "order": 3,
        "width": "4",
        "height": "3",
        "format": "<div layout=\"row\" layout-align=\"space-between\">\n    <table width=\"100%\" height=\"100%\">\n        <tr>\n            <td colspan=\"2\">{{msg.title}}</td>\n        </tr>\n        <tr>\n            <td rowspan=\"2\" style=\"text-align: center;\"><span style=\"font-size: 300%; font-weight: bold;\">{{msg.current}}</span><br/>{{msg.unit}}</td>\n            <td style=\"text-align: center; font-size: 300%; font-weight: bold;\" ng-style=\"{color: msg.trend === 'up' ? 'green' : 'red'}\">{{(msg.trend === 'up') ? '&#8679;' : '&#8681;'}}</td>\n        </tr>\n        <tr>\n            <td style=\"text-align: center; font-style: italic;\">{{msg.reference}}</td>\n        </tr>\n    </table>\n</div>",
        "storeOutMessages": false,
        "fwdInMessages": false,
        "templateScope": "local",
        "x": 1041.7401733398438,
        "y": 1674.5107421875,
        "wires": [
            []
        ]
    },
    {
        "id": "c47b33de.447678",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "SQL",
        "func": "var p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\nvar sql = [];\n\nfromdate = today0h - p_7d;\nenddate = today0h;\nsql.push({ topic: \"SELECT sum(value) AS value FROM sensor_data WHERE device='solar' AND sensor='production' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n\nfromdate = fromdate - p_7d;\nenddate = enddate - p_7d;\nsql.push({ topic: \"SELECT sum(value) AS value FROM sensor_data WHERE device='solar' AND sensor='production' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n\n// set the completed flag for the join node later\nsql[sql.length-1].complete=true;\n\nreturn [ sql ];",
        "outputs": 1,
        "noerr": 0,
        "x": 440.74017333984375,
        "y": 1675.5107421875,
        "wires": [
            [
                "b20eacd8.3dbbd"
            ]
        ]
    },
    {
        "id": "b20eacd8.3dbbd",
        "type": "sqlite",
        "z": "2cf1d395.65be64",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 585.7401733398438,
        "y": 1674.5107421875,
        "wires": [
            [
                "dbf9480d.232f8"
            ]
        ]
    },
    {
        "id": "dbf9480d.232f8",
        "type": "join",
        "z": "2cf1d395.65be64",
        "name": "",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "timeout": "",
        "count": "",
        "x": 718.7401733398438,
        "y": 1674.5107421875,
        "wires": [
            [
                "b77f9f2f.8fa1c8"
            ]
        ]
    },
    {
        "id": "b77f9f2f.8fa1c8",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "Prep Data",
        "func": "// Output format for the ui_template node\n// msg.current: current values displayed in large numbers\n// msg.unit: unit value shown under the current value\n// msg.trend = up|down: displays the up/down trend arrow\n// msg.reference: reference/past value displayed in smaller numbers\n// msg.title: KPI title shown on the top\n\nmsg.title = \"Solar generation in last 7 days\";\nmsg.current = parseFloat(msg.payload[0][0].value/1000).toFixed(1);\nmsg.unit = \"kWh\";\nmsg.reference = Math.abs(Math.floor((msg.payload[0][0].value-msg.payload[1][0].value)/msg.payload[0][0].value*100)) + \"%\";\nif (msg.payload[0][0].value>msg.payload[1][0].value) {\n    msg.trend = \"up\";\n} else {\n    msg.trend = \"down\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 880.7401733398438,
        "y": 1674.5107421875,
        "wires": [
            [
                "65bfb866.0f6498"
            ]
        ]
    },
    {
        "id": "c34dcbe2.430e68",
        "type": "ui_template",
        "z": "2cf1d395.65be64",
        "group": "a7d74e40.4d39f",
        "name": "Trend",
        "order": 3,
        "width": "4",
        "height": "3",
        "format": "<div layout=\"row\" layout-align=\"space-between\">\n    <table width=\"100%\" height=\"100%\" style=\"border-collapse: collapse;\">\n        <tr>\n            <td colspan=\"2\">{{msg.title}}</td>\n        </tr>\n        <tr>\n            <td rowspan=\"2\" style=\"text-align: center;\"><span style=\"font-size: 300%; font-weight: bold;\">{{msg.current}}</span><br/>{{msg.unit}}</td>\n            <td style=\"text-align: center; font-size: 300%; font-weight: bold;\" ng-style=\"{color: msg.trend === 'up' ? 'green' : 'red'}\">&nbsp;</td>\n        </tr>\n        <tr>\n            <td style=\"text-align: center; font-style: italic;\">{{msg.reference}}</td>\n        </tr>\n        <tr style=\"background-color: lightgrey;\">\n            <td width={{msg.reference}} style=\"border-bottom: 6px solid blue;\"></td><td width={{1-msg.reference}}></td>\n        </tr>\n    </table>\n</div>",
        "storeOutMessages": false,
        "fwdInMessages": false,
        "templateScope": "local",
        "x": 911.7401733398438,
        "y": 1729.5107421875,
        "wires": [
            []
        ]
    },
    {
        "id": "6179ba75.af6e3c",
        "type": "sqlite",
        "z": "2cf1d395.65be64",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 590.7401733398438,
        "y": 1729.5107421875,
        "wires": [
            [
                "10bfbd32.5dd9ab"
            ]
        ]
    },
    {
        "id": "10bfbd32.5dd9ab",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "Prep Data",
        "func": "// Output format for the ui_template node\n// msg.current: current values displayed in large numbers\n// msg.unit: unit value shown under the current value\n// msg.trend = up|down: displays the up/down trend arrow\n// msg.reference: reference/past value displayed in smaller numbers\n// msg.title: KPI title shown on the top\n\nsolar_max = global.get(\"solar_max\");\n\nif (msg.payload[0].value > solar_max){\n    solar_max = msg.payload[0].value;\n    global.set(\"solar_max\", solar_max);\n}\n\nmsg.title = \"Solar generation yesterday vs. max\";\nmsg.current = parseFloat(msg.payload[0].value/1000).toFixed(2);\nmsg.unit = \"kWh\";\nmsg.reference = Math.abs(Math.floor((msg.payload[0].value/(solar_max))*100)) + \"%\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 750.7401733398438,
        "y": 1729.5107421875,
        "wires": [
            [
                "c34dcbe2.430e68"
            ]
        ]
    },
    {
        "id": "93945eac.5d5aa",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 658.692626953125,
        "y": 1494.5109252929688,
        "wires": []
    },
    {
        "id": "5cec2b6.ce9fe54",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "<==========Statistics==========>",
        "info": "",
        "x": 625.442626953125,
        "y": 1532.7609252929688,
        "wires": []
    },
    {
        "id": "4c3e6ccf.201df4",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 700.0226440429688,
        "y": 2401.79541015625,
        "wires": []
    },
    {
        "id": "65dbcb26.48eedc",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "<==========House meter==========>",
        "info": "",
        "x": 676.7726440429688,
        "y": 2440.04541015625,
        "wires": []
    },
    {
        "id": "5c8c7e4a.d5e5b",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "det Meter reading",
        "func": "var meter_reading = global.get(\"provider_meter\");\n\nvar last_minute = msg.payload;\n\nmeter_reading += last_minute;\nmeter_reading = Number((meter_reading).toFixed(2));\nglobal.set(\"provider_meter\",meter_reading);\n\nmsg.payload = Number((meter_reading/1000).toFixed(1));\n\nmsg.payload = msg.payload + \" kWh\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 730,
        "y": 2580,
        "wires": [
            [
                "38f595e4.133c92",
                "9576f568.6f99b",
                "e1787f8b.7b49b"
            ]
        ]
    },
    {
        "id": "bebc8f53.01a63",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "",
        "func": "var consumption = msg.payload/60;\nmsg.payload = Number((consumption).toFixed(2));\n\nif ( (msg.payload===\"NaN\") || !(msg.payload) ) \n    return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 546.78857421875,
        "y": 2580.4679565429688,
        "wires": [
            [
                "5c8c7e4a.d5e5b"
            ]
        ]
    },
    {
        "id": "3f434545.4268ca",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "c615b96.54c52c8"
        ],
        "x": 416.5158386230469,
        "y": 2581.6952514648438,
        "wires": [
            [
                "bebc8f53.01a63"
            ]
        ]
    },
    {
        "id": "38f595e4.133c92",
        "type": "ui_text",
        "z": "ef23770c.5edc1",
        "group": "9efd6936.d139d",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Consumption",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 964.8567504882812,
        "y": 2579.4452514648438,
        "wires": []
    },
    {
        "id": "d142439.492df4",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "SQL",
        "func": "var p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\nvar sql = [];\n\nfromdate = today0h - p_1d;\nenddate = today0h;\nsql.push({ topic: \"SELECT sum(value) AS value FROM sensor_data WHERE device='solar' AND sensor='production' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n\n// set the completed flag for the join node later\nsql[sql.length-1].complete=true;\n\nreturn [ sql ];",
        "outputs": 1,
        "noerr": 0,
        "x": 443.490234375,
        "y": 1734.5941772460938,
        "wires": [
            [
                "6179ba75.af6e3c"
            ]
        ]
    },
    {
        "id": "c7019427.c864a8",
        "type": "inject",
        "z": "2cf1d395.65be64",
        "name": "",
        "topic": "",
        "payload": "11000",
        "payloadType": "num",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 556.8038940429688,
        "y": 1803.4300842285156,
        "wires": [
            [
                "ccffab0c.2d548"
            ]
        ]
    },
    {
        "id": "ccffab0c.2d548",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "set max solar",
        "func": "global.set(\"solar_max\",msg.payload);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 820.1871948242188,
        "y": 1807.1800842285156,
        "wires": [
            []
        ]
    },
    {
        "id": "1398c56b.78217b",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "save choice",
        "func": "msg.payload = global.get(\"plugA_t_c\");\n\n\nif (msg.payload > 1000){\n    msg.payload = msg.payload/1000;\n    msg.payload = Number((msg.payload).toFixed(2));\n    msg.payload = msg.payload + \" kWh\";\n}else{\n    msg.payload = msg.payload + \" Wh\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 805.610595703125,
        "y": 1195.5196838378906,
        "wires": [
            [
                "cccad978.d70dd8"
            ]
        ]
    },
    {
        "id": "cccad978.d70dd8",
        "type": "ui_text",
        "z": "be52c199.c86f58",
        "group": "3bbbbd5f.04b81a",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Today consumption",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1060.227294921875,
        "y": 1194.5196838378906,
        "wires": []
    },
    {
        "id": "7b81bba2.3d94dc",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "save choice",
        "func": "var cost = global.get(\"fixed_energy_cost\");\nvar today_cost = 0;\n\nmsg.payload = global.get(\"plugA_t_c\");\n        \ntoday_cost = (msg.payload/1000)*cost\n\nmsg.payload = Number((today_cost).toFixed(4));\n\n msg.payload = msg.payload + \" \";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 811.610595703125,
        "y": 1242.5196838378906,
        "wires": [
            [
                "ea282760.80fc4"
            ]
        ]
    },
    {
        "id": "ea282760.80fc4",
        "type": "ui_text",
        "z": "be52c199.c86f58",
        "group": "3bbbbd5f.04b81a",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Today cost",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1042.227294921875,
        "y": 1240.5196838378906,
        "wires": []
    },
    {
        "id": "b49fc88c.9a31f",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "save choice",
        "func": "msg.payload = global.get(\"plugB_t_c\");\n\n\nif (msg.payload > 1000){\n    msg.payload = msg.payload/1000;\n    msg.payload = Number((msg.payload).toFixed(2));\n    msg.payload = msg.payload + \" kWh\";\n}else{\n    msg.payload = msg.payload + \" Wh\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 795.88330078125,
        "y": 1224.38330078125,
        "wires": [
            [
                "9f898eb8.17eba8"
            ]
        ]
    },
    {
        "id": "9f898eb8.17eba8",
        "type": "ui_text",
        "z": "c1eaebbb.b6c98",
        "group": "27fc78e8.8a487",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Today consumption",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1050.5,
        "y": 1223.38330078125,
        "wires": []
    },
    {
        "id": "a31707e2.6f79e8",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "save choice",
        "func": "var cost = global.get(\"fixed_energy_cost\");\nvar today_cost = 0;\n\nmsg.payload = global.get(\"plugB_t_c\");\n        \ntoday_cost = (msg.payload/1000)*cost\n\nmsg.payload = Number((today_cost).toFixed(4));\n\n msg.payload = msg.payload + \" \";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 801.88330078125,
        "y": 1271.38330078125,
        "wires": [
            [
                "a92273e3.176188"
            ]
        ]
    },
    {
        "id": "a92273e3.176188",
        "type": "ui_text",
        "z": "c1eaebbb.b6c98",
        "group": "27fc78e8.8a487",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Today cost",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1032.5,
        "y": 1269.38330078125,
        "wires": []
    },
    {
        "id": "377d34f0.994c14",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "save choice",
        "func": "msg.payload = global.get(\"plug1_t_c\");\n\n\nif (msg.payload > 1000){\n    msg.payload = msg.payload/1000;\n    msg.payload = Number((msg.payload).toFixed(2));\n    msg.payload = msg.payload + \" kWh\";\n}else{\n    msg.payload = msg.payload + \" Wh\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 850.5196533203125,
        "y": 1524.2923583984375,
        "wires": [
            [
                "a058556c.15a73"
            ]
        ]
    },
    {
        "id": "a058556c.15a73",
        "type": "ui_text",
        "z": "a4b5eb1e.5dd4d8",
        "group": "d92701a0.92dba",
        "order": 6,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Today consumption",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1105.1363525390625,
        "y": 1523.2923583984375,
        "wires": []
    },
    {
        "id": "af291191.93fa5",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "save choice",
        "func": "var cost = global.get(\"fixed_energy_cost\");\nvar today_cost = 0;\n\nmsg.payload = global.get(\"plug1_t_c\");\n        \ntoday_cost = (msg.payload/1000)*cost\n\nmsg.payload = Number((today_cost).toFixed(4));\n\n msg.payload = msg.payload + \" \";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 856.5196533203125,
        "y": 1571.2923583984375,
        "wires": [
            [
                "f5fa888b.30ad5"
            ]
        ]
    },
    {
        "id": "f5fa888b.30ad5",
        "type": "ui_text",
        "z": "a4b5eb1e.5dd4d8",
        "group": "d92701a0.92dba",
        "order": 7,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Today cost",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1087.1363525390625,
        "y": 1569.2923583984375,
        "wires": []
    },
    {
        "id": "89c7ed08.984a4",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "save choice",
        "func": "msg.payload = global.get(\"plug2_t_c\");\n\n\nif (msg.payload > 1000){\n    msg.payload = msg.payload/1000;\n    msg.payload = Number((msg.payload).toFixed(2));\n    msg.payload = msg.payload + \" kWh\";\n}else{\n    msg.payload = msg.payload + \" Wh\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 697.88330078125,
        "y": 1449.38330078125,
        "wires": [
            [
                "4b63a53e.8c737c"
            ]
        ]
    },
    {
        "id": "4b63a53e.8c737c",
        "type": "ui_text",
        "z": "bbaf6eb0.1f878",
        "group": "dee9af7d.49a6c8",
        "order": 6,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Today consumption",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 952.5,
        "y": 1448.38330078125,
        "wires": []
    },
    {
        "id": "3572c416.655cac",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "save choice",
        "func": "var cost = global.get(\"fixed_energy_cost\");\nvar today_cost = 0;\n\nmsg.payload = global.get(\"plug2_t_c\");\n        \ntoday_cost = (msg.payload/1000)*cost\n\nmsg.payload = Number((today_cost).toFixed(4));\n\n msg.payload = msg.payload + \" \";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 703.88330078125,
        "y": 1496.38330078125,
        "wires": [
            [
                "462a79e6.7d15d8"
            ]
        ]
    },
    {
        "id": "462a79e6.7d15d8",
        "type": "ui_text",
        "z": "bbaf6eb0.1f878",
        "group": "dee9af7d.49a6c8",
        "order": 7,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Today cost",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 934.5,
        "y": 1494.38330078125,
        "wires": []
    },
    {
        "id": "195f72c1.ee47f5",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "save choice",
        "func": "msg.payload = global.get(\"plug3_t_c\");\n\n\nif (msg.payload > 1000){\n    msg.payload = msg.payload/1000;\n    msg.payload = Number((msg.payload).toFixed(2));\n    msg.payload = msg.payload + \" kWh\";\n}else{\n    msg.payload = msg.payload + \" Wh\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 703.88330078125,
        "y": 1401.13330078125,
        "wires": [
            [
                "9fc61a3d.96b808"
            ]
        ]
    },
    {
        "id": "9fc61a3d.96b808",
        "type": "ui_text",
        "z": "2a4ee4a1.258c6c",
        "group": "8dc84beb.c40e98",
        "order": 6,
        "width": 0,
        "height": 0,
        "name": "Today consumption",
        "label": "Today consumption",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 958.5,
        "y": 1400.13330078125,
        "wires": []
    },
    {
        "id": "e4c47808.5ad568",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "save choice",
        "func": "var cost = global.get(\"fixed_energy_cost\");\nvar today_cost = 0;\n\nmsg.payload = global.get(\"plug3_t_c\");\n        \ntoday_cost = (msg.payload/1000)*cost\n\nmsg.payload = Number((today_cost).toFixed(4));\n\n msg.payload = msg.payload + \" \";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 709.88330078125,
        "y": 1448.13330078125,
        "wires": [
            [
                "e4ff6a17.2120e8"
            ]
        ]
    },
    {
        "id": "e4ff6a17.2120e8",
        "type": "ui_text",
        "z": "2a4ee4a1.258c6c",
        "group": "8dc84beb.c40e98",
        "order": 7,
        "width": 0,
        "height": 0,
        "name": "Today  cost",
        "label": "Today cost",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 940.5,
        "y": 1446.13330078125,
        "wires": []
    },
    {
        "id": "4d7aa21.cc283dc",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "save choice",
        "func": "msg.payload = global.get(\"plugS_t_c\");\n\n\nif (msg.payload > 1000){\n    msg.payload = msg.payload/1000;\n    msg.payload = Number((msg.payload).toFixed(2));\n    msg.payload = msg.payload + \" kWh\";\n}else{\n    msg.payload = msg.payload + \" Wh\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 752.8963012695312,
        "y": 1088.9547424316406,
        "wires": [
            [
                "11ecfc17.056ddc"
            ]
        ]
    },
    {
        "id": "d700318.c2666d",
        "type": "comment",
        "z": "584b08c1.d6cff8",
        "name": "Auto reset",
        "info": "",
        "x": 360,
        "y": 1040,
        "wires": []
    },
    {
        "id": "d75915b7.1872b8",
        "type": "inject",
        "z": "584b08c1.d6cff8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "01 00 * * *",
        "once": false,
        "x": 376.92424427379257,
        "y": 1095.6818514737215,
        "wires": [
            [
                "5e7526d5.4f1be8",
                "e54ba7eb.cf267"
            ]
        ]
    },
    {
        "id": "4c98d869.eff128",
        "type": "exec",
        "z": "584b08c1.d6cff8",
        "command": "sudo reboot",
        "addpay": false,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": false,
        "name": "",
        "x": 796.0150146484375,
        "y": 1094.3179321289062,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "bb652e4e.dfe86",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 734.318115234375,
        "y": 2177.5,
        "wires": []
    },
    {
        "id": "43285e92.c93fe8",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "<==========Category==========>",
        "info": "",
        "x": 783.068115234375,
        "y": 2218.75,
        "wires": []
    },
    {
        "id": "5e7526d5.4f1be8",
        "type": "delay",
        "z": "584b08c1.d6cff8",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 580.5606079101562,
        "y": 1096.5909423828125,
        "wires": [
            [
                "4c98d869.eff128"
            ]
        ]
    },
    {
        "id": "e54ba7eb.cf267",
        "type": "link out",
        "z": "584b08c1.d6cff8",
        "name": "reset_alert",
        "links": [
            "e1f6c005.c580a"
        ],
        "x": 529.4697265625,
        "y": 1138.5455322265625,
        "wires": []
    },
    {
        "id": "e1f6c005.c580a",
        "type": "link in",
        "z": "68347deb.b93a34",
        "name": "",
        "links": [
            "e54ba7eb.cf267"
        ],
        "x": 281.2424621582031,
        "y": 164.09090423583984,
        "wires": [
            [
                "35da0df4.88b92a"
            ]
        ]
    },
    {
        "id": "a676f6e.b7e0b08",
        "type": "inject",
        "z": "2cf1d395.65be64",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 216.3782958984375,
        "y": 1676.1827087402344,
        "wires": [
            [
                "1a531d7b.3b4e83",
                "c47b33de.447678",
                "d142439.492df4"
            ]
        ]
    },
    {
        "id": "2a0521e3.e7fba6",
        "type": "inject",
        "z": "5f22000e.0f3588",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 117,
        "y": 260,
        "wires": [
            [
                "2e81763d.0676aa"
            ]
        ]
    },
    {
        "id": "2e81763d.0676aa",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "SQL",
        "func": "msg.topic = \"SELECT * FROM state ORDER BY sta_id\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 280,
        "y": 260,
        "wires": [
            [
                "34fde8e0.5fb6a8"
            ]
        ]
    },
    {
        "id": "34fde8e0.5fb6a8",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 444,
        "y": 260,
        "wires": [
            [
                "62a06ad7.443ba4"
            ]
        ]
    },
    {
        "id": "62a06ad7.443ba4",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Process states",
        "func": "global.set(\"Diag_State_Buffer\",msg.payload);\n\nvar output = [];\nfor (var i = 0; i < msg.payload.length; i++) {\n    //output.push( \"[\"+msg.payload[i].id+\"] \"+msg.payload[i].caption);\n    obj = {};\n    \n    obj [\"[\"+msg.payload[i].sta_id+\"] \"+msg.payload[i].sta_title]=msg.payload[i].sta_id;\n    output.push(obj);\n}\nmsg.options = output;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 644,
        "y": 261,
        "wires": [
            [
                "9d336263.4746d8"
            ]
        ]
    },
    {
        "id": "9d336263.4746d8",
        "type": "ui_dropdown",
        "z": "5f22000e.0f3588",
        "name": "",
        "label": "Select",
        "group": "a69229a4.0e735",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "options": [
            {
                "label": "",
                "value": "",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "",
        "x": 830,
        "y": 261,
        "wires": [
            [
                "1cc3ae91.103d79"
            ]
        ]
    },
    {
        "id": "1260c8ef.72b187",
        "type": "ui_text_input",
        "z": "5f22000e.0f3588",
        "name": "",
        "label": "Caption",
        "group": "a69229a4.0e735",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": false,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 847,
        "y": 382,
        "wires": [
            [
                "4cb3f5fd.08c39c"
            ]
        ]
    },
    {
        "id": "a423366c.f5028",
        "type": "ui_colour_picker",
        "z": "5f22000e.0f3588",
        "name": "",
        "label": "Color",
        "group": "a69229a4.0e735",
        "format": "hex",
        "outformat": "string",
        "showSwatch": true,
        "showPicker": false,
        "showValue": false,
        "showAlpha": false,
        "order": 4,
        "width": 0,
        "height": 0,
        "passthru": false,
        "topic": "",
        "x": 838,
        "y": 423,
        "wires": [
            [
                "c3964834.f67a18"
            ]
        ]
    },
    {
        "id": "1cc3ae91.103d79",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "SQL",
        "func": "global.set(\"diag_state_selected\",msg.payload);\nmsg.topic = \"SELECT * FROM state WHERE sta_id=\" + msg.payload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 119,
        "y": 375,
        "wires": [
            [
                "3123f65e.e7a7aa"
            ]
        ]
    },
    {
        "id": "3123f65e.e7a7aa",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 283,
        "y": 375,
        "wires": [
            [
                "6dce2004.2887e"
            ]
        ]
    },
    {
        "id": "6dce2004.2887e",
        "type": "switch",
        "z": "5f22000e.0f3588",
        "name": "If no data",
        "property": "payload.length",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 449,
        "y": 375,
        "wires": [
            [
                "fb253147.dd0d18",
                "8ddd8b06.07f498",
                "f5a2d20c.50a5b8"
            ]
        ]
    },
    {
        "id": "fb253147.dd0d18",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].sta_title",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 652,
        "y": 382,
        "wires": [
            [
                "1260c8ef.72b187"
            ]
        ]
    },
    {
        "id": "8ddd8b06.07f498",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].sta_color",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 651,
        "y": 423,
        "wires": [
            [
                "a423366c.f5028"
            ]
        ]
    },
    {
        "id": "f6e9a989.d10938",
        "type": "ui_numeric",
        "z": "5f22000e.0f3588",
        "name": "",
        "label": "ID",
        "group": "a69229a4.0e735",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": false,
        "topic": "",
        "format": "{{value}}",
        "min": 0,
        "max": "100",
        "step": 1,
        "x": 836,
        "y": 342,
        "wires": [
            [
                "18054ef.3d1ce31"
            ]
        ]
    },
    {
        "id": "f5a2d20c.50a5b8",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].sta_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 654,
        "y": 342,
        "wires": [
            [
                "f6e9a989.d10938"
            ]
        ]
    },
    {
        "id": "46f98732.a1191",
        "type": "ui_button",
        "z": "5f22000e.0f3588",
        "name": "",
        "group": "a69229a4.0e735",
        "order": 0,
        "width": 0,
        "height": 0,
        "label": "Create New",
        "color": "",
        "bgcolor": "",
        "icon": "add",
        "payload": "",
        "payloadType": "str",
        "topic": "",
        "x": 95.77780151367188,
        "y": 188.99998474121094,
        "wires": [
            [
                "5632b09f.cddbb8"
            ]
        ]
    },
    {
        "id": "5632b09f.cddbb8",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "SQL",
        "func": "msg.topic = \"INSERT INTO state (sta_id,sta_title,sta_color) VALUES (\";\n\nif (global.get(\"diag_state_id\")!==undefined) {\n    msg.topic = msg.topic+global.get(\"diag_state_id\")+\", \";\n}else return;\n\nif (global.get(\"diag_state_caption\")!==undefined) {\n    msg.topic = msg.topic+ \"'\"+global.get(\"diag_state_caption\")+\"', \";\n}else return;\n\nif (global.get(\"diag_state_color\")!==undefined) {\n    msg.topic = msg.topic+ \"'\"+global.get(\"diag_state_color\")+\"')\";\n}else return;\n\nglobal.set(\"diag_state_selected\",undefined);\nglobal.set(\"diag_state_id\",undefined);\nglobal.set(\"diag_state_caption\",undefined);\nglobal.set(\"diag_state_color\",undefined);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 293,
        "y": 189,
        "wires": [
            [
                "e8258992.ff6b9"
            ]
        ]
    },
    {
        "id": "e8258992.ff6b9",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 457,
        "y": 189,
        "wires": [
            [
                "2e81763d.0676aa",
                "aeb15c0b.688a3"
            ]
        ]
    },
    {
        "id": "18054ef.3d1ce31",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Store value",
        "func": "global.set(\"diag_state_id\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1026,
        "y": 341,
        "wires": [
            []
        ]
    },
    {
        "id": "4cb3f5fd.08c39c",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Store value",
        "func": "global.set(\"diag_state_caption\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1027,
        "y": 382,
        "wires": [
            []
        ]
    },
    {
        "id": "c3964834.f67a18",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Store value",
        "func": "global.set(\"diag_state_color\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1029,
        "y": 423,
        "wires": [
            []
        ]
    },
    {
        "id": "817dcda8.2d85a",
        "type": "ui_button",
        "z": "5f22000e.0f3588",
        "name": "",
        "group": "a69229a4.0e735",
        "order": 0,
        "width": 0,
        "height": 0,
        "label": "Update selected",
        "color": "",
        "bgcolor": "#FF9000",
        "icon": "mode_edit",
        "payload": "",
        "payloadType": "str",
        "topic": "",
        "x": 105,
        "y": 145,
        "wires": [
            [
                "a8a69958.76e47"
            ]
        ]
    },
    {
        "id": "a8a69958.76e47",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "SQL",
        "func": "if (global.get(\"diag_state_selected\")!==undefined) {\n    msg.topic = \"UPDATE state SET \";\n    if (global.get(\"diag_state_id\")!==undefined) {\n        msg.topic = msg.topic+ \"sta_id=\"+global.get(\"diag_state_id\")+\", \";\n    }\n    if (global.get(\"diag_state_caption\")!==undefined) {\n        msg.topic = msg.topic+ \"sta_title='\"+global.get(\"diag_state_caption\")+\"', \";\n    }\n    if (global.get(\"diag_state_color\")!==undefined) {\n        msg.topic = msg.topic+ \"sta_color='\"+global.get(\"diag_state_color\")+\"', \";\n    }\n    msg.topic = msg.topic.substring(0,msg.topic.length-2);      \n    msg.topic = msg.topic+ \" WHERE sta_id=\"+global.get(\"diag_state_selected\");\n    \n    global.set(\"diag_state_selected\",undefined);\n    global.set(\"diag_state_id\",undefined);\n    global.set(\"diag_state_caption\",undefined);\n    global.set(\"diag_state_color\",undefined);\n} else {\n    msg.topic = \"\";\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 291,
        "y": 145,
        "wires": [
            [
                "186d216.696ef5f"
            ]
        ]
    },
    {
        "id": "186d216.696ef5f",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 459,
        "y": 143,
        "wires": [
            [
                "2e81763d.0676aa",
                "58ec67b4.5e77a8"
            ]
        ]
    },
    {
        "id": "ad984345.348fc8",
        "type": "ui_button",
        "z": "5f22000e.0f3588",
        "name": "",
        "group": "a69229a4.0e735",
        "order": 0,
        "width": 0,
        "height": 0,
        "label": "Delete selected",
        "color": "",
        "bgcolor": "#ff5555",
        "icon": "delete",
        "payload": "",
        "payloadType": "str",
        "topic": "",
        "x": 104.77777099609375,
        "y": 96.99998474121094,
        "wires": [
            [
                "db9805ba.91221"
            ]
        ]
    },
    {
        "id": "db9805ba.91221",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "SQL",
        "func": "if (global.get(\"diag_state_selected\")!==undefined) {\n    msg.topic = \"DELETE FROM state WHERE sta_id=\"+global.get(\"diag_state_selected\");\n    global.set(\"diag_state_selected\",undefined);\n    global.set(\"diag_state_id\",undefined);\n    global.set(\"diag_state_caption\",undefined);\n    global.set(\"diag_state_color\",undefined);\n} else {\n    msg.topic = \"\";\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 292,
        "y": 97,
        "wires": [
            [
                "98cf4390.ef61b"
            ]
        ]
    },
    {
        "id": "98cf4390.ef61b",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 458,
        "y": 98,
        "wires": [
            [
                "2e81763d.0676aa",
                "ddde3817.78362"
            ]
        ]
    },
    {
        "id": "e48337fc.9786d",
        "type": "comment",
        "z": "5f22000e.0f3588",
        "name": "Maintenance of the State table",
        "info": "",
        "x": 165,
        "y": 50,
        "wires": []
    },
    {
        "id": "c398da86.7edae8",
        "type": "ui_toast",
        "z": "5f22000e.0f3588",
        "position": "top right",
        "displayTime": "3",
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "topic": "",
        "name": "",
        "x": 941,
        "y": 144,
        "wires": []
    },
    {
        "id": "ddde3817.78362",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Toast msg",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "Selected entry has been deleted",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 665.5,
        "y": 98,
        "wires": [
            [
                "c398da86.7edae8"
            ]
        ]
    },
    {
        "id": "58ec67b4.5e77a8",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Toast msg",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "Selected entry has been updated",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 666,
        "y": 148,
        "wires": [
            [
                "c398da86.7edae8"
            ]
        ]
    },
    {
        "id": "aeb15c0b.688a3",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Toast msg",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "New entry has been created",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 666,
        "y": 193,
        "wires": [
            [
                "c398da86.7edae8"
            ]
        ]
    },
    {
        "id": "90ad9298.bca79",
        "type": "comment",
        "z": "5f22000e.0f3588",
        "name": "Receiving and processing messages",
        "info": "",
        "x": 199,
        "y": 912,
        "wires": []
    },
    {
        "id": "18aa5169.db8ac7",
        "type": "link in",
        "z": "5f22000e.0f3588",
        "name": "Diagnostic_Update",
        "links": [
            "1adc6062.5ed3c8",
            "1856177c.692aa9",
            "e592d5a5.26bde8",
            "b73c8744.8ec588",
            "59df56a.e8d5aa8",
            "6bc27c2.26eb584",
            "b269471e.f03798",
            "149d2576.aa372b",
            "4f24cc12.704334",
            "85f0d77.da83928",
            "78fed854.1b6aa8",
            "eaf2075b.f08f88",
            "9371bd5d.293c2",
            "8c6c56bb.efe678",
            "2e75adec.578e52",
            "d9ab022c.d40aa",
            "7692ea3d.040324",
            "5c63f003.554",
            "89cc7882.52fb68",
            "ee08c280.18881",
            "31989b49.404cf4",
            "1711c87b.c95a78",
            "858824a8.955768",
            "1ceba7.f7399459",
            "8d86bc97.858bd",
            "c1d8ef52.f0ff9",
            "d89c963e.0231a8",
            "7e2617bc.18faa",
            "f40a3ebf.f31ec8",
            "ef65add9.ca22e8",
            "ba0eaaa6.452e28",
            "4c1cccb9.365dac",
            "9d51b430.ad948",
            "cf642beb.b34b88",
            "1e22c4cf.e74adb",
            "8458310a.7c8",
            "e07a4722.04bc9",
            "27f352e4.061f4e",
            "e44bc285.5dbfd8",
            "92bfe55f.c321b8",
            "bfb77a28.136ff8",
            "2ef065d7.99110a",
            "2a69a773.cadc6",
            "d7d571fc.e9529",
            "9d9dacd3.2e77d",
            "66e2addf.d19644",
            "c1ecd589.31b19",
            "72dc8246.2e24e4",
            "629412ae.1c82fc",
            "7ca776a8.45eb28",
            "c05f325.7ad59d",
            "ab64b528.c3008",
            "5d07d276.a1698c",
            "7ec9d456.20ca34",
            "b21a85d9.dbf59",
            "94177f84.a3048",
            "6322a98b.1861b8",
            "4cc8e350.f8a3ac",
            "50f36e5.973139",
            "3cac2d44.41c6d2"
        ],
        "x": 175,
        "y": 1220,
        "wires": [
            [
                "5aba0691.fccd",
                "3c2936be.f6e132",
                "aad65bc0.57e8",
                "46eef2e3.d83824",
                "8e47776d.c30db",
                "90317476.7f2da8"
            ]
        ]
    },
    {
        "id": "b46c626c.d68558",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Diagnostic input message structure",
        "func": "msg.payload = \"This updates the system status as well\";\nmsg.system = 1; // System id, use 1 for Dummy\nmsg.state = 1; // specify if the message is to change system status\nmsg.severity = 0; // 0: information, 1: warning, 2: error\n//msg.email = true; // if separate email should be sent\n//msg.emailtext = \"\"; this a long text which goes into the email\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 413,
        "y": 959,
        "wires": [
            [
                "1adc6062.5ed3c8"
            ]
        ]
    },
    {
        "id": "ebffa6da.8ef348",
        "type": "inject",
        "z": "5f22000e.0f3588",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 130,
        "y": 960,
        "wires": [
            [
                "b46c626c.d68558"
            ]
        ]
    },
    {
        "id": "1adc6062.5ed3c8",
        "type": "link out",
        "z": "5f22000e.0f3588",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 640,
        "y": 959,
        "wires": []
    },
    {
        "id": "7e534bf2.d71844",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Insert message record",
        "func": "var d = new Date();\nvar epoch = d.getTime();\n\nif (msg.state>0) {\n    msg.topic = \"INSERT INTO message (msg_system,msg_severity,msg_text,msg_epoch,msg_newstate) VALUES (\"+msg.system+\",\"+msg.severity+\",'\"+msg.payload+\"',\"+epoch+\",\"+msg.state+\")\";\n} else {\n    msg.topic = \"INSERT INTO message (msg_system,msg_severity,msg_text,msg_epoch) VALUES (\"+msg.system+\",\"+msg.severity+\",'\"+msg.payload+\"',\"+epoch+\")\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 651,
        "y": 1061,
        "wires": [
            [
                "2facdaa8.dcad86"
            ]
        ]
    },
    {
        "id": "2facdaa8.dcad86",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 984,
        "y": 1062,
        "wires": [
            [
                "1365071c.9ce639"
            ]
        ]
    },
    {
        "id": "5aba0691.fccd",
        "type": "switch",
        "z": "5f22000e.0f3588",
        "name": "Check status change",
        "property": "state",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 381,
        "y": 1152.0000610351562,
        "wires": [
            [
                "1715a384.6cb344",
                "434344e3.f7f16c"
            ]
        ]
    },
    {
        "id": "3c2936be.f6e132",
        "type": "switch",
        "z": "5f22000e.0f3588",
        "name": "Check email",
        "property": "email",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 353.08331298828125,
        "y": 1406.277587890625,
        "wires": [
            [
                "caaa8f30.c5e868"
            ]
        ]
    },
    {
        "id": "a62d5ead.24c978",
        "type": "e-mail",
        "z": "5f22000e.0f3588",
        "server": "smtp.gmail.com",
        "port": "465",
        "secure": true,
        "name": "",
        "dname": "Email notification",
        "x": 1004,
        "y": 1406,
        "wires": []
    },
    {
        "id": "caaa8f30.c5e868",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Email content",
        "func": "msg.topic = msg.payload;\nmsg.payload = msg.emailtext;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 597.0833129882812,
        "y": 1406.277587890625,
        "wires": [
            [
                "1da1c377.378e3d"
            ]
        ]
    },
    {
        "id": "4e7c7d5a.86671c",
        "type": "comment",
        "z": "5f22000e.0f3588",
        "name": "Message Log",
        "info": "",
        "x": 170,
        "y": 1560,
        "wires": []
    },
    {
        "id": "7d57e13b.03e8e8",
        "type": "template",
        "z": "5f22000e.0f3588",
        "name": "Formatting",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<table>\n    <tr><th>Severity</th><th>Timestamp</th><th>System</th><th>Message</th></tr>\n    {{#payload}}\n        <tr class=\"\">\n            <td>{{msg_severity}}</td>\n            <td>{{msg_timestamp}}</td>\n            <td>{{sys_name}}</td>\n            <td>{{msg_text}}</td>\n        </tr>\n    {{/payload}}\n</table>\n",
        "x": 778.2499932183159,
        "y": 1997.37503390842,
        "wires": [
            [
                "a1154418.dcd94"
            ]
        ]
    },
    {
        "id": "a1154418.dcd94",
        "type": "ui_template",
        "z": "5f22000e.0f3588",
        "group": "32fd5db3.b26d8a",
        "name": "Log output",
        "order": 1,
        "width": "18",
        "height": "4",
        "format": "<div ng-bind-html=\"msg.payload\" style=\"height:400;\"></div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "templateScope": "local",
        "x": 999.2499932183159,
        "y": 1997.37503390842,
        "wires": [
            []
        ]
    },
    {
        "id": "4628e3b6.fc87bc",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "SQL",
        "func": "context.set(msg.topic,msg.payload);\n\nvar d = new Date();\nvar epoch = d.getTime();\nvar fromdate = 0;\nvar enddate = 0;\n\nmsg.topic = \"SELECT * FROM message, system2 WHERE msg_system = sys_id \";\n\nif (context.get(\"msg_severity\")!==undefined) {\n    if (context.get(\"msg_severity\")!==\"*\") {\n        msg.topic = msg.topic + \" AND msg_severity = \"+context.get(\"msg_severity\");\n    }\n}\n\nif (context.get(\"msg_system\")!==undefined) {\n    if (context.get(\"msg_system\")!==\"*\") {\n        msg.topic = msg.topic + \" AND msg_system = \"+context.get(\"msg_system\");\n    }\n}\n\nif (context.get(\"msg_newstate\")===1) {\n    msg.topic = msg.topic + \" AND msg_newstate IS NOT NULL \";\n}\n\nif (context.get(\"msg_time\")!==undefined) {\n    switch (context.get(\"msg_time\")) {\n        case 0:\n            fromdate = epoch - 1000*60*60*24;\n            msg.topic = msg.topic + \" AND msg_epoch > \"+fromdate;\n            break;\n        case 1:\n            fromdate = epoch - 1000*60*60*24*7;\n            msg.topic = msg.topic + \" AND msg_epoch > \"+fromdate;\n            break;\n        case 2:\n            fromdate = epoch - 1000*60*60*24*30;\n            msg.topic = msg.topic + \" AND msg_epoch > \"+fromdate;\n            break;\n    }\n}\n\n// msg.topic = msg.topic.substring(0,msg.topic.length-2);\nmsg.topic = msg.topic+ \" ORDER BY msg_id\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 365.249993218316,
        "y": 1996.37503390842,
        "wires": [
            [
                "b120cc08.2bc15",
                "57d0103d.e5c4a"
            ]
        ]
    },
    {
        "id": "b120cc08.2bc15",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 553.2499932183159,
        "y": 1996.37503390842,
        "wires": [
            [
                "7d57e13b.03e8e8"
            ]
        ]
    },
    {
        "id": "36453ac1.c78746",
        "type": "inject",
        "z": "5f22000e.0f3588",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 198.24999321831598,
        "y": 1996.37503390842,
        "wires": [
            [
                "4628e3b6.fc87bc"
            ]
        ]
    },
    {
        "id": "7af248e0.911958",
        "type": "ui_button",
        "z": "5f22000e.0f3588",
        "name": "",
        "group": "32fd5db3.b26d8a",
        "order": 2,
        "width": "3",
        "height": "1",
        "label": "Refresh",
        "color": "",
        "bgcolor": "",
        "icon": "",
        "payload": "",
        "payloadType": "str",
        "topic": "msg_refresh",
        "x": 601.2499932183159,
        "y": 1706.37503390842,
        "wires": [
            [
                "4628e3b6.fc87bc"
            ]
        ]
    },
    {
        "id": "f2b16e49.e137e8",
        "type": "ui_dropdown",
        "z": "5f22000e.0f3588",
        "name": "Severity",
        "label": "",
        "group": "32fd5db3.b26d8a",
        "order": 3,
        "width": "4",
        "height": "1",
        "passthru": true,
        "options": [
            {
                "label": "All severity",
                "value": "*",
                "type": "str"
            },
            {
                "label": "Information only",
                "value": 0,
                "type": "num"
            },
            {
                "label": "Warnings only",
                "value": 1,
                "type": "num"
            },
            {
                "label": "Errors only",
                "value": 2,
                "type": "num"
            }
        ],
        "payload": "",
        "topic": "msg_severity",
        "x": 600.2499932183159,
        "y": 1752.37503390842,
        "wires": [
            [
                "4628e3b6.fc87bc"
            ]
        ]
    },
    {
        "id": "29ca5454.8b064c",
        "type": "ui_dropdown",
        "z": "5f22000e.0f3588",
        "name": "Time filter",
        "label": "",
        "group": "32fd5db3.b26d8a",
        "order": 4,
        "width": "4",
        "height": "1",
        "passthru": true,
        "options": [
            {
                "label": "Last 24 hrs",
                "value": 0,
                "type": "num"
            },
            {
                "label": "Last 7 days",
                "value": 1,
                "type": "num"
            },
            {
                "label": "Last 30 days",
                "value": 2,
                "type": "num"
            },
            {
                "label": "All",
                "value": 3,
                "type": "num"
            }
        ],
        "payload": "",
        "topic": "msg_time",
        "x": 602.2499932183159,
        "y": 1799.37503390842,
        "wires": [
            [
                "4628e3b6.fc87bc"
            ]
        ]
    },
    {
        "id": "560007dd.5c414",
        "type": "inject",
        "z": "5f22000e.0f3588",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 178.24999321831598,
        "y": 1744.37503390842,
        "wires": [
            [
                "18375005.cafbb",
                "f2ee6c42.ffadd8",
                "bb5b3fd4.379328"
            ]
        ]
    },
    {
        "id": "18375005.cafbb",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Initial value",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "*",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 408.249993218316,
        "y": 1752.37503390842,
        "wires": [
            [
                "f2b16e49.e137e8",
                "761b05c5.6cfa5c"
            ]
        ]
    },
    {
        "id": "f2ee6c42.ffadd8",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Initial value",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 409.249993218316,
        "y": 1798.37503390842,
        "wires": [
            [
                "29ca5454.8b064c"
            ]
        ]
    },
    {
        "id": "f0abb9d6.4748b8",
        "type": "ui_toast",
        "z": "5f22000e.0f3588",
        "position": "top right",
        "displayTime": "3",
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "topic": "",
        "name": "",
        "x": 646.3610229492188,
        "y": 1020.16650390625,
        "wires": []
    },
    {
        "id": "b988efe7.e8e438",
        "type": "ui_dropdown",
        "z": "5f22000e.0f3588",
        "name": "New State",
        "label": "",
        "group": "32fd5db3.b26d8a",
        "order": 5,
        "width": "4",
        "height": "1",
        "passthru": true,
        "options": [
            {
                "label": "All messages",
                "value": 0,
                "type": "num"
            },
            {
                "label": "Only new status",
                "value": 1,
                "type": "num"
            }
        ],
        "payload": "",
        "topic": "msg_newstate",
        "x": 612.2499932183159,
        "y": 1845.37503390842,
        "wires": [
            [
                "4628e3b6.fc87bc"
            ]
        ]
    },
    {
        "id": "bb5b3fd4.379328",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Initial value",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 413.249993218316,
        "y": 1847.37503390842,
        "wires": [
            [
                "b988efe7.e8e438"
            ]
        ]
    },
    {
        "id": "3320509b.33d198",
        "type": "ui_dropdown",
        "z": "5f22000e.0f3588",
        "name": "System",
        "label": "",
        "group": "32fd5db3.b26d8a",
        "order": 6,
        "width": "5",
        "height": "1",
        "passthru": true,
        "options": [
            {
                "label": "",
                "value": "",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "msg_system",
        "x": 599.2499932183159,
        "y": 1655.37503390842,
        "wires": [
            [
                "4628e3b6.fc87bc"
            ]
        ]
    },
    {
        "id": "3ebf7b74.e25fb4",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Process systems",
        "func": "var output = [];\noutput.push({\"All systems\":\"*\"});\nfor (var i = 0; i < msg.payload.length; i++) {\n    obj = {};\n    obj [\"[\"+msg.payload[i].sys_id+\"] \"+msg.payload[i].sys_name]=msg.payload[i].sys_id;\n    output.push(obj);\n}\nmsg.options = output;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 408.249993218316,
        "y": 1655.37503390842,
        "wires": [
            [
                "3320509b.33d198"
            ]
        ]
    },
    {
        "id": "761b05c5.6cfa5c",
        "type": "delay",
        "z": "5f22000e.0f3588",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 405.749993218316,
        "y": 1705.37503390842,
        "wires": [
            [
                "3320509b.33d198"
            ]
        ]
    },
    {
        "id": "92a9e9e8.2de998",
        "type": "comment",
        "z": "5f22000e.0f3588",
        "name": "Message Archiving",
        "info": "",
        "x": 190,
        "y": 2140,
        "wires": []
    },
    {
        "id": "f888ae59.7bec1",
        "type": "inject",
        "z": "5f22000e.0f3588",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 184,
        "y": 2197,
        "wires": [
            [
                "18724c3b.2acc5c"
            ]
        ]
    },
    {
        "id": "51dd79ad.702688",
        "type": "link in",
        "z": "5f22000e.0f3588",
        "name": "Diag email notification in",
        "links": [
            "3bdde187.1895fe",
            "687a1723.72ac88"
        ],
        "x": 655,
        "y": 1460,
        "wires": [
            [
                "1da1c377.378e3d"
            ]
        ]
    },
    {
        "id": "86469ca5.c34db",
        "type": "comment",
        "z": "5f22000e.0f3588",
        "name": "Diagnostic Daily Digest",
        "info": "",
        "x": 200,
        "y": 2309,
        "wires": []
    },
    {
        "id": "6c0e36bc.67a52",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 547,
        "y": 2197,
        "wires": [
            []
        ]
    },
    {
        "id": "18724c3b.2acc5c",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "SQL",
        "func": "var d = new Date();\nvar epoch = d.getTime();\n\n// today - 30 days\nvar fromdate = epoch - 1000*60*60*24*30;\n\nmsg.topic = \"DELETE FROM message WHERE msg_epoch < \"+fromdate;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 351,
        "y": 2197,
        "wires": [
            [
                "6c0e36bc.67a52"
            ]
        ]
    },
    {
        "id": "8ef78291.7783f8",
        "type": "template",
        "z": "5f22000e.0f3588",
        "name": "Formatting",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<table>\n    <tr><th>Name</th><th>State</th><th>Category</th><th>Energy state</th><th>last epoch</th><th>Relay State</th><th>Avg consumption</th></tr>\n    {{#payload}}\n        <tr>\n            <td>{{sys_name}}</td>\n            <td bgcolor={{sta_color}}>{{sta_title}}</td>\n            <td align=\"center\">{{sys_cat}}</td>\n            <td align=\"center\">{{sys_energy_state}}</td>\n            <td >{{sys_last_epoch}}</td>\n            <td align=\"center\">{{sys_relay}}</td>\n            <td align=\"center\">{{sys_avg_cons}}</td>\n        </tr>\n    {{/payload}}\n</table>\n",
        "output": "str",
        "x": 797.5555267333984,
        "y": 2369.110757827759,
        "wires": [
            [
                "2f86ecc8.0772e4"
            ]
        ]
    },
    {
        "id": "9b0aa659.04c168",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "System State Summary",
        "func": "msg.topic = \"SELECT * FROM system2, state WHERE sys_state = sta_id ORDER BY sys_id\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 429.44444274902344,
        "y": 2370.111001968384,
        "wires": [
            [
                "d62831d0.643c28"
            ]
        ]
    },
    {
        "id": "d62831d0.643c28",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 621.4444427490234,
        "y": 2369.111001968384,
        "wires": [
            [
                "8ef78291.7783f8",
                "f7194bf1.25c798"
            ]
        ]
    },
    {
        "id": "96cf0dd7.e1a938",
        "type": "inject",
        "z": "5f22000e.0f3588",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "00 06 * * *",
        "once": false,
        "x": 201.11111450195312,
        "y": 2370.111001968384,
        "wires": [
            [
                "9b0aa659.04c168",
                "ddf2d757.f37f58",
                "361c82f6.490956",
                "f3c5e5e7.bb2e98",
                "cd54bea3.dc60d8",
                "908586c3.279",
                "2ed1d604.e5e7ca"
            ]
        ]
    },
    {
        "id": "dafe308e.36c868",
        "type": "template",
        "z": "5f22000e.0f3588",
        "name": "Formatting",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<table width=\"100%\">\n    <tr><td class=\"solidline\"><b>Severity</b></td><td class=\"solidline\"><b>Timestamp</b></td><td class=\"solidline\"><b>System</b></td><td class=\"solidline\"><b>Message</b></td></tr>\n    {{#payload}}\n        <tr style=\"border-bottom: 1px dotted #e0e0e0;\">\n            <td class=\"dottedline\">{{msg_severity}}</td>\n            <td class=\"dottedline\">{{msg_timestamp}}</td>\n            <td class=\"dottedline\">{{sys_name}}</td>\n            <td class=\"dottedline\">{{msg_text}}</td>\n        </tr>\n    {{/payload}}\n</table>\n",
        "x": 796.6666641235352,
        "y": 2438.9999771118164,
        "wires": [
            [
                "5709a417.21b22c"
            ]
        ]
    },
    {
        "id": "581072ab.c8ab54",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Messages",
        "func": "var d = new Date();\nvar epoch = d.getTime();\nvar fromdate = 0;\nfromdate = epoch - 1000*60*60*24;\n\nmsg.topic = \"SELECT * FROM message, system2 WHERE msg_system = sys_id AND msg_epoch > \"+fromdate;\nmsg.topic = msg.topic+ \" ORDER BY msg_id\";\n\n//msg.complete = true;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 398.2222137451172,
        "y": 2440.111001968384,
        "wires": [
            [
                "e68b44e8.8e9c18"
            ]
        ]
    },
    {
        "id": "e68b44e8.8e9c18",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 604.9999847412109,
        "y": 2439.111001968384,
        "wires": [
            [
                "dafe308e.36c868"
            ]
        ]
    },
    {
        "id": "ddf2d757.f37f58",
        "type": "delay",
        "z": "5f22000e.0f3588",
        "name": "",
        "pauseType": "delay",
        "timeout": "100",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 195.4444580078125,
        "y": 2440.111246109009,
        "wires": [
            [
                "581072ab.c8ab54"
            ]
        ]
    },
    {
        "id": "896e10cf.ecf9a8",
        "type": "comment",
        "z": "5f22000e.0f3588",
        "name": "System Status Stat Reset",
        "info": "",
        "x": 217.80555725097656,
        "y": 2857.972330093384,
        "wires": []
    },
    {
        "id": "f105a43f.41378",
        "type": "inject",
        "z": "5f22000e.0f3588",
        "name": "",
        "topic": "reset",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 218.91666412353516,
        "y": 2923.527750015259,
        "wires": [
            [
                "201420d5.fa18a"
            ]
        ]
    },
    {
        "id": "e2408cf3.b06548",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Reset log",
        "func": "global.set(\"Diag_System_Buffer\",msg.payload);\n\nvar d = new Date();\nvar current = d.getTime();\nvar output = [];\n\nif (msg.payload!==undefined) {\n    for (var i = 0; i < msg.payload.length; i++) {\n        output = [];\n        output.push( { state: msg.payload[i].sys_state, epoch: current } );\n        global.set(msg.payload[i].sys_name.replace(\" \",\"_\")+\"_statestat\",output);\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 711.3610992431641,
        "y": 2924.416666030884,
        "wires": [
            [
                "9152a723.600e58"
            ]
        ]
    },
    {
        "id": "9152a723.600e58",
        "type": "debug",
        "z": "5f22000e.0f3588",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 882.4721527099609,
        "y": 2924.527994155884,
        "wires": []
    },
    {
        "id": "1715a384.6cb344",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Update state stat",
        "func": "var systembuf = global.get(\"Diag_System_Buffer\");\nvar d = new Date();\nvar current = d.getTime();\nvar sys_name = \"\";\n\n// find the system name\nfor (var i=0; i<systembuf.length; i++) {\n    if (systembuf[i].sys_id===msg.system) {\n        sys_name = systembuf[i].sys_name;\n    }\n}\n\nvar statestat = global.get(sys_name.replace(\" \",\"_\")+\"_statestat\");\nif (statestat===undefined) {\n    statestat = [];\n}\n\nstatestat.push({state: msg.state, epoch: current});\nglobal.set(sys_name.replace(\" \",\"_\")+\"_statestat\",statestat);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 641.8888549804688,
        "y": 1115.111083984375,
        "wires": [
            []
        ]
    },
    {
        "id": "f7194bf1.25c798",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Generate state stat",
        "func": "var statebuf = global.get(\"Diag_State_Buffer\");\nvar d = new Date();\nvar current = d.getTime();\nvar sys_name = \"\";\nvar html = \"<table width='100%'>\";\n\nfor (var i=0; i<msg.payload.length; i++) {\n    html = html + \"<tr><td nowrap>\" + msg.payload[i].sys_name + \"</td><td width='100%'><table height='100%' width='100%'><tr>\";\n    var statestat = global.get(msg.payload[i].sys_name.replace(\" \",\"_\")+\"_statestat\");\n    var width = 0;\n    for (var j=0; j<statestat.length; j++) {\n        if (j===statestat.length-1) {\n            // this is the last item in the list\n            width=Math.floor((current-statestat[j].epoch)/(current-statestat[0].epoch)*100+0.999999999);\n        } else {\n            // this is not the last item in the list\n            width=Math.floor((statestat[j+1].epoch-statestat[j].epoch)/(current-statestat[0].epoch)*100+0.999999999);\n        }\n        \n        // find the color for the state\n        var mycolor = \"\";\n        for (var k=0; k<statebuf.length; k++) {\n            if (statebuf[k].sta_id===statestat[j].state) {\n                mycolor = statebuf[k].sta_color;\n            }\n        }\n        \n        html = html + \"<td style='background-color:\" + mycolor + \"; width:\" + width + \"%'>&nbsp;</td>\";\n    }\n    html = html + \"</tr></table></td></tr>\\n\";\n}\nhtml = html + \"</table>\\n\";\n\nmsg.payload = html;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 598.6666717529297,
        "y": 2504.2225341796875,
        "wires": [
            [
                "82a25680.3ec918",
                "201420d5.fa18a"
            ]
        ]
    },
    {
        "id": "201420d5.fa18a",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "SQL",
        "func": "msg.topic = \"SELECT * FROM system2 ORDER BY sys_id\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 399.9166717529297,
        "y": 2923.972330093384,
        "wires": [
            [
                "2df012e2.5e7aae"
            ]
        ]
    },
    {
        "id": "2df012e2.5e7aae",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 552.9166717529297,
        "y": 2923.972330093384,
        "wires": [
            [
                "e2408cf3.b06548"
            ]
        ]
    },
    {
        "id": "e07f7e60.8853e8",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Dump state stat",
        "func": "var systembuf = global.get(\"Diag_System_Buffer\");\nvar d = new Date();\nvar current = d.getTime();\nvar sys_name = \"\";\nvar output = [];\nvar statestat = [];\n\n// find the system name\nfor (var i=0; i<systembuf.length; i++) {\n    sys_name = systembuf[i].sys_name;\n    //var statestat = \"none\";\n    statestat = global.get(sys_name.replace(\" \",\"_\")+\"_statestat\");\n    if (statestat===undefined) {\n        statestat=[];\n    }\n    output.push({system: sys_name, stat: statestat});\n}\n\nmsg.payload = output;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 434.9167022705078,
        "y": 3052.25830078125,
        "wires": [
            [
                "236e7b78.85396c"
            ]
        ]
    },
    {
        "id": "236e7b78.85396c",
        "type": "debug",
        "z": "5f22000e.0f3588",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 694.7738227844238,
        "y": 3053.6868534088135,
        "wires": []
    },
    {
        "id": "70e62b04.347764",
        "type": "inject",
        "z": "5f22000e.0f3588",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 214.77382278442388,
        "y": 3050.8297105516704,
        "wires": [
            [
                "e07f7e60.8853e8"
            ]
        ]
    },
    {
        "id": "ee5e13a4.f485c",
        "type": "comment",
        "z": "5f22000e.0f3588",
        "name": "Debugging",
        "info": "",
        "x": 150.48809814453125,
        "y": 2999.401123046875,
        "wires": []
    },
    {
        "id": "fe2f43d6.3fcaf8",
        "type": "template",
        "z": "5f22000e.0f3588",
        "name": "Email body",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<html>\n    <body style=\"margin:0; padding:0;\" bgcolor=\"#f2f2f2\" leftmargin=\"0\" t=\nopmargin=\"0\" marginwidth=\"0\" marginheight=\"0\">\n<style>\n   body {\n    margin: 0;\n    padding: 0;\n    -ms-text-size-adjust: 100%;\n    -webkit-text-size-adjust: 100%;\n    font-family: 'Roboto', Helvetica, Arial, sans-serif;\n  }\n\n  table {\n    border-spacing: 0;\n  }\n\n  table td {\n    border-collapse: collapse;\n  }\n\n  .ReadMsgBody {\n    width: 100%;\n    background-color: #ebebeb;\n  }\n  \n  .divider {\n    border-bottom: 1px solid #e2066e;\n  }\n  \n  td.solidline {\n      border-bottom: 1px solid #e0e0e0;\n  }\n  \n  td.dottedline {\n      border-bottom: 1px dotted #e0e0e0;\n  }  \n\n</style>        \n\n<table border=\"0\" width=\"100%\" height=\"100%\" cellpadding=\"0\" cellsp=\nacing=\"0\" bgcolor=\"#ffffff\" style=\"border: 20px solid #f2f2f2;\">\n  <tr><td valign=\"top\" width=\"20\"></td><td valign=\"top\">\n        \n        <p style=\"text-align: right;\"><span style=\"font-size:150%;\">{{{payload.title}}}</span><br/>\n        <span style=\"font-size:80%;\">{{{payload.date}}}</span></p>\n        <table bgcolor=\"#f3f3f3\" cellspacing=\"4\" align=\"center\"><tr><td bgcolor=\"#ffffff\" width=\"120\">{{{payload.solar1}}}</td><td bgcolor=\"#ffffff\" width=\"120\">{{{payload.solar2}}}</td><td bgcolor=\"#ffffff\" width=\"120\">{{{payload.solar3}}}</td></tr></table>\n  </td><td valign=\"top\" width=\"20\"></td></tr>\n  <tr><td style=\"border-bottom: 1px solid #e2066e;\" colspan=\"3\"></td></tr>\n  <tr><td valign=\"top\" width=\"20\"></td><td valign=\"top\">\n        {{{payload.state_summary}}}\n  </td><td valign=\"top\" width=\"20\"></td></tr>\n  <tr><td style=\"border-bottom: 1px solid #e2066e;\" colspan=\"3\"></td></tr>\n  <tr><td valign=\"top\" width=\"20\"></td><td valign=\"top\">\n        {{{payload.state_stat}}}\n  </td><td valign=\"top\" width=\"20\"></td></tr>\n  <tr><td style=\"border-bottom: 1px solid #e2066e;\" colspan=\"3\"></td></tr>\n  <tr><td valign=\"top\" width=\"20\"></td><td valign=\"top\">\n        {{{payload.messages}}}\n  </td><td valign=\"top\" width=\"20\"></td></tr>\n \n</table>\n    </body>\n</html>",
        "x": 1442.4443817138672,
        "y": 2365.7503356933594,
        "wires": [
            [
                "3b977bfc.a0537c"
            ]
        ]
    },
    {
        "id": "3b977bfc.a0537c",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "Daily Diagnostic Report",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1450.7777557373047,
        "y": 2451.0836181640625,
        "wires": [
            [
                "3358fbd3.13109c",
                "57e3f20f.8de9c4"
            ]
        ]
    },
    {
        "id": "687a1723.72ac88",
        "type": "link out",
        "z": "5f22000e.0f3588",
        "name": "",
        "links": [
            "51dd79ad.702688"
        ],
        "x": 1735,
        "y": 2500,
        "wires": []
    },
    {
        "id": "2f86ecc8.0772e4",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Set topic",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "state_summary",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 958.8889007568359,
        "y": 2368.4444732666016,
        "wires": [
            [
                "bb495ef.27f3ba"
            ]
        ]
    },
    {
        "id": "5709a417.21b22c",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Set topic",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "messages",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 958.1111450195312,
        "y": 2438.6668643951416,
        "wires": [
            [
                "bb495ef.27f3ba"
            ]
        ]
    },
    {
        "id": "82a25680.3ec918",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Set topic",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "state_stat",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 963.3332977294922,
        "y": 2503.444498062134,
        "wires": [
            [
                "bb495ef.27f3ba"
            ]
        ]
    },
    {
        "id": "361c82f6.490956",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Run date",
        "func": "// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nmsg.payload = dd + \".\" + mm + \".\" + yyyy + \".\";    \n      \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 396.6666717529297,
        "y": 2563.722330093384,
        "wires": [
            [
                "f3099d5c.a1b168"
            ]
        ]
    },
    {
        "id": "f3099d5c.a1b168",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Set topic",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "date",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 964.1666717529297,
        "y": 2562.472330093384,
        "wires": [
            [
                "bb495ef.27f3ba"
            ]
        ]
    },
    {
        "id": "378008dd.969fe",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Set topic",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "title",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 965.4166717529297,
        "y": 2612.472330093384,
        "wires": [
            [
                "bb495ef.27f3ba"
            ]
        ]
    },
    {
        "id": "f3c5e5e7.bb2e98",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Report title",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "HEMS Diagnistic Daily Report",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 405.4166717529297,
        "y": 2611.222330093384,
        "wires": [
            [
                "378008dd.969fe"
            ]
        ]
    },
    {
        "id": "2c4361d1.f6ce9e",
        "type": "template",
        "z": "5f22000e.0f3588",
        "name": "Formatting",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "\n    <table width=\"100%\" height=\"100%\">\n        <tr>\n            <td colspan=\"2\">{{title}}</td>\n        </tr>\n        <tr>\n            <td rowspan=\"2\" style=\"text-align: center;\"><span style=\"font-size: 300%; font-weight: bold;\">{{current}}</span><br/>{{unit}}</td>\n            <td style=\"text-align: center; font-size: 300%; font-weight: bold; color:{{trendcolor}}; background-color:white;\">{{{trend}}}</td>\n        </tr>\n        <tr>\n            <td style=\"text-align: center; font-style: italic;\">{{reference}}</td>\n        </tr>\n    </table>\n",
        "x": 999.1666870117188,
        "y": 2663.7223777770996,
        "wires": [
            [
                "1dffa105.45f0af"
            ]
        ]
    },
    {
        "id": "3e07db74.f550a4",
        "type": "template",
        "z": "5f22000e.0f3588",
        "name": "Formatting",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "\n    <table width=\"100%\" height=\"100%\">\n        <tr>\n            <td colspan=\"2\">{{title}}</td>\n        </tr>\n        <tr>\n            <td rowspan=\"2\" style=\"text-align: center;\"><span style=\"font-size: 300%; font-weight: bold;\">{{current}}</span><br/>{{unit}}</td>\n            <td style=\"text-align: center; font-size: 300%; font-weight: bold; color:{{trendcolor}}; background-color:white;\">{{{trend}}}</td>\n        </tr>\n        <tr>\n            <td style=\"text-align: center; font-style: italic;\">{{reference}}</td>\n        </tr>\n    </table>\n",
        "x": 996.6666870117188,
        "y": 2716.2223777770996,
        "wires": [
            [
                "ed754a10.969948"
            ]
        ]
    },
    {
        "id": "28cbac0e.fb0c74",
        "type": "template",
        "z": "5f22000e.0f3588",
        "name": "Formatting",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "\n    <table width=\"100%\" height=\"100%\" style=\"border-collapse: collapse;\">\n        <tr>\n            <td colspan=\"2\">{{title}}</td>\n        </tr>\n        <tr>\n            <td rowspan=\"2\" style=\"text-align: center;\"><span style=\"font-size: 300%; font-weight: bold;\">{{current}}</span><br/>{{unit}}</td>\n            <td style=\"text-align: center; font-size: 300%; font-weight: bold; color:{{trendcolor}}; background-color:white;\">&nbsp;</td>\n        </tr>\n        <tr>\n            <td style=\"text-align: center; font-style: italic;\">{{reference}}</td>\n        </tr>\n        <tr style=\"background-color: lightgrey;\"><td colspan=\"2\">\n            <table width=\"100%\" height=\"100%\" style=\"border-collapse: collapse;\"><tr>\n            <td width={{reference}} style=\"border-bottom: 6px solid blue;\"></td><td width={{reference2}}></td>\n            </tr></table></td>\n        </tr>\n    </table>\n",
        "x": 867.9166870117188,
        "y": 2769.9723777770996,
        "wires": [
            [
                "4dac4078.ee5"
            ]
        ]
    },
    {
        "id": "1dffa105.45f0af",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Set topic",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "solar1",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1192.4166717529297,
        "y": 2663.972412109375,
        "wires": [
            [
                "1535ef48.a456d1",
                "62ae2504.2a00a4"
            ]
        ]
    },
    {
        "id": "ed754a10.969948",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Set topic",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "solar2",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1189.9166717529297,
        "y": 2717.722412109375,
        "wires": [
            [
                "1535ef48.a456d1",
                "62ae2504.2a00a4"
            ]
        ]
    },
    {
        "id": "4dac4078.ee5",
        "type": "change",
        "z": "5f22000e.0f3588",
        "name": "Set topic",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "solar3",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1191.1666870117188,
        "y": 2768.972459793091,
        "wires": [
            [
                "1535ef48.a456d1",
                "62ae2504.2a00a4"
            ]
        ]
    },
    {
        "id": "55737127.30f5b",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Comms notification",
        "func": "var devicename = \"plug1\";\nvar system_id = 1; //System id number for fiagnostic update\nvar online_threshold = 10; //Seconds between updates which the device is considered online\nvar offline_threshold = 30; //Seconds between updates which the device is considered offline\n\nvar temp = context.get(devicename +\"_update\");\nvar current = new Date();\nmsg.payload = \"No data\";\nmsg.warning = false;\n\nif (msg.topic!==\"timecheck\") {\n    // Do not update the context if it is triggerd by the check inject node\n    context.set(devicename +\"_update\",current)\n}\nif (temp===undefined) {\n    // when node-red booting or redeployed\n    context.set(devicename +\"_update\",current)\n}else{\n    current = current - temp;\n    current = Math.floor(current/1000)\n    node.status({fill:\"blue\",shape:\"ring\",text:\"last message:\" + current + \"s\"});\n    \n    /*;\n    var minute = Math.floor(current/60);\n    var hour = Math.floor(minute/60);\n    var day = Math.floor(hour/24);\n    */\n    if (context.get(devicename +\"_state\")!==1) {\n        if (current<online_threshold) {\n            msg.payload = devicename + \" now online\";\n            msg.system = system_id; \n            msg.state = 1;\n            msg.severity = 0;\n            msg.warning = true;\n            \n            //msg.email = true; //if separate email should be sent\n            //msg.emailtext = \"\"; //text contained in the email\n            \n            context.set(devicename +\"_state\",1);\n        }\n    }if (context.get(devicename +\"_state\")!==99){\n        if (current>offline_threshold) {\n            msg.payload =  devicename + \" not transmiting\";\n            msg.system = system_id; \n            msg.state = 99;\n            msg.severity = 2;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",99);\n        }\n    }\n\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 620.0741577148438,
        "y": 2379.5187377929688,
        "wires": [
            [
                "cb1e0a78.1f1ee",
                "e63f99c9.bba7f8"
            ]
        ]
    },
    {
        "id": "cc02aa28.4257b8",
        "type": "link in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "4a27c2fa.685884",
            "7f5a6a46.c4819c"
        ],
        "x": 457.51861572265625,
        "y": 2379.6299438476562,
        "wires": [
            [
                "55737127.30f5b"
            ]
        ]
    },
    {
        "id": "cb1e0a78.1f1ee",
        "type": "switch",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 850.4443969726562,
        "y": 2379.6672973632812,
        "wires": [
            [
                "d89c963e.0231a8",
                "d4a28947.2603a8"
            ]
        ]
    },
    {
        "id": "d89c963e.0231a8",
        "type": "link out",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 985.5555419921875,
        "y": 2382.22265625,
        "wires": []
    },
    {
        "id": "c8a8e081.f00128",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 670.88330078125,
        "y": 2475.38330078125,
        "wires": []
    },
    {
        "id": "8400333b.328ac",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "<==========Category==========>",
        "info": "",
        "x": 637.63330078125,
        "y": 2513.63330078125,
        "wires": []
    },
    {
        "id": "fa43849a.2563a8",
        "type": "inject",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Heartbeat",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "1",
        "crontab": "",
        "once": false,
        "x": 419.76666259765625,
        "y": 2424.0166015625,
        "wires": [
            [
                "55737127.30f5b"
            ]
        ]
    },
    {
        "id": "d4a28947.2603a8",
        "type": "debug",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1048.7666320800781,
        "y": 2443.7166442871094,
        "wires": []
    },
    {
        "id": "e63f99c9.bba7f8",
        "type": "debug",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 829.7666015625,
        "y": 2437.716552734375,
        "wires": []
    },
    {
        "id": "b7631c0d.ce204",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 646.88330078125,
        "y": 2054.38330078125,
        "wires": []
    },
    {
        "id": "77986c5a.fd4184",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "<==========Category==========>",
        "info": "",
        "x": 613.63330078125,
        "y": 2092.63330078125,
        "wires": []
    },
    {
        "id": "c52bd194.a02af8",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "Comms notification",
        "func": "var devicename = \"plug2\";\nvar system_id = 2; //System id number for fiagnostic update\nvar online_threshold = 10; //Seconds between updates which the device is considered online\nvar offline_threshold = 30; //Seconds between updates which the device is considered offline\n\nvar temp = context.get(devicename +\"_update\");\nvar current = new Date();\nmsg.payload = \"No data\";\nmsg.warning = false;\n\nif (msg.topic!==\"timecheck\") {\n    // Do not update the context if it is triggerd by the check inject node\n    context.set(devicename +\"_update\",current)\n}\nif (temp===undefined) {\n    // when node-red booting or redeployed\n    context.set(devicename +\"_update\",current)\n}else{\n    current = current - temp;\n    current = Math.floor(current/1000)\n    node.status({fill:\"blue\",shape:\"ring\",text:\"last message:\" + current + \"s\"});\n    \n    /*;\n    var minute = Math.floor(current/60);\n    var hour = Math.floor(minute/60);\n    var day = Math.floor(hour/24);\n    */\n    if (context.get(devicename +\"_state\")!==1) {\n        if (current<online_threshold) {\n            msg.payload = devicename + \" now online\";\n            msg.system = system_id; \n            msg.state = 1;\n            msg.severity = 0;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",1);\n        }\n    }if (context.get(devicename +\"_state\")!==99){\n        if (current>offline_threshold) {\n            msg.payload =  devicename + \" not transmiting\";\n            msg.system = system_id; \n            msg.state = 99;\n            msg.severity = 2;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",99);\n        }\n    }\n\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 579.88330078125,
        "y": 2590.3831787109375,
        "wires": [
            [
                "48c343a.3d5a53c",
                "4a161da3.26cdfc"
            ]
        ]
    },
    {
        "id": "9c01f7a9.c3b4e",
        "type": "link in",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "2d878a6f.e60d26"
        ],
        "x": 417.3277587890625,
        "y": 2590.494384765625,
        "wires": [
            [
                "c52bd194.a02af8"
            ]
        ]
    },
    {
        "id": "48c343a.3d5a53c",
        "type": "switch",
        "z": "bbaf6eb0.1f878",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 810.2535400390625,
        "y": 2590.53173828125,
        "wires": [
            [
                "ba0eaaa6.452e28",
                "e8db7ace.065ed8"
            ]
        ]
    },
    {
        "id": "ba0eaaa6.452e28",
        "type": "link out",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 945.3646850585938,
        "y": 2593.0870971679688,
        "wires": []
    },
    {
        "id": "1012acc9.7e359b",
        "type": "inject",
        "z": "bbaf6eb0.1f878",
        "name": "Heartbeat",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "1",
        "crontab": "",
        "once": false,
        "x": 374.5758056640625,
        "y": 2639.8810424804688,
        "wires": [
            [
                "c52bd194.a02af8"
            ]
        ]
    },
    {
        "id": "e8db7ace.065ed8",
        "type": "debug",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1008.5757751464844,
        "y": 2654.581085205078,
        "wires": []
    },
    {
        "id": "4a161da3.26cdfc",
        "type": "debug",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 789.5757446289062,
        "y": 2648.5809936523438,
        "wires": []
    },
    {
        "id": "16ce71df.9068f6",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "Comms notification",
        "func": "var devicename = \"plug3\";\nvar system_id = 3; //System id number for fiagnostic update\nvar online_threshold = 10; //Seconds between updates which the device is considered online\nvar offline_threshold = 30; //Seconds between updates which the device is considered offline\n\nvar temp = context.get(devicename +\"_update\");\nvar current = new Date();\nmsg.payload = \"No data\";\nmsg.warning = false;\n\nif (msg.topic!==\"timecheck\") {\n    // Do not update the context if it is triggerd by the check inject node\n    context.set(devicename +\"_update\",current)\n}\nif (temp===undefined) {\n    // when node-red booting or redeployed\n    context.set(devicename +\"_update\",current)\n}else{\n    current = current - temp;\n    current = Math.floor(current/1000)\n    node.status({fill:\"blue\",shape:\"ring\",text:\"last message:\" + current + \"s\"});\n    \n    /*;\n    var minute = Math.floor(current/60);\n    var hour = Math.floor(minute/60);\n    var day = Math.floor(hour/24);\n    */\n    if (context.get(devicename +\"_state\")!==1) {\n        if (current<online_threshold) {\n            msg.payload = devicename + \" now online\";\n            msg.system = system_id; \n            msg.state = 1;\n            msg.severity = 0;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",1);\n        }\n    }if (context.get(devicename +\"_state\")!==99){\n        if (current>offline_threshold) {\n            msg.payload =  devicename + \" not transmiting\";\n            msg.system = system_id; \n            msg.state = 99;\n            msg.severity = 2;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",99);\n        }\n    }\n\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 540.3074951171875,
        "y": 2164.38330078125,
        "wires": [
            [
                "2e158c4c.bdff14",
                "d1478097.4406e8"
            ]
        ]
    },
    {
        "id": "168d945b.243c8c",
        "type": "link in",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "349c8e0a.86e3b2"
        ],
        "x": 377.751953125,
        "y": 2164.4945068359375,
        "wires": [
            [
                "16ce71df.9068f6"
            ]
        ]
    },
    {
        "id": "2e158c4c.bdff14",
        "type": "switch",
        "z": "2a4ee4a1.258c6c",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 770.677734375,
        "y": 2164.5318603515625,
        "wires": [
            [
                "4c1cccb9.365dac",
                "57873ccf.b52c04"
            ]
        ]
    },
    {
        "id": "4c1cccb9.365dac",
        "type": "link out",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 905.7888793945312,
        "y": 2167.0872192382812,
        "wires": []
    },
    {
        "id": "110eeea.4d5c991",
        "type": "inject",
        "z": "2a4ee4a1.258c6c",
        "name": "Heartbeat",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "1",
        "crontab": "",
        "once": false,
        "x": 335,
        "y": 2213.8811645507812,
        "wires": [
            [
                "16ce71df.9068f6"
            ]
        ]
    },
    {
        "id": "57873ccf.b52c04",
        "type": "debug",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 968.9999694824219,
        "y": 2228.5812072753906,
        "wires": []
    },
    {
        "id": "d1478097.4406e8",
        "type": "debug",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 749.9999389648438,
        "y": 2222.5811157226562,
        "wires": []
    },
    {
        "id": "f03704a4.773b5",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 715.8832397460938,
        "y": 2682.38330078125,
        "wires": []
    },
    {
        "id": "b3928d23.2029a8",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "<==========Category==========>",
        "info": "",
        "x": 682.6332397460938,
        "y": 2720.63330078125,
        "wires": []
    },
    {
        "id": "ca207e1b.d855a",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "Comms notification",
        "func": "var devicename = \"plug0\";\nvar system_id = 10; //System id number for fiagnostic update\nvar online_threshold = 10; //Seconds between updates which the device is considered online\nvar offline_threshold = 30; //Seconds between updates which the device is considered offline\n\nvar temp = context.get(devicename +\"_update\");\nvar current = new Date();\nmsg.payload = \"No data\";\nmsg.warning = false;\n\nif (msg.topic!==\"timecheck\") {\n    // Do not update the context if it is triggerd by the check inject node\n    context.set(devicename +\"_update\",current)\n}\nif (temp===undefined) {\n    // when node-red booting or redeployed\n    context.set(devicename +\"_update\",current)\n}else{\n    current = current - temp;\n    current = Math.floor(current/1000)\n    node.status({fill:\"blue\",shape:\"ring\",text:\"last message:\" + current + \"s\"});\n    \n    /*;\n    var minute = Math.floor(current/60);\n    var hour = Math.floor(minute/60);\n    var day = Math.floor(hour/24);\n    */\n    if (context.get(devicename +\"_state\")!==1) {\n        if (current<online_threshold) {\n            msg.payload = devicename + \" now online\";\n            msg.system = system_id; \n            msg.state = 1;\n            msg.severity = 0;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",1);\n        }\n    }if (context.get(devicename +\"_state\")!==99){\n        if (current>offline_threshold) {\n            msg.payload =  devicename + \" not transmiting\";\n            msg.system = system_id; \n            msg.state = 99;\n            msg.severity = 2;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",99);\n        }\n    }\n\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 609.3074340820312,
        "y": 2792.38330078125,
        "wires": [
            [
                "a7f7c72b.9e8c6"
            ]
        ]
    },
    {
        "id": "a5b517c9.76809",
        "type": "link in",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "f36ca3a5.292f98"
        ],
        "x": 446.75189208984375,
        "y": 2792.4945068359375,
        "wires": [
            [
                "ca207e1b.d855a"
            ]
        ]
    },
    {
        "id": "a7f7c72b.9e8c6",
        "type": "switch",
        "z": "ef23770c.5edc1",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 839.6776733398438,
        "y": 2792.5318603515625,
        "wires": [
            [
                "9d51b430.ad948"
            ]
        ]
    },
    {
        "id": "9d51b430.ad948",
        "type": "link out",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 974.788818359375,
        "y": 2795.0872192382812,
        "wires": []
    },
    {
        "id": "611d36ec.7f2fb8",
        "type": "inject",
        "z": "ef23770c.5edc1",
        "name": "Heartbeat",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "1",
        "crontab": "",
        "once": false,
        "x": 403.99993896484375,
        "y": 2841.8811645507812,
        "wires": [
            [
                "ca207e1b.d855a"
            ]
        ]
    },
    {
        "id": "5c32b6ae.51fc4",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 677.8832702636719,
        "y": 2005.13330078125,
        "wires": []
    },
    {
        "id": "80fe7de2.a95c38",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "<==========Category==========>",
        "info": "",
        "x": 644.6332702636719,
        "y": 2043.38330078125,
        "wires": []
    },
    {
        "id": "cafb51b5.59a66",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "Comms notification",
        "func": "var devicename = \"plugA\";\nvar system_id = 11; //System id number for fiagnostic update\nvar online_threshold = 10; //Seconds between updates which the device is considered online\nvar offline_threshold = 30; //Seconds between updates which the device is considered offline\n\nvar temp = context.get(devicename +\"_update\");\nvar current = new Date();\nmsg.payload = \"No data\";\nmsg.warning = false;\n\nif (msg.topic!==\"timecheck\") {\n    // Do not update the context if it is triggerd by the check inject node\n    context.set(devicename +\"_update\",current)\n}\nif (temp===undefined) {\n    // when node-red booting or redeployed\n    context.set(devicename +\"_update\",current)\n}else{\n    current = current - temp;\n    current = Math.floor(current/1000)\n    node.status({fill:\"blue\",shape:\"ring\",text:\"last message:\" + current + \"s\"});\n    \n    /*;\n    var minute = Math.floor(current/60);\n    var hour = Math.floor(minute/60);\n    var day = Math.floor(hour/24);\n    */\n    if (context.get(devicename +\"_state\")!==1) {\n        if (current<online_threshold) {\n            msg.payload = devicename + \" now online\";\n            msg.system = system_id; \n            msg.state = 1;\n            msg.severity = 0;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",1);\n        }\n    }if (context.get(devicename +\"_state\")!==99){\n        if (current>offline_threshold) {\n            msg.payload =  devicename + \" not transmiting\";\n            msg.system = system_id; \n            msg.state = 99;\n            msg.severity = 2;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",99);\n        }\n    }\n\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 571.3074645996094,
        "y": 2115.13330078125,
        "wires": [
            [
                "a5f106fb.5c4258"
            ]
        ]
    },
    {
        "id": "599fe2fe.eb93c4",
        "type": "link in",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "f36ca3a5.292f98"
        ],
        "x": 408.7519226074219,
        "y": 2115.2445068359375,
        "wires": [
            [
                "cafb51b5.59a66"
            ]
        ]
    },
    {
        "id": "a5f106fb.5c4258",
        "type": "switch",
        "z": "be52c199.c86f58",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 801.6777038574219,
        "y": 2115.2818603515625,
        "wires": [
            [
                "cf642beb.b34b88"
            ]
        ]
    },
    {
        "id": "cf642beb.b34b88",
        "type": "link out",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 936.7888488769531,
        "y": 2117.8372192382812,
        "wires": []
    },
    {
        "id": "acad1a7c.877608",
        "type": "inject",
        "z": "be52c199.c86f58",
        "name": "Heartbeat",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "1",
        "crontab": "",
        "once": false,
        "x": 365.9999694824219,
        "y": 2164.6311645507812,
        "wires": [
            [
                "cafb51b5.59a66"
            ]
        ]
    },
    {
        "id": "d5e535b6.8d28f",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 664.88330078125,
        "y": 2027.38330078125,
        "wires": []
    },
    {
        "id": "e7e6abd3.3c359",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "<==========Category==========>",
        "info": "",
        "x": 631.63330078125,
        "y": 2065.63330078125,
        "wires": []
    },
    {
        "id": "f82815e8.e8ae88",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "Comms notification",
        "func": "var devicename = \"plugB\";\nvar system_id = 12; //System id number for fiagnostic update\nvar online_threshold = 10; //Seconds between updates which the device is considered online\nvar offline_threshold = 30; //Seconds between updates which the device is considered offline\n\nvar temp = context.get(devicename +\"_update\");\nvar current = new Date();\nmsg.payload = \"No data\";\nmsg.warning = false;\n\nif (msg.topic!==\"timecheck\") {\n    // Do not update the context if it is triggerd by the check inject node\n    context.set(devicename +\"_update\",current)\n}\nif (temp===undefined) {\n    // when node-red booting or redeployed\n    context.set(devicename +\"_update\",current)\n}else{\n    current = current - temp;\n    current = Math.floor(current/1000)\n    node.status({fill:\"blue\",shape:\"ring\",text:\"last message:\" + current + \"s\"});\n    \n    /*;\n    var minute = Math.floor(current/60);\n    var hour = Math.floor(minute/60);\n    var day = Math.floor(hour/24);\n    */\n    if (context.get(devicename +\"_state\")!==1) {\n        if (current<online_threshold) {\n            msg.payload = devicename + \" now online\";\n            msg.system = system_id; \n            msg.state = 1;\n            msg.severity = 0;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",1);\n        }\n    }if (context.get(devicename +\"_state\")!==99){\n        if (current>offline_threshold) {\n            msg.payload =  devicename + \" not transmiting\";\n            msg.system = system_id; \n            msg.state = 99;\n            msg.severity = 2;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",99);\n        }\n    }\n\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 558.3074951171875,
        "y": 2137.38330078125,
        "wires": [
            [
                "13ebafe8.21e2a8"
            ]
        ]
    },
    {
        "id": "6d2381d.dcf4a8",
        "type": "link in",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "f36ca3a5.292f98"
        ],
        "x": 395.751953125,
        "y": 2137.4945068359375,
        "wires": [
            [
                "f82815e8.e8ae88"
            ]
        ]
    },
    {
        "id": "13ebafe8.21e2a8",
        "type": "switch",
        "z": "c1eaebbb.b6c98",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 791.677734375,
        "y": 2143.53173828125,
        "wires": [
            [
                "1e22c4cf.e74adb"
            ]
        ]
    },
    {
        "id": "1e22c4cf.e74adb",
        "type": "link out",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 923.7888793945312,
        "y": 2140.0872192382812,
        "wires": []
    },
    {
        "id": "57bb6876.0ae968",
        "type": "inject",
        "z": "c1eaebbb.b6c98",
        "name": "Heartbeat",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "1",
        "crontab": "",
        "once": false,
        "x": 353,
        "y": 2186.8811645507812,
        "wires": [
            [
                "f82815e8.e8ae88"
            ]
        ]
    },
    {
        "id": "9f089ac8.e597a",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 662.76904296875,
        "y": 1895.8714904785156,
        "wires": []
    },
    {
        "id": "97c0f80.6333c88",
        "type": "comment",
        "z": "2cf1d395.65be64",
        "name": "<==========Category==========>",
        "info": "",
        "x": 629.51904296875,
        "y": 1934.1214904785156,
        "wires": []
    },
    {
        "id": "db4456c.978b0a8",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "Comms notification",
        "func": "var devicename = \"plugS\";\nvar system_id = 5; //System id number for fiagnostic update\nvar online_threshold = 10; //Seconds between updates which the device is considered online\nvar offline_threshold = 30; //Seconds between updates which the device is considered offline\n\nvar temp = context.get(devicename +\"_update\");\nvar current = new Date();\nmsg.payload = \"No data\";\nmsg.warning = false;\n\nif (msg.topic!==\"timecheck\") {\n    // Do not update the context if it is triggerd by the check inject node\n    context.set(devicename +\"_update\",current)\n}\nif (temp===undefined) {\n    // when node-red booting or redeployed\n    context.set(devicename +\"_update\",current)\n}else{\n    current = current - temp;\n    current = Math.floor(current/1000)\n    node.status({fill:\"blue\",shape:\"ring\",text:\"last message:\" + current + \"s\"});\n    \n    /*;\n    var minute = Math.floor(current/60);\n    var hour = Math.floor(minute/60);\n    var day = Math.floor(hour/24);\n    */\n    if (context.get(devicename +\"_state\")!==1) {\n        if (current<online_threshold) {\n            msg.payload = devicename + \" now online\";\n            msg.system = system_id; \n            msg.state = 1;\n            msg.severity = 0;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",1);\n        }\n    }if (context.get(devicename +\"_state\")!==99){\n        if (current>offline_threshold) {\n            msg.payload =  devicename + \" not transmiting\";\n            msg.system = system_id; \n            msg.state = 99;\n            msg.severity = 2;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",99);\n        }\n    }\n\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 556.1932373046875,
        "y": 2005.8714904785156,
        "wires": [
            [
                "510c691.3fc3298"
            ]
        ]
    },
    {
        "id": "4745a48e.030a94",
        "type": "link in",
        "z": "2cf1d395.65be64",
        "name": "",
        "links": [
            "afe923ae.3ecf3"
        ],
        "x": 393.6376953125,
        "y": 2005.9826965332031,
        "wires": [
            [
                "db4456c.978b0a8"
            ]
        ]
    },
    {
        "id": "510c691.3fc3298",
        "type": "switch",
        "z": "2cf1d395.65be64",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 786.5634765625,
        "y": 2006.0200500488281,
        "wires": [
            [
                "8458310a.7c8"
            ]
        ]
    },
    {
        "id": "8458310a.7c8",
        "type": "link out",
        "z": "2cf1d395.65be64",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 921.6746215820312,
        "y": 2008.5754089355469,
        "wires": []
    },
    {
        "id": "46ece79d.0d6e98",
        "type": "inject",
        "z": "2cf1d395.65be64",
        "name": "Heartbeat",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "1",
        "crontab": "",
        "once": false,
        "x": 350.8857421875,
        "y": 2055.369354248047,
        "wires": [
            [
                "db4456c.978b0a8"
            ]
        ]
    },
    {
        "id": "40f5266a.8039d",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "Comms notification",
        "func": "var devicename = \"plugS\";\nvar system_id = 5; //System id number for fiagnostic update\nvar online_threshold = 10; //Seconds between updates which the device is considered online\nvar offline_threshold = 30; //Seconds between updates which the device is considered offline\n\nvar temp = context.get(devicename +\"_update\");\nvar current = new Date();\nmsg.payload = \"No data\";\nmsg.warning = false;\n\nmsg.payload = devicename + \" not producing\";\nmsg.system = system_id; \nmsg.state = 70;\nmsg.severity = 2;\nmsg.warning = true;\n\nmsg.email = true; //if separate email should be sent\nmsg.emailtext = \"Solar panel not producing energy\"; //text contained in the email\n\ncontext.set(devicename +\"_state\",70);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 581.76904296875,
        "y": 2140.8714294433594,
        "wires": [
            [
                "a9a9c069.8f40f8"
            ]
        ]
    },
    {
        "id": "a9a9c069.8f40f8",
        "type": "switch",
        "z": "2cf1d395.65be64",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 812.1392822265625,
        "y": 2141.019989013672,
        "wires": [
            [
                "e07a4722.04bc9"
            ]
        ]
    },
    {
        "id": "e07a4722.04bc9",
        "type": "link out",
        "z": "2cf1d395.65be64",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 947.2504272460938,
        "y": 2143.5753479003906,
        "wires": []
    },
    {
        "id": "3fb0b95c.a80f8e",
        "type": "inject",
        "z": "2cf1d395.65be64",
        "name": "Heartbeat",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 355.4615478515625,
        "y": 2140.3692321777344,
        "wires": [
            [
                "40f5266a.8039d"
            ]
        ]
    },
    {
        "id": "cd54bea3.dc60d8",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "SQL",
        "func": "var p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\nvar sql = [];\n\nfromdate = today0h - p_30d;\nenddate = today0h;\nsql.push({ topic: \"SELECT sum(value) AS value FROM sensor_data WHERE device='solar' AND sensor='production' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n\nfromdate = fromdate - p_30d;\nenddate = enddate - p_30d;\nsql.push({ topic: \"SELECT sum(value) AS value FROM sensor_data WHERE device='solar' AND sensor='production' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n\n// set the completed flag for the join node later\nsql[sql.length-1].complete=true;\n\nreturn [ sql ];",
        "outputs": 1,
        "noerr": 0,
        "x": 380.54991149902344,
        "y": 2665.2890625,
        "wires": [
            [
                "3d17de61.8c63ea"
            ]
        ]
    },
    {
        "id": "3d17de61.8c63ea",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 525.5499114990234,
        "y": 2664.2890625,
        "wires": [
            [
                "a344456d.f0c378"
            ]
        ]
    },
    {
        "id": "a344456d.f0c378",
        "type": "join",
        "z": "5f22000e.0f3588",
        "name": "",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "timeout": "",
        "count": "",
        "x": 658.5499114990234,
        "y": 2664.2890625,
        "wires": [
            [
                "f9ebef78.aa6c6"
            ]
        ]
    },
    {
        "id": "f9ebef78.aa6c6",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Prep Data",
        "func": "// Output format for the ui_template node\n// msg.current: current values displayed in large numbers\n// msg.unit: unit value shown under the current value\n// msg.trend = up|down: displays the up/down trend arrow\n// msg.reference: reference/past value displayed in smaller numbers\n// msg.title: KPI title shown on the top\n\nmsg.title = \"Solar generation in last 30 days\";\nmsg.current = Math.floor(msg.payload[0][0].value/1000);\nmsg.unit = \"kWh\";\nmsg.reference = Math.floor(msg.payload[1][0].value/1000);\nif (msg.payload[0][0].value>msg.payload[1][0].value) {\n    msg.trend = \"up\";\n} else {\n    msg.trend = \"down\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 820.5499114990234,
        "y": 2664.2890625,
        "wires": [
            [
                "2c4361d1.f6ce9e"
            ]
        ]
    },
    {
        "id": "908586c3.279",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "SQL",
        "func": "var p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\nvar sql = [];\n\nfromdate = today0h - p_7d;\nenddate = today0h;\nsql.push({ topic: \"SELECT sum(value) AS value FROM sensor_data WHERE device='solar' AND sensor='production' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n\nfromdate = fromdate - p_7d;\nenddate = enddate - p_7d;\nsql.push({ topic: \"SELECT sum(value) AS value FROM sensor_data WHERE device='solar' AND sensor='production' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n\n// set the completed flag for the join node later\nsql[sql.length-1].complete=true;\n\nreturn [ sql ];",
        "outputs": 1,
        "noerr": 0,
        "x": 378.54991149902344,
        "y": 2717.2890625,
        "wires": [
            [
                "5919484f.cc335"
            ]
        ]
    },
    {
        "id": "5919484f.cc335",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 523.5499114990234,
        "y": 2716.2890625,
        "wires": [
            [
                "2b6ba1eb.58bdd6"
            ]
        ]
    },
    {
        "id": "2b6ba1eb.58bdd6",
        "type": "join",
        "z": "5f22000e.0f3588",
        "name": "",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "timeout": "",
        "count": "",
        "x": 656.5499114990234,
        "y": 2716.2890625,
        "wires": [
            [
                "f6a2b462.fa23f"
            ]
        ]
    },
    {
        "id": "f6a2b462.fa23f",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Prep Data",
        "func": "// Output format for the ui_template node\n// msg.current: current values displayed in large numbers\n// msg.unit: unit value shown under the current value\n// msg.trend = up|down: displays the up/down trend arrow\n// msg.reference: reference/past value displayed in smaller numbers\n// msg.title: KPI title shown on the top\n\nmsg.title = \"Solar generation in last 7 days\";\nmsg.current = parseFloat(msg.payload[0][0].value/1000).toFixed(1);\nmsg.unit = \"kWh\";\nmsg.reference = Math.abs(Math.floor((msg.payload[0][0].value-msg.payload[1][0].value)/msg.payload[0][0].value*100)) + \"%\";\nif (msg.payload[0][0].value>msg.payload[1][0].value) {\n    msg.trend = \"up\";\n} else {\n    msg.trend = \"down\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 818.5499114990234,
        "y": 2716.2890625,
        "wires": [
            [
                "3e07db74.f550a4"
            ]
        ]
    },
    {
        "id": "bf01d1dd.f97998",
        "type": "sqlite",
        "z": "5f22000e.0f3588",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 528.5499114990234,
        "y": 2771.2890625,
        "wires": [
            [
                "f78f87c6.8334c8"
            ]
        ]
    },
    {
        "id": "f78f87c6.8334c8",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Prep Data",
        "func": "// Output format for the ui_template node\n// msg.current: current values displayed in large numbers\n// msg.unit: unit value shown under the current value\n// msg.trend = up|down: displays the up/down trend arrow\n// msg.reference: reference/past value displayed in smaller numbers\n// msg.title: KPI title shown on the top\n\nsolar_max = global.get(\"solar_max\");\n\nif (msg.payload[0].value > solar_max){\n    solar_max = msg.payload[0].value;\n    global.set(\"solar_max\", solar_max);\n}\n\nmsg.title = \"Solar generation yesterday vs. max\";\nmsg.current = parseFloat(msg.payload[0].value/1000).toFixed(2);\nmsg.unit = \"kWh\";\nmsg.reference = Math.abs(Math.floor((msg.payload[0].value/(solar_max))*100)) + \"%\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 688.5499114990234,
        "y": 2771.2890625,
        "wires": [
            [
                "28cbac0e.fb0c74"
            ]
        ]
    },
    {
        "id": "2ed1d604.e5e7ca",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "SQL",
        "func": "var p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\nvar sql = [];\n\nfromdate = today0h - p_1d;\nenddate = today0h;\nsql.push({ topic: \"SELECT sum(value) AS value FROM sensor_data WHERE device='solar' AND sensor='production' AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate });\n\n// set the completed flag for the join node later\nsql[sql.length-1].complete=true;\n\nreturn [ sql ];",
        "outputs": 1,
        "noerr": 0,
        "x": 381.2999725341797,
        "y": 2776.3724975585938,
        "wires": [
            [
                "bf01d1dd.f97998"
            ]
        ]
    },
    {
        "id": "3358fbd3.13109c",
        "type": "delay",
        "z": "5f22000e.0f3588",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "5",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 1620,
        "y": 2500,
        "wires": [
            [
                "687a1723.72ac88"
            ]
        ]
    },
    {
        "id": "1535ef48.a456d1",
        "type": "debug",
        "z": "5f22000e.0f3588",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1410,
        "y": 2768,
        "wires": []
    },
    {
        "id": "bb495ef.27f3ba",
        "type": "join",
        "z": "5f22000e.0f3588",
        "name": "",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "5",
        "count": "5",
        "x": 1129.9888153076172,
        "y": 2367.7501220703125,
        "wires": [
            [
                "4bb727a.81f2858"
            ]
        ]
    },
    {
        "id": "57e3f20f.8de9c4",
        "type": "debug",
        "z": "5f22000e.0f3588",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 1610.2108459472656,
        "y": 2413.8280696868896,
        "wires": []
    },
    {
        "id": "62ae2504.2a00a4",
        "type": "join",
        "z": "5f22000e.0f3588",
        "name": "",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "2",
        "count": "3",
        "x": 1409.9944305419922,
        "y": 2663.64501953125,
        "wires": [
            [
                "4bb727a.81f2858"
            ]
        ]
    },
    {
        "id": "4bb727a.81f2858",
        "type": "join",
        "z": "5f22000e.0f3588",
        "name": "",
        "mode": "custom",
        "build": "merged",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "10",
        "count": "8",
        "x": 1291.8885955810547,
        "y": 2366.4679565429688,
        "wires": [
            [
                "fe2f43d6.3fcaf8"
            ]
        ]
    },
    {
        "id": "24a796b8.43fc12",
        "type": "inject",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 179.75,
        "y": 284,
        "wires": [
            [
                "ecf366c8.8550b8"
            ]
        ]
    },
    {
        "id": "ecf366c8.8550b8",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "msg.topic = \"SELECT * FROM category ORDER BY cat_id\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 342.75,
        "y": 284,
        "wires": [
            [
                "21d8f9f3.166b96"
            ]
        ]
    },
    {
        "id": "21d8f9f3.166b96",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 506.75,
        "y": 284,
        "wires": [
            [
                "d20c2a0e.d5163"
            ]
        ]
    },
    {
        "id": "d20c2a0e.d5163",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Process states",
        "func": "global.set(\"Diag_Category_Buffer\",msg.payload);\n\nvar output = [];\nfor (var i = 0; i < msg.payload.length; i++) {\n    //output.push( \"[\"+msg.payload[i].id+\"] \"+msg.payload[i].caption);\n    obj = {};\n    \n    obj [\"[\"+msg.payload[i].cat_id+\"] \"+msg.payload[i].cat_name]=msg.payload[i].cat_id;\n    output.push(obj);\n}\nmsg.options = output;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 706.75,
        "y": 285,
        "wires": [
            [
                "b34a0c60.124c8",
                "43cff885.157d7"
            ]
        ]
    },
    {
        "id": "b34a0c60.124c8",
        "type": "ui_dropdown",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "Select",
        "place": "",
        "group": "a0bae005.bf1858",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "options": [
            {
                "label": "",
                "value": "",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "",
        "x": 892.75,
        "y": 285,
        "wires": [
            [
                "f74040ee.130c6"
            ]
        ]
    },
    {
        "id": "dab40baa.f8c4c8",
        "type": "ui_text_input",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "Name",
        "group": "a0bae005.bf1858",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": false,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 1119.75,
        "y": 404,
        "wires": [
            [
                "d43c3cd5.7153f"
            ]
        ]
    },
    {
        "id": "f74040ee.130c6",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "global.set(\"diag_cat_selected\",msg.payload);\nmsg.topic = \"SELECT * FROM category WHERE cat_id=\" + msg.payload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 181.75,
        "y": 399,
        "wires": [
            [
                "337a4eba.ab37ba"
            ]
        ]
    },
    {
        "id": "337a4eba.ab37ba",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 345.75,
        "y": 399,
        "wires": [
            [
                "b3917cd7.d50d5"
            ]
        ]
    },
    {
        "id": "b3917cd7.d50d5",
        "type": "switch",
        "z": "9e52ccb8.2c00a8",
        "name": "If no data",
        "property": "payload.length",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 511.75,
        "y": 399,
        "wires": [
            [
                "1aa3b1ec.96e1fe",
                "b40b36ca.827468",
                "56341765.620b98",
                "490d0f6.8f2e87",
                "4bf3cc85.c9f00c",
                "d8fc065e.7f426",
                "b9ad3886.d20ef"
            ]
        ]
    },
    {
        "id": "1aa3b1ec.96e1fe",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].cat_name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 720.75,
        "y": 407,
        "wires": [
            [
                "dab40baa.f8c4c8"
            ]
        ]
    },
    {
        "id": "b40b36ca.827468",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].interruption",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 719.75,
        "y": 448,
        "wires": [
            [
                "72e46d99.0f844c"
            ]
        ]
    },
    {
        "id": "9074a5f7.7cc788",
        "type": "ui_numeric",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "ID",
        "group": "a0bae005.bf1858",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": false,
        "topic": "",
        "format": "{{value}}",
        "min": 0,
        "max": "100",
        "step": 1,
        "x": 1122.75,
        "y": 367,
        "wires": [
            [
                "55944473.59d3dc"
            ]
        ]
    },
    {
        "id": "56341765.620b98",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].cat_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 722.75,
        "y": 367,
        "wires": [
            [
                "9074a5f7.7cc788"
            ]
        ]
    },
    {
        "id": "c3078fc4.730bc",
        "type": "ui_button",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "group": "a0bae005.bf1858",
        "order": 9,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Create New",
        "color": "",
        "bgcolor": "",
        "icon": "add",
        "payload": "",
        "payloadType": "str",
        "topic": "",
        "x": 158.52780151367188,
        "y": 212.99998474121094,
        "wires": [
            [
                "be1e2b0b.1212c"
            ]
        ]
    },
    {
        "id": "be1e2b0b.1212c",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "msg.topic = \"INSERT INTO category (cat_id,cat_name,interruption,max_cont_down_time,min_down_time,max_down_time,down_time_span) VALUES (\";\n\n\nif (global.get(\"diag_cat_id\")!==undefined) {\n    msg.topic = msg.topic+global.get(\"diag_cat_id\")+\", \";\n}else return;\n\nif (global.get(\"diag_cat_name\")!==undefined) {\n    msg.topic = msg.topic+ \"'\"+global.get(\"diag_cat_name\")+\"', \";\n}else return;\n\nif (global.get(\"diag_cat_interr\")!==undefined) {\n    msg.topic = msg.topic+global.get(\"diag_cat_interr\")+\",\";\n}else return;\n\n//if no interruption possible no further data saved\nif (global.get(\"diag_cat_interr\") === 0) {\n    msg.topic = msg.topic+ \"NULL,NULL,NULL,NULL)\";  \n}else{\n    if (global.get(\"diag_cat_maxcdt\")!==undefined) {\n        msg.topic = msg.topic+global.get(\"diag_cat_maxcdt\")+\",\";\n    }else return;\n    if (global.get(\"diag_cat_mindt\")!==undefined) {\n        msg.topic = msg.topic+global.get(\"diag_cat_mindt\")+\",\";\n    }else return;   \n    if (global.get(\"diag_cat_maxdt\")!==undefined) {\n        msg.topic = msg.topic+global.get(\"diag_cat_maxdt\")+\",\";\n    }else return;   \n    if (global.get(\"diag_cat_dts\")!==undefined) {\n        msg.topic = msg.topic+global.get(\"diag_cat_dts\")+\")\";\n    }else return;   \n}\n\nglobal.set(\"diag_cat_id\",undefined);\nglobal.set(\"diag_cat_name\",undefined);\nglobal.set(\"diag_cat_interr\",undefined);\nglobal.set(\"diag_cat_maxcdt\",undefined);\nglobal.set(\"diag_cat_mindt\",undefined);\nglobal.set(\"diag_cat_maxdt\",undefined);\nglobal.set(\"diag_cat_dts\",undefined);\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 355.75,
        "y": 213,
        "wires": [
            [
                "9ed25d37.3ecf9"
            ]
        ]
    },
    {
        "id": "9ed25d37.3ecf9",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 519.75,
        "y": 213,
        "wires": [
            [
                "ecf366c8.8550b8",
                "2380439e.b794fc"
            ]
        ]
    },
    {
        "id": "55944473.59d3dc",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"diag_cat_id\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1308.75,
        "y": 366,
        "wires": [
            []
        ]
    },
    {
        "id": "d43c3cd5.7153f",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"diag_cat_name\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1310.75,
        "y": 404,
        "wires": [
            []
        ]
    },
    {
        "id": "3c9979a6.6fcfb6",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"diag_cat_interr\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1313.75,
        "y": 444,
        "wires": [
            []
        ]
    },
    {
        "id": "72b50bfc.f44614",
        "type": "ui_button",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "group": "a0bae005.bf1858",
        "order": 10,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Update selected",
        "color": "",
        "bgcolor": "#FF9000",
        "icon": "mode_edit",
        "payload": "",
        "payloadType": "str",
        "topic": "",
        "x": 168.75,
        "y": 168,
        "wires": [
            [
                "4b6a169e.11715"
            ]
        ]
    },
    {
        "id": "4b6a169e.11715",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "if (global.get(\"diag_cat_selected\")!==undefined) {\n    msg.topic = \"UPDATE category SET \";\n    \n    if (global.get(\"diag_cat_id\")!==undefined) {\n        msg.topic = msg.topic+\"cat_id=\"+global.get(\"diag_cat_id\")+\",\";\n    }\n    \n    if (global.get(\"diag_cat_name\")!==undefined) {\n        msg.topic = msg.topic+\"cat_name='\"+global.get(\"diag_cat_name\")+\"',\";\n    }\n    \n    if (global.get(\"diag_cat_interr\")!==undefined) {\n        msg.topic = msg.topic+\"interruption=\"+global.get(\"diag_cat_interr\")+\",\";\n    }\n    \n    if (global.get(\"diag_cat_maxcdt\")!==undefined) {\n        msg.topic = msg.topic+\"max_cont_down_time=\"+global.get(\"diag_cat_maxcdt\")+\",\";\n    }\n    if (global.get(\"diag_cat_mindt\")!==undefined) {\n        msg.topic = msg.topic+\"min_down_time=\"+global.get(\"diag_cat_mindt\")+\",\";\n    } \n    if (global.get(\"diag_cat_maxdt\")!==undefined) {\n        msg.topic = msg.topic+\"max_down_time=\"+global.get(\"diag_cat_maxdt\")+\",\";\n    }  \n    if (global.get(\"diag_cat_dts\")!==undefined) {\n        msg.topic = msg.topic+\"down_time_span=\"+global.get(\"diag_cat_dts\")+\",\";\n    }   \n    \n    msg.topic = msg.topic.substring(0,msg.topic.length-1);      //rever razo\n    msg.topic = msg.topic+ \" WHERE cat_id=\"+global.get(\"diag_cat_selected\");\n    \n    \n    global.set(\"diag_cat_id\",undefined);\n    global.set(\"diag_cat_name\",undefined);\n    global.set(\"diag_cat_interr\",undefined);\n    global.set(\"diag_cat_maxcdt\",undefined);\n    global.set(\"diag_cat_mindt\",undefined);\n    global.set(\"diag_cat_maxdt\",undefined);\n    global.set(\"diag_cat_dts\",undefined);\n} else {\n    msg.topic = \"\";\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 353.75,
        "y": 169,
        "wires": [
            [
                "da5fa8b4.fbac2"
            ]
        ]
    },
    {
        "id": "da5fa8b4.fbac2",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 521.75,
        "y": 167,
        "wires": [
            [
                "ecf366c8.8550b8",
                "4c3b2d2f.af8f04"
            ]
        ]
    },
    {
        "id": "3bbdef9f.b73b",
        "type": "ui_button",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "group": "a0bae005.bf1858",
        "order": 11,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Delete selected",
        "color": "",
        "bgcolor": "#ff5555",
        "icon": "delete",
        "payload": "",
        "payloadType": "str",
        "topic": "",
        "x": 167.52777099609375,
        "y": 120.99998474121094,
        "wires": [
            [
                "7f790cef.a8019c"
            ]
        ]
    },
    {
        "id": "7f790cef.a8019c",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "if (global.get(\"diag_cat_selected\")!==undefined) {\n    msg.topic = \"DELETE FROM category WHERE cat_id=\"+global.get(\"diag_cat_selected\");\n    global.set(\"diag_cat_id\",undefined);\n    global.set(\"diag_cat_name\",undefined);\n    global.set(\"diag_cat_interr\",undefined);\n    global.set(\"diag_cat_maxcdt\",undefined);\n    global.set(\"diag_cat_mindt\",undefined);\n    global.set(\"diag_cat_maxdt\",undefined);\n    global.set(\"diag_cat_dts\",undefined);\n} else {\n    msg.topic = \"\";\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 354.75,
        "y": 121,
        "wires": [
            [
                "74a20dcf.e4e2d4"
            ]
        ]
    },
    {
        "id": "74a20dcf.e4e2d4",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 520.75,
        "y": 122,
        "wires": [
            [
                "ecf366c8.8550b8",
                "ba387b1c.bbaba8"
            ]
        ]
    },
    {
        "id": "6cbdfd59.b5b3fc",
        "type": "comment",
        "z": "9e52ccb8.2c00a8",
        "name": "Maintenance of the category table",
        "info": "",
        "x": 237.75,
        "y": 74,
        "wires": []
    },
    {
        "id": "f1febb13.c98da8",
        "type": "ui_toast",
        "z": "9e52ccb8.2c00a8",
        "position": "top right",
        "displayTime": "3",
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "topic": "",
        "name": "",
        "x": 1003.75,
        "y": 168,
        "wires": []
    },
    {
        "id": "ba387b1c.bbaba8",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Toast msg",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "Selected entry has been deleted",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 728.25,
        "y": 122,
        "wires": [
            [
                "f1febb13.c98da8"
            ]
        ]
    },
    {
        "id": "4c3b2d2f.af8f04",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Toast msg",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "Selected entry has been updated",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 728.75,
        "y": 172,
        "wires": [
            [
                "f1febb13.c98da8"
            ]
        ]
    },
    {
        "id": "2380439e.b794fc",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Toast msg",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "New entry has been created",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 728.75,
        "y": 217,
        "wires": [
            [
                "f1febb13.c98da8"
            ]
        ]
    },
    {
        "id": "72e46d99.0f844c",
        "type": "ui_switch",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "Interruptible",
        "group": "a0bae005.bf1858",
        "order": 4,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "",
        "style": "",
        "onvalue": "1",
        "onvalueType": "num",
        "onicon": "",
        "oncolor": "",
        "offvalue": "0",
        "offvalueType": "num",
        "officon": "",
        "offcolor": "",
        "x": 1144.36669921875,
        "y": 447,
        "wires": [
            [
                "3c9979a6.6fcfb6"
            ]
        ]
    },
    {
        "id": "1c586891.1f76e7",
        "type": "ui_text_input",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "Maximum continuous down time (min)",
        "group": "a0bae005.bf1858",
        "order": 5,
        "width": 0,
        "height": 0,
        "passthru": false,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 1218.75,
        "y": 490.75,
        "wires": [
            [
                "f83b686f.d7cb8"
            ]
        ]
    },
    {
        "id": "f83b686f.d7cb8",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"diag_cat_maxcdt\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1461.75,
        "y": 490.75,
        "wires": [
            []
        ]
    },
    {
        "id": "a4ddcdbd.396fd8",
        "type": "ui_text_input",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "Minimum down time (min)",
        "group": "a0bae005.bf1858",
        "order": 6,
        "width": 0,
        "height": 0,
        "passthru": false,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 1177.75,
        "y": 528.75,
        "wires": [
            [
                "7e839474.03b15c"
            ]
        ]
    },
    {
        "id": "490d0f6.8f2e87",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].min_down_time",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 718.75,
        "y": 531.75,
        "wires": [
            [
                "9a73796d.35e4c8"
            ]
        ]
    },
    {
        "id": "7e839474.03b15c",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"diag_cat_mindt\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1467.75,
        "y": 526.75,
        "wires": [
            []
        ]
    },
    {
        "id": "30e3ca.b420ac36",
        "type": "ui_text_input",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "Maximum down time (min)",
        "group": "a0bae005.bf1858",
        "order": 7,
        "width": 0,
        "height": 0,
        "passthru": false,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 1177.75,
        "y": 565.75,
        "wires": [
            [
                "cf0c116f.b69818"
            ]
        ]
    },
    {
        "id": "4bf3cc85.c9f00c",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].max_down_time",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 718.75,
        "y": 568.75,
        "wires": [
            [
                "b2333801.1cf12"
            ]
        ]
    },
    {
        "id": "cf0c116f.b69818",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"diag_cat_maxdt\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1477.75,
        "y": 564.75,
        "wires": [
            []
        ]
    },
    {
        "id": "5f8a8013.a9e2b8",
        "type": "ui_text_input",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "Down time span (hours)",
        "group": "a0bae005.bf1858",
        "order": 8,
        "width": 0,
        "height": 0,
        "passthru": false,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 1175.75,
        "y": 600.75,
        "wires": [
            [
                "4087c7c9.b3ec48"
            ]
        ]
    },
    {
        "id": "d8fc065e.7f426",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].down_time_span",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 716.75,
        "y": 603.75,
        "wires": [
            [
                "4b72354b.0737bc"
            ]
        ]
    },
    {
        "id": "4087c7c9.b3ec48",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"diag_cat_dts\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1472.75,
        "y": 601.75,
        "wires": [
            []
        ]
    },
    {
        "id": "b9ad3886.d20ef",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].max_cont_down_time",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 719.75,
        "y": 493.75,
        "wires": [
            [
                "93e8771d.e71858"
            ]
        ]
    },
    {
        "id": "93e8771d.e71858",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "blanck if null",
        "func": "if ( (msg.payload===\"NaN\") || (!msg.payload) ) \n    msg.payload = \"\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 930.36669921875,
        "y": 491,
        "wires": [
            [
                "1c586891.1f76e7"
            ]
        ]
    },
    {
        "id": "9a73796d.35e4c8",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "blanck if null",
        "func": "if ( (msg.payload===\"NaN\") || (!msg.payload) ) \n    msg.payload = \"\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 925.75,
        "y": 529.75,
        "wires": [
            [
                "a4ddcdbd.396fd8"
            ]
        ]
    },
    {
        "id": "b2333801.1cf12",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "blanck if null",
        "func": "if ( (msg.payload===\"NaN\") || (!msg.payload) ) \n    msg.payload = \"\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 922.75,
        "y": 566.75,
        "wires": [
            [
                "30e3ca.b420ac36"
            ]
        ]
    },
    {
        "id": "4b72354b.0737bc",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "blanck if null",
        "func": "if ( (msg.payload===\"NaN\") || (!msg.payload) ) \n    msg.payload = \"\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 921.75,
        "y": 603.75,
        "wires": [
            [
                "5f8a8013.a9e2b8"
            ]
        ]
    },
    {
        "id": "9a55cda7.e1a43",
        "type": "inject",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 184.75,
        "y": 926.75,
        "wires": [
            [
                "f66645b2.1d6348"
            ]
        ]
    },
    {
        "id": "f66645b2.1d6348",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "msg.topic = \"SELECT * FROM system2 ORDER BY sys_id\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 360.2500305175781,
        "y": 925.5,
        "wires": [
            [
                "a08c7661.2d09",
                "fe8f69c9.751968"
            ]
        ]
    },
    {
        "id": "a08c7661.2d09",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 511.75,
        "y": 926.75,
        "wires": [
            [
                "d4b0ab80.e0766",
                "ec383f98.029f9"
            ]
        ]
    },
    {
        "id": "d4b0ab80.e0766",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Process systems",
        "func": "global.set(\"Diag_System2_Buffer\",msg.payload);\n\nvar output = [];\nfor (var i = 0; i < msg.payload.length; i++) {\n    //output.push( \"[\"+msg.payload[i].id+\"] \"+msg.payload[i].caption);\n    obj = {};\n    \n    obj [\"[\"+msg.payload[i].sys_id+\"] \"+msg.payload[i].sys_name]=msg.payload[i].sys_id;\n    output.push(obj);\n}\nmsg.options = output;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 721.75,
        "y": 927.75,
        "wires": [
            [
                "443a9446.c414ac"
            ]
        ]
    },
    {
        "id": "443a9446.c414ac",
        "type": "ui_dropdown",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "Select",
        "place": "",
        "group": "dc50d37c.093608",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "options": [
            {
                "label": "",
                "value": "",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "",
        "x": 897.75,
        "y": 927.75,
        "wires": [
            [
                "48c2756e.e5fb0c"
            ]
        ]
    },
    {
        "id": "306a9be5.297cb4",
        "type": "ui_text_input",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "Name",
        "group": "dc50d37c.093608",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": false,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 930,
        "y": 1120,
        "wires": [
            [
                "eeaabb15.6d728"
            ]
        ]
    },
    {
        "id": "48c2756e.e5fb0c",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "global.set(\"diag_system2_selected\",msg.payload);\nmsg.topic = \"SELECT * FROM system2 WHERE sys_id=\" + msg.payload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 196.75,
        "y": 1082.75,
        "wires": [
            [
                "2569dd5c.34ea5a"
            ]
        ]
    },
    {
        "id": "2569dd5c.34ea5a",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 360.75,
        "y": 1082.75,
        "wires": [
            [
                "f7207033.591978"
            ]
        ]
    },
    {
        "id": "f7207033.591978",
        "type": "switch",
        "z": "9e52ccb8.2c00a8",
        "name": "If no data",
        "property": "payload.length",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 526.75,
        "y": 1082.75,
        "wires": [
            [
                "3b82865d.0e1a5a",
                "273f154c.3d62ca",
                "ba3a9de7.3f0ba8"
            ]
        ]
    },
    {
        "id": "3b82865d.0e1a5a",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].sys_name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 741.75,
        "y": 1119.75,
        "wires": [
            [
                "306a9be5.297cb4"
            ]
        ]
    },
    {
        "id": "ae462da0.4bd778",
        "type": "ui_numeric",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "ID",
        "group": "dc50d37c.093608",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": false,
        "topic": "",
        "format": "{{value}}",
        "min": 0,
        "max": "100",
        "step": 1,
        "x": 932.75,
        "y": 1082.75,
        "wires": [
            [
                "a622e2bb.e99b98"
            ]
        ]
    },
    {
        "id": "273f154c.3d62ca",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].sys_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 746.75,
        "y": 1082.75,
        "wires": [
            [
                "ae462da0.4bd778"
            ]
        ]
    },
    {
        "id": "e6c42868.536b38",
        "type": "ui_button",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "group": "dc50d37c.093608",
        "order": 5,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Create New",
        "color": "",
        "bgcolor": "",
        "icon": "add",
        "payload": "",
        "payloadType": "str",
        "topic": "",
        "x": 167.75,
        "y": 856.75,
        "wires": [
            [
                "6666e90a.98434"
            ]
        ]
    },
    {
        "id": "6666e90a.98434",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "msg.topic = \"INSERT INTO system2 (sys_id,sys_name,sys_state,sys_cat) VALUES (\";\n\nif (global.get(\"diag_system2_id\")!==undefined) {\n    msg.topic = msg.topic+global.get(\"diag_system2_id\")+\", \";\n\n}else return;\n\nif (global.get(\"diag_system2_name\")!==undefined) {\n    msg.topic = msg.topic+ \"'\"+global.get(\"diag_system2_name\")+\"',\";\n}else return;\n\nmsg.topic = msg.topic+ \"0,\";\n\nif (global.get(\"diag_system2_cat\")!==undefined) {\n    msg.topic = msg.topic+global.get(\"diag_system2_cat\")+\")\";\n}else return;\n\nglobal.set(\"diag_system2_selected\",undefined);\nglobal.set(\"diag_system2_id\",undefined);\nglobal.set(\"diag_system2_name\",undefined);\nglobal.set(\"diag_system2_cat\",undefined);\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 360.75,
        "y": 855.75,
        "wires": [
            [
                "89971938.54d91"
            ]
        ]
    },
    {
        "id": "89971938.54d91",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 524.75,
        "y": 855.75,
        "wires": [
            [
                "f66645b2.1d6348",
                "480e6b.acdc4194"
            ]
        ]
    },
    {
        "id": "a622e2bb.e99b98",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"diag_system2_id\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1118.75,
        "y": 1081.75,
        "wires": [
            []
        ]
    },
    {
        "id": "eeaabb15.6d728",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"diag_system2_name\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1120.75,
        "y": 1119.75,
        "wires": [
            []
        ]
    },
    {
        "id": "caf2dc05.6cbe28",
        "type": "ui_button",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "group": "dc50d37c.093608",
        "order": 6,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Update selected",
        "color": "",
        "bgcolor": "#FF9000",
        "icon": "mode_edit",
        "payload": "",
        "payloadType": "str",
        "topic": "",
        "x": 173.75,
        "y": 810.75,
        "wires": [
            [
                "54f20cce.18260c"
            ]
        ]
    },
    {
        "id": "54f20cce.18260c",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "if (global.get(\"diag_system2_selected\")!==undefined) {\n    msg.topic = \"UPDATE system2 SET \";\n    if (global.get(\"diag_system2_id\")!==undefined) {\n        msg.topic = msg.topic+ \"sys_id=\"+global.get(\"diag_system2_id\")+\",\";\n    }\n    if (global.get(\"diag_system2_name\")!==undefined) {\n        msg.topic = msg.topic+ \"sys_name='\"+global.get(\"diag_system2_name\")+\"',\";\n    }\n    if (global.get(\"diag_system2_cat\")!==undefined) {\n        msg.topic = msg.topic+ \"sys_cat=\"+global.get(\"diag_system2_cat\")+\",\";\n    }\n    \n    msg.topic = msg.topic.substring(0,msg.topic.length-1);\n    msg.topic = msg.topic+ \" WHERE sys_id=\"+global.get(\"diag_system2_selected\");\n    \n    global.set(\"diag_system2_selected\",undefined);\n    global.set(\"diag_system2_id\",undefined);\n    global.set(\"diag_system2_name\",undefined);\n    global.set(\"diag_system2_cat\",undefined);\n} else {\n    msg.topic = \"\";\n}\nreturn msg;\n\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 358.75,
        "y": 811.75,
        "wires": [
            [
                "89dd753a.a4422"
            ]
        ]
    },
    {
        "id": "89dd753a.a4422",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 526.75,
        "y": 809.75,
        "wires": [
            [
                "f66645b2.1d6348",
                "44db0a01.50f834"
            ]
        ]
    },
    {
        "id": "d040567d.b19268",
        "type": "ui_button",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "group": "dc50d37c.093608",
        "order": 7,
        "width": 0,
        "height": 0,
        "passthru": false,
        "label": "Delete selected",
        "color": "",
        "bgcolor": "#ff5555",
        "icon": "delete",
        "payload": "",
        "payloadType": "str",
        "topic": "",
        "x": 174.75,
        "y": 763.75,
        "wires": [
            [
                "cd8e5148.61985"
            ]
        ]
    },
    {
        "id": "cd8e5148.61985",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "if (global.get(\"diag_system2_selected\")!==undefined) {\n    msg.topic = \"DELETE FROM system2 WHERE sys_id=\"+global.get(\"diag_system2_selected\");\n    global.set(\"diag_system2_selected\",undefined);\n    global.set(\"diag_system2_id\",undefined);\n    global.set(\"diag_system2_name\",undefined);\n    global.set(\"diag_system2_cat\",undefined);\n} else {\n    msg.topic = \"\";\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 359.75,
        "y": 763.75,
        "wires": [
            [
                "3ce03cd5.24798c"
            ]
        ]
    },
    {
        "id": "3ce03cd5.24798c",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 525.75,
        "y": 764.75,
        "wires": [
            [
                "f66645b2.1d6348",
                "9f5d6e29.e26d4"
            ]
        ]
    },
    {
        "id": "440c2f16.d32ec8",
        "type": "comment",
        "z": "9e52ccb8.2c00a8",
        "name": "Maintenance of the System table",
        "info": "",
        "x": 232.75,
        "y": 716.75,
        "wires": []
    },
    {
        "id": "91a44110.6934f8",
        "type": "ui_toast",
        "z": "9e52ccb8.2c00a8",
        "position": "top right",
        "displayTime": "3",
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "topic": "",
        "name": "",
        "x": 1039.861083984375,
        "y": 808.6388244628906,
        "wires": []
    },
    {
        "id": "9f5d6e29.e26d4",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Toast msg",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "Selected entry has been deleted",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 768.25,
        "y": 765.75,
        "wires": [
            [
                "91a44110.6934f8"
            ]
        ]
    },
    {
        "id": "44db0a01.50f834",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Toast msg",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "Selected entry has been updated",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 767.75,
        "y": 809.75,
        "wires": [
            [
                "91a44110.6934f8"
            ]
        ]
    },
    {
        "id": "480e6b.acdc4194",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Toast msg",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "New entry has been created",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 767.75,
        "y": 855.75,
        "wires": [
            [
                "91a44110.6934f8"
            ]
        ]
    },
    {
        "id": "ba3a9de7.3f0ba8",
        "type": "change",
        "z": "9e52ccb8.2c00a8",
        "name": "Format data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload[0].sys_cat",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 745.75,
        "y": 1199.75,
        "wires": [
            [
                "b73124e.8383358"
            ]
        ]
    },
    {
        "id": "b73124e.8383358",
        "type": "ui_dropdown",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "Category",
        "place": "",
        "group": "dc50d37c.093608",
        "order": 4,
        "width": 0,
        "height": 0,
        "passthru": false,
        "options": [
            {
                "label": "",
                "value": "",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "",
        "x": 945.75,
        "y": 1199.75,
        "wires": [
            [
                "982ca55.60889d8"
            ]
        ]
    },
    {
        "id": "43cff885.157d7",
        "type": "link out",
        "z": "9e52ccb8.2c00a8",
        "name": "update_cat",
        "links": [
            "107486a1.9a5ec1"
        ],
        "x": 873.36669921875,
        "y": 243.25,
        "wires": []
    },
    {
        "id": "107486a1.9a5ec1",
        "type": "link in",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "links": [
            "43cff885.157d7"
        ],
        "x": 836.36669921875,
        "y": 1154.5,
        "wires": [
            [
                "b73124e.8383358"
            ]
        ]
    },
    {
        "id": "982ca55.60889d8",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"diag_system2_cat\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1118.75,
        "y": 1200.25,
        "wires": [
            []
        ]
    },
    {
        "id": "4a6b14e5.833f9c",
        "type": "comment",
        "z": "9e52ccb8.2c00a8",
        "name": "System status display",
        "info": "",
        "x": 197.7777099609375,
        "y": 1286.166748046875,
        "wires": []
    },
    {
        "id": "e726166a.f8867",
        "type": "template",
        "z": "9e52ccb8.2c00a8",
        "name": "Formatting",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<table>\n    <tr><th>Name</th><th>State</th><th>Category</th><th>Energy state</th><th>last epoch</th><th>Relay State</th><th>Avg consumption</th></tr>\n    {{#payload}}\n        <tr>\n            <td>{{sys_name}}</td>\n            <td bgcolor={{sta_color}}>{{sta_title}}</td>\n            <td align=\"center\">{{sys_cat}}</td>\n            <td align=\"center\">{{sys_energy_state}}</td>\n            <td >{{sys_last_epoch}}</td>\n            <td align=\"center\">{{sys_relay}}</td>\n            <td align=\"center\">{{sys_avg_cons}}</td>\n        </tr>\n    {{/payload}}\n</table>\n",
        "x": 810.97216796875,
        "y": 1347.25,
        "wires": [
            [
                "10409bb4.57203c",
                "455fe6e5.4bd9f8"
            ]
        ]
    },
    {
        "id": "10409bb4.57203c",
        "type": "ui_template",
        "z": "9e52ccb8.2c00a8",
        "group": "5fb27f4a.0e8b48",
        "name": "Status list",
        "order": 0,
        "width": "14",
        "height": "6",
        "format": "<div ng-bind-html=\"msg.payload\" style=\"height:100%;\"></div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "templateScope": "local",
        "x": 1123.7777099609375,
        "y": 1345.944580078125,
        "wires": [
            []
        ]
    },
    {
        "id": "d651d396.4153b",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "msg.topic = \"SELECT * FROM system2, state WHERE sys_state = sta_id ORDER BY sys_id\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 335.7777099609375,
        "y": 1345.944580078125,
        "wires": [
            [
                "9f96743c.782ca8"
            ]
        ]
    },
    {
        "id": "9f96743c.782ca8",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 508.7777099609375,
        "y": 1346.944580078125,
        "wires": [
            [
                "455fe6e5.4bd9f8",
                "e726166a.f8867"
            ]
        ]
    },
    {
        "id": "562602.48daa2",
        "type": "inject",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 168.7777099609375,
        "y": 1345.944580078125,
        "wires": [
            [
                "d651d396.4153b"
            ]
        ]
    },
    {
        "id": "455fe6e5.4bd9f8",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 1110,
        "y": 1400,
        "wires": []
    },
    {
        "id": "434344e3.f7f16c",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Status update 2",
        "func": "msg.topic = \"UPDATE system2 SET sys_state=\"+msg.state+\" WHERE sys_id=\"+msg.system;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 631.5555419921875,
        "y": 1190.4168701171875,
        "wires": [
            [
                "2facdaa8.dcad86"
            ]
        ]
    },
    {
        "id": "1365071c.9ce639",
        "type": "link out",
        "z": "5f22000e.0f3588",
        "name": "update state",
        "links": [
            "9e2e9c38.e703a"
        ],
        "x": 1135.1851806640625,
        "y": 1062.3889465332031,
        "wires": []
    },
    {
        "id": "9e2e9c38.e703a",
        "type": "link in",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "links": [
            "1365071c.9ce639"
        ],
        "x": 187.62962341308594,
        "y": 1396.9999389648438,
        "wires": [
            [
                "d651d396.4153b"
            ]
        ]
    },
    {
        "id": "57d0103d.e5c4a",
        "type": "debug",
        "z": "5f22000e.0f3588",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 550.5463256835938,
        "y": 2047.9861450195312,
        "wires": []
    },
    {
        "id": "ef0e6d30.54bbe",
        "type": "comment",
        "z": "584b08c1.d6cff8",
        "name": "Threshold",
        "info": "",
        "x": 901,
        "y": 298,
        "wires": []
    },
    {
        "id": "b5ebced6.19101",
        "type": "function",
        "z": "584b08c1.d6cff8",
        "name": "set tax value",
        "func": "//0.1652\nglobal.set(\"energy_threshold\",msg.payload);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1259.1192626953125,
        "y": 388.6667022705078,
        "wires": [
            []
        ]
    },
    {
        "id": "5fc1ea62.6f02cc",
        "type": "link in",
        "z": "584b08c1.d6cff8",
        "name": "",
        "links": [
            "92e74f8e.536b",
            "5b454428.1c4fe4"
        ],
        "x": 1100.2222290039062,
        "y": 327.5555419921875,
        "wires": [
            [
                "4249f3ee.d6a484"
            ]
        ]
    },
    {
        "id": "4249f3ee.d6a484",
        "type": "ui_text",
        "z": "584b08c1.d6cff8",
        "group": "e542aa93.916948",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Threshold",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 1246.888916015625,
        "y": 326.44439697265625,
        "wires": []
    },
    {
        "id": "31bc0f9d.684b7",
        "type": "ui_text_input",
        "z": "584b08c1.d6cff8",
        "name": "",
        "label": "change power (Wats)",
        "group": "e542aa93.916948",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 1032.4444580078125,
        "y": 388.6666259765625,
        "wires": [
            [
                "b5ebced6.19101",
                "4249f3ee.d6a484"
            ]
        ]
    },
    {
        "id": "d5d2ce37.d784f8",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore threshold",
        "func": "msg.topic = \"energy_threshold\";\nmsg.payload = global.get(\"energy_threshold\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 507.5,
        "y": 1143.0556030273438,
        "wires": [
            [
                "92e74f8e.536b"
            ]
        ]
    },
    {
        "id": "92e74f8e.536b",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_threshold",
        "links": [
            "399f5635.9ad072",
            "5fc1ea62.6f02cc"
        ],
        "x": 692.6296997070312,
        "y": 1141.388916015625,
        "wires": []
    },
    {
        "id": "d60a3107.f453e",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "round",
        "func": "var devicename = \"plug3\";\nvar system_id = 3; //System id number for fiagnostic update\n\nvar threshold = global.get(\"energy_threshold\");\nvar last_consuming = context.get(devicename +\"_consuming\");\nvar power = msg.payload; \nvar consuming = 0;\nmsg.warning = false;\n\n/*msg.payload = threshold;\n\nreturn msg;\n*/\n\nif(power >= threshold){\n    consuming = 1;\n    \n} \n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n\nif(consuming != last_consuming){\n    context.set(devicename +\"_consuming\",consuming); \n    node.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n    \n    if (consuming == 1){\n        msg.payload = devicename + \" now consuming\";   \n        msg.system = system_id; \n        msg.consuming = 1;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }else{\n        msg.payload = devicename + \" not consuming\";   \n        msg.system = system_id; \n        msg.consuming = 0;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }\n \n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1030,
        "y": 892,
        "wires": [
            [
                "7ceb1c41.75c5ac"
            ]
        ]
    },
    {
        "id": "7ceb1c41.75c5ac",
        "type": "switch",
        "z": "2a4ee4a1.258c6c",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1256.4722900390625,
        "y": 898.388916015625,
        "wires": [
            [
                "27f352e4.061f4e"
            ]
        ]
    },
    {
        "id": "27f352e4.061f4e",
        "type": "link out",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1378.111083984375,
        "y": 894.6943054199219,
        "wires": []
    },
    {
        "id": "480012a9.1339c4",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Energy state update",
        "func": "msg.topic = \"UPDATE system2 SET sys_energy_state=\"+msg.consuming+\" WHERE sys_id=\"+msg.system;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 648.4375,
        "y": 1234.6875610351562,
        "wires": [
            [
                "2facdaa8.dcad86",
                "7ad2263f.f19348"
            ]
        ]
    },
    {
        "id": "aad65bc0.57e8",
        "type": "switch",
        "z": "5f22000e.0f3588",
        "name": "Check if consuming available",
        "property": "consuming",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 397.6319885253906,
        "y": 1233.7708129882812,
        "wires": [
            [
                "480012a9.1339c4"
            ]
        ]
    },
    {
        "id": "b7a8605f.dd321",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "round",
        "func": "var devicename = \"plug1\";\nvar system_id = 1; //System id number for fiagnostic update\n\nvar threshold = global.get(\"energy_threshold\");\nvar last_consuming = context.get(devicename +\"_consuming\");\nvar power = msg.payload; \nvar consuming = 0;\nmsg.warning = false;\n\n/*msg.payload = threshold;\n\nreturn msg;\n*/\n\nif(power >= threshold){\n    consuming = 1;\n    \n} \n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n\nif(consuming != last_consuming){\n    context.set(devicename +\"_consuming\",consuming); \n    node.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n    \n    if (consuming == 1){\n        msg.payload = devicename + \" now consuming\";   \n        msg.system = system_id; \n        msg.consuming = 1;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }else{\n        msg.payload = devicename + \" not consuming\";   \n        msg.system = system_id; \n        msg.consuming = 0;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }\n \n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1110.9375,
        "y": 872.1875,
        "wires": [
            [
                "abb0bb89.cffc38"
            ]
        ]
    },
    {
        "id": "abb0bb89.cffc38",
        "type": "switch",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1271.7706909179688,
        "y": 872.048583984375,
        "wires": [
            [
                "e44bc285.5dbfd8"
            ]
        ]
    },
    {
        "id": "e44bc285.5dbfd8",
        "type": "link out",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1384.6594848632812,
        "y": 877.10400390625,
        "wires": []
    },
    {
        "id": "7ad2263f.f19348",
        "type": "debug",
        "z": "5f22000e.0f3588",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 1009.2083740234375,
        "y": 1235.9375610351562,
        "wires": []
    },
    {
        "id": "5c7e8aa7.8290cc",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "round",
        "func": "var devicename = \"plug2\";\nvar system_id = 2; //System id number for fiagnostic update\n\nvar threshold = global.get(\"energy_threshold\");\nvar last_consuming = context.get(devicename +\"_consuming\");\nvar power = msg.payload; \nvar consuming = 0;\nmsg.warning = false;\n\n/*msg.payload = threshold;\n\nreturn msg;\n*/\n\nif(power >= threshold){\n    consuming = 1;\n    \n} \n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n\nif(consuming != last_consuming){\n    context.set(devicename +\"_consuming\",consuming); \n    node.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n    \n    if (consuming == 1){\n        msg.payload = devicename + \" now consuming\";   \n        msg.system = system_id; \n        msg.consuming = 1;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }else{\n        msg.payload = devicename + \" not consuming\";   \n        msg.system = system_id; \n        msg.consuming = 0;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }\n \n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 929.6875,
        "y": 899.6875,
        "wires": [
            [
                "c2b99250.a90fc"
            ]
        ]
    },
    {
        "id": "c2b99250.a90fc",
        "type": "switch",
        "z": "bbaf6eb0.1f878",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1090.5206909179688,
        "y": 899.548583984375,
        "wires": [
            [
                "92bfe55f.c321b8"
            ]
        ]
    },
    {
        "id": "92bfe55f.c321b8",
        "type": "link out",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1203.4094848632812,
        "y": 904.60400390625,
        "wires": []
    },
    {
        "id": "b44bffa.c670b",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "round",
        "func": "var devicename = \"plug0\";\nvar system_id = 10; //System id number for fiagnostic update\n\nvar threshold = global.get(\"energy_threshold\");\nvar last_consuming = context.get(devicename +\"_consuming\");\nvar power = msg.payload; \nvar consuming = 0;\nmsg.warning = false;\n\n/*msg.payload = threshold;\n\nreturn msg;\n*/\n\nif(power >= threshold){\n    consuming = 1;\n    \n} \n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n\nif(consuming != last_consuming){\n    context.set(devicename +\"_consuming\",consuming); \n    node.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n    \n    if (consuming == 1){\n        msg.payload = devicename + \" now consuming\";   \n        msg.system = system_id; \n        msg.consuming = 1;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }else{\n        msg.payload = devicename + \" not consuming\";   \n        msg.system = system_id; \n        msg.consuming = 0;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }\n \n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 861.0764770507812,
        "y": 692.3264770507812,
        "wires": [
            [
                "bc5d0eb9.25a3"
            ]
        ]
    },
    {
        "id": "bc5d0eb9.25a3",
        "type": "switch",
        "z": "ef23770c.5edc1",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1021.90966796875,
        "y": 692.1875610351562,
        "wires": [
            [
                "bfb77a28.136ff8"
            ]
        ]
    },
    {
        "id": "bfb77a28.136ff8",
        "type": "link out",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1133.6874389648438,
        "y": 690.5762939453125,
        "wires": []
    },
    {
        "id": "a7bc17f9.7ce678",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "round",
        "func": "var devicename = \"plugA\";\nvar system_id = 11; //System id number for fiagnostic update\n\nvar threshold = global.get(\"energy_threshold\");\nvar last_consuming = context.get(devicename +\"_consuming\");\nvar power = msg.payload; \nvar consuming = 0;\nmsg.warning = false;\n\n/*msg.payload = threshold;\n\nreturn msg;\n*/\n\nif(power >= threshold){\n    consuming = 1;\n    \n} \n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n\nif(consuming != last_consuming){\n    context.set(devicename +\"_consuming\",consuming); \n    node.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n    \n    if (consuming == 1){\n        msg.payload = devicename + \" now consuming\";   \n        msg.system = system_id; \n        msg.consuming = 1;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }else{\n        msg.payload = devicename + \" not consuming\";   \n        msg.system = system_id; \n        msg.consuming = 0;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }\n \n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 997.1875,
        "y": 430.9375,
        "wires": [
            [
                "d48824de.0b2ed8"
            ]
        ]
    },
    {
        "id": "d48824de.0b2ed8",
        "type": "switch",
        "z": "be52c199.c86f58",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1158.0206909179688,
        "y": 430.798583984375,
        "wires": [
            [
                "2ef065d7.99110a"
            ]
        ]
    },
    {
        "id": "2ef065d7.99110a",
        "type": "link out",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1270.9094848632812,
        "y": 435.85400390625,
        "wires": []
    },
    {
        "id": "c95ba018.0786a",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "round",
        "func": "var devicename = \"plugB\";\nvar system_id = 12; //System id number for fiagnostic update\n\nvar threshold = global.get(\"energy_threshold\");\nvar last_consuming = context.get(devicename +\"_consuming\");\nvar power = msg.payload; \nvar consuming = 0;\nmsg.warning = false;\n\n/*msg.payload = threshold;\n\nreturn msg;\n*/\n\nif(power >= threshold){\n    consuming = 1;\n    \n} \n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n\nif(consuming != last_consuming){\n    context.set(devicename +\"_consuming\",consuming); \n    node.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n    \n    if (consuming == 1){\n        msg.payload = devicename + \" now consuming\";   \n        msg.system = system_id; \n        msg.consuming = 1;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }else{\n        msg.payload = devicename + \" not consuming\";   \n        msg.system = system_id; \n        msg.consuming = 0;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }\n \n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1054.6875,
        "y": 433.4375,
        "wires": [
            [
                "356195.d30d9e6c"
            ]
        ]
    },
    {
        "id": "356195.d30d9e6c",
        "type": "switch",
        "z": "c1eaebbb.b6c98",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1215.5206909179688,
        "y": 433.298583984375,
        "wires": [
            [
                "2a69a773.cadc6"
            ]
        ]
    },
    {
        "id": "2a69a773.cadc6",
        "type": "link out",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1328.4094848632812,
        "y": 438.35400390625,
        "wires": []
    },
    {
        "id": "642f4ea8.183638",
        "type": "function",
        "z": "2cf1d395.65be64",
        "name": "round",
        "func": "var devicename = \"plugS\";\nvar system_id = 5; //System id number for fiagnostic update\n\nvar threshold = global.get(\"energy_threshold\");\nvar last_consuming = context.get(devicename +\"_consuming\");\nvar power = msg.payload; \nvar consuming = 0;\nmsg.warning = false;\n\n/*msg.payload = threshold;\n\nreturn msg;\n*/\n\nif(power >= threshold){\n    consuming = 1;\n    \n} \n\n\nif(consuming != last_consuming){\n    context.set(devicename +\"_consuming\",consuming); \n    node.status({fill:\"blue\",shape:\"ring\",text:\"Producing:\" + consuming});\n    \n    if (consuming == 1){\n        msg.payload = devicename + \" now producing\";   \n        msg.system = system_id; \n        msg.consuming = 1;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }else{\n        msg.payload = devicename + \" not producing\";   \n        msg.system = system_id; \n        msg.consuming = 0;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }\n \n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 864.7525634765625,
        "y": 517.6258544921875,
        "wires": [
            [
                "f1360ea4.cdbbd"
            ]
        ]
    },
    {
        "id": "f1360ea4.cdbbd",
        "type": "switch",
        "z": "2cf1d395.65be64",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1025.5857543945312,
        "y": 517.4869384765625,
        "wires": [
            [
                "d7d571fc.e9529"
            ]
        ]
    },
    {
        "id": "d7d571fc.e9529",
        "type": "link out",
        "z": "2cf1d395.65be64",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1147.5656127929688,
        "y": 517.0878295898438,
        "wires": []
    },
    {
        "id": "35f44c43.6243c4",
        "type": "aggregator",
        "z": "2cf1d395.65be64",
        "name": "5s mean",
        "topic": "Solar",
        "intervalCount": "5",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 519.509033203125,
        "y": 558.6160888671875,
        "wires": [
            [
                "642f4ea8.183638",
                "1a4538aa.5d83cf"
            ]
        ]
    },
    {
        "id": "5d79d3c7.eba19c",
        "type": "aggregator",
        "z": "a4b5eb1e.5dd4d8",
        "name": "5s mean",
        "topic": "Solar",
        "intervalCount": "5",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 573.4375,
        "y": 903.4375,
        "wires": [
            [
                "b7a8605f.dd321"
            ]
        ]
    },
    {
        "id": "c67758d0.144f78",
        "type": "aggregator",
        "z": "bbaf6eb0.1f878",
        "name": "5s mean",
        "topic": "Solar",
        "intervalCount": "5",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 462.1875,
        "y": 899.6875,
        "wires": [
            [
                "5c7e8aa7.8290cc"
            ]
        ]
    },
    {
        "id": "494c0474.96f3cc",
        "type": "aggregator",
        "z": "2a4ee4a1.258c6c",
        "name": "5s mean",
        "topic": "Solar",
        "intervalCount": "5",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 524.6875,
        "y": 890.9375,
        "wires": [
            [
                "d60a3107.f453e"
            ]
        ]
    },
    {
        "id": "eb575e5b.cced",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 742.75,
        "y": 2509.75,
        "wires": []
    },
    {
        "id": "5e87ad7f.c1d4ac",
        "type": "comment",
        "z": "a4b5eb1e.5dd4d8",
        "name": "<==========Avg consumption while on==========>",
        "info": "",
        "x": 671.5,
        "y": 2556,
        "wires": []
    },
    {
        "id": "829fc984.a76468",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "SQL",
        "func": "var device = \"plug1\"; //System id number for fiagnostic update\n\n\nvar threshold = global.get(\"energy_threshold\");\n// This will handle any device and any attribute as long as it is in the DB\nvar p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\n\n\nfromdate = context.get(\"fromdate\");\nif (fromdate===undefined) {\n    // set the period to a default if it is not selected yet\n    fromdate = today0h-7*p_1d;\n}\nenddate = context.get(\"enddate\");\nif (enddate===undefined) {\n    // set the period to a default if it is not selected yet\n    enddate = today0h;\n}\n\n\n// Regenerate the SQL statements\n// Run through the data source list an generate the SQL statements\n\n\nmsg.topic = \"SELECT AVG(value) FROM sensor_data WHERE device='\"+device+\"' AND sensor='power' AND value > \"+threshold+\" AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 616.75,
        "y": 2631.75,
        "wires": [
            [
                "62d3dbc5.115e7c"
            ]
        ]
    },
    {
        "id": "62d3dbc5.115e7c",
        "type": "sqlite",
        "z": "a4b5eb1e.5dd4d8",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 763.75,
        "y": 2631.75,
        "wires": [
            [
                "3321d63f.0c257a"
            ]
        ]
    },
    {
        "id": "225c3915.b283a6",
        "type": "inject",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Daily AVG ",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "00 01 * * *",
        "once": false,
        "x": 465.75,
        "y": 2633.75,
        "wires": [
            [
                "829fc984.a76468"
            ]
        ]
    },
    {
        "id": "9fa52ff4.e88cc8",
        "type": "debug",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1123.36669921875,
        "y": 2687.75,
        "wires": []
    },
    {
        "id": "3321d63f.0c257a",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "save avg",
        "func": "var system_id = 1; //System id number for fiagnostic update\n\n\nvar power = Number((msg.payload[0][\"AVG(value)\"]).toFixed(2));\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"AVG power:\" + power});\n\nmsg.payload = null;\nmsg.system = system_id; \nmsg.avg = power;\nmsg.severity = 0;\nmsg.warning = true;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 929.566650390625,
        "y": 2631.16650390625,
        "wires": [
            [
                "9fa52ff4.e88cc8",
                "9d9dacd3.2e77d"
            ]
        ]
    },
    {
        "id": "9d9dacd3.2e77d",
        "type": "link out",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1076.2886962890625,
        "y": 2630.082763671875,
        "wires": []
    },
    {
        "id": "46eef2e3.d83824",
        "type": "switch",
        "z": "5f22000e.0f3588",
        "name": "Check if payload available",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 387.75,
        "y": 1064.25,
        "wires": [
            [
                "7e534bf2.d71844",
                "f0abb9d6.4748b8"
            ]
        ]
    },
    {
        "id": "429eba55.d16424",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Energy AVG update",
        "func": "msg.topic = \"UPDATE system2 SET sys_avg_cons=\"+msg.avg+\" WHERE sys_id=\"+msg.system;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650.75,
        "y": 1274,
        "wires": [
            [
                "23409c0a.1ce434",
                "2facdaa8.dcad86"
            ]
        ]
    },
    {
        "id": "8e47776d.c30db",
        "type": "switch",
        "z": "5f22000e.0f3588",
        "name": "Check if AVG available",
        "property": "avg",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 376.9444885253906,
        "y": 1273.083251953125,
        "wires": [
            [
                "429eba55.d16424"
            ]
        ]
    },
    {
        "id": "23409c0a.1ce434",
        "type": "debug",
        "z": "5f22000e.0f3588",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 1008.5208740234375,
        "y": 1275.25,
        "wires": []
    },
    {
        "id": "4bb55e03.d4128",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 688.75,
        "y": 2731.75,
        "wires": []
    },
    {
        "id": "1e02a48d.9124ab",
        "type": "comment",
        "z": "bbaf6eb0.1f878",
        "name": "<==========Avg consumption while on==========>",
        "info": "",
        "x": 617.5,
        "y": 2778,
        "wires": []
    },
    {
        "id": "c645ddc5.60caa",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "SQL",
        "func": "var device = \"plug2\"; //System id number for fiagnostic update\n\n\nvar threshold = global.get(\"energy_threshold\");\n// This will handle any device and any attribute as long as it is in the DB\nvar p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\n\n\nfromdate = context.get(\"fromdate\");\nif (fromdate===undefined) {\n    // set the period to a default if it is not selected yet\n    fromdate = today0h-7*p_1d;\n}\nenddate = context.get(\"enddate\");\nif (enddate===undefined) {\n    // set the period to a default if it is not selected yet\n    enddate = today0h;\n}\n\n\n// Regenerate the SQL statements\n// Run through the data source list an generate the SQL statements\n\n\nmsg.topic = \"SELECT AVG(value) FROM sensor_data WHERE device='\"+device+\"' AND sensor='power' AND value > \"+threshold+\" AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 562.75,
        "y": 2853.75,
        "wires": [
            [
                "f0ace299.195348"
            ]
        ]
    },
    {
        "id": "f0ace299.195348",
        "type": "sqlite",
        "z": "bbaf6eb0.1f878",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 709.75,
        "y": 2853.75,
        "wires": [
            [
                "eef7d278.e4de58"
            ]
        ]
    },
    {
        "id": "46e40092.2dc0c8",
        "type": "inject",
        "z": "bbaf6eb0.1f878",
        "name": "Daily AVG ",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "00 01 * * *",
        "once": false,
        "x": 411.75,
        "y": 2855.75,
        "wires": [
            [
                "c645ddc5.60caa"
            ]
        ]
    },
    {
        "id": "7d47c848.9f8d28",
        "type": "debug",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1069.36669921875,
        "y": 2909.75,
        "wires": []
    },
    {
        "id": "eef7d278.e4de58",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "save avg",
        "func": "var system_id = 2; //System id number for fiagnostic update\n\n\nvar power = Number((msg.payload[0][\"AVG(value)\"]).toFixed(2));\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"AVG power:\" + power});\n\nmsg.payload = null;\nmsg.system = system_id; \nmsg.avg = power;\nmsg.severity = 0;\nmsg.warning = true;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 875.566650390625,
        "y": 2853.16650390625,
        "wires": [
            [
                "7d47c848.9f8d28",
                "66e2addf.d19644"
            ]
        ]
    },
    {
        "id": "66e2addf.d19644",
        "type": "link out",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1022.2886962890625,
        "y": 2852.082763671875,
        "wires": []
    },
    {
        "id": "b4cee680.7bd65",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 652,
        "y": 2307.75,
        "wires": []
    },
    {
        "id": "3f0ff085.5f96a8",
        "type": "comment",
        "z": "2a4ee4a1.258c6c",
        "name": "<==========Avg consumption while on==========>",
        "info": "",
        "x": 580.75,
        "y": 2354,
        "wires": []
    },
    {
        "id": "cc25daaf.7c782",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "SQL",
        "func": "var device = \"plug3\"; //System id number for fiagnostic update\n\n\nvar threshold = global.get(\"energy_threshold\");\n// This will handle any device and any attribute as long as it is in the DB\nvar p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\n\n\nfromdate = context.get(\"fromdate\");\nif (fromdate===undefined) {\n    // set the period to a default if it is not selected yet\n    fromdate = today0h-7*p_1d;\n}\nenddate = context.get(\"enddate\");\nif (enddate===undefined) {\n    // set the period to a default if it is not selected yet\n    enddate = today0h;\n}\n\n\n// Regenerate the SQL statements\n// Run through the data source list an generate the SQL statements\n\n\nmsg.topic = \"SELECT AVG(value) FROM sensor_data WHERE device='\"+device+\"' AND sensor='power' AND value > \"+threshold+\" AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 482,
        "y": 2414.75,
        "wires": [
            [
                "50bf1157.11356"
            ]
        ]
    },
    {
        "id": "50bf1157.11356",
        "type": "sqlite",
        "z": "2a4ee4a1.258c6c",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 629,
        "y": 2414.75,
        "wires": [
            [
                "b40a075c.e1fde"
            ]
        ]
    },
    {
        "id": "ce34cc17.d12cc8",
        "type": "inject",
        "z": "2a4ee4a1.258c6c",
        "name": "Daily AVG ",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "00 01 * * *",
        "once": false,
        "x": 331,
        "y": 2416.75,
        "wires": [
            [
                "cc25daaf.7c782"
            ]
        ]
    },
    {
        "id": "944d2bc0.304f18",
        "type": "debug",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 988.61669921875,
        "y": 2470.75,
        "wires": []
    },
    {
        "id": "b40a075c.e1fde",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "save avg",
        "func": "var system_id = 3; //System id number for fiagnostic update\n\nvar power = Number((msg.payload[0][\"AVG(value)\"]).toFixed(2));\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"AVG power:\" + power});\n\nmsg.payload = null;\nmsg.system = system_id; \nmsg.avg = power;\nmsg.severity = 0;\nmsg.warning = true;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 794.816650390625,
        "y": 2414.16650390625,
        "wires": [
            [
                "944d2bc0.304f18",
                "c1ecd589.31b19"
            ]
        ]
    },
    {
        "id": "c1ecd589.31b19",
        "type": "link out",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 941.5386962890625,
        "y": 2413.082763671875,
        "wires": []
    },
    {
        "id": "6025e7bb.32204",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 709.7499389648438,
        "y": 2916.75,
        "wires": []
    },
    {
        "id": "dabd8cda.980338",
        "type": "comment",
        "z": "ef23770c.5edc1",
        "name": "<==========Avg consumption while on==========>",
        "info": "",
        "x": 638.4999389648438,
        "y": 2963,
        "wires": []
    },
    {
        "id": "68ad3384.9e314c",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "SQL",
        "func": "var device = \"plug0\"; //System id number for fiagnostic update\n\n\nvar threshold = global.get(\"energy_threshold\");\n// This will handle any device and any attribute as long as it is in the DB\nvar p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\n\n\nfromdate = context.get(\"fromdate\");\nif (fromdate===undefined) {\n    // set the period to a default if it is not selected yet\n    fromdate = today0h-7*p_1d;\n}\nenddate = context.get(\"enddate\");\nif (enddate===undefined) {\n    // set the period to a default if it is not selected yet\n    enddate = today0h;\n}\n\n\n// Regenerate the SQL statements\n// Run through the data source list an generate the SQL statements\n\n\nmsg.topic = \"SELECT AVG(value) FROM sensor_data WHERE device='\"+device+\"' AND sensor='realPower' AND value > \"+threshold+\" AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 583.7499389648438,
        "y": 3038.75,
        "wires": [
            [
                "d2dfd6db.b795f8"
            ]
        ]
    },
    {
        "id": "d2dfd6db.b795f8",
        "type": "sqlite",
        "z": "ef23770c.5edc1",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 730.7499389648438,
        "y": 3038.75,
        "wires": [
            [
                "708ad775.8fa6c"
            ]
        ]
    },
    {
        "id": "a6fc259f.16907",
        "type": "inject",
        "z": "ef23770c.5edc1",
        "name": "Daily AVG ",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "00 01 * * *",
        "once": false,
        "x": 432.74993896484375,
        "y": 3040.75,
        "wires": [
            [
                "68ad3384.9e314c"
            ]
        ]
    },
    {
        "id": "456f5b2e.62a284",
        "type": "debug",
        "z": "ef23770c.5edc1",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1090.3666381835938,
        "y": 3094.75,
        "wires": []
    },
    {
        "id": "708ad775.8fa6c",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "save avg",
        "func": "var system_id = 10; //System id number for fiagnostic update\n\n\nvar power = Number((msg.payload[0][\"AVG(value)\"]).toFixed(2));\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"AVG power:\" + power});\n\nmsg.payload = null;\nmsg.system = system_id; \nmsg.avg = power;\nmsg.severity = 0;\nmsg.warning = true;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 896.5665893554688,
        "y": 3038.16650390625,
        "wires": [
            [
                "456f5b2e.62a284",
                "72dc8246.2e24e4"
            ]
        ]
    },
    {
        "id": "72dc8246.2e24e4",
        "type": "link out",
        "z": "ef23770c.5edc1",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1043.2886352539062,
        "y": 3037.082763671875,
        "wires": []
    },
    {
        "id": "3c11328d.cdf976",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 704.75,
        "y": 2216.75,
        "wires": []
    },
    {
        "id": "a47eaa72.6f3b7",
        "type": "comment",
        "z": "be52c199.c86f58",
        "name": "<==========Avg consumption while on==========>",
        "info": "",
        "x": 633.5,
        "y": 2263,
        "wires": []
    },
    {
        "id": "8cdd03e2.41137",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "SQL",
        "func": "var device = \"plugA\"; //System id number for fiagnostic update\n\n\nvar threshold = global.get(\"energy_threshold\");\n// This will handle any device and any attribute as long as it is in the DB\nvar p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\n\n\nfromdate = context.get(\"fromdate\");\nif (fromdate===undefined) {\n    // set the period to a default if it is not selected yet\n    fromdate = today0h-7*p_1d;\n}\nenddate = context.get(\"enddate\");\nif (enddate===undefined) {\n    // set the period to a default if it is not selected yet\n    enddate = today0h;\n}\n\n\n// Regenerate the SQL statements\n// Run through the data source list an generate the SQL statements\n\n\nmsg.topic = \"SELECT AVG(value) FROM sensor_data WHERE device='\"+device+\"' AND sensor='realPower' AND value > \"+threshold+\" AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 578.75,
        "y": 2338.75,
        "wires": [
            [
                "2d536cfc.72e3dc"
            ]
        ]
    },
    {
        "id": "2d536cfc.72e3dc",
        "type": "sqlite",
        "z": "be52c199.c86f58",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 725.75,
        "y": 2338.75,
        "wires": [
            [
                "81a18fa3.5ebda"
            ]
        ]
    },
    {
        "id": "8fc4b899.0939c8",
        "type": "inject",
        "z": "be52c199.c86f58",
        "name": "Daily AVG ",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "00 01 * * *",
        "once": false,
        "x": 427.75,
        "y": 2340.75,
        "wires": [
            [
                "8cdd03e2.41137"
            ]
        ]
    },
    {
        "id": "df38de87.078e9",
        "type": "debug",
        "z": "be52c199.c86f58",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1085.36669921875,
        "y": 2394.75,
        "wires": []
    },
    {
        "id": "81a18fa3.5ebda",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "save avg",
        "func": "var system_id = 11; //System id number for fiagnostic update\n\n\nvar power = Number((msg.payload[0][\"AVG(value)\"]).toFixed(2));\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"AVG power:\" + power});\n\nmsg.payload = null;\nmsg.system = system_id; \nmsg.avg = power;\nmsg.severity = 0;\nmsg.warning = true;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 891.566650390625,
        "y": 2338.16650390625,
        "wires": [
            [
                "df38de87.078e9",
                "629412ae.1c82fc"
            ]
        ]
    },
    {
        "id": "629412ae.1c82fc",
        "type": "link out",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1038.2886962890625,
        "y": 2337.082763671875,
        "wires": []
    },
    {
        "id": "4f48331c.544c74",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 689.75,
        "y": 2251.75,
        "wires": []
    },
    {
        "id": "f42734ef.52ad78",
        "type": "comment",
        "z": "c1eaebbb.b6c98",
        "name": "<==========Avg consumption while on==========>",
        "info": "",
        "x": 618.5,
        "y": 2298,
        "wires": []
    },
    {
        "id": "1413e3b0.69a31c",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "SQL",
        "func": "var device = \"plugB\"; //System id number for fiagnostic update\n\n\nvar threshold = global.get(\"energy_threshold\");\n// This will handle any device and any attribute as long as it is in the DB\nvar p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\n\n\nfromdate = context.get(\"fromdate\");\nif (fromdate===undefined) {\n    // set the period to a default if it is not selected yet\n    fromdate = today0h-7*p_1d;\n}\nenddate = context.get(\"enddate\");\nif (enddate===undefined) {\n    // set the period to a default if it is not selected yet\n    enddate = today0h;\n}\n\n\n// Regenerate the SQL statements\n// Run through the data source list an generate the SQL statements\n\n\nmsg.topic = \"SELECT AVG(value) FROM sensor_data WHERE device='\"+device+\"' AND sensor='realPower' AND value > \"+threshold+\" AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 563.75,
        "y": 2373.75,
        "wires": [
            [
                "967ab777.c7f71"
            ]
        ]
    },
    {
        "id": "967ab777.c7f71",
        "type": "sqlite",
        "z": "c1eaebbb.b6c98",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 710.75,
        "y": 2373.75,
        "wires": [
            [
                "e0e91328.b84348"
            ]
        ]
    },
    {
        "id": "5c6bad85.43275c",
        "type": "inject",
        "z": "c1eaebbb.b6c98",
        "name": "Daily AVG ",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "00 01 * * *",
        "once": false,
        "x": 412.75,
        "y": 2375.75,
        "wires": [
            [
                "1413e3b0.69a31c"
            ]
        ]
    },
    {
        "id": "867138.26d6fec8",
        "type": "debug",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1070.36669921875,
        "y": 2429.75,
        "wires": []
    },
    {
        "id": "e0e91328.b84348",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "save avg",
        "func": "var system_id = 12; //System id number for fiagnostic update\n\n\nvar power = Number((msg.payload[0][\"AVG(value)\"]).toFixed(2));\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"AVG power:\" + power});\n\nmsg.payload = null;\nmsg.system = system_id; \nmsg.avg = power;\nmsg.severity = 0;\nmsg.warning = true;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 876.566650390625,
        "y": 2373.16650390625,
        "wires": [
            [
                "867138.26d6fec8",
                "7ca776a8.45eb28"
            ]
        ]
    },
    {
        "id": "7ca776a8.45eb28",
        "type": "link out",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1023.2886962890625,
        "y": 2372.082763671875,
        "wires": []
    },
    {
        "id": "692dda9.0c550a4",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "save to db relay status",
        "func": "var devicename = \"plug1\";\nvar system_id = 1; //System id number for fiagnostic update\n\nvar relay = msg.payload; \nvar last_relay = context.get(devicename +\"_relay\");\n\nvar d = new Date();\nvar epoch = d.getTime();\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Relay:\" + relay});\n\n\nif(relay != last_relay){\n    context.set(devicename +\"_relay\",relay); \n\n    if (relay == 1){\n        msg.payload = devicename + \" is now ON\";   \n        msg.system = system_id; \n        msg.relay = 1;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }else{\n        msg.payload = devicename + \" in now OFF\";   \n        msg.system = system_id; \n        msg.relay = 0;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }\n    \n    msg.last_epoch = epoch;\n \n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1042.75,
        "y": 506.7499694824219,
        "wires": [
            [
                "d769fb7a.014ad"
            ]
        ]
    },
    {
        "id": "d769fb7a.014ad",
        "type": "switch",
        "z": "a4b5eb1e.5dd4d8",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1245.583251953125,
        "y": 507.6110534667969,
        "wires": [
            [
                "ab64b528.c3008"
            ]
        ]
    },
    {
        "id": "ab64b528.c3008",
        "type": "link out",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1372.471923828125,
        "y": 508.6664733886719,
        "wires": []
    },
    {
        "id": "925dd150.9ca6b",
        "type": "ui_switch",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "label": "Relay",
        "group": "d92701a0.92dba",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "relay1_state",
        "style": "",
        "onvalue": "1",
        "onvalueType": "str",
        "onicon": "",
        "oncolor": "",
        "offvalue": "0",
        "offvalueType": "str",
        "officon": "",
        "offcolor": "",
        "x": 810,
        "y": 458,
        "wires": [
            [
                "84ff77c1.301218",
                "91b5673b.5eeab",
                "692dda9.0c550a4"
            ]
        ]
    },
    {
        "id": "7afdece3.2eb944",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "Relay state update",
        "func": "msg.topic = \"UPDATE system2 SET sys_relay=\"+msg.relay+\", sys_last_epoch=\"+msg.last_epoch+\"  WHERE sys_id=\"+msg.system;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 639.8055114746094,
        "y": 1314.75,
        "wires": [
            [
                "9e26d04e.4ed23",
                "2facdaa8.dcad86"
            ]
        ]
    },
    {
        "id": "90317476.7f2da8",
        "type": "switch",
        "z": "5f22000e.0f3588",
        "name": "Check if relay state available",
        "property": "relay",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 396,
        "y": 1313.833251953125,
        "wires": [
            [
                "7afdece3.2eb944"
            ]
        ]
    },
    {
        "id": "9e26d04e.4ed23",
        "type": "debug",
        "z": "5f22000e.0f3588",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 1007.5763854980469,
        "y": 1316,
        "wires": []
    },
    {
        "id": "51e92ec2.fe6e68",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "round",
        "func": "var devicename = \"plug2\";\nvar system_id = 2; //System id number for fiagnostic update\n\nvar relay = msg.payload; \nvar last_relay = context.get(devicename +\"_relay\");\n\nvar d = new Date();\nvar epoch = d.getTime();\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Relay:\" + relay});\n\n\nif(relay != last_relay){\n    context.set(devicename +\"_relay\",relay); \n\n    if (relay == 1){\n        msg.payload = devicename + \" is now ON\";   \n        msg.system = system_id; \n        msg.relay = 1;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }else{\n        msg.payload = devicename + \" in now OFF\";   \n        msg.system = system_id; \n        msg.relay = 0;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }\n    msg.last_epoch = epoch;\n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 882,
        "y": 442,
        "wires": [
            [
                "4a8529b1.890458"
            ]
        ]
    },
    {
        "id": "4a8529b1.890458",
        "type": "switch",
        "z": "bbaf6eb0.1f878",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1042.8331909179688,
        "y": 441.861083984375,
        "wires": [
            [
                "5d07d276.a1698c"
            ]
        ]
    },
    {
        "id": "5d07d276.a1698c",
        "type": "link out",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1165.721923828125,
        "y": 442.91650390625,
        "wires": []
    },
    {
        "id": "e83a40be.752288",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "update status",
        "func": "var devicename = \"plug3\";\nvar system_id = 3; //System id number for diagnostic update\n\nvar relay = msg.payload; \nvar last_relay = context.get(devicename +\"_relay\");\n\nvar d = new Date();\nvar epoch = d.getTime();\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Relay:\" + relay});\n\n\nif(relay != last_relay){\n    context.set(devicename +\"_relay\",relay); \n\n    if (relay == \"1\"){\n        msg.payload = devicename + \" is now ON\";   \n        msg.system = system_id; \n        msg.relay = 1;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }else{\n        msg.payload = devicename + \" in now OFF\";   \n        msg.system = system_id; \n        msg.relay = 0;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }\n    msg.last_epoch = epoch;\n \n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 986,
        "y": 480,
        "wires": [
            [
                "4397db2c.86e2cc"
            ]
        ]
    },
    {
        "id": "4397db2c.86e2cc",
        "type": "switch",
        "z": "2a4ee4a1.258c6c",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1186,
        "y": 480,
        "wires": [
            [
                "7ec9d456.20ca34"
            ]
        ]
    },
    {
        "id": "7ec9d456.20ca34",
        "type": "link out",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1317,
        "y": 480,
        "wires": []
    },
    {
        "id": "a36fdc45.b0eb38",
        "type": "debug",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 895,
        "y": 322,
        "wires": []
    },
    {
        "id": "3b3869f9.dcb2d6",
        "type": "inject",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "topic": "",
        "payload": "0",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 278.75,
        "y": 407.75,
        "wires": [
            [
                "3a703e97.f6496a"
            ]
        ]
    },
    {
        "id": "775a1fec.25f3c",
        "type": "inject",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "topic": "",
        "payload": "1",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 280.75,
        "y": 462.7499694824219,
        "wires": [
            [
                "3a703e97.f6496a"
            ]
        ]
    },
    {
        "id": "3a703e97.f6496a",
        "type": "ui_switch",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "label": "Relay",
        "group": "213b5215.c08486",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "relay2_state",
        "style": "",
        "onvalue": "1",
        "onvalueType": "str",
        "onicon": "",
        "oncolor": "",
        "offvalue": "0",
        "offvalueType": "str",
        "officon": "",
        "offcolor": "",
        "x": 550,
        "y": 380,
        "wires": [
            [
                "cf1b1f45.9b94e8"
            ]
        ]
    },
    {
        "id": "cf1b1f45.9b94e8",
        "type": "ui_switch",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "label": "Relay",
        "group": "dee9af7d.49a6c8",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "relay2_state",
        "style": "",
        "onvalue": "1",
        "onvalueType": "str",
        "onicon": "",
        "oncolor": "",
        "offvalue": "0",
        "offvalueType": "str",
        "officon": "",
        "offcolor": "",
        "x": 670,
        "y": 380,
        "wires": [
            [
                "a36fdc45.b0eb38",
                "61ece7d2.e0755",
                "51e92ec2.fe6e68"
            ]
        ]
    },
    {
        "id": "cb15c1b3.0b8098",
        "type": "comment",
        "z": "9e52ccb8.2c00a8",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 637.75,
        "y": 1499.75,
        "wires": []
    },
    {
        "id": "a0422b31.1cad6",
        "type": "comment",
        "z": "9e52ccb8.2c00a8",
        "name": "<==========Control algorithm==========>",
        "info": "",
        "x": 706.5,
        "y": 1542,
        "wires": []
    },
    {
        "id": "3b7380dd.c1dda",
        "type": "ui_switch",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "State",
        "group": "722ee8c5.f8de58",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "max_load_control",
        "style": "",
        "onvalue": "1",
        "onvalueType": "str",
        "onicon": "",
        "oncolor": "",
        "offvalue": "0",
        "offvalueType": "str",
        "officon": "",
        "offcolor": "",
        "x": 272.3666687011719,
        "y": 1747,
        "wires": [
            [
                "64311789.0af7d8"
            ]
        ]
    },
    {
        "id": "33c435e6.2138ba",
        "type": "ui_switch",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "State",
        "group": "d56da8c0.0455f",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "solar_threshold_control",
        "style": "",
        "onvalue": "1",
        "onvalueType": "str",
        "onicon": "",
        "oncolor": "",
        "offvalue": "0",
        "offvalueType": "str",
        "officon": "",
        "offcolor": "",
        "x": 283.75,
        "y": 2062.75,
        "wires": [
            [
                "8f888746.b5566"
            ]
        ]
    },
    {
        "id": "e894cf3e.53bdb8",
        "type": "ui_text_input",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": "Max load (W)",
        "group": "722ee8c5.f8de58",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": false,
        "mode": "text",
        "delay": 300,
        "topic": "max_load",
        "x": 292.75,
        "y": 1789.75,
        "wires": [
            [
                "30e861ce.9b492e"
            ]
        ]
    },
    {
        "id": "ae9e9506.5f747",
        "type": "ui_text_input",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "label": " Solar threshold (W)",
        "group": "d56da8c0.0455f",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": false,
        "mode": "text",
        "delay": 300,
        "topic": "solar_threshold",
        "x": 321.75,
        "y": 2109.75,
        "wires": [
            [
                "37800514.113c4a"
            ]
        ]
    },
    {
        "id": "64311789.0af7d8",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"max_load_control\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 532.75,
        "y": 1746.75,
        "wires": [
            []
        ]
    },
    {
        "id": "30e861ce.9b492e",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"max_load\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 533.75,
        "y": 1793.75,
        "wires": [
            []
        ]
    },
    {
        "id": "8f888746.b5566",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"solar_threshold_control\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 539.75,
        "y": 2062.75,
        "wires": [
            []
        ]
    },
    {
        "id": "37800514.113c4a",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"solar_threshold\",msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 540.75,
        "y": 2109.75,
        "wires": [
            []
        ]
    },
    {
        "id": "8320718.73c221",
        "type": "debug",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 689.449951171875,
        "y": 580.933349609375,
        "wires": []
    },
    {
        "id": "1a4538aa.5d83cf",
        "type": "link out",
        "z": "2cf1d395.65be64",
        "name": "solar_control",
        "links": [
            "b426fa07.5ac0e"
        ],
        "x": 639.4998779296875,
        "y": 588.4242553710938,
        "wires": []
    },
    {
        "id": "b426fa07.5ac0e",
        "type": "link in",
        "z": "9e52ccb8.2c00a8",
        "name": "solar_control",
        "links": [
            "1a4538aa.5d83cf"
        ],
        "x": 139.60101318359375,
        "y": 2186.03564453125,
        "wires": [
            [
                "bf23638d.63e738"
            ]
        ]
    },
    {
        "id": "cf83a567.c60898",
        "type": "aggregator",
        "z": "ef23770c.5edc1",
        "name": "5s mean",
        "topic": "Power",
        "intervalCount": "5",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 559.5184936523438,
        "y": 611.7408447265625,
        "wires": [
            [
                "1648a462.85f7f4"
            ]
        ]
    },
    {
        "id": "1648a462.85f7f4",
        "type": "link out",
        "z": "ef23770c.5edc1",
        "name": "main_control",
        "links": [
            "b31ed010.798348",
            "8192cc22.61a74"
        ],
        "x": 678.2777709960938,
        "y": 610.2964477539062,
        "wires": []
    },
    {
        "id": "b31ed010.798348",
        "type": "link in",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "links": [
            "1648a462.85f7f4"
        ],
        "x": 202.27781677246094,
        "y": 1865.9072875976562,
        "wires": [
            [
                "4d8032cb.0dc484"
            ]
        ]
    },
    {
        "id": "4d8032cb.0dc484",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "check if main conditions adressed",
        "func": "max_load = global.get(\"max_load\");\nmax_load_control = global.get(\"max_load_control\");\n\nvar message = {mode:0, diftomax:0};\n\nif ( max_load_control == \"0\"){\n    message.mode = 0;\n    msg.payload = message;\n     node.status({fill:\"red\",shape:\"ring\",text:\"Not active\"});\n   \n    return msg\n}\nif (msg.payload < max_load){\n    message.mode = 1;\n    message.diftomax = max_load-msg.payload;\n    node.status({fill:\"green\",shape:\"ring\",text:\"Max energy not reached\"})\n    msg.payload = message;\n    return msg\n}\n    \nnode.status({fill:\"blue\",shape:\"ring\",text:\"Max energy reached\"});\n\nmessage.mode = 2;\nmsg.payload = message\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 413.5185852050781,
        "y": 1866.1851806640625,
        "wires": [
            [
                "b0fb3260.7dd548",
                "2ffb3c5f.b24c4c"
            ]
        ]
    },
    {
        "id": "b0fb3260.7dd548",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 696.29638671875,
        "y": 1869.944091796875,
        "wires": []
    },
    {
        "id": "bf23638d.63e738",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "check if main conditions adressed",
        "func": "solar_threshold = global.get(\"solar_threshold\");\nsolar_threshold_control = global.get(\"solar_threshold_control\");\n\nmsg.saving = 0;\n\nif ( solar_threshold_control == \"0\")\n    return msg;\n\nif (msg.payload < solar_threshold){\n    node.status({fill:\"blue\",shape:\"ring\",text:\"Condtions not met\"})\n    return msg;\n}\n\nmsg.saving = 1;\n    \nnode.status({fill:\"blue\",shape:\"ring\",text:\"Condtions met\"});\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 333.61114501953125,
        "y": 2184.27783203125,
        "wires": [
            [
                "5f1c596a.f09708",
                "f39dc364.0e39d8"
            ]
        ]
    },
    {
        "id": "5f1c596a.f09708",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 591.388916015625,
        "y": 2232.036865234375,
        "wires": []
    },
    {
        "id": "97b561af.671e28",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore max_load",
        "func": "msg.topic = \"max_load\";\nmsg.payload = global.get(\"max_load\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1021.9445190429688,
        "y": 364.16680908203125,
        "wires": [
            [
                "7066e9dd.33c508"
            ]
        ]
    },
    {
        "id": "7066e9dd.33c508",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_max_load",
        "links": [
            "bdfd85db.9f727"
        ],
        "x": 1293.74072265625,
        "y": 364.7223205566406,
        "wires": []
    },
    {
        "id": "41bf7f98.de1b3",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore Solar_threshold_control",
        "func": "msg.topic = \"solar_threshold_control\";\nmsg.payload = global.get(\"solar_threshold_control\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1057.5000610351562,
        "y": 496.3887634277344,
        "wires": [
            [
                "e3c7ace9.8f7ef8"
            ]
        ]
    },
    {
        "id": "e3c7ace9.8f7ef8",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_solar_threshold_control",
        "links": [
            "65cc854b.5a11ec"
        ],
        "x": 1290.4075317382812,
        "y": 499.1666259765625,
        "wires": []
    },
    {
        "id": "8e8699c1.71e458",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore Solar_threshold",
        "func": "msg.topic = \"solar_threshold\";\nmsg.payload = global.get(\"solar_threshold\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1029.7222900390625,
        "y": 451.9446105957031,
        "wires": [
            [
                "17677a6c.8a960e"
            ]
        ]
    },
    {
        "id": "17677a6c.8a960e",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_solar_threshold",
        "links": [
            "94a4c3f5.930068"
        ],
        "x": 1292.6297607421875,
        "y": 454.72247314453125,
        "wires": []
    },
    {
        "id": "66188ab7.e8ba2c",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore max_load_control",
        "func": "msg.topic = \"max_load_control\";\nmsg.payload = global.get(\"max_load_control\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1040.8334350585938,
        "y": 407.4999694824219,
        "wires": [
            [
                "4e9b1d6.a433be4"
            ]
        ]
    },
    {
        "id": "4e9b1d6.a433be4",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_max_load_control",
        "links": [
            "d0636916.d5dc18"
        ],
        "x": 1292.629638671875,
        "y": 408.05548095703125,
        "wires": []
    },
    {
        "id": "f4672c67.f75378",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "all_restore",
        "links": [
            "f80bd7fe.1d9ca8"
        ],
        "x": 275.9629652235243,
        "y": 516.9444444444445,
        "wires": []
    },
    {
        "id": "f80bd7fe.1d9ca8",
        "type": "link in",
        "z": "68347deb.b93a34",
        "name": "",
        "links": [
            "f4672c67.f75378"
        ],
        "x": 829.2962036132812,
        "y": 369.44444274902344,
        "wires": [
            [
                "97b561af.671e28",
                "66188ab7.e8ba2c",
                "8e8699c1.71e458",
                "41bf7f98.de1b3",
                "baf17744.5adee8",
                "36ba236b.94793c",
                "3fafaba3.7fb784"
            ]
        ]
    },
    {
        "id": "d0636916.d5dc18",
        "type": "link in",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "links": [
            "4e9b1d6.a433be4"
        ],
        "x": 166.62962341308594,
        "y": 1748.1112060546875,
        "wires": [
            [
                "3b7380dd.c1dda"
            ]
        ]
    },
    {
        "id": "bdfd85db.9f727",
        "type": "link in",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "links": [
            "7066e9dd.33c508"
        ],
        "x": 168.1666717529297,
        "y": 1790.611083984375,
        "wires": [
            [
                "e894cf3e.53bdb8"
            ]
        ]
    },
    {
        "id": "65cc854b.5a11ec",
        "type": "link in",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "links": [
            "e3c7ace9.8f7ef8"
        ],
        "x": 183.05555725097656,
        "y": 2063.0552978515625,
        "wires": [
            [
                "33c435e6.2138ba"
            ]
        ]
    },
    {
        "id": "94a4c3f5.930068",
        "type": "link in",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "links": [
            "17677a6c.8a960e"
        ],
        "x": 179.7222442626953,
        "y": 2108.611083984375,
        "wires": [
            [
                "ae9e9506.5f747"
            ]
        ]
    },
    {
        "id": "f39dc364.0e39d8",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Store value",
        "func": "global.set(\"solar_saving\",msg);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 595.75,
        "y": 2182.75,
        "wires": [
            []
        ]
    },
    {
        "id": "59a59873.16eb28",
        "type": "comment",
        "z": "9e52ccb8.2c00a8",
        "name": "General max load",
        "info": "",
        "x": 217.75,
        "y": 1617.75,
        "wires": []
    },
    {
        "id": "f3601cb1.486ec",
        "type": "comment",
        "z": "9e52ccb8.2c00a8",
        "name": "Solar saving",
        "info": "",
        "x": 165.75,
        "y": 1924.75,
        "wires": []
    },
    {
        "id": "8192cc22.61a74",
        "type": "link in",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "links": [
            "1648a462.85f7f4"
        ],
        "x": 182.75,
        "y": 2306.75,
        "wires": [
            [
                "a58f6432.23cd8"
            ]
        ]
    },
    {
        "id": "37a242bf.34f996",
        "type": "comment",
        "z": "9e52ccb8.2c00a8",
        "name": "msg.mode: 0->off  1->limit not reached  2->limit reached",
        "info": "",
        "x": 643.75,
        "y": 1599.75,
        "wires": []
    },
    {
        "id": "a58f6432.23cd8",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "check if main consumption bigger than solar production",
        "func": "solar_saving = global.get(\"solar_saving\");\nsaving = solar_saving.saving;\nproduction = solar_saving.payload;\n\nmax_load = global.get(\"max_load\");\nmax_load_control = global.get(\"max_load_control\");\n\nvar message = {solarmode:0, surplus:0};\n\nif ( saving == \"0\"){\n    message.solarmode = 0;\n    msg.payload = message;\n    node.status({fill:\"red\",shape:\"ring\",text:\"Not active\"});\n    return msg\n}\nif (msg.payload < production){\n    message.solarmode = 1;\n    message.surplus = production-msg.payload;\n    node.status({fill:\"green\",shape:\"ring\",text:\"Extra energy available\"});\n    msg.payload = message;\n    return msg\n}\n    \nnode.status({fill:\"blue\",shape:\"ring\",text:\"Max energy reached\"});\n\nmessage.solarmode = 2;\nmsg.payload = message;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 452.75,
        "y": 2309.75,
        "wires": [
            [
                "2ffb3c5f.b24c4c"
            ]
        ]
    },
    {
        "id": "d0fc125.f111b7",
        "type": "inject",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "topic": "",
        "payload": "0",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 120.75,
        "y": 1667.75,
        "wires": [
            [
                "3b7380dd.c1dda"
            ]
        ]
    },
    {
        "id": "54a7980.4e686e8",
        "type": "inject",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "topic": "",
        "payload": "1",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 120.75,
        "y": 1703.75,
        "wires": [
            [
                "3b7380dd.c1dda"
            ]
        ]
    },
    {
        "id": "4de75773.7d47f8",
        "type": "inject",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "topic": "",
        "payload": "0",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 139.75,
        "y": 1984.7500305175781,
        "wires": [
            [
                "33c435e6.2138ba"
            ]
        ]
    },
    {
        "id": "8d68c8b.18422b8",
        "type": "inject",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "topic": "",
        "payload": "1",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 141.75,
        "y": 2023.75,
        "wires": [
            [
                "33c435e6.2138ba"
            ]
        ]
    },
    {
        "id": "2ffb3c5f.b24c4c",
        "type": "join",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "0",
        "count": "2",
        "x": 806.36669921875,
        "y": 2018.5,
        "wires": [
            [
                "debec5fa.f4e25"
            ]
        ]
    },
    {
        "id": "5e7d6af0.e1693c",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "check if algorithm should run",
        "func": "n_inactive_devices = global.get(\"inative_equipments\");\ntotal_n_devices = global.get(\"total_n_devices\");\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Inactive: \"+n_inactive_devices+\" DevicesTot: \"+total_n_devices });\n\nif ( (msg.payload.mode == \"0\") && (msg.payload.solarmode == \"0\") ){\n    msg.payload = 0;\n    return msg;\n}\n\nif (n_inactive_devices < total_n_devices){\n    if (msg.payload.solarmode == \"2\") {\n        msg.payload = 2;\n        return msg;\n    }\n}\n\nif (n_inactive_devices > \"0\"){\n    if ( msg.payload.solarmode == \"1\"){\n        msg.extra = msg.payload.surplus;\n        msg.payload = 1;\n        return msg;\n    }\n}\n\nif (n_inactive_devices < total_n_devices){\n    if ( (msg.payload.mode == \"2\") ){\n        msg.payload = 2;\n        return msg;\n    }\n}\n\nif (n_inactive_devices > \"0\"){\n    //only activates when solar mode not active\n    if ( (msg.payload.mode == \"1\") ){\n        msg.extra = msg.payload.diftomax; \n        msg.payload = 1;\n        return msg;\n    }\n}\n\nreturn\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1187.7499389648438,
        "y": 2017.25,
        "wires": [
            [
                "7ed86177.dcf9a8",
                "b10ae09c.954c88",
                "b2ba7a37.492ea"
            ]
        ]
    },
    {
        "id": "fdba52da.cff63",
        "type": "inject",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 877.36669921875,
        "y": 1793,
        "wires": [
            [
                "28433cfe.553e94"
            ]
        ]
    },
    {
        "id": "28433cfe.553e94",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "func": "global.set(\"inative_equipments\",1);\nglobal.set(\"total_n_devices\",3);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1035.36669921875,
        "y": 1792,
        "wires": [
            []
        ]
    },
    {
        "id": "7ed86177.dcf9a8",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "msg.topic = \"SELECT sys_id, sys_energy_state, sys_last_epoch, sys_relay, sys_avg_cons, interruption, max_cont_down_time, min_down_time, max_down_time, down_time_span FROM system2, category WHERE sys_cat = cat_id and sys_relay not NULL and sys_state = 1 ORDER BY sys_id \";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1028.75,
        "y": 2166.75,
        "wires": [
            [
                "d22d0a39.e432e"
            ]
        ]
    },
    {
        "id": "d22d0a39.e432e",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 1173.75,
        "y": 2167.75,
        "wires": [
            [
                "99181cbd.3bf9b"
            ]
        ]
    },
    {
        "id": "99181cbd.3bf9b",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "func": "var off_devices = 0;\nvar cont_devices = 0;\nvar i = 0;\n\nglobal.set(\"controllable_devices\",msg.payload);\nglobal.set(\"total_n_devices\",msg.payload.length);\n\nwhile (i < msg.payload.length){\n    if (msg.payload[i].sys_relay == \"0\")\n        off_devices++;\n    if (msg.payload[i].interruption == \"1\")\n        cont_devices++;\n    i++;\n}\n\nglobal.set(\"inative_equipments\",off_devices);\nglobal.set(\"n_cont_equipments\",cont_devices);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1309.75,
        "y": 2165.75,
        "wires": [
            [
                "69efd51a.ad6874"
            ]
        ]
    },
    {
        "id": "e8be9d74.e871",
        "type": "inject",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "60",
        "crontab": "",
        "once": false,
        "x": 912.75,
        "y": 2084.75,
        "wires": [
            [
                "7ed86177.dcf9a8"
            ]
        ]
    },
    {
        "id": "b10ae09c.954c88",
        "type": "link out",
        "z": "9e52ccb8.2c00a8",
        "name": "algorithm_orders",
        "links": [
            "8c2039dc.a721e"
        ],
        "x": 1416.3666381835938,
        "y": 2018.25,
        "wires": []
    },
    {
        "id": "8c2039dc.a721e",
        "type": "link in",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "links": [
            "b10ae09c.954c88"
        ],
        "x": 66.36666870117188,
        "y": 2579.5,
        "wires": [
            [
                "8ceed845.2936a"
            ]
        ]
    },
    {
        "id": "8ceed845.2936a",
        "type": "switch",
        "z": "9e52ccb8.2c00a8",
        "name": "Check if to increase/decrease consumption",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "2",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 290.3666687011719,
        "y": 2578.5,
        "wires": [
            [
                "ceaa4fe4.c93fc",
                "7504a679.cf19"
            ],
            [
                "10a670ab.641d3f",
                "e9bddf8c.bcf5d8"
            ]
        ]
    },
    {
        "id": "10a670ab.641d3f",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "check if migh be interrupted",
        "func": "var controllable_devices = global.get(\"controllable_devices\");\nvar last_used_device = global.get(\"last_used_device\");\n\nvar i = 0;\n\nwhile (i < controllable_devices.length){\n    \n    //if device not last one being interropted \n    if (controllable_devices[i].sys_id != last_used_device){\n        msg.payload = \"A\"; \n        //if device can be stopped\n        if (controllable_devices[i].interruption == \"1\"){ \n            msg.payload = \"B\"; \n            //if device is using energy\n            if (controllable_devices[i].sys_energy_state != \"0\"){\n                msg.payload = \"C\"; \n                //if device relay is on\n                if (controllable_devices[i].sys_relay == \"1\"){\n                    global.set(\"last_used_device\",controllable_devices[i].sys_id);\n                    msg.payload = controllable_devices[i].sys_id; \n                    msg.device = msg.payload;\n                    msg.down_time_span = controllable_devices[i].down_time_span;\n                    msg.max_down_time = controllable_devices[i].max_down_time;\n                    \n                    return msg;\n                }\n            }\n        }\n    }\n    i++;\n    \n}\n\nglobal.set(\"last_used_device\",null);\n\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 621.75,
        "y": 2632.75,
        "wires": [
            [
                "7c20066d.3248"
            ]
        ]
    },
    {
        "id": "3ea50ea2.d8114a",
        "type": "comment",
        "z": "9e52ccb8.2c00a8",
        "name": "increase",
        "info": "",
        "x": 550.75,
        "y": 2472.75,
        "wires": []
    },
    {
        "id": "59838fd9.fa6fa",
        "type": "comment",
        "z": "9e52ccb8.2c00a8",
        "name": "decrease",
        "info": "",
        "x": 564.75,
        "y": 2592.75,
        "wires": []
    },
    {
        "id": "e9bddf8c.bcf5d8",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 544.36669921875,
        "y": 2691.75,
        "wires": []
    },
    {
        "id": "7c20066d.3248",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "SQL",
        "func": "var d = new Date();\nvar current = d.getTime();\nvar p_1h   =  1000*60*60 ; // 1 Hour\n\n\nvar fromdate = current - msg.down_time_span*p_1h;\nvar enddate = current;\n\nmsg.topic = \"SELECT COUNT(value) FROM sensor_data WHERE device = 'plug\"+msg.payload+\"' AND sensor='relay' AND value = 0 AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 814.75,
        "y": 2633.75,
        "wires": [
            [
                "d2acb84b.917828",
                "ec6a504f.5b67e8"
            ]
        ]
    },
    {
        "id": "d2acb84b.917828",
        "type": "sqlite",
        "z": "9e52ccb8.2c00a8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 947.75,
        "y": 2633.75,
        "wires": [
            [
                "5c0ebbcb.78567c",
                "1a84f0df.b146e7",
                "cd08110.cc54d7"
            ]
        ]
    },
    {
        "id": "4a7fa7dc.3bf618",
        "type": "inject",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "60",
        "crontab": "",
        "once": false,
        "x": 384.36669921875,
        "y": 2936,
        "wires": [
            [
                "95b5658e.ff0e4"
            ]
        ]
    },
    {
        "id": "5c0ebbcb.78567c",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1107.36669921875,
        "y": 2722.7498779296875,
        "wires": []
    },
    {
        "id": "1a84f0df.b146e7",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "confirm if to interrupt",
        "func": "\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Time off: \"+msg.payload[0][\"COUNT(value)\"]+ \", Max time off:\"+ msg.max_down_time });\n\nif ( msg.payload[0][\"COUNT(value)\"] >= msg.max_down_time )\n    return; //device has stayed too much time on;\n\nmsg.payload = \"0\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1143.75,
        "y": 2633.75,
        "wires": [
            [
                "a1654fdf.01619",
                "a254884d.7ee7d8"
            ]
        ]
    },
    {
        "id": "a254884d.7ee7d8",
        "type": "link out",
        "z": "9e52ccb8.2c00a8",
        "name": "advanced_relay_control",
        "links": [
            "d82d8530.697cd",
            "ddaefbd3.6f367",
            "2d7abf77.efbed8",
            "8592df7d.956e28",
            "b040408f.ec57c8"
        ],
        "x": 1318.36669921875,
        "y": 2632.25,
        "wires": []
    },
    {
        "id": "d82d8530.697cd",
        "type": "link in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "a254884d.7ee7d8",
            "afe27c52.3f2458",
            "7bcbfd8c.46e444"
        ],
        "x": 298.36669921875,
        "y": 348.4999694824219,
        "wires": [
            [
                "484cf498.ae3204"
            ]
        ]
    },
    {
        "id": "ddaefbd3.6f367",
        "type": "link in",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "a254884d.7ee7d8",
            "afe27c52.3f2458",
            "7bcbfd8c.46e444"
        ],
        "x": 264.75,
        "y": 328.75,
        "wires": [
            [
                "d15be954.0544f"
            ]
        ]
    },
    {
        "id": "2d7abf77.efbed8",
        "type": "link in",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "a254884d.7ee7d8",
            "afe27c52.3f2458",
            "7bcbfd8c.46e444"
        ],
        "x": 342.75,
        "y": 329.75,
        "wires": [
            [
                "dca15a82.1d6aa"
            ]
        ]
    },
    {
        "id": "484cf498.ae3204",
        "type": "switch",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "property": "device",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 437.36669921875,
        "y": 345.4999694824219,
        "wires": [
            [
                "391e98c2.64ad4"
            ]
        ]
    },
    {
        "id": "d15be954.0544f",
        "type": "switch",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "property": "device",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "2",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 365.75,
        "y": 329.75,
        "wires": [
            [
                "3a703e97.f6496a"
            ]
        ]
    },
    {
        "id": "dca15a82.1d6aa",
        "type": "switch",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "property": "device",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "3",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 432.75,
        "y": 329.75,
        "wires": [
            [
                "f808b4e4.b3bc1"
            ]
        ]
    },
    {
        "id": "a1654fdf.01619",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1347.36669921875,
        "y": 2715.75,
        "wires": []
    },
    {
        "id": "84ff77c1.301218",
        "type": "debug",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 1010,
        "y": 380,
        "wires": []
    },
    {
        "id": "ceaa4fe4.c93fc",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "check if migh be interrupted",
        "func": "var controllable_devices = global.get(\"controllable_devices\");\nvar last_turnedon_device = global.get(\"last_turnedon_device\");\n\nvar i = 0;\n\nwhile (i < controllable_devices.length){\n    \n    //if device not last one being interropted \n    if (controllable_devices[i].sys_id != last_turnedon_device){\n        msg.payload = \"A\"; \n        //if device can be stopped\n        if (controllable_devices[i].interruption == \"1\"){ \n            msg.payload = \"B\"; \n            //if device relay is off\n            if (controllable_devices[i].sys_relay == \"0\"){\n                //if available energy smaller than average\n                if (controllable_devices[i].sys_avg_cons < msg.extra){\n                    global.set(\"last_turnedon_device\",controllable_devices[i].sys_id);\n                    msg.payload = controllable_devices[i].sys_id; \n                    msg.device = msg.payload;\n                    msg.min_down_time = controllable_devices[i].min_down_time;\n                    msg.sys_last_epoch = controllable_devices[i].sys_last_epoch;\n                    \n                    return msg;\n                }  \n            }\n        }\n    }\n    i++;\n}\n\nglobal.set(\"last_turnedon_device\",null);\n\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 615.75,
        "y": 2518.75,
        "wires": [
            [
                "cb9aaf20.80a52",
                "98b6139d.88388"
            ]
        ]
    },
    {
        "id": "cb9aaf20.80a52",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "Check if min time passed",
        "func": "var d = new Date();\nvar current = d.getTime();\nvar p_1m   =  1000*60 ;\n\nvar elapsed_time = current - msg.sys_last_epoch;\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Inactive: \"+(elapsed_time/(1000*60))});\n\nif (elapsed_time < msg.min_down_time*p_1m)\n    return;\n\n\nmsg.payload = \"1\";\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 994.75,
        "y": 2520.75,
        "wires": [
            [
                "afe27c52.3f2458"
            ]
        ]
    },
    {
        "id": "afe27c52.3f2458",
        "type": "link out",
        "z": "9e52ccb8.2c00a8",
        "name": "advanced_relay_control",
        "links": [
            "d82d8530.697cd",
            "ddaefbd3.6f367",
            "2d7abf77.efbed8",
            "8592df7d.956e28",
            "b040408f.ec57c8"
        ],
        "x": 1304.1849365234375,
        "y": 2505.522705078125,
        "wires": []
    },
    {
        "id": "7504a679.cf19",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 714.75,
        "y": 2459.75,
        "wires": []
    },
    {
        "id": "69efd51a.ad6874",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1450,
        "y": 2180,
        "wires": []
    },
    {
        "id": "b2ba7a37.492ea",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1421.75,
        "y": 1971.75,
        "wires": []
    },
    {
        "id": "b38e4e6c.5503a8",
        "type": "inject",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 587.3666687011719,
        "y": 3159,
        "wires": [
            [
                "d7eb0ef5.e917a8"
            ]
        ]
    },
    {
        "id": "d7eb0ef5.e917a8",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 781.36669921875,
        "y": 3157.75,
        "wires": []
    },
    {
        "id": "2f42d963.da22a6",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "check if max continuous down time passed",
        "func": "var controllable_devices = global.get(\"controllable_devices\");\n\nvar d = new Date();\nvar current = d.getTime();\nvar p_1m   =  1000*60 ;\n\nvar i = 0;\n\n//msg.payload = controllable_devices;\n\nwhile (i < controllable_devices.length){\n\n    //if device can be stopped\n    if (controllable_devices[i].interruption == \"1\"){ \n        //msg.payload = \"B\"; \n        //if device relay is off\n        if (controllable_devices[i].sys_relay == \"0\"){\n            \n            var elapsed_time = current - controllable_devices[i].sys_last_epoch;\n            \n            node.status({fill:\"blue\",shape:\"ring\",text:\"Inactive: \"+(elapsed_time/(1000*60))});\n\n            if (elapsed_time > controllable_devices[i].max_cont_down_time*p_1m){\n                \n                msg.payload = \"1\"; \n                msg.device = controllable_devices[i].sys_id;\n                \n                return msg;\n            }  \n        }\n    }\n\n    i++;\n}\n\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 966.75,
        "y": 2937.75,
        "wires": [
            [
                "7bcbfd8c.46e444",
                "a35c489d.4cdd2"
            ]
        ]
    },
    {
        "id": "7bcbfd8c.46e444",
        "type": "link out",
        "z": "9e52ccb8.2c00a8",
        "name": "advanced_relay_control",
        "links": [
            "d82d8530.697cd",
            "ddaefbd3.6f367",
            "2d7abf77.efbed8",
            "8592df7d.956e28",
            "b040408f.ec57c8"
        ],
        "x": 1204.75,
        "y": 2936.75,
        "wires": []
    },
    {
        "id": "a35c489d.4cdd2",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1228.449966430664,
        "y": 3000.4000396728516,
        "wires": []
    },
    {
        "id": "dfd360b7.866af",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 1288.449951171875,
        "y": 2577.39990234375,
        "wires": []
    },
    {
        "id": "cd08110.cc54d7",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "func": "msg.payload = msg.payload[0][\"COUNT(value)\"]\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1104.449966430664,
        "y": 2579.2166900634766,
        "wires": [
            [
                "dfd360b7.866af"
            ]
        ]
    },
    {
        "id": "ec6a504f.5b67e8",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 851.566650390625,
        "y": 2724.1663818359375,
        "wires": []
    },
    {
        "id": "6a0b22a7.1035f4",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "relayState",
        "func": "msg.payload = msg.payload.relay;\nmsg.topic = \"relay\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 313.566650390625,
        "y": 538.566650390625,
        "wires": [
            [
                "c8bcf61a.be197",
                "de237351.a9b5a8"
            ]
        ]
    },
    {
        "id": "a57c028f.9dbf68",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "state changed?",
        "func": "var temp = context.get(\"last_state\");\n\nif (msg.payload == temp)\n    return;\n\ncontext.set(\"last_state\", msg.payload);\n\nif (msg.payload == \"1\")\n    msg.payload = \"1\";\nelse\n    msg.payload = \"0\";\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 375.4788818359375,
        "y": 521.566650390625,
        "wires": [
            [
                "3a703e97.f6496a",
                "6972befc.39746"
            ]
        ]
    },
    {
        "id": "f285f394.36e7a8",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "relayState",
        "func": "msg.payload = msg.payload.relay;\nmsg.topic = \"relay\";\n\nreturn msg;\n\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 182.99998474121094,
        "y": 519.837890625,
        "wires": [
            [
                "a57c028f.9dbf68",
                "9bb47bb5.ee73f8"
            ]
        ]
    },
    {
        "id": "278db065.64d45",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "state changed?",
        "func": "var temp = context.get(\"last_state\");\n\nif (msg.payload === temp)\n    return;\n\ncontext.set(\"last_state\", msg.payload);\n\nif (msg.payload == \"1\")\n    msg.payload = \"1\";\nelse\n    msg.payload = \"0\";\n\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 436,
        "y": 513,
        "wires": [
            [
                "f808b4e4.b3bc1"
            ]
        ]
    },
    {
        "id": "ecb6a153.8466a8",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "relayState",
        "func": "msg.payload = msg.payload.relay;\nmsg.topic = \"relay\";\n\nreturn msg;\n\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 221.0877685546875,
        "y": 512.837890625,
        "wires": [
            [
                "6cb1fb0a.80f8c4",
                "278db065.64d45"
            ]
        ]
    },
    {
        "id": "568f5ffe.6ab4e",
        "type": "mqtt in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "topic": "tele/sonoff_pow/ENERGY",
        "qos": "1",
        "broker": "4f35fce7.f4f55c",
        "x": 215.93017578125,
        "y": 117.20301818847656,
        "wires": [
            [
                "925b0bbf.cb3d1",
                "37e025d7.ca9742"
            ]
        ]
    },
    {
        "id": "925b0bbf.cb3d1",
        "type": "debug",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "payload",
        "x": 494.93017578125,
        "y": 126.70301818847656,
        "wires": []
    },
    {
        "id": "37e025d7.ca9742",
        "type": "json",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "pretty": false,
        "x": 241.30892944335938,
        "y": 225.21815490722656,
        "wires": [
            [
                "bea55a90.4a99e"
            ]
        ]
    },
    {
        "id": "436f93ec.be5184",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "<==========Messages reception==========>",
        "info": "",
        "x": 576.93017578125,
        "y": 36.20301818847656,
        "wires": []
    },
    {
        "id": "95b5658e.ff0e4",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "check if any saving mode active",
        "func": "var solar_control = global.get(\"solar_threshold_control\");\nvar main_control = global.get(\"max_load_control\");\n\nif ((solar_control == \"0\") && (main_control == \"0\"))\n    return;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 641.566650390625,
        "y": 2937.566650390625,
        "wires": [
            [
                "2f42d963.da22a6"
            ]
        ]
    },
    {
        "id": "3016a0ae.3796f",
        "type": "mqtt in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "topic": "stat/sonoff_pow/POWER",
        "qos": "1",
        "broker": "4f35fce7.f4f55c",
        "x": 247.29388427734375,
        "y": 607.7484741210938,
        "wires": [
            [
                "2b37f488.a5962c"
            ]
        ]
    },
    {
        "id": "5131521d.3202f4",
        "type": "inject",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "topic": "",
        "payload": "0",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 313.47564697265625,
        "y": 502.29376220703125,
        "wires": [
            [
                "ea9f8e5a.77c83"
            ]
        ]
    },
    {
        "id": "6a6f4536.043a9c",
        "type": "inject",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "topic": "",
        "payload": "1",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 311.47564697265625,
        "y": 557.2937316894531,
        "wires": [
            [
                "ea9f8e5a.77c83"
            ]
        ]
    },
    {
        "id": "e9ee5a7e.8b19b",
        "type": "mqtt out",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "topic": "cmnd/sonoff_pow/POWER",
        "qos": "1",
        "retain": "",
        "broker": "4f35fce7.f4f55c",
        "x": 1194.8392333984375,
        "y": 450.2483825683594,
        "wires": []
    },
    {
        "id": "d537c13e.c45a",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "State status",
        "func": "var flow_name = flow.get(\"flow_name\");\n\nif (msg.payload === undefined) {\n    state = '1';\n    global.set(flow_name+\"_state\",state);\n    msg.payload = state;\n}else{\n    global.set(flow_name+\"_state\",msg.payload);\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 971.8392333984375,
        "y": 449.7484130859375,
        "wires": [
            [
                "e9ee5a7e.8b19b"
            ]
        ]
    },
    {
        "id": "2b37f488.a5962c",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "state changed?",
        "func": "\nvar temp = context.get(\"last_state\");\n\n\nif (msg.payload == temp)\n    return;\n\ncontext.set(\"last_state\", msg.payload);\n\nif (msg.payload == \"ON\")\n    msg.payload = \"1\";\nelse\n    msg.payload = \"0\";\n\nreturn msg;\n\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 460.657470703125,
        "y": 607.2937622070312,
        "wires": [
            [
                "ea9f8e5a.77c83"
            ]
        ]
    },
    {
        "id": "f5343243.e82918",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 654.43017578125,
        "y": 317.4530029296875,
        "wires": []
    },
    {
        "id": "5f42c4f.075253c",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "<==========Relay management==========>",
        "info": "",
        "x": 646.93017578125,
        "y": 358.4530029296875,
        "wires": []
    },
    {
        "id": "ea9f8e5a.77c83",
        "type": "ui_switch",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "label": "Relay",
        "group": "b0658e7d.f070a",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "relay",
        "style": "",
        "onvalue": "1",
        "onvalueType": "str",
        "onicon": "",
        "oncolor": "",
        "offvalue": "0",
        "offvalueType": "str",
        "officon": "",
        "offcolor": "",
        "x": 644.43017578125,
        "y": 516.4530029296875,
        "wires": [
            [
                "711a73a8.11c14c"
            ]
        ]
    },
    {
        "id": "dd43d95f.565318",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "save to db relay status",
        "func": "var devicename = flow.get(\"flow_name\");\n\nvar system_id = flow.get(\"flow_id\"); //System id number for fiagnostic update\n\nvar relay = msg.payload; \nvar last_relay = context.get(devicename +\"_relay\");\n\nvar d = new Date();\nvar epoch = d.getTime();\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Relay:\" + relay});\n\n\nif(relay != last_relay){\n    context.set(devicename +\"_relay\",relay); \n\n    if (relay == 1){\n        msg.payload = devicename + \" is now ON\";   \n        msg.system = system_id; \n        msg.relay = 1;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }else{\n        msg.payload = devicename + \" in now OFF\";   \n        msg.system = system_id; \n        msg.relay = 0;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }\n    \n    msg.last_epoch = epoch;\n \n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 998.543701171875,
        "y": 510.2029113769531,
        "wires": [
            [
                "ff0e94fc.ef934"
            ]
        ]
    },
    {
        "id": "ff0e94fc.ef934",
        "type": "switch",
        "z": "bb2dc5a6.c18128",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1242.2860107421875,
        "y": 512.8821411132812,
        "wires": [
            [
                "3cac2d44.41c6d2"
            ]
        ]
    },
    {
        "id": "711a73a8.11c14c",
        "type": "ui_switch",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "label": "Relay",
        "group": "5d54337e.fe413c",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "relay",
        "style": "",
        "onvalue": "1",
        "onvalueType": "str",
        "onicon": "",
        "oncolor": "",
        "offvalue": "0",
        "offvalueType": "str",
        "officon": "",
        "offcolor": "",
        "x": 770,
        "y": 516,
        "wires": [
            [
                "dd43d95f.565318",
                "d537c13e.c45a",
                "f2c68a39.f09f3"
            ]
        ]
    },
    {
        "id": "f2c68a39.f09f3",
        "type": "debug",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 990,
        "y": 580,
        "wires": []
    },
    {
        "id": "8592df7d.956e28",
        "type": "link in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "a254884d.7ee7d8",
            "afe27c52.3f2458",
            "7bcbfd8c.46e444"
        ],
        "x": 188.3624267578125,
        "y": 418.5185546875,
        "wires": [
            [
                "b7a548bd.bd2ef8"
            ]
        ]
    },
    {
        "id": "b7a548bd.bd2ef8",
        "type": "switch",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "property": "device",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "4",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 327.3624267578125,
        "y": 415.5185546875,
        "wires": [
            [
                "ea9f8e5a.77c83"
            ]
        ]
    },
    {
        "id": "f5123852.7587b",
        "type": "debug",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "topic",
        "x": 1114.449966430664,
        "y": 1998.3999786376953,
        "wires": []
    },
    {
        "id": "99235591.82bb88",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "Current",
        "func": "msg.payload = msg.payload.Current;\nmsg.topic = \"Current\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 400.944580078125,
        "y": 1286.3987426757812,
        "wires": [
            [
                "c4ec1ae6.b649a",
                "2ee7b619.023fc2"
            ]
        ]
    },
    {
        "id": "8c205202.da3ff8",
        "type": "link in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "bea55a90.4a99e"
        ],
        "x": 251.7626953125,
        "y": 1339.0350952148438,
        "wires": [
            [
                "99235591.82bb88",
                "de8e69ae.f401e",
                "203da77e.bf6f6"
            ]
        ]
    },
    {
        "id": "491aa545.9c69e4",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "Power",
        "func": "msg.payload = msg.payload.Power;\nmsg.topic = \"Power\";\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Power:\" +msg.payload+ \"w\" });\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 311.0593566894531,
        "y": 989.0600891113281,
        "wires": [
            [
                "faa98761.2dd4b",
                "adeca5f4.14a62",
                "90113df9.ab4b28"
            ]
        ]
    },
    {
        "id": "bcb0ba74.39d74",
        "type": "link in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "bea55a90.4a99e"
        ],
        "x": 212.05935668945312,
        "y": 989.0600891113281,
        "wires": [
            [
                "491aa545.9c69e4"
            ]
        ]
    },
    {
        "id": "52892460.1ef014",
        "type": "file in",
        "z": "bb2dc5a6.c18128",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power4chart",
        "format": "utf8",
        "sendError": true,
        "x": 499.6048278808594,
        "y": 1131.4236755371094,
        "wires": [
            [
                "b7906173.6fef2"
            ]
        ]
    },
    {
        "id": "da422d65.77b258",
        "type": "inject",
        "z": "bb2dc5a6.c18128",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 333.6048278808594,
        "y": 1132.4236755371094,
        "wires": [
            [
                "52892460.1ef014"
            ]
        ]
    },
    {
        "id": "b7906173.6fef2",
        "type": "json",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "x": 633.6048278808594,
        "y": 1131.4236755371094,
        "wires": [
            [
                "4ecfe3d8.895cdc"
            ]
        ]
    },
    {
        "id": "99baddc5.a4f24",
        "type": "file",
        "z": "bb2dc5a6.c18128",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power4chart",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1063.4619140625,
        "y": 1130.1737365722656,
        "wires": []
    },
    {
        "id": "a4d1dd59.50252",
        "type": "link in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "15ebce98.bf63d9"
        ],
        "x": 345.9608154296875,
        "y": 457.81781005859375,
        "wires": [
            [
                "ea9f8e5a.77c83"
            ]
        ]
    },
    {
        "id": "deb1438e.ce1138",
        "type": "ui_text",
        "z": "bb2dc5a6.c18128",
        "group": "5d54337e.fe413c",
        "order": 2,
        "width": 0,
        "height": 0,
        "name": "Power",
        "label": "Power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 922.9618530273438,
        "y": 1048.4236755371094,
        "wires": []
    },
    {
        "id": "4ecfe3d8.895cdc",
        "type": "ui_chart",
        "z": "bb2dc5a6.c18128",
        "name": "Power",
        "group": "5d54337e.fe413c",
        "order": 3,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 924.2119750976562,
        "y": 1098.4237365722656,
        "wires": [
            [
                "99baddc5.a4f24"
            ],
            []
        ]
    },
    {
        "id": "a7250b25.a9a518",
        "type": "ui_text",
        "z": "bb2dc5a6.c18128",
        "group": "5d54337e.fe413c",
        "order": 4,
        "width": 0,
        "height": 0,
        "name": "Current",
        "label": "Current",
        "format": "{{msg.payload}} A",
        "layout": "row-spread",
        "x": 895.6362609863281,
        "y": 1281.3403625488281,
        "wires": []
    },
    {
        "id": "faa98761.2dd4b",
        "type": "aggregator",
        "z": "bb2dc5a6.c18128",
        "name": "10s mean",
        "topic": "Power",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 537.7090148925781,
        "y": 1068.5278625488281,
        "wires": [
            [
                "96f20936.551b"
            ]
        ]
    },
    {
        "id": "c4ec1ae6.b649a",
        "type": "aggregator",
        "z": "bb2dc5a6.c18128",
        "name": "10s mean",
        "topic": "Current",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 581.7403259277344,
        "y": 1283.1944274902344,
        "wires": [
            [
                "3da5bee1.b1d00a"
            ]
        ]
    },
    {
        "id": "96f20936.551b",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 686.4590148925781,
        "y": 1071.0278625488281,
        "wires": [
            [
                "deb1438e.ce1138",
                "4ecfe3d8.895cdc",
                "a4f8e85c.a3a8a"
            ]
        ]
    },
    {
        "id": "3da5bee1.b1d00a",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 725.4903259277344,
        "y": 1284.4444885253906,
        "wires": [
            [
                "a7250b25.a9a518"
            ]
        ]
    },
    {
        "id": "8c78317d.ae2028",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "PlugX webpage",
        "info": "",
        "x": 920.1702575683594,
        "y": 999.7777404785156,
        "wires": []
    },
    {
        "id": "c2fb85ad.ebb88",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "Plug1 webpage",
        "info": "",
        "x": 893.8443908691406,
        "y": 1230.9332580566406,
        "wires": []
    },
    {
        "id": "f4cd37b7.7b2138",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "Plugs webpage",
        "info": "",
        "x": 916.3927001953125,
        "y": 804.81005859375,
        "wires": []
    },
    {
        "id": "5b3743cb.f7791c",
        "type": "file in",
        "z": "bb2dc5a6.c18128",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power4chart1min",
        "format": "utf8",
        "sendError": true,
        "x": 505.1427001953125,
        "y": 846.0599670410156,
        "wires": [
            [
                "b118eb9.5088a98"
            ]
        ]
    },
    {
        "id": "443d0aa2.6cd2bc",
        "type": "inject",
        "z": "bb2dc5a6.c18128",
        "name": "Startup",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 339.1427001953125,
        "y": 847.0599670410156,
        "wires": [
            [
                "5b3743cb.f7791c"
            ]
        ]
    },
    {
        "id": "b118eb9.5088a98",
        "type": "json",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "x": 639.1427001953125,
        "y": 846.0599670410156,
        "wires": [
            [
                "ff22361a.29b368"
            ]
        ]
    },
    {
        "id": "556caf29.c5d7b8",
        "type": "file",
        "z": "bb2dc5a6.c18128",
        "name": "Chart dump",
        "filename": "/home/pi/NRdata/power4chart1min",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "x": 1078.6427001953125,
        "y": 847.3099060058594,
        "wires": []
    },
    {
        "id": "adeca5f4.14a62",
        "type": "aggregator",
        "z": "bb2dc5a6.c18128",
        "name": "1min mean",
        "topic": "Power",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 507.2855224609375,
        "y": 902.7713012695312,
        "wires": [
            [
                "e2af81b9.51f708"
            ]
        ]
    },
    {
        "id": "e2af81b9.51f708",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 668.8927001953125,
        "y": 902.4141540527344,
        "wires": [
            [
                "7ade2156.662408",
                "ff22361a.29b368"
            ]
        ]
    },
    {
        "id": "7ade2156.662408",
        "type": "link out",
        "z": "bb2dc5a6.c18128",
        "name": "plug4_1m_avg",
        "links": [
            "f4b8fc9b.12f61",
            "ee8ec860.628e3"
        ],
        "x": 764.1427612304688,
        "y": 943.44091796875,
        "wires": []
    },
    {
        "id": "d33e6ee0.7cbe38",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "Save to DB",
        "func": "var flow_name = flow.get(\"flow_name\");\n\nvar sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('\"+flow_name+\"','power',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 834.0770874023438,
        "y": 2165.8602447509766,
        "wires": [
            [
                "f35e2498.9b995"
            ]
        ]
    },
    {
        "id": "f35e2498.9b995",
        "type": "sqlite",
        "z": "bb2dc5a6.c18128",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 1042.910400390625,
        "y": 2166.8602447509766,
        "wires": [
            []
        ]
    },
    {
        "id": "8e33be6b.d8fc",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "Plug1 DB",
        "info": "",
        "x": 543.7285766601562,
        "y": 2003.6783599853516,
        "wires": []
    },
    {
        "id": "ee8ec860.628e3",
        "type": "link in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "7ade2156.662408"
        ],
        "x": 480.5469055175781,
        "y": 2187.5120391845703,
        "wires": [
            [
                "1fdfa5cb.0ce5d2",
                "d33e6ee0.7cbe38"
            ]
        ]
    },
    {
        "id": "6fd9ac5.23cacd4",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "Save to DB",
        "func": "var flow_name = flow.get(\"flow_name\");\n\nvar sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('\"+flow_name+\"','consumption',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 844.6377563476562,
        "y": 2274.9666290283203,
        "wires": [
            [
                "c61d945d.7e852"
            ]
        ]
    },
    {
        "id": "c61d945d.7e852",
        "type": "sqlite",
        "z": "bb2dc5a6.c18128",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 1046.4710693359375,
        "y": 2275.9666290283203,
        "wires": [
            []
        ]
    },
    {
        "id": "1fdfa5cb.0ce5d2",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "det Wh minute",
        "func": "var last_minute = msg.payload;\n\nmsg.payload = Number((last_minute/60).toFixed(2));\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 653.6377563476562,
        "y": 2274.9666290283203,
        "wires": [
            [
                "6fd9ac5.23cacd4"
            ]
        ]
    },
    {
        "id": "679a761f.c931e",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "every minute",
        "info": "",
        "x": 311.7286071777344,
        "y": 2066.966323852539,
        "wires": []
    },
    {
        "id": "110f9893.2f7f87",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 692.68310546875,
        "y": 1909.9438018798828,
        "wires": []
    },
    {
        "id": "bb997cec.88175",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 701.6654052734375,
        "y": 1600.363052368164,
        "wires": []
    },
    {
        "id": "f3bcfc13.5cfd38",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 666.3927001953125,
        "y": 701.4766540527344,
        "wires": []
    },
    {
        "id": "a43ce148.696b58",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "<==========Power chart and current ==========>",
        "info": "",
        "x": 681.6427001953125,
        "y": 745.2266540527344,
        "wires": []
    },
    {
        "id": "d93ee5cf.3f4fb",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "<==========Consumption and cost==========>",
        "info": "",
        "x": 697.6654052734375,
        "y": 1643.863052368164,
        "wires": []
    },
    {
        "id": "8c22ab8e.3fbdd8",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "<==========Database==========>",
        "info": "",
        "x": 659.43310546875,
        "y": 1948.1938018798828,
        "wires": []
    },
    {
        "id": "aa133521.6082f",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "Save to DB",
        "func": "var flow_name = flow.get(\"flow_name\");\n\nvar sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data(device,sensor,value,epoch) \" +\n        \"VALUES ('\"+flow_name+\"','relay',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 944.5921630859375,
        "y": 2065.511917114258,
        "wires": [
            [
                "49e2a6c.8e516d8"
            ]
        ]
    },
    {
        "id": "49e2a6c.8e516d8",
        "type": "sqlite",
        "z": "bb2dc5a6.c18128",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 1128.334716796875,
        "y": 2066.966567993164,
        "wires": [
            []
        ]
    },
    {
        "id": "ca21e389.db8e5",
        "type": "delay",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 761.5921630859375,
        "y": 2067.511917114258,
        "wires": [
            [
                "aa133521.6082f"
            ]
        ]
    },
    {
        "id": "f8da0622.e8b748",
        "type": "link in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "bea55a90.4a99e"
        ],
        "x": 444.6830749511719,
        "y": 2066.5121002197266,
        "wires": [
            [
                "f90ee19b.05aa88"
            ]
        ]
    },
    {
        "id": "71796790.22205",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "Plug energy consumption today",
        "info": "",
        "x": 701.09716796875,
        "y": 1712.885757446289,
        "wires": []
    },
    {
        "id": "86293e7f.f4db8",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "det Wh Day",
        "func": "var flow_name = flow.get(\"flow_name\");\n\nvar consumption = global.get(flow_name+\"_t_c\");\nvar last_m_date = global.get(flow_name+\"_t_d\");\n\nvar last_minute = msg.payload;\nvar atual_m_date = 0;\n\nif ( (consumption===\"NaN\") || (!consumption) ) \n    consumption = 0;\n\n//det date timestamp\nvar now     = new Date(); \nvar year    = now.getFullYear();\nvar month   = now.getMonth()+1; \nvar day     = now.getDate();\n\nif(month.toString().length == 1) {\nvar month = '0'+month;\n}\nif(day.toString().length == 1) {\nvar day = '0'+day;\n} \n\nmsg.timestamp = year+'-'+month+'-'+day;\nvar atual_m_date = msg.timestamp;\n\n//check if day has passed\nif (last_m_date === undefined) {\n    last_m_date = atual_m_date;\n    global.set(flow_name+\"_t_d\",last_m_date);\n}else{\n    //check if day is over to restart counting\n    if (last_m_date !== atual_m_date) {\n        consumption = 0;\n        global.set(flow_name+\"_t_d\",atual_m_date);\n    }\n}\n\n//calculate power consumption\nif (consumption === undefined) {\n    consumption = last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(flow_name+\"_t_c\",consumption);\n}else{\n    consumption += last_minute;\n    consumption = Number((consumption).toFixed(2));\n    global.set(flow_name+\"_t_c\",consumption);\n}\n\nmsg.payload = consumption;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 634.3116455078125,
        "y": 1756.5996856689453,
        "wires": [
            [
                "26e33e61.13cc5a",
                "dff88b52.08b228"
            ]
        ]
    },
    {
        "id": "3c5a901c.cf1ab",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "round and filter",
        "func": "var consumption = msg.payload/60;\nmsg.payload = Number((consumption).toFixed(2));\n\nif ( (msg.payload===\"NaN\") || !(msg.payload) ) \n    return;\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 411.4638671875,
        "y": 1761.0675811767578,
        "wires": [
            [
                "86293e7f.f4db8"
            ]
        ]
    },
    {
        "id": "f4b8fc9b.12f61",
        "type": "link in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "7ade2156.662408"
        ],
        "x": 263.46380615234375,
        "y": 1765.2039947509766,
        "wires": [
            [
                "3c5a901c.cf1ab"
            ]
        ]
    },
    {
        "id": "a4f8e85c.a3a8a",
        "type": "ui_text",
        "z": "bb2dc5a6.c18128",
        "group": "b0658e7d.f070a",
        "order": 3,
        "width": 0,
        "height": 0,
        "name": "Power",
        "label": "Power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 914.6427001953125,
        "y": 895.9766540527344,
        "wires": []
    },
    {
        "id": "ff22361a.29b368",
        "type": "ui_chart",
        "z": "bb2dc5a6.c18128",
        "name": "Power",
        "group": "b0658e7d.f070a",
        "order": 4,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": "6",
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 913.8927001953125,
        "y": 847.9767456054688,
        "wires": [
            [
                "556caf29.c5d7b8"
            ],
            []
        ]
    },
    {
        "id": "26e33e61.13cc5a",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "save choice",
        "func": "var flow_name = flow.get(\"flow_name\");\n\nmsg.payload = global.get(flow_name+\"_t_c\");\n\n\nif (msg.payload > 1000){\n    msg.payload = msg.payload/1000;\n    msg.payload = Number((msg.payload).toFixed(2));\n    msg.payload = msg.payload + \" kWh\";\n}else{\n    msg.payload = msg.payload + \" Wh\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 843.98046875,
        "y": 1758.269058227539,
        "wires": [
            [
                "d4c55ac9.da46d"
            ]
        ]
    },
    {
        "id": "d4c55ac9.da46d",
        "type": "ui_text",
        "z": "bb2dc5a6.c18128",
        "group": "5d54337e.fe413c",
        "order": 6,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Today consumption",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1098.59716796875,
        "y": 1757.269058227539,
        "wires": []
    },
    {
        "id": "dff88b52.08b228",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "save choice",
        "func": "var flow_name = flow.get(\"flow_name\");\n\nvar cost = global.get(\"fixed_energy_cost\");\nvar today_cost = 0;\n\nmsg.payload = global.get(flow_name+\"_t_c\");\n        \ntoday_cost = (msg.payload/1000)*cost\n\nmsg.payload = Number((today_cost).toFixed(4));\n\n msg.payload = msg.payload + \" \";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 849.98046875,
        "y": 1805.269058227539,
        "wires": [
            [
                "e78812f4.c2a1c"
            ]
        ]
    },
    {
        "id": "e78812f4.c2a1c",
        "type": "ui_text",
        "z": "bb2dc5a6.c18128",
        "group": "5d54337e.fe413c",
        "order": 7,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Today cost",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1080.59716796875,
        "y": 1803.269058227539,
        "wires": []
    },
    {
        "id": "6fb3b12b.b5e45",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 727.7789306640625,
        "y": 2614.2042846679688,
        "wires": []
    },
    {
        "id": "c23f495.c9e42b8",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "<==========General status==========>",
        "info": "",
        "x": 796.5289306640625,
        "y": 2655.4542846679688,
        "wires": []
    },
    {
        "id": "f35494f0.f2425",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "Comms notification",
        "func": "var devicename = flow.get(\"flow_name\");\nvar system_id = flow.get(\"flow_id\"); //System id number for fiagnostic update\nvar online_threshold = 10; //Seconds between updates which the device is considered online\nvar offline_threshold = 30; //Seconds between updates which the device is considered offline\n\nvar temp = context.get(devicename +\"_update\");\nvar current = new Date();\nmsg.payload = \"No data\";\nmsg.warning = false;\n\nif (msg.topic!==\"timecheck\") {\n    // Do not update the context if it is triggerd by the check inject node\n    context.set(devicename +\"_update\",current)\n}\nif (temp===undefined) {\n    // when node-red booting or redeployed\n    context.set(devicename +\"_update\",current)\n}else{\n    current = current - temp;\n    current = Math.floor(current/1000)\n    node.status({fill:\"blue\",shape:\"ring\",text:\"last message:\" + current + \"s\"});\n    \n    /*;\n    var minute = Math.floor(current/60);\n    var hour = Math.floor(minute/60);\n    var day = Math.floor(hour/24);\n    */\n    if (context.get(devicename +\"_state\")!==1) {\n        if (current<online_threshold) {\n            msg.payload = devicename + \" now online\";\n            msg.system = system_id; \n            msg.state = 1;\n            msg.severity = 0;\n            msg.warning = true;\n            \n            //msg.email = true; //if separate email should be sent\n            //msg.emailtext = \"\"; //text contained in the email\n            \n            context.set(devicename +\"_state\",1);\n        }\n    }if (context.get(devicename +\"_state\")!==99){\n        if (current>offline_threshold) {\n            msg.payload =  devicename + \" not transmiting\";\n            msg.system = system_id; \n            msg.state = 99;\n            msg.severity = 2;\n            msg.warning = true;\n            \n            context.set(devicename +\"_state\",99);\n        }\n    }\n\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 629.8985595703125,
        "y": 2725.3140258789062,
        "wires": [
            [
                "da71a3cf.6bc338",
                "9cfabcc3.b9f82"
            ]
        ]
    },
    {
        "id": "44d52e06.62a77",
        "type": "link in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "bea55a90.4a99e"
        ],
        "x": 467.343017578125,
        "y": 2725.4252319335938,
        "wires": [
            [
                "f35494f0.f2425"
            ]
        ]
    },
    {
        "id": "da71a3cf.6bc338",
        "type": "switch",
        "z": "bb2dc5a6.c18128",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 860.268798828125,
        "y": 2725.4625854492188,
        "wires": [
            [
                "94177f84.a3048",
                "d1febe70.436838"
            ]
        ]
    },
    {
        "id": "94177f84.a3048",
        "type": "link out",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 995.3799438476562,
        "y": 2728.0179443359375,
        "wires": []
    },
    {
        "id": "a20478e1.a2a258",
        "type": "inject",
        "z": "bb2dc5a6.c18128",
        "name": "Heartbeat",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "1",
        "crontab": "",
        "once": false,
        "x": 424.591064453125,
        "y": 2774.8118896484375,
        "wires": [
            [
                "f35494f0.f2425"
            ]
        ]
    },
    {
        "id": "d1febe70.436838",
        "type": "debug",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1058.5910339355469,
        "y": 2789.511932373047,
        "wires": []
    },
    {
        "id": "9cfabcc3.b9f82",
        "type": "debug",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 839.5910034179688,
        "y": 2783.5118408203125,
        "wires": []
    },
    {
        "id": "9201305f.26532",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "round",
        "func": "var devicename = flow.get(\"flow_name\");\nvar system_id = flow.get(\"flow_id\"); //System id number for fiagnostic update\n\nvar threshold = global.get(\"energy_threshold\");\nvar last_consuming = context.get(devicename +\"_consuming\");\nvar power = msg.payload; \nvar consuming = 0;\nmsg.warning = false;\n\n/*msg.payload = threshold;\n\nreturn msg;\n*/\n\nif(power >= threshold){\n    consuming = 1;\n    \n} \n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n\nif(consuming != last_consuming){\n    context.set(devicename +\"_consuming\",consuming); \n    node.status({fill:\"blue\",shape:\"ring\",text:\"Consuming:\" + consuming});\n    \n    if (consuming == 1){\n        msg.payload = devicename + \" now consuming\";   \n        msg.system = system_id; \n        msg.consuming = 1;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }else{\n        msg.payload = devicename + \" not consuming\";   \n        msg.system = system_id; \n        msg.consuming = 0;\n        msg.state = 1;\n        msg.severity = 0;\n        msg.warning = true;\n    }\n \n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1037.1256713867188,
        "y": 950.7095947265625,
        "wires": [
            [
                "e8957a6a.8ece8"
            ]
        ]
    },
    {
        "id": "e8957a6a.8ece8",
        "type": "switch",
        "z": "bb2dc5a6.c18128",
        "name": "Update status?",
        "property": "warning",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1197.9588623046875,
        "y": 950.5706787109375,
        "wires": [
            [
                "6322a98b.1861b8"
            ]
        ]
    },
    {
        "id": "6322a98b.1861b8",
        "type": "link out",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1310.84765625,
        "y": 955.6260986328125,
        "wires": []
    },
    {
        "id": "90113df9.ab4b28",
        "type": "aggregator",
        "z": "bb2dc5a6.c18128",
        "name": "5s mean",
        "topic": "Solar",
        "intervalCount": "5",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 526.8984069824219,
        "y": 980.1414489746094,
        "wires": [
            [
                "9201305f.26532"
            ]
        ]
    },
    {
        "id": "6b4e30dd.040ee",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "[==========================================================================================================================]",
        "info": "",
        "x": 726.2108154296875,
        "y": 2938.2724609375,
        "wires": []
    },
    {
        "id": "cee2d3b9.31b32",
        "type": "comment",
        "z": "bb2dc5a6.c18128",
        "name": "<==========Avg consumption while on==========>",
        "info": "",
        "x": 654.9608154296875,
        "y": 2984.5224609375,
        "wires": []
    },
    {
        "id": "d3b95342.c4ed28",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "SQL",
        "func": "var device = flow.get(\"flow_name\");\n\n\nvar threshold = global.get(\"energy_threshold\");\n// This will handle any device and any attribute as long as it is in the DB\nvar p_30d  = 1000*60*60*24*30 ; //30 Days\nvar p_7d  = 1000*60*60*24*7 ; //7 Days\nvar p_1d   =  1000*60*60*24 ; // 1 Day\nvar d = new Date();\nvar current = d.getTime();\nvar today0h = d.setHours(0,0,0,0);\nvar day = d.getDay();\nvar monday0h = today0h - (day + (day === 0 ? -6:1)) * p_1d;\nvar fromdate = 0;\nvar enddate = 0;\n\n\nfromdate = context.get(\"fromdate\");\nif (fromdate===undefined) {\n    // set the period to a default if it is not selected yet\n    fromdate = today0h-7*p_1d;\n}\nenddate = context.get(\"enddate\");\nif (enddate===undefined) {\n    // set the period to a default if it is not selected yet\n    enddate = today0h;\n}\n\n\n// Regenerate the SQL statements\n// Run through the data source list an generate the SQL statements\n\n\nmsg.topic = \"SELECT AVG(value) FROM sensor_data WHERE device='\"+device+\"' AND sensor='power' AND value > \"+threshold+\" AND epoch >= \" + fromdate + \" AND epoch <= \" + enddate;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 600.2108154296875,
        "y": 3060.2724609375,
        "wires": [
            [
                "e682ab42.f2d2d"
            ]
        ]
    },
    {
        "id": "e682ab42.f2d2d",
        "type": "sqlite",
        "z": "bb2dc5a6.c18128",
        "mydb": "b629c67.a0f9e38",
        "name": "DB",
        "x": 747.2108154296875,
        "y": 3060.2724609375,
        "wires": [
            [
                "92fa61ff.d831b"
            ]
        ]
    },
    {
        "id": "31c643bf.d9969c",
        "type": "inject",
        "z": "bb2dc5a6.c18128",
        "name": "Daily AVG ",
        "topic": "timecheck",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "00 01 * * *",
        "once": false,
        "x": 449.2108154296875,
        "y": 3062.2724609375,
        "wires": [
            [
                "d3b95342.c4ed28"
            ]
        ]
    },
    {
        "id": "e6084944.092af",
        "type": "debug",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1106.8275146484375,
        "y": 3116.2724609375,
        "wires": []
    },
    {
        "id": "92fa61ff.d831b",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "save avg",
        "func": "var system_id = flow.get(\"flow_id\"); //System id number for fiagnostic update\n\n\nvar power = Number((msg.payload[0][\"AVG(value)\"]).toFixed(2));\n\nnode.status({fill:\"blue\",shape:\"ring\",text:\"AVG power:\" + power});\n\nmsg.payload = null;\nmsg.system = system_id; \nmsg.avg = power;\nmsg.severity = 0;\nmsg.warning = true;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 913.0274658203125,
        "y": 3059.68896484375,
        "wires": [
            [
                "e6084944.092af",
                "4cc8e350.f8a3ac"
            ]
        ]
    },
    {
        "id": "4cc8e350.f8a3ac",
        "type": "link out",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1059.74951171875,
        "y": 3058.605224609375,
        "wires": []
    },
    {
        "id": "baf17744.5adee8",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore relay4 state",
        "func": "msg.topic = \"plug4_state\";\nmsg.payload = global.get(\"plug4_state\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010,
        "y": 540,
        "wires": [
            [
                "15ebce98.bf63d9"
            ]
        ]
    },
    {
        "id": "15ebce98.bf63d9",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_relay4",
        "links": [
            "a4d1dd59.50252"
        ],
        "x": 1195.7271728515625,
        "y": 542,
        "wires": []
    },
    {
        "id": "78a2ef27.1847f",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "set flow name",
        "func": "flow.set (\"flow_name\", \"plug4\")\nflow.set (\"flow_id\", 4)\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 997.3333740234375,
        "y": 93.78787231445312,
        "wires": [
            []
        ]
    },
    {
        "id": "18cd11b8.062ad6",
        "type": "inject",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 829.0452880859375,
        "y": 93.92425537109375,
        "wires": [
            [
                "78a2ef27.1847f"
            ]
        ]
    },
    {
        "id": "3cac2d44.41c6d2",
        "type": "link out",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "18aa5169.db8ac7"
        ],
        "x": 1384.1513671875,
        "y": 516.1514892578125,
        "wires": []
    },
    {
        "id": "bea55a90.4a99e",
        "type": "link out",
        "z": "bb2dc5a6.c18128",
        "name": "Plug4dat",
        "links": [
            "bcb0ba74.39d74",
            "8c205202.da3ff8",
            "f8da0622.e8b748",
            "44d52e06.62a77"
        ],
        "x": 353.8787536621094,
        "y": 226.60606384277344,
        "wires": []
    },
    {
        "id": "de8e69ae.f401e",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "Voltage",
        "func": "msg.payload = msg.payload.Voltage;\nmsg.topic = \"Voltage\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 395.060546875,
        "y": 1392.3332824707031,
        "wires": [
            [
                "230a9b91.05496c",
                "327bb3a0.4eac1c"
            ]
        ]
    },
    {
        "id": "d5c2eb87.3e3a1",
        "type": "ui_text",
        "z": "bb2dc5a6.c18128",
        "group": "5d54337e.fe413c",
        "order": 4,
        "width": 0,
        "height": 0,
        "name": "Voltage",
        "label": "Voltage",
        "format": "{{msg.payload}} V",
        "layout": "row-spread",
        "x": 889.7522277832031,
        "y": 1387.27490234375,
        "wires": []
    },
    {
        "id": "230a9b91.05496c",
        "type": "aggregator",
        "z": "bb2dc5a6.c18128",
        "name": "10s mean",
        "topic": "Current",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 575.8562927246094,
        "y": 1389.1289672851562,
        "wires": [
            [
                "c4a4571.b4d1c28"
            ]
        ]
    },
    {
        "id": "c4a4571.b4d1c28",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 719.6062927246094,
        "y": 1390.3790283203125,
        "wires": [
            [
                "d5c2eb87.3e3a1"
            ]
        ]
    },
    {
        "id": "203da77e.bf6f6",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "Power factor",
        "func": "msg.payload = msg.payload.Factor;\nmsg.topic = \"Factor\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 400.5151672363281,
        "y": 1485.9697570800781,
        "wires": [
            [
                "b528491f.b967",
                "107a0088.3d4847"
            ]
        ]
    },
    {
        "id": "9abeb7bd.12d5d8",
        "type": "ui_text",
        "z": "bb2dc5a6.c18128",
        "group": "5d54337e.fe413c",
        "order": 4,
        "width": 0,
        "height": 0,
        "name": "Power factor",
        "label": "Power factor",
        "format": "{{msg.payload}} ",
        "layout": "row-spread",
        "x": 895.2068481445312,
        "y": 1480.911376953125,
        "wires": []
    },
    {
        "id": "b528491f.b967",
        "type": "aggregator",
        "z": "bb2dc5a6.c18128",
        "name": "10s mean",
        "topic": "Current",
        "intervalCount": "10",
        "intervalUnits": "s",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 571.3109130859375,
        "y": 1482.7654418945312,
        "wires": [
            [
                "3e75e180.599e56"
            ]
        ]
    },
    {
        "id": "3e75e180.599e56",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 715.0609130859375,
        "y": 1484.0155029296875,
        "wires": [
            [
                "9abeb7bd.12d5d8"
            ]
        ]
    },
    {
        "id": "f90ee19b.05aa88",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "State status",
        "func": "var flow_name = flow.get(\"flow_name\");\n\nmsg.payload = global.get(flow_name+\"_state\");\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 566.8787231445312,
        "y": 2065.605697631836,
        "wires": [
            [
                "ca21e389.db8e5"
            ]
        ]
    },
    {
        "id": "fa692c25.e6d39",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "Save to DB",
        "func": "var flow_name = flow.get(\"flow_name\");\n\nvar sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('\"+flow_name+\"','current',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 785.9695739746094,
        "y": 2376.8788452148438,
        "wires": [
            [
                "14f2caf4.c6a4cd"
            ]
        ]
    },
    {
        "id": "14f2caf4.c6a4cd",
        "type": "sqlite",
        "z": "bb2dc5a6.c18128",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 1032.0756530761719,
        "y": 2378.787796020508,
        "wires": [
            []
        ]
    },
    {
        "id": "bf185f77.b02e48",
        "type": "link in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "2df32916.22605e"
        ],
        "x": 517.8939819335938,
        "y": 2373.9849853515625,
        "wires": [
            [
                "fa692c25.e6d39"
            ]
        ]
    },
    {
        "id": "2ee7b619.023fc2",
        "type": "aggregator",
        "z": "bb2dc5a6.c18128",
        "name": "1min mean",
        "topic": "current",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 579.6060791015625,
        "y": 1332.333251953125,
        "wires": [
            [
                "2df32916.22605e"
            ]
        ]
    },
    {
        "id": "327bb3a0.4eac1c",
        "type": "aggregator",
        "z": "bb2dc5a6.c18128",
        "name": "1min mean",
        "topic": "current",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 575.9697265625,
        "y": 1433.242431640625,
        "wires": [
            [
                "e0586b1e.f4d7f"
            ]
        ]
    },
    {
        "id": "107a0088.3d4847",
        "type": "aggregator",
        "z": "bb2dc5a6.c18128",
        "name": "1min mean",
        "topic": "current",
        "intervalCount": "1",
        "intervalUnits": "m",
        "submitIncompleteInterval": true,
        "aggregationType": "mean",
        "x": 573.242431640625,
        "y": 1526.8787841796875,
        "wires": [
            [
                "26831308.e2068c"
            ]
        ]
    },
    {
        "id": "2df32916.22605e",
        "type": "link out",
        "z": "bb2dc5a6.c18128",
        "name": "plug4_1m_current_avg",
        "links": [
            "bf185f77.b02e48"
        ],
        "x": 729.4999389648438,
        "y": 1331.1515197753906,
        "wires": []
    },
    {
        "id": "e0586b1e.f4d7f",
        "type": "link out",
        "z": "bb2dc5a6.c18128",
        "name": "plug4_1m_voltage_avg",
        "links": [
            "696186b6.814af8"
        ],
        "x": 737.787841796875,
        "y": 1435.9697265625,
        "wires": []
    },
    {
        "id": "26831308.e2068c",
        "type": "link out",
        "z": "bb2dc5a6.c18128",
        "name": "plug4_1m_factor_avg",
        "links": [
            "3045bef4.992a1a"
        ],
        "x": 735.9696044921875,
        "y": 1530.51513671875,
        "wires": []
    },
    {
        "id": "d663b28a.797778",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "Save to DB",
        "func": "var flow_name = flow.get(\"flow_name\");\n\nvar sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('\"+flow_name+\"','voltage',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 788.6968994140625,
        "y": 2440.51513671875,
        "wires": [
            [
                "1cf56527.af508b"
            ]
        ]
    },
    {
        "id": "1cf56527.af508b",
        "type": "sqlite",
        "z": "bb2dc5a6.c18128",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 1034.802978515625,
        "y": 2442.424087524414,
        "wires": [
            []
        ]
    },
    {
        "id": "696186b6.814af8",
        "type": "link in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "e0586b1e.f4d7f"
        ],
        "x": 520.6213073730469,
        "y": 2437.6212768554688,
        "wires": [
            [
                "d663b28a.797778"
            ]
        ]
    },
    {
        "id": "a8dc6d09.d70238",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "Save to DB",
        "func": "var flow_name = flow.get(\"flow_name\");\n\nvar sql = \"\";\nvar d = new Date();\nvar epoch = d.getTime();\nvar outputs = [];\n\nsql = \"INSERT INTO sensor_data (device,sensor,value,epoch) \" +\n        \"VALUES ('\"+flow_name+\"','factor',\"+msg.payload+\",\"+epoch+\")\";\noutputs.push({topic:sql});        \n    \n// Update the status with current timestamp\nvar now = new Date();\nvar yyyy = now.getFullYear();\nvar mm = now.getMonth() < 9 ? \"0\" + (now.getMonth() + 1) : (now.getMonth() + 1); // getMonth() is zero-based\nvar dd  = now.getDate() < 10 ? \"0\" + now.getDate() : now.getDate();\nvar hh = now.getHours() < 10 ? \"0\" + now.getHours() : now.getHours();\nvar mmm  = now.getMinutes() < 10 ? \"0\" + now.getMinutes() : now.getMinutes();\nvar ss  = now.getSeconds() < 10 ? \"0\" + now.getSeconds() : now.getSeconds();\nnode.status({fill:\"blue\",shape:\"ring\",text:\"Last update: \"+dd + \".\" + mm + \".\" + yyyy + \" \" + hh + \":\" + mmm + \":\" + ss});    \n      \nreturn [ outputs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 785.060546875,
        "y": 2505.0606536865234,
        "wires": [
            [
                "650d87d4.276a18"
            ]
        ]
    },
    {
        "id": "650d87d4.276a18",
        "type": "sqlite",
        "z": "bb2dc5a6.c18128",
        "mydb": "b629c67.a0f9e38",
        "name": "Meter DB",
        "x": 1035.7120361328125,
        "y": 2506.969940185547,
        "wires": [
            []
        ]
    },
    {
        "id": "3045bef4.992a1a",
        "type": "link in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "26831308.e2068c"
        ],
        "x": 516.9849548339844,
        "y": 2502.166793823242,
        "wires": [
            [
                "a8dc6d09.d70238"
            ]
        ]
    },
    {
        "id": "edd7e578.aee2c",
        "type": "inject",
        "z": "584b08c1.d6cff8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "01 12 * * *",
        "once": false,
        "x": 376.066650390625,
        "y": 1135.5576171875,
        "wires": [
            []
        ]
    },
    {
        "id": "debec5fa.f4e25",
        "type": "function",
        "z": "9e52ccb8.2c00a8",
        "name": "join payloads",
        "func": "Object.assign(msg.payload[0], msg.payload[1]);\n\nmsg.payload = msg.payload[0];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 953.25,
        "y": 2019.199951171875,
        "wires": [
            [
                "5e7d6af0.e1693c",
                "2f387811.f46888"
            ]
        ]
    },
    {
        "id": "2f387811.f46888",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "payload",
        "x": 1141.449951171875,
        "y": 1950.25,
        "wires": []
    },
    {
        "id": "503fdccb.7ca554",
        "type": "inject",
        "z": "584b08c1.d6cff8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "11 6 * * *",
        "once": false,
        "x": 372.066650390625,
        "y": 1178.9577026367188,
        "wires": [
            []
        ]
    },
    {
        "id": "14fbda0f.408316",
        "type": "inject",
        "z": "584b08c1.d6cff8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "10 18 * * *",
        "once": false,
        "x": 371.066650390625,
        "y": 1221.9577026367188,
        "wires": [
            []
        ]
    },
    {
        "id": "ae5a39f5.d3ce6",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 516.8833312988281,
        "y": 2079.88330078125,
        "wires": [
            [
                "e068c2af.44f1f8"
            ]
        ]
    },
    {
        "id": "8e75890f.e12788",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 504.8833312988281,
        "y": 2239.88330078125,
        "wires": [
            [
                "4325d041.5d152"
            ]
        ]
    },
    {
        "id": "40fdb70.aff6e48",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 508.8833312988281,
        "y": 2159.88330078125,
        "wires": [
            [
                "6894d6f5.feee8"
            ]
        ]
    },
    {
        "id": "fb747644.21fdd8",
        "type": "function",
        "z": "ef23770c.5edc1",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 505.8833312988281,
        "y": 2319.88330078125,
        "wires": [
            [
                "66321043.e3363"
            ]
        ]
    },
    {
        "id": "3fc1c841.fb365",
        "type": "function",
        "z": "a4b5eb1e.5dd4d8",
        "name": "SQL",
        "func": "var system_id = 1;\n\nmsg.topic = \"SELECT sys_name FROM system2 WHERE sys_id =\"+system_id;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 934.88330078125,
        "y": 127.88333129882812,
        "wires": [
            [
                "a09aa8fe.37145"
            ]
        ]
    },
    {
        "id": "a09aa8fe.37145",
        "type": "sqlite",
        "z": "a4b5eb1e.5dd4d8",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 1060.88330078125,
        "y": 127.88333129882812,
        "wires": [
            [
                "3c7428b7.aa5b8"
            ]
        ]
    },
    {
        "id": "fe8f69c9.751968",
        "type": "link out",
        "z": "9e52ccb8.2c00a8",
        "name": "names_update",
        "links": [
            "3777ad4a.739882",
            "bc357e7e.8ddd2",
            "aa7566dc.4643",
            "76216d75.56f0ac",
            "72c8dc37.7c149c",
            "5472a208.2c8d6c",
            "5a803a7.1e74644",
            "1b174ec2.bc6af9"
        ],
        "x": 477.7666320800781,
        "y": 975.949951171875,
        "wires": []
    },
    {
        "id": "e3fe964f.939388",
        "type": "inject",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 815.7666015625,
        "y": 80.01666259765625,
        "wires": [
            [
                "3fc1c841.fb365"
            ]
        ]
    },
    {
        "id": "3777ad4a.739882",
        "type": "link in",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "links": [
            "fe8f69c9.751968"
        ],
        "x": 840.7666015625,
        "y": 127.71665954589844,
        "wires": [
            [
                "3fc1c841.fb365"
            ]
        ]
    },
    {
        "id": "3c7428b7.aa5b8",
        "type": "change",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "msg.payload[0].sys_name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1033.7666015625,
        "y": 188.55001831054688,
        "wires": [
            [
                "53572ca3.cae0a4"
            ]
        ]
    },
    {
        "id": "690a8705.79035",
        "type": "ui_text",
        "z": "bbaf6eb0.1f878",
        "group": "213b5215.c08486",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "Name",
        "label": "",
        "format": "{{msg.payload}}",
        "layout": "row-left",
        "x": 1102.5,
        "y": 197.5833740234375,
        "wires": []
    },
    {
        "id": "fd96449b.e7c75",
        "type": "function",
        "z": "bbaf6eb0.1f878",
        "name": "SQL",
        "func": "var system_id = 2;\n\nmsg.topic = \"SELECT sys_name FROM system2 WHERE sys_id =\"+system_id;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 824.2666015625,
        "y": 138.18328857421875,
        "wires": [
            [
                "121d4bb7.4e7dac"
            ]
        ]
    },
    {
        "id": "121d4bb7.4e7dac",
        "type": "sqlite",
        "z": "bbaf6eb0.1f878",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 950.2666015625,
        "y": 138.18328857421875,
        "wires": [
            [
                "4c1bf208.de5d34"
            ]
        ]
    },
    {
        "id": "e41376ea.058258",
        "type": "inject",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 705.14990234375,
        "y": 90.31661987304688,
        "wires": [
            [
                "fd96449b.e7c75"
            ]
        ]
    },
    {
        "id": "aa7566dc.4643",
        "type": "link in",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "links": [
            "fe8f69c9.751968"
        ],
        "x": 730.14990234375,
        "y": 138.01661682128906,
        "wires": [
            [
                "fd96449b.e7c75"
            ]
        ]
    },
    {
        "id": "4c1bf208.de5d34",
        "type": "change",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "msg.payload[0].sys_name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 923.14990234375,
        "y": 198.8499755859375,
        "wires": [
            [
                "690a8705.79035"
            ]
        ]
    },
    {
        "id": "4f56cb95.20d944",
        "type": "function",
        "z": "2a4ee4a1.258c6c",
        "name": "SQL",
        "func": "var system_id = 3;\n\nmsg.topic = \"SELECT sys_name FROM system2 WHERE sys_id =\"+system_id;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 910.2666015625,
        "y": 135.18328857421875,
        "wires": [
            [
                "f7996f2d.aba148"
            ]
        ]
    },
    {
        "id": "f7996f2d.aba148",
        "type": "sqlite",
        "z": "2a4ee4a1.258c6c",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 1036.2666015625,
        "y": 135.18328857421875,
        "wires": [
            [
                "18e5a6.290b9a5b"
            ]
        ]
    },
    {
        "id": "d4d07547.718508",
        "type": "inject",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 791.14990234375,
        "y": 87.31661987304688,
        "wires": [
            [
                "4f56cb95.20d944"
            ]
        ]
    },
    {
        "id": "76216d75.56f0ac",
        "type": "link in",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "links": [
            "fe8f69c9.751968"
        ],
        "x": 816.14990234375,
        "y": 135.01661682128906,
        "wires": [
            [
                "4f56cb95.20d944"
            ]
        ]
    },
    {
        "id": "18e5a6.290b9a5b",
        "type": "change",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "msg.payload[0].sys_name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1009.14990234375,
        "y": 195.8499755859375,
        "wires": [
            [
                "6dee035.04eb9fc"
            ]
        ]
    },
    {
        "id": "d1d270e2.805958",
        "type": "ui_text",
        "z": "bb2dc5a6.c18128",
        "group": "b0658e7d.f070a",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "Name",
        "label": "",
        "format": "{{msg.payload}}",
        "layout": "row-left",
        "x": 1136.88330078125,
        "y": 268.8833312988281,
        "wires": []
    },
    {
        "id": "e2dada36.1799e",
        "type": "function",
        "z": "bb2dc5a6.c18128",
        "name": "SQL",
        "func": "var system_id = flow.get(\"flow_id\");\n\nmsg.topic = \"SELECT sys_name FROM system2 WHERE sys_id =\"+system_id;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 871.2666015625,
        "y": 209.18328857421875,
        "wires": [
            [
                "a0a8da96.4ecfe"
            ]
        ]
    },
    {
        "id": "a0a8da96.4ecfe",
        "type": "sqlite",
        "z": "bb2dc5a6.c18128",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 997.2666015625,
        "y": 209.18328857421875,
        "wires": [
            [
                "dc117d33.294998"
            ]
        ]
    },
    {
        "id": "e4224fa0.36c37",
        "type": "inject",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 752.14990234375,
        "y": 161.31661987304688,
        "wires": [
            [
                "e2dada36.1799e"
            ]
        ]
    },
    {
        "id": "72c8dc37.7c149c",
        "type": "link in",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "links": [
            "fe8f69c9.751968"
        ],
        "x": 777.14990234375,
        "y": 209.01661682128906,
        "wires": [
            [
                "e2dada36.1799e"
            ]
        ]
    },
    {
        "id": "dc117d33.294998",
        "type": "change",
        "z": "bb2dc5a6.c18128",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "msg.payload[0].sys_name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 970.14990234375,
        "y": 269.8499755859375,
        "wires": [
            [
                "d1d270e2.805958"
            ]
        ]
    },
    {
        "id": "9576f568.6f99b",
        "type": "debug",
        "z": "ef23770c.5edc1",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 940.3114013671875,
        "y": 2506.286376953125,
        "wires": []
    },
    {
        "id": "143fc1e8.2358be",
        "type": "debug",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 972,
        "y": 360,
        "wires": []
    },
    {
        "id": "b7b35da7.ed75f",
        "type": "ui_text",
        "z": "c1eaebbb.b6c98",
        "group": "79110c42.df685c",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "Name",
        "label": "",
        "format": "{{msg.payload}}",
        "layout": "row-left",
        "x": 1096.050048828125,
        "y": 133.56671142578125,
        "wires": []
    },
    {
        "id": "147d0dfa.e9e6d2",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "SQL",
        "func": "var system_id = 12;\n\nmsg.topic = \"SELECT sys_name FROM system2 WHERE sys_id =\"+system_id;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 830.433349609375,
        "y": 73.86666870117188,
        "wires": [
            [
                "6c6bdf41.56822"
            ]
        ]
    },
    {
        "id": "6c6bdf41.56822",
        "type": "sqlite",
        "z": "c1eaebbb.b6c98",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 956.433349609375,
        "y": 73.86666870117188,
        "wires": [
            [
                "f4770112.f82268"
            ]
        ]
    },
    {
        "id": "53f35a83.7d97b4",
        "type": "inject",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 711.316650390625,
        "y": 26,
        "wires": [
            [
                "147d0dfa.e9e6d2"
            ]
        ]
    },
    {
        "id": "5a803a7.1e74644",
        "type": "link in",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "links": [
            "fe8f69c9.751968"
        ],
        "x": 742.316650390625,
        "y": 92.69999694824219,
        "wires": [
            [
                "147d0dfa.e9e6d2"
            ]
        ]
    },
    {
        "id": "f4770112.f82268",
        "type": "change",
        "z": "c1eaebbb.b6c98",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "msg.payload[0].sys_name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 929.316650390625,
        "y": 134.53335571289062,
        "wires": [
            [
                "b7b35da7.ed75f"
            ]
        ]
    },
    {
        "id": "5afbc8e7.8023b",
        "type": "ui_text",
        "z": "be52c199.c86f58",
        "group": "63ae4fc1.3ca57",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "Name",
        "label": "",
        "format": "{{msg.payload}}",
        "layout": "row-left",
        "x": 1094.050048828125,
        "y": 130.56671142578125,
        "wires": []
    },
    {
        "id": "590278a4.e9c37",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "SQL",
        "func": "var system_id = 11;\n\nmsg.topic = \"SELECT sys_name FROM system2 WHERE sys_id =\"+system_id;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 826.433349609375,
        "y": 74.86666870117188,
        "wires": [
            [
                "82c1d197.29b268"
            ]
        ]
    },
    {
        "id": "82c1d197.29b268",
        "type": "sqlite",
        "z": "be52c199.c86f58",
        "mydb": "b629c67.a0f9e38",
        "name": "Diag DB",
        "x": 952.433349609375,
        "y": 74.86666870117188,
        "wires": [
            [
                "6382823f.28612c"
            ]
        ]
    },
    {
        "id": "d77075c6.3cc4f8",
        "type": "inject",
        "z": "be52c199.c86f58",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 707.316650390625,
        "y": 27,
        "wires": [
            [
                "590278a4.e9c37"
            ]
        ]
    },
    {
        "id": "1b174ec2.bc6af9",
        "type": "link in",
        "z": "be52c199.c86f58",
        "name": "",
        "links": [
            "fe8f69c9.751968"
        ],
        "x": 732.316650390625,
        "y": 74.69999694824219,
        "wires": [
            [
                "590278a4.e9c37"
            ]
        ]
    },
    {
        "id": "6382823f.28612c",
        "type": "change",
        "z": "be52c199.c86f58",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "msg.payload[0].sys_name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 925.316650390625,
        "y": 135.53335571289062,
        "wires": [
            [
                "5afbc8e7.8023b"
            ]
        ]
    },
    {
        "id": "4cb2769c.1020b8",
        "type": "debug",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 470,
        "y": 1140,
        "wires": []
    },
    {
        "id": "f376e185.1e3bf",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 490,
        "y": 1920,
        "wires": [
            [
                "a48cd467.ce24f8"
            ]
        ]
    },
    {
        "id": "e0a88055.fda15",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 490,
        "y": 1840,
        "wires": [
            [
                "b8286516.82dc48"
            ]
        ]
    },
    {
        "id": "2c0545b5.00256a",
        "type": "function",
        "z": "be52c199.c86f58",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 490,
        "y": 1740,
        "wires": [
            [
                "8a7f67ef.eed828"
            ]
        ]
    },
    {
        "id": "b2ae6df0.433f7",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 1940,
        "wires": [
            [
                "29c92b83.07396c"
            ]
        ]
    },
    {
        "id": "3f9f0782.d06b28",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 1860,
        "wires": [
            [
                "c83b3757.e9e53"
            ]
        ]
    },
    {
        "id": "95cdd141.2690e",
        "type": "function",
        "z": "c1eaebbb.b6c98",
        "name": "round",
        "func": "//msg.payload = Math.round(6.688689);\nmsg.payload = Number((msg.payload).toFixed(2));\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 1760,
        "wires": [
            [
                "83f672ad.7cbae8"
            ]
        ]
    },
    {
        "id": "484ebdd.5d0e544",
        "type": "debug",
        "z": "ef23770c.5edc1",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 570,
        "y": 980,
        "wires": []
    },
    {
        "id": "d94fe7c5.2ff8a8",
        "type": "debug",
        "z": "a4b5eb1e.5dd4d8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 530,
        "y": 100,
        "wires": []
    },
    {
        "id": "721451a8.03eee",
        "type": "debug",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 490,
        "y": 100,
        "wires": []
    },
    {
        "id": "55e26854.68ac58",
        "type": "mqtt in",
        "z": "ef23770c.5edc1",
        "name": "",
        "topic": "/pwrMeter/#",
        "qos": "2",
        "broker": "4f35fce7.f4f55c",
        "x": 1030,
        "y": 100,
        "wires": [
            [
                "c6eaf6f8.f85f68"
            ]
        ]
    },
    {
        "id": "1b6a1e9f.996e89",
        "type": "debug",
        "z": "ef23770c.5edc1",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "payload",
        "x": 576.1666259765625,
        "y": 113.66665649414062,
        "wires": []
    },
    {
        "id": "c6eaf6f8.f85f68",
        "type": "debug",
        "z": "ef23770c.5edc1",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "payload",
        "x": 1190,
        "y": 100,
        "wires": []
    },
    {
        "id": "6972befc.39746",
        "type": "debug",
        "z": "bbaf6eb0.1f878",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 620.0799102783203,
        "y": 535.756965637207,
        "wires": []
    },
    {
        "id": "84e5289f.16cc28",
        "type": "link in",
        "z": "5f22000e.0f3588",
        "name": "",
        "links": [
            "ec383f98.029f9"
        ],
        "x": 249,
        "y": 1616,
        "wires": [
            [
                "3ebf7b74.e25fb4"
            ]
        ]
    },
    {
        "id": "ec383f98.029f9",
        "type": "link out",
        "z": "9e52ccb8.2c00a8",
        "name": "system2_out",
        "links": [
            "84e5289f.16cc28"
        ],
        "x": 623,
        "y": 970,
        "wires": []
    },
    {
        "id": "4401f90d.6f8178",
        "type": "link in",
        "z": "5f22000e.0f3588",
        "name": "",
        "links": [
            "f7bc15e9.15759",
            "8967fd5d.2b59c"
        ],
        "x": 248.24999321831598,
        "y": 1656.37503390842,
        "wires": [
            []
        ]
    },
    {
        "id": "b3e9796d.6551c8",
        "type": "template",
        "z": "5f22000e.0f3588",
        "name": "Formatting",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<table>\n    <tr><th>System</th><th>Status</th></tr>\n    {{#payload}}\n        <tr>\n            <td>{{sys_name}}</td>\n            <td style=\"background-color: {{sta_color}};\">{{sta_title}}</td>\n        </tr>\n    {{/payload}}\n</table>\n\n\n",
        "output": "str",
        "x": 1130,
        "y": 2180,
        "wires": [
            []
        ]
    },
    {
        "id": "7c42889d.d030d8",
        "type": "comment",
        "z": "584b08c1.d6cff8",
        "name": "report email",
        "info": "",
        "x": 910,
        "y": 98,
        "wires": []
    },
    {
        "id": "e966db44.6c4a78",
        "type": "function",
        "z": "584b08c1.d6cff8",
        "name": "Save email",
        "func": "global.set(\"report_email\",msg.payload);\n\nreturn;",
        "outputs": 1,
        "noerr": 0,
        "x": 1238.0636596679688,
        "y": 214.8888397216797,
        "wires": [
            []
        ]
    },
    {
        "id": "3d527430.bd182c",
        "type": "link in",
        "z": "584b08c1.d6cff8",
        "name": "",
        "links": [
            "37fc93fe.1d769c"
        ],
        "x": 1086.1114196777344,
        "y": 155.2754669189453,
        "wires": [
            [
                "b79bedc4.75405"
            ]
        ]
    },
    {
        "id": "b79bedc4.75405",
        "type": "ui_text",
        "z": "584b08c1.d6cff8",
        "group": "5ca00d55.879cf4",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "E-mail",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1226.5373229980469,
        "y": 165.55325317382812,
        "wires": []
    },
    {
        "id": "551bb272.5ae36c",
        "type": "ui_text_input",
        "z": "584b08c1.d6cff8",
        "name": "",
        "label": "insert e-mail address",
        "group": "5ca00d55.879cf4",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 1017,
        "y": 215,
        "wires": [
            [
                "e966db44.6c4a78",
                "b79bedc4.75405"
            ]
        ]
    },
    {
        "id": "36ba236b.94793c",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore email",
        "func": "msg.topic = \"report_email\";\nmsg.payload = global.get(\"report_email\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 990,
        "y": 600,
        "wires": [
            [
                "37fc93fe.1d769c"
            ]
        ]
    },
    {
        "id": "37fc93fe.1d769c",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_email",
        "links": [
            "3d527430.bd182c"
        ],
        "x": 1195.1296997070312,
        "y": 598.3333129882812,
        "wires": []
    },
    {
        "id": "1da1c377.378e3d",
        "type": "function",
        "z": "5f22000e.0f3588",
        "name": "msg to",
        "func": "msg.to = global.get(\"report_email\");\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 795,
        "y": 1406,
        "wires": [
            [
                "a62d5ead.24c978"
            ]
        ]
    },
    {
        "id": "342847e3.c24608",
        "type": "function",
        "z": "584b08c1.d6cff8",
        "name": "set house meter reading",
        "func": "var meter_value = msg.payload*1000; \n\nglobal.set(\"provider_meter\",meter_value);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1270,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "4cabfb5d.a541f4",
        "type": "comment",
        "z": "584b08c1.d6cff8",
        "name": "Provider meter",
        "info": "",
        "x": 920,
        "y": 480,
        "wires": []
    },
    {
        "id": "b143155c.5823a8",
        "type": "ui_text_input",
        "z": "584b08c1.d6cff8",
        "name": "",
        "label": "enter consumption value",
        "group": "99a4dc27.7780b",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": true,
        "mode": "text",
        "delay": 300,
        "topic": "",
        "x": 970,
        "y": 620,
        "wires": [
            [
                "342847e3.c24608",
                "5d95c5d6.2c39fc"
            ]
        ]
    },
    {
        "id": "5d95c5d6.2c39fc",
        "type": "ui_text",
        "z": "584b08c1.d6cff8",
        "group": "99a4dc27.7780b",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "Provider meter",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1240,
        "y": 560,
        "wires": []
    },
    {
        "id": "519c6ba5.fd38e4",
        "type": "link in",
        "z": "584b08c1.d6cff8",
        "name": "",
        "links": [
            "319fe944.cdb416",
            "e1787f8b.7b49b"
        ],
        "x": 1035,
        "y": 560,
        "wires": [
            [
                "5d95c5d6.2c39fc"
            ]
        ]
    },
    {
        "id": "3fafaba3.7fb784",
        "type": "function",
        "z": "68347deb.b93a34",
        "name": "restore provider meter",
        "func": "msg.topic = \"provider_meter\";\nmsg.payload = global.get(\"provider_meter\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1020,
        "y": 660,
        "wires": [
            [
                "319fe944.cdb416"
            ]
        ]
    },
    {
        "id": "319fe944.cdb416",
        "type": "link out",
        "z": "68347deb.b93a34",
        "name": "restore_provider_meter",
        "links": [
            "519c6ba5.fd38e4"
        ],
        "x": 1195.1296997070312,
        "y": 658.3333129882812,
        "wires": []
    },
    {
        "id": "e1787f8b.7b49b",
        "type": "link out",
        "z": "ef23770c.5edc1",
        "name": "provider_meter",
        "links": [
            "519c6ba5.fd38e4"
        ],
        "x": 915.5,
        "y": 2629.2999877929688,
        "wires": []
    },
    {
        "id": "2f67ddaf.59b8f2",
        "type": "catch",
        "z": "2cf1d395.65be64",
        "name": "",
        "scope": [
            "dae92716.08532",
            "b20eacd8.3dbbd",
            "6179ba75.af6e3c",
            "83c3c86e.68e8d",
            "dbf9480d.232f8",
            "2363c8fe.51fee8",
            "b77f9f2f.8fa1c8",
            "10bfbd32.5dd9ab",
            "1a531d7b.3b4e83",
            "c47b33de.447678",
            "d142439.492df4",
            "20c5593b.c7241e",
            "65bfb866.0f6498",
            "c34dcbe2.430e68"
        ],
        "x": 226,
        "y": 1734,
        "wires": [
            [
                "1a531d7b.3b4e83",
                "c47b33de.447678",
                "d142439.492df4"
            ]
        ]
    },
    {
        "id": "9b46d119.cfbf1",
        "type": "ui_dropdown",
        "z": "2cf1d395.65be64",
        "name": "",
        "label": "Local production module",
        "place": "Select source",
        "group": "145e2cec.4e9fa3",
        "order": 0,
        "width": 0,
        "height": 0,
        "passthru": true,
        "options": [
            {
                "label": "Main A",
                "value": "0",
                "type": "str"
            },
            {
                "label": "Main B",
                "value": "1",
                "type": "str"
            },
            {
                "label": "Plug 1",
                "value": "2",
                "type": "str"
            },
            {
                "label": "Plug 2",
                "value": "3",
                "type": "str"
            },
            {
                "label": " Plug 3 ",
                "value": "4",
                "type": "str"
            },
            {
                "label": "Solar module",
                "value": "5",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "",
        "x": 1050,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "98b6139d.88388",
        "type": "debug",
        "z": "9e52ccb8.2c00a8",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 941.5,
        "y": 2456.2999877929688,
        "wires": []
    },
    {
        "id": "6dee035.04eb9fc",
        "type": "ui_text",
        "z": "2a4ee4a1.258c6c",
        "group": "d8070267.de17e8",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "Name",
        "label": "",
        "format": "{{msg.payload}}",
        "layout": "row-left",
        "x": 1184.5,
        "y": 196.5833740234375,
        "wires": []
    },
    {
        "id": "693310c.3d6e1f",
        "type": "ui_text",
        "z": "2a4ee4a1.258c6c",
        "group": "d8070267.de17e8",
        "order": 3,
        "width": 0,
        "height": 0,
        "name": "Power",
        "label": "Power",
        "format": "{{msg.payload}} W",
        "layout": "row-spread",
        "x": 898,
        "y": 790,
        "wires": []
    },
    {
        "id": "347ad60f.d794ca",
        "type": "ui_chart",
        "z": "2a4ee4a1.258c6c",
        "name": "Power",
        "group": "d8070267.de17e8",
        "order": 4,
        "width": 0,
        "height": 0,
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": "6",
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "x": 897.25,
        "y": 742.0000915527344,
        "wires": [
            [
                "8f00f9e2.3c02d8"
            ],
            []
        ]
    },
    {
        "id": "e7f8383c.d12df",
        "type": "ui_switch",
        "z": "2a4ee4a1.258c6c",
        "name": "",
        "label": "Relay",
        "group": "d8070267.de17e8",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": true,
        "decouple": "false",
        "topic": "relay3_state",
        "style": "",
        "onvalue": "1",
        "onvalueType": "str",
        "onicon": "",
        "oncolor": "",
        "offvalue": "0",
        "offvalueType": "str",
        "officon": "",
        "offcolor": "",
        "x": 767,
        "y": 420,
        "wires": [
            [
                "143fc1e8.2358be",
                "69cd15fd.97c654",
                "e83a40be.752288"
            ]
        ]
    },
    {
        "id": "bf1a9287.84a0f8",
        "type": "function",
        "z": "f512852c.8ffbe8",
        "name": "set flow name",
        "func": "flow.set (\"solar_save3\", msg.payload);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 320,
        "y": 800,
        "wires": [
            [
                "897c5de8.07ebc8"
            ]
        ]
    },
    {
        "id": "f8b9eb80.3f34f",
        "type": "function",
        "z": "f512852c.8ffbe8",
        "name": "set flow name",
        "func": "var solar = flow.get(\"solar_save3\");\n\nconsole.log(msg.payload.length);\nconsole.log(solar.length);\n\nvar ll = msg.payload.length;\n\nconsole.log(ll);\n\nif (solar.length < ll)\n    ll = solar.length;\n\nconsole.log(ll);\n\n\nfor (var i=0; i<ll; i++) {\n    \n    msg.payload[i].value = solar[i].value;\n    msg.payload[i].device = \"solar\";\n    msg.payload[i].sensor = \"power\";\n    \n}\n\n//msg.payload = solar;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1020,
        "y": 780,
        "wires": [
            [
                "1d37c7b4.37add8"
            ]
        ]
    },
    {
        "id": "3ac6838f.6d0004",
        "type": "inject",
        "z": "f512852c.8ffbe8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 829.7666320800781,
        "y": 784.0166625976562,
        "wires": [
            [
                "f8b9eb80.3f34f"
            ]
        ]
    },
    {
        "id": "b3179a67.05045",
        "type": "debug",
        "z": "f512852c.8ffbe8",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1210,
        "y": 880,
        "wires": []
    },
    {
        "id": "897c5de8.07ebc8",
        "type": "debug",
        "z": "f512852c.8ffbe8",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 490,
        "y": 800,
        "wires": []
    },
    {
        "id": "7662e7a4.bf6338",
        "type": "debug",
        "z": "f512852c.8ffbe8",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1175.6000671386719,
        "y": 271.0666809082031,
        "wires": []
    },
    {
        "id": "54bc754e.afaa7c",
        "type": "delay",
        "z": "f512852c.8ffbe8",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "5",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 800,
        "y": 840,
        "wires": [
            [
                "f8b9eb80.3f34f"
            ]
        ]
    },
    {
        "id": "553d3002.90a688",
        "type": "delay",
        "z": "f512852c.8ffbe8",
        "name": "",
        "pauseType": "rate",
        "timeout": "3",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 260,
        "y": 900,
        "wires": [
            [
                "d96bd13b.12004"
            ]
        ]
    },
    {
        "id": "1d37c7b4.37add8",
        "type": "delay",
        "z": "f512852c.8ffbe8",
        "name": "",
        "pauseType": "delay",
        "timeout": "4",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1030.7666320800781,
        "y": 886.1499938964844,
        "wires": [
            [
                "b3179a67.05045"
            ]
        ]
    },
    {
        "id": "1389ad0d.c99e53",
        "type": "inject",
        "z": "f512852c.8ffbe8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 760,
        "y": 920,
        "wires": [
            [
                "2fd9af60.3598c"
            ]
        ]
    },
    {
        "id": "2fd9af60.3598c",
        "type": "function",
        "z": "f512852c.8ffbe8",
        "name": "",
        "func": "msg.complete = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 890,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "d96bd13b.12004",
        "type": "debug",
        "z": "f512852c.8ffbe8",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 485.7666320800781,
        "y": 881.7166442871094,
        "wires": []
    }
]